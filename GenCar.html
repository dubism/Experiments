<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pollinations — Time × Environment × Car</title>
<style>
  :root{
    --fg:#e8eef5; --muted:#a6b0bd; --accent:#5ac8fa;
    --c1:#222; --c2:#111; --c3:#191919; --c4:#101010;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(at 0% 0%, var(--c1), transparent 60%),
    radial-gradient(at 100% 0%, var(--c2), transparent 60%),
    radial-gradient(at 0% 100%, var(--c3), transparent 60%),
    radial-gradient(at 100% 100%, var(--c4), transparent 60%), #0a0a0a;
    color:var(--fg); font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}
  /* Nudge the image slightly above dead center */
  .stage{width:min(92vw,1000px); transform:translateY(-5vh); display:flex; justify-content:center; align-items:center}
  .frame{position:relative; width:100%; aspect-ratio:16/10; border-radius:14px; overflow:hidden;
    box-shadow:0 12px 32px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06); background:#111}
  .frame img{position:absolute; inset:0; margin:auto; max-width:100%; max-height:100%; object-fit:contain; image-rendering:auto; filter:contrast(1.02) saturate(1.02)}
  .frame .loading{position:absolute; inset:auto 0 10px 0; text-align:center; font-size:12px; color:var(--muted)}
  .controls{width:min(92vw,860px); margin-top:16px; transform:translateY(-3vh)}
  .row{display:grid; grid-template-columns:110px 1fr 90px; gap:12px; align-items:center; padding:10px 12px}
  .label{font-weight:600; letter-spacing:.2px}
  .val{font-variant-numeric:tabular-nums; text-align:right; color:var(--muted)}
  input[type="range"]{width:100%; -webkit-appearance:none; appearance:none; height:28px; background:transparent}
  input[type="range"]::-webkit-slider-runnable-track{height:6px; border-radius:999px; background:linear-gradient(90deg, rgba(255,255,255,.25), rgba(255,255,255,.12))}
  input[type="range"]::-moz-range-track{height:6px; border-radius:999px; background:linear-gradient(90deg, rgba(255,255,255,.25), rgba(255,255,255,.12))}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%;
    background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.5); margin-top:-6px}
  input[type="range"]::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:#fff; border:none; box-shadow:0 2px 8px rgba(0,0,0,.5)}
  .hint{opacity:.75; font-size:11px; text-align:center; margin-top:8px; color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="stage">
      <div class="frame" id="frame">
        <img id="img" alt="Generated scene" crossOrigin="anonymous">
        <div class="loading" id="loading">Loading…</div>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <div class="label">Time</div>
        <input id="time" type="range" min="0" max="23" step="1">
        <div class="val" id="timeVal"></div>
      </div>
      <div class="row">
        <div class="label">Environment</div>
        <input id="env" type="range" min="0" max="9" step="1">
        <div class="val" id="envVal"></div>
      </div>
      <div class="row">
        <div class="label">Car type</div>
        <input id="car" type="range" min="0" max="9" step="1">
        <div class="val" id="carVal"></div>
      </div>
      <div class="hint">Updates on every change • Background adapts to image colors (4-point gradient)</div>
    </div>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const img = $('#img'), loading = $('#loading');

  const habitats = [
    "alpine tundra",                // 0
    "boreal coniferous forest",     // 1
    "mixed temperate forest",       // 2
    "deciduous woodland",           // 3
    "grassland steppe",             // 4
    "farmland and orchards",        // 5
    "Mediterranean scrubland",      // 6
    "savanna",                      // 7
    "semi-desert badlands",         // 8
    "sandy desert dunes"            // 9
  ];
  const cars = [
    "microcar (A-segment)",
    "city hatchback (B-segment)",
    "compact sedan (C-segment)",
    "midsize sedan",
    "estate wagon",
    "compact SUV",
    "midsize SUV",
    "large SUV",
    "pickup truck",
    "minibus / van"
  ];

  const timeEl = $('#time'), envEl = $('#env'), carEl = $('#car');
  const timeVal = $('#timeVal'), envVal = $('#envVal'), carVal = $('#carVal');

  // Randomize defaults and trigger initial render immediately
  timeEl.value = Math.floor(Math.random()*24);
  envEl.value  = Math.floor(Math.random()*habitats.length);
  carEl.value  = Math.floor(Math.random()*cars.length);
  reflectLabels();
  generate();

  // Live update on every change
  [timeEl, envEl, carEl].forEach(el => el.addEventListener('input', () => { reflectLabels(); generate(); }));

  function reflectLabels(){
    const h = +timeEl.value, e = +envEl.value, c = +carEl.value;
    timeVal.textContent = labelHour(h);
    envVal.textContent  = habitats[e];
    carVal.textContent  = cars[c];
  }

  function labelHour(h){
    const hh = String(h).padStart(2,'0')+":00";
    if (h>=4 && h<6) return `pre-dawn · ${hh}`;
    if (h>=6 && h<8) return `sunrise · ${hh}`;
    if (h>=8 && h<12) return `morning · ${hh}`;
    if (h===12)       return `noon · 12:00`;
    if (h>12 && h<17) return `afternoon · ${hh}`;
    if (h>=17 && h<20)return `sunset · ${hh}`;
    if (h>=20 && h<22)return `blue hour · ${hh}`;
    if (h>=22 || h<2) return `night · ${hh}`;
    return `late night · ${hh}`;
  }

  function buildPrompt(){
    const h = +timeEl.value, e = +envEl.value, c = +carEl.value;
    const hour = String(h).padStart(2,'0')+":00";
    // Keep it short for speed.
    return `A realistic photo of a ${cars[c]} in ${habitats[e]} at ${hour}. Natural light, detailed, no text`;
  }

  // Compose Pollinations URL: fastest small image via model=turbo
  function pollinationsURL(prompt){
    const w = 640, h = 384; // small & quick
    const seed = Math.floor(Math.random()*1e9);
    return `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?model=turbo&width=${w}&height=${h}&enhance=false&seed=${seed}`;
  }

  let inFlight = 0;
  function generate(){
    const prompt = buildPrompt();
    const url = pollinationsURL(prompt);
    inFlight++;
    loading.textContent = "Loading…";
    img.style.opacity = .25;
    img.onload = () => {
      img.style.opacity = 1;
      loading.textContent = "";
      // Extract palette once loaded
      try { extractPaletteToBackground(img); }
      catch(e){ fallbackPaletteToBackground(url); }
    };
    img.onerror = () => {
      loading.textContent = "Load error — retrying…";
      // quick retry with a new seed
      setTimeout(()=>{ img.src = pollinationsURL(prompt) + `&t=${Date.now()}`; }, 300);
    };
    img.src = url + `&t=${Date.now()}`; // bust cache
  }

  // --- Palette extraction (fast k-means over downsample) ---
  function extractPaletteToBackground(imageEl){
    const cvs = document.createElement('canvas'), ctx = cvs.getContext('2d', {willReadFrequently:true});
    const S = 64; // small sample for speed
    cvs.width = S; cvs.height = S;
    ctx.drawImage(imageEl, 0, 0, S, S);
    let data;
    try { data = ctx.getImageData(0,0,S,S).data; }
    catch(e){ fallbackPaletteToBackground(imageEl.src); return; } // CORS taint fallback

    const pts = [];
    for (let i=0;i<data.length;i+=4){
      const a = data[i+3];
      if (a<16) continue;
      pts.push([data[i], data[i+1], data[i+2]]);
    }
    const centers = kmeans(pts, 4, 7);
    // Sort by cluster size (desc)
    centers.sort((a,b)=>b.count-a.count);
    const cols = centers.map(c=>rgbToHex(c[0],c[1],c[2]));
    applyGradient(cols);
  }

  // Simple kmeans (k clusters, iters). Returns [{0:r,1:g,2:b,count:n},...]
  function kmeans(points, k=4, iters=6){
    // init with random samples
    const centers = Array.from({length:k}, _=>{
      const p = points[(Math.random()*points.length)|0];
      return [p[0],p[1],p[2], 0];
    });
    for (let t=0;t<iters;t++){
      const acc = centers.map(_=>({r:0,g:0,b:0,n:0}));
      for (let i=0;i<points.length;i++){
        const p = points[i];
        let bi=0, bd=1e9;
        for (let j=0;j<k;j++){
          const c = centers[j], dr=p[0]-c[0], dg=p[1]-c[1], db=p[2]-c[2];
          const d = dr*dr+dg*dg+db*db;
          if (d<bd){ bd=d; bi=j; }
        }
        const A = acc[bi]; A.r+=p[0]; A.g+=p[1]; A.b+=p[2]; A.n++;
      }
      for (let j=0;j<k;j++){
        const A = acc[j];
        if (A.n>0){ centers[j][0]=A.r/A.n; centers[j][1]=A.g/A.n; centers[j][2]=A.b/A.n; centers[j].count=A.n; }
      }
    }
    return centers.map(c=>[c[0]|0,c[1]|0,c[2]|0, c.count||1]);
  }

  function rgbToHex(r,g,b){
    return "#"+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
  }

  function applyGradient(cols){
    const [c1="#222",c2="#111",c3="#191919",c4="#101010"] = cols;
    document.documentElement.style.setProperty('--c1', c1);
    document.documentElement.style.setProperty('--c2', c2);
    document.documentElement.style.setProperty('--c3', c3);
    document.documentElement.style.setProperty('--c4', c4);
  }

  // Fallback: derive colors from URL hash if canvas is tainted
  function fallbackPaletteToBackground(str){
    const h = xmur3(str), rnd=mulberry32(h());
    const cols = Array.from({length:4}, _=>{
      const r = 32 + (rnd()*160|0), g = 32 + (rnd()*160|0), b = 32 + (rnd()*160|0);
      return rgbToHex(r,g,b);
    });
    applyGradient(cols);
  }
  // Tiny PRNGs
  function xmur3(str){ for(var h=1779033703^str.length,i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;} return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0;};}
  function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}

})();
</script>
</body>
</html>