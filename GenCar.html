<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pollinations — Time × Environment × Car × Era × Direction</title>
<link rel="preconnect" href="https://image.pollinations.ai" crossorigin>
<link rel="dns-prefetch" href="//image.pollinations.ai">
<link rel="dns-prefetch" href="//images.weserv.nl">
<style>
  :root{
    --fg:#e8eef5; --muted:#a6b0bd;
    --c1:#1a1a1a; --c2:#121212; --c3:#151515; --c4:#0f0f0f; /* neutral waiting palette */
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;background:
      radial-gradient(at 0% 0%, var(--c1), transparent 60%),
      radial-gradient(at 100% 0%, var(--c2), transparent 60%),
      radial-gradient(at 0% 100%, var(--c3), transparent 60%),
      radial-gradient(at 100% 100%, var(--c4), transparent 60%), #0b0b0b;
    color:var(--fg); font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    overflow-y:auto; overflow-x:hidden;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }

  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start; gap:8px}

  .stage{width:min(96vw, 900px); display:flex; justify-content:center; align-items:center}
  .frame{
    position:relative; width:100%; aspect-ratio:16/10; border-radius:12px; overflow:hidden;
    box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06); background:#111;
  }
  .frame img{
    position:absolute; inset:0; margin:auto; max-width:100%; max-height:100%;
    object-fit:contain; image-rendering:auto; filter:contrast(1.02) saturate(1.02);
  }
  .loading{
    position:absolute; left:0; right:0; bottom:8px; text-align:center; font-size:12px; color:var(--muted);
    transition:opacity .2s ease; opacity:0; pointer-events:none;
  }
  .loading.show{opacity:1}

  /* Controls */
  .controls{width:min(96vw, 900px); margin-top:4px}
  .row{padding:6px 4px}
  .top{display:flex; justify-content:space-between; align-items:baseline; margin:0 2px 4px}
  .label{font-weight:600; letter-spacing:.2px}
  .val{font-variant-numeric:tabular-nums; color:var(--muted); font-size:12px}
  input[type="range"]{width:100%; -webkit-appearance:none; appearance:none; height:28px; background:transparent}
  input[type="range"]::-webkit-slider-runnable-track{height:6px; border-radius:999px; background:linear-gradient(90deg, rgba(255,255,255,.28), rgba(255,255,255,.14))}
  input[type="range"]::-moz-range-track{height:6px; border-radius:999px; background:linear-gradient(90deg, rgba(255,255,255,.28), rgba(255,255,255,.14))}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%;
    background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.5); margin-top:-6px}
  input[type="range"]::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:#fff; border:none; box-shadow:0 2px 8px rgba(0,0,0,.5)}
  input[type="range"]:disabled{opacity:.55; cursor:not-allowed}
  input[type="range"]:disabled::-webkit-slider-thumb{background:#c9c9c9; box-shadow:none}
  input[type="range"]:disabled::-moz-range-thumb{background:#c9c9c9; box-shadow:none}
  .hint{opacity:.75; font-size:11px; text-align:center; margin:6px 0 10px; color:var(--muted)}

  .errbar{
    position:fixed; left:12px; right:12px; bottom:12px; padding:10px 12px; border-radius:10px;
    background:#2b1212; color:#ffd6d6; border:1px solid #913c3c; font-size:12px; display:none; z-index:9998
  }

  /* Overlay: prompt + debug combined, toggled by chevron */
  .peek{
    position:fixed; right:12px; bottom:12px; z-index:9999;
    width:36px; height:36px; border-radius:50%;
    display:grid; place-items:center;
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18);
    color:#fff; cursor:pointer;
    backdrop-filter: blur(8px);
    transform:rotate(0deg); transition:transform .2s ease;
  }
  .peek[aria-expanded="true"]{ transform:rotate(180deg); }

  .overlay{
    position:fixed; inset:12px; z-index:9997; display:none;
    background:rgba(10,10,10,.88); border:1px solid rgba(255,255,255,.1); border-radius:12px;
    backdrop-filter: blur(10px);
  }
  .overlay.show{ display:block; }
  .overlay .inner{ height:100%; display:flex; flex-direction:column; }
  .overlay header{
    display:flex; align-items:center; justify-content:space-between; padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,.08); font-weight:600;
  }
  .overlay main{ flex:1; overflow:auto; padding:10px 12px; display:grid; grid-template-columns:1fr; gap:12px; }
  .card{
    background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px;
  }
  .card h3{ margin:0 0 6px 0; font-size:13px; color:#dfe6ef; }
  pre{white-space:pre-wrap; word-break:break-word; margin:0; font:12px/1.35 ui-monospace,SFMono-Regular,Consolas,monospace; color:#dfe6ef}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .btn{
    appearance:none; border:1px solid rgba(255,255,255,.12); border-radius:8px; padding:6px 10px;
    background:rgba(255,255,255,.06); color:var(--fg); font:12px; cursor:pointer; text-decoration:none;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="stage">
      <div class="frame">
        <img id="img" alt="Generated scene" crossorigin="anonymous" referrerpolicy="no-referrer" decoding="async" loading="eager" fetchpriority="high">
        <div class="loading" id="loading" aria-live="polite">Loading…</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="row">
        <div class="top"><div class="label">Time</div><div class="val" id="timeVal"></div></div>
        <input id="time" type="range" min="0" max="23" step="1">
      </div>
      <div class="row">
        <div class="top"><div class="label">Environment</div><div class="val" id="envVal"></div></div>
        <input id="env" type="range" min="0" max="9" step="1">
      </div>
      <div class="row">
        <div class="top"><div class="label">Car type</div><div class="val" id="carVal"></div></div>
        <input id="car" type="range" min="0" max="9" step="1">
      </div>
      <div class="row">
        <div class="top"><div class="label">Era</div><div class="val" id="eraVal"></div></div>
        <input id="era" type="range" min="0" max="11" step="1">
      </div>
      <div class="row">
        <div class="top"><div class="label">Direction</div><div class="val" id="dirVal"></div></div>
        <input id="dir" type="range" min="0" max="7" step="1">
      </div>
      <div class="hint">Updates after 500 ms pause · Background adapts to image colors (4-point gradient)</div>
    </div>
  </div>

  <!-- Chevron + Overlay -->
  <button id="peek" class="peek" aria-expanded="false" title="Show prompt & debug">⌄</button>
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="inner">
      <header>
        <span>Prompt & Debug</span>
        <div class="actions">
          <button class="btn" id="copyPrompt">Copy prompt</button>
          <button class="btn" id="copyURL">Copy image URL</button>
          <button class="btn" id="retry">Retry</button>
          <button class="btn" id="selfTest">Self-test</button>
          <a class="btn" id="openImg" target="_blank" rel="noopener">Open image</a>
        </div>
      </header>
      <main>
        <div class="card">
          <h3>Current Prompt</h3>
          <pre id="promptText">—</pre>
        </div>
        <div class="card">
          <h3>Debug log</h3>
          <pre id="debugText">—</pre>
        </div>
      </main>
    </div>
  </div>

  <div id="errbar" class="errbar"></div>

<script>
'use strict';
(() => {
  const WAIT_MS = 500;

  /* Error bar */
  const errbar = document.getElementById('errbar');
  const showError = (msg)=>{ errbar.textContent = msg; errbar.style.display='block'; clearTimeout(showError._t); showError._t=setTimeout(()=>errbar.style.display='none',7000); };
  window.addEventListener('error', e => showError(`Script error: ${e.message}`));
  window.addEventListener('unhandledrejection', e => showError(`Promise error: ${e.reason?.message || e.reason}`));

  /* DOM */
  const $ = s => document.querySelector(s);
  const img = $('#img'), loading = $('#loading');
  const promptText = $('#promptText'), openImg = $('#openImg'), copyPromptBtn = $('#copyPrompt');
  const debugText = $('#debugText'), selfTestBtn = $('#selfTest'), retryBtn = $('#retry'), copyURLBtn = $('#copyURL');
  const peekBtn = $('#peek'), overlay = $('#overlay');

  const habitats = ["alpine tundra","boreal coniferous forest","mixed temperate forest","deciduous woodland","grassland steppe","farmland and orchards","Mediterranean scrubland","savanna","semi-desert badlands","sandy desert dunes"];
  const cars = ["microcar (A-segment)","city hatchback (B-segment)","compact sedan (C-segment)","midsize sedan","estate wagon","compact SUV","midsize SUV","large SUV","pickup truck","minibus / van"];

  const eras = [
    "1890s","1920s","1950s","1960s","1970s","1980s","1990s","2000s","2010s","2020s",
    "futuristic","unbelievably mesmerizingly sci-fi"
  ];

  const directions = [
    "front three-quarter HERO shot — camera at headlight height",
    "rear three-quarter HERO shot — camera at taillight height",
    "perfect side profile — orthographic 90°, no perspective",
    "dead-on front view — grille perfectly square to camera",
    "dead-on rear view — bumper perfectly square to camera",
    "dramatic LOW-ANGLE front three-quarter — ground-level",
    "HIGH-ANGLE front three-quarter — from above",
    "TRUE OVERHEAD top-down — car centered"
  ];

  const timeEl = $('#time'), envEl = $('#env'), carEl = $('#car'), eraEl = $('#era'), dirEl = $('#dir');
  const timeVal = $('#timeVal'), envVal = $('#envVal'), carVal = $('#carVal'), eraVal = $('#eraVal'), dirVal = $('#dirVal');
  const sliders = [timeEl, envEl, carEl, eraEl, dirEl];

  const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
  const log=(m)=>{ debugText.textContent=`[${(new Date).toLocaleTimeString()}] ${m}\n`+debugText.textContent; };

  /* Overlay toggle */
  function toggleOverlay(force){
    const open = typeof force==='boolean' ? force : overlay.classList.contains('show')===false;
    overlay.classList.toggle('show', open);
    overlay.setAttribute('aria-hidden', String(!open));
    peekBtn.setAttribute('aria-expanded', String(open));
  }
  peekBtn.addEventListener('click', ()=>toggleOverlay());
  // Escape to close
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') toggleOverlay(false); });

  /* Time (color-free) */
  function timeCue(h){
    if (h>=4 && h<6)  return "pre-dawn hush; faint horizon glow; long soft shadows; bright morning star visible";
    if (h>=6 && h<8)  return "sun just rising; low-angle light; long soft shadows; thin ground mist";
    if (h>=8 && h<12) return "clear directional daylight; crisp shadows; airy atmosphere";
    if (h===12)       return "midday overhead light; minimal shadows; high clarity";
    if (h>12 && h<17) return "afternoon light; defined shadows; gentle haze";
    if (h>=17 && h<20)return "sun near horizon; raking light; bold silhouettes possible";
    if (h>=20 && h<22)return "twilight after sunset; soft ambient glow; first stars emerging";
    if (h>=22 || h<2) return "night; moonlight and starlight; constellations visible";
    return "deep night; sparse light sources; quiet atmosphere";
  }

  /* Era cues: numeric + word forms + design ethos */
  function eraCue(label){
    const map = {
      "1890s": "1890s (eighteen-nineties) — horseless carriage spirit; exposed coachwork; spindly wheels; brass fittings",
      "1920s": "1920s (20s, nineteen-twenties) — early streamlining; art-deco cues; upright radiators; coachbuilt bodies",
      "1950s": "1950s (50s, nineteen-fifties) — jet-age optimism; tailfins; chrome; two-tone trims; whitewall tires",
      "1960s": "1960s (60s, nineteen-sixties) — clean curves; coke-bottle waists; muscle-car stance; simple brightwork",
      "1970s": "1970s (70s, nineteen-seventies) — wedge-shaped experiments; oil-crisis compactness; louvers; vinyl textures",
      "1980s": "1980s (80s, nineteen-eighties) — boxy precision; sharp creases; pop-up headlamps; black rub strips",
      "1990s": "1990s (90s, nineteen-nineties) — aero-organic rounding; cab-forward; flush glass; smooth cladding",
      "2000s": "2000s (00s, two-thousands) — taut surfacing; flame-surfacing accents; big alloys; high beltlines",
      "2010s": "2010s (10s, twenty-tens) — LED signatures; aggressive grilles; origami creases; crossover boom",
      "2020s": "2020s (20s, twenty-twenties) — EV minimalism; sealed grilles; parametric lighting; slipperier aero",
      "futuristic": "futuristic — near-future concept design; seamless panels; advanced composites; plausible sensors",
      "unbelievably mesmerizingly sci-fi": "unbelievably mesmerizingly sci-fi — starship-like presence; alien megastructures; impossible engineering; luminous seams"
    };
    return map[label] || `${label} style authenticity`;
  }

  function labelHour(h){
    const hh = String(h).padStart(2,'0')+":00";
    if (h>=4 && h<6)  return `pre-dawn · ${hh}`;
    if (h>=6 && h<8)  return `sunrise · ${hh}`;
    if (h>=8 && h<12) return `morning · ${hh}`;
    if (h===12)       return `noon · 12:00`;
    if (h>12 && h<17) return `afternoon · ${hh}`;
    if (h>=17 && h<20)return `sunset · ${hh}`;
    if (h>=20 && h<22)return `twilight · ${hh}`;
    if (h>=22 || h<2) return `night · ${hh}`;
    return `late night · ${hh}`;
  }
  function reflectLabels(){
    timeVal.textContent = labelHour(+timeEl.value);
    envVal.textContent  = habitats[+envEl.value];
    carVal.textContent  = cars[+carEl.value];
    eraVal.textContent  = eras[+eraEl.value];
    dirVal.textContent  = directions[+dirEl.value];
  }

  /* Prompt — now with lively eras + time cues */
  function buildPrompt(){
    const env  = habitats[+envEl.value];
    const car  = cars[+carEl.value];
    const era  = eras[+eraEl.value];
    const dir  = directions[+dirEl.value];
    const timeText = timeCue(+timeEl.value);
    const eraText  = eraCue(era);
    return `A realistic photo of a ${car} in ${env}. Era: ${eraText}. Camera angle: ${dir}. Time: ${timeText}. Natural light, detailed, no text`;
  }

  /* URLs + fallbacks */
  const uBase=(prompt,model,w,h)=>{const seed=(Math.random()*1e9|0);const base=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=${w}&height=${h}&enhance=false&seed=${seed}`;return model?`${base}&model=${model}`:base;};
  const uTurbo=p=>uBase(p,'turbo',640,384);
  const uFlux =p=>uBase(p,'flux',640,384);
  const uPlain=p=>uBase(p,null,640,384);
  const uSmall=p=>uBase(p,'turbo',512,512);
  const uProxy=url=>`https://images.weserv.nl/?url=${encodeURIComponent(url.replace(/^https?:\/\//,''))}`;
  const candidates=(p)=>{const a=uTurbo(p),b=uFlux(p),c=uPlain(p),d=uSmall(p); return [a,b,c,d,uProxy(a),uProxy(b)];};

  const setLoading=(on,txt='')=>{loading.classList.toggle('show',!!on); loading.textContent=on?`Loading…${txt}`:'';};
  const setControlsEnabled=(enabled)=>{ [timeEl,envEl,carEl,eraEl,dirEl].forEach(el=>el.disabled=!enabled); };

  /* Keep-previous: preload -> swap */
  let genToken=0;
  function loadSequence(prompt){
    const seq=candidates(prompt); let i=0; const token=++genToken;
    setWaitingGradient(prompt);
    setLoading(true,` (attempt ${i+1}/${seq.length})`);
    tryOne(seq[i]);

    function tryOne(url){
      if(token!==genToken) return;
      const pre=new Image(); pre.crossOrigin='anonymous'; pre.referrerPolicy='no-referrer';
      const start=performance.now();

      pre.onload=()=>{ if(token!==genToken) return;
        img.src=pre.src; setLoading(false); setControlsEnabled(true);
        log(`Loaded OK in ${Math.round(performance.now()-start)}ms via ${url.includes('weserv.nl')?'proxy':'direct'}`);
        try{ extractPaletteToBackground(pre); }catch{ setWaitingGradient(url); }
      };
      pre.onerror=()=>{ if(token!==genToken) return;
        if(++i<seq.length){ setLoading(true,` (attempt ${i+1}/${seq.length})`); tryOne(seq[i]); }
        else{ setLoading(false); setControlsEnabled(true); showError('Image load failed repeatedly.'); log('All attempts failed.'); }
      };

      pre.src=url+`&t=${Date.now()%1e7}`;
      if(typeof pre.decode==='function'){ pre.decode().catch(()=>{}); }
      updatePromptUI(prompt,url);
    }
  }

  function updatePromptUI(prompt,url){
    promptText.textContent=prompt;
    openImg.href=url;
    copyURLBtn.onclick=async()=>{try{await navigator.clipboard.writeText(url); log('Copied URL');}catch{showError('Clipboard blocked');}};
    copyPromptBtn.onclick=async()=>{try{await navigator.clipboard.writeText(prompt);}catch{showError('Clipboard blocked');}};
  }

  /* Palette */
  function extractPaletteToBackground(imageEl){
    const cvs=document.createElement('canvas'), ctx=cvs.getContext('2d',{willReadFrequently:true});
    const S=64; cvs.width=S; cvs.height=S; ctx.drawImage(imageEl,0,0,S,S);
    let data; try{ data=ctx.getImageData(0,0,S,S).data; }catch{ setWaitingGradient(imageEl.currentSrc||imageEl.src); return; }
    const pts=[]; for(let i=0;i<data.length;i+=4){ if(data[i+3]>=16) pts.push([data[i],data[i+1],data[i+2]]); }
    if(!pts.length){ setWaitingGradient(imageEl.currentSrc||imageEl.src); return; }
    const centers=kmeansRGB(pts,4,7).sort((A,B)=>B.count-A.count);
    const cols=centers.map(c=>rgbToHex(c.r,c.g,c.b)); applyGradient(cols);
  }
  function kmeansRGB(points,k=4,iters=6){
    const centers=Array.from({length:k},_=>{const p=points[(Math.random()*points.length)|0]; return {r:p[0],g:p[1],b:p[2],count:1};});
    for(let t=0;t<iters;t++){
      const acc=centers.map(_=>({r:0,g:0,b:0,n:0}));
      for(let i=0;i<points.length;i++){
        const p=points[i]; let bi=0,bd=Infinity;
        for(let j=0;j<k;j++){const c=centers[j],dr=p[0]-c.r,dg=p[1]-c.g,db=p[2]-c.b; const d=dr*dr+dg*dg+db*db; if(d<bd){bd=d;bi=j;}}
        const A=acc[bi]; A.r+=p[0]; A.g+=p[1]; A.b+=p[2]; A.n++;
      }
      for(let j=0;j<k;j++){const A=acc[j]; if(A.n>0){centers[j].r=A.r/A.n; centers[j].g=A.g/A.n; centers[j].b=A.b/A.n; centers[j].count=A.n;}}
    }
    return centers.map(c=>({r:c.r|0,g:c.g|0,b:c.b|0,count:c.count||1}));
  }
  const rgbToHex=(r,g,b)=>"#"+[r,g,b].map(v=>clamp(v|0,0,255).toString(16).padStart(2,'0')).join('');
  function applyGradient(cols){
    const [c1="#1a1a1a",c2="#121212",c3="#151515",c4="#0f0f0f"]=cols;
    const root=document.documentElement.style;
    root.setProperty('--c1',c1); root.setProperty('--c2',c2); root.setProperty('--c3',c3); root.setProperty('--c4',c4);
  }
  function setWaitingGradient(seedStr){
    const seed=xmur3(seedStr||'seed')(); const rnd=mulberry32(seed);
    const g=()=>{const v=24+((rnd()*180)|0); return `#${[v,v,v].map(x=>x.toString(16).padStart(2,'0')).join('')}`;};
    applyGradient([g(),g(),g(),g()]);
  }
  function xmur3(str){for(var h=1779033703^str.length,i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0;};}
  function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}

  /* Debounce to 500 ms; disable sliders while waiting + loading */
  let debounceT=0, dragging=false;
  function scheduleGenerate(){
    clearTimeout(debounceT);
    setControlsEnabled(false);
    setLoading(true,' (queued)');
    debounceT=setTimeout(()=>{ setLoading(true,''); loadSequence(buildPrompt()); }, WAIT_MS);
  }

  // Input wiring
  [timeEl, envEl, carEl, eraEl, dirEl].forEach(el=>{
    el.addEventListener('pointerdown', ()=>{ dragging=true; clearTimeout(debounceT); setControlsEnabled(true); setLoading(false); });
    el.addEventListener('input', ()=>{ reflectLabels(); });
    const release = ()=>{ if(dragging){ dragging=false; scheduleGenerate(); } };
    el.addEventListener('pointerup', release);
    el.addEventListener('touchend', release, {passive:true});
    el.addEventListener('mouseup', release);
    el.addEventListener('change', ()=>{ if(!dragging) scheduleGenerate(); });
  });

  // Buttons
  retryBtn.onclick=()=>scheduleGenerate();
  selfTestBtn.onclick=async()=>{ log(`UA: ${navigator.userAgent}`); log(`online: ${navigator.onLine}`); await probe('https://picsum.photos/3'); const t=uPlain('test'); await probe(t); await probe(uProxy(t)); };
  copyURLBtn.onclick=async()=>{ try{ await navigator.clipboard.writeText(openImg.href||''); log('Copied URL'); }catch{ showError('Clipboard blocked'); } };
  copyPromptBtn.onclick=async()=>{ try{ await navigator.clipboard.writeText(promptText.textContent||''); }catch{ showError('Clipboard blocked'); } };

  function probe(url){ return new Promise(res=>{const t0=performance.now(); const im=new Image(); im.onload=()=>{log(`PROBE OK ${url} (${Math.round(performance.now()-t0)}ms)`); res();}; im.onerror=()=>{log(`PROBE ERROR ${url}`); res();}; im.referrerPolicy='no-referrer'; im.crossOrigin='anonymous'; im.src=url+`&p=${Date.now()%1e7}`;}); }

  // Init
  timeEl.value=(Math.random()*24)|0;
  envEl.value =(Math.random()*habitats.length)|0;
  carEl.value =(Math.random()*cars.length)|0;
  eraEl.value =(Math.random()*eras.length)|0;
  dirEl.value =(Math.random()*directions.length)|0;
  reflectLabels();
  scheduleGenerate(); // initial run
})();
</script>
</body>
</html>