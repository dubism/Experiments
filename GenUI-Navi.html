<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Predictive Mobility — Signal Chips → UI Generator</title>
  <style>
    :root{--bg:#0c0d10;--fg:#e9eaee;--muted:#9aa0aa;--chip:#1a1c21;--chip-on:#2b6ef6;--chip-on-fg:#fff;--line:#23252b;--accent:#21c07c;--warn:#ffb020;--err:#ff5c5c}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";-webkit-font-smoothing:antialiased}
    .wrap{max-width:920px;margin:0 auto;padding:16px 14px 32px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:6px 0 10px}
    h1{font-size:16px;font-weight:700;letter-spacing:.2px;margin:0}
    .explain{color:var(--muted);font-size:13px;margin:6px 0 14px}
    .panel{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0 14px;background:#0e1014}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .label{font-size:12px;font-weight:600;color:#c6cbd6;text-transform:uppercase;letter-spacing:.6px}
    button.chip{border:1px solid var(--line);background:var(--chip);color:var(--fg);padding:8px 11px;border-radius:999px;cursor:pointer}
    button.chip[aria-pressed="true"]{background:var(--chip-on);color:var(--chip-on-fg);border-color:transparent}
    .split{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:10px;padding:12px 14px;background:var(--chip-on);color:#fff;cursor:pointer;font-weight:600}
    .btn.secondary{background:#2a2d34}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--fg)}
    .status{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;}
    .dot.ready{background:var(--accent)} .dot.wait{background:var(--warn)} .dot.err{background:var(--err)}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .small{font-size:12px;color:var(--muted)}
    .inline-input{display:inline-flex;align-items:center;gap:8px}
    input[type="time"],input[type="number"]{background:#0c0e12;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:6px 8px;font-size:13px}
    /* Overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:10px;z-index:9999}
    .sheet{position:relative;background:#0b0c0f;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.6);width:calc(100vw - 20px);height:calc(100vh - 20px);display:flex;flex-direction:column;overflow:hidden}
    .sheet-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    .sheet-title{font-weight:700;font-size:14px}
    .sheet-actions{display:flex;gap:8px}
    .sheet-body{flex:1;position:relative;background:#000}
    .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
    .spinner{width:28px;height:28px;border:3px solid #2a2d34;border-top-color:#8aa2ff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    iframe#render{position:absolute;inset:0;width:100%;height:100%;border:0;background:#fff}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{padding:3px 8px;border:1px solid var(--line);border-radius:999px;color:#c9cdd5;background:#111319;font-size:11px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Predictive Mobility — Situation Chips</h1>
      <div class="status"><span class="dot ready"></span><span id="statusText">Ready</span></div>
    </header>
    <p class="explain">
      Pick the chips that describe your situation. Click <b>Run</b> to ask the model for a tailored mobility UI.
      The model is instructed to return <b>only an HTML document</b> (starts with <span class="mono">&lt;!doctype html&gt;</span>),
      which we render below in a centered overlay.
    </p>


<!-- 1) Mission & Time -->
<section class="panel" data-group="mission">
  <div class="label">Mission &amp; Time</div>
  <div class="row">
    <button class="chip" data-value="arrive-by">Arrive-by</button>
    <button class="chip" data-value="start-at">Start-at</button>
    <button class="chip" data-value="leave-after">Leave-after</button>
    <button class="chip" data-value="commute">Commute</button>
    <button class="chip" data-value="pickup">Pickup</button>
    <button class="chip" data-value="errand">Errand</button>
    <button class="chip" data-value="airport">Airport</button>
    <button class="chip" data-value="exercise">Exercise</button>
    <button class="chip" data-value="scenic">Scenic</button>
  </div>
  <div class="row" style="margin-top:6px;align-items:center;gap:12px">
    <div class="inline-input"><span class="pill">Time</span><input type="time" id="timeValue" /></div>
    <div class="inline-input"><span class="pill">Buffer (min)</span><input id="bufferValue" type="number" min="0" max="60" step="5" placeholder="10" style="width:80px" /></div>
  </div>
</section>

<!-- 2) Assets & Access -->
<section class="panel" data-group="assets">
  <div class="label">Assets &amp; Access</div>
  <div class="row">
    <button class="chip" data-value="car-ready">Car ready</button>
    <button class="chip" data-value="car-low-range">Car low range</button>
    <button class="chip" data-value="find-car">Unknown car location</button>
    <button class="chip" data-value="parking-permit">Parking permit</button>
    <button class="chip" data-value="pt-pass">PT pass</button>
    <button class="chip" data-value="micro-nearby">Micromobility nearby</button>
    <button class="chip" data-value="charger-available">Charger available</button>
    <button class="chip" data-value="payment-ready">Payment ready</button>
  </div>
</section>

<!-- 3) Your Rules & Payload -->
<section class="panel" data-group="rules">
  <div class="label">Your Rules &amp; Payload</div>
  <div class="row">
    <button class="chip" data-value="avoid-tolls">Avoid tolls</button>
    <button class="chip" data-value="step-free">Step-free</button>
    <button class="chip" data-value="flat-only">Flat (bike)</button>
    <button class="chip" data-value="scenic-bias">Scenic bias</button>
    <button class="chip" data-value="budget-cap">Budget cap</button>
    <button class="chip" data-value="with-child">With child</button>
    <button class="chip" data-value="with-pet">With pet</button>
    <button class="chip" data-value="luggage">Luggage</button>
    <button class="chip" data-value="with-bike">Bike with me</button>
    <button class="chip" data-value="business">Business (receipt)</button>
  </div>
  <div class="row" style="margin-top:6px;align-items:center;gap:12px">
    <div class="inline-input"><span class="pill">Max CZK</span><input id="budgetValue" type="number" min="0" step="50" placeholder="—" style="width:100px" /></div>
  </div>
</section>

<!-- 4) Out There Now -->
<section class="panel" data-group="outthere">
  <div class="label">Out There Now</div>
  <div class="row">
    <button class="chip" data-value="traffic-bad">Traffic bad</button>
    <button class="chip" data-value="pt-strike">PT strike</button>
    <button class="chip" data-value="rain">Rain</button>
    <button class="chip" data-value="heat">Heat</button>
    <button class="chip" data-value="snow">Snow</button>
    <button class="chip" data-value="windy">Windy</button>
    <button class="chip" data-value="event-closure">Event/closure</button>
    <button class="chip" data-value="charger-busy">Chargers busy</button>
    <button class="chip" data-value="night-safety">Night safety</button>
  </div>
</section>

<!-- 5) Habits & People -->
<section class="panel" data-group="habits">
  <div class="label">Habits &amp; People</div>
  <div class="row">
    <button class="chip" data-value="routine-commute">Routine commute</button>
    <button class="chip" data-value="school-pickup">School pickup</button>
    <button class="chip" data-value="coffee-along">Coffee stop</button>
    <button class="chip" data-value="groceries-along">Groceries stop</button>
    <button class="chip" data-value="preferred-charger">Preferred charger</button>
    <button class="chip" data-value="social-pickup">Pick up a friend</button>
  </div>
</section>

<div class="footer">
  <div class="small">
    Defaults used silently: Prague • iPhone • Citymove • Drive/PT/Walk/Brompton (flat).
  </div>
  <div class="split">
    <button class="btn ghost" id="btnPreview">Preview prompt</button>
    <button class="btn" id="btnRun">Run</button>
  </div>
</div>

<div class="panel">
  <div class="label">Progress</div>
  <div id="progress" class="small">Waiting to run…</div>
</div>

  </div>


  <!-- Overlay Renderer -->


  <div class="overlay" id="overlay">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Rendered UI">
      <div class="sheet-header">
        <div class="sheet-title">Rendered UI (HTML doc)</div>
        <div class="sheet-actions">
          <button class="btn secondary" id="btnCopy">Copy HTML</button>
          <button class="btn secondary" id="btnDownload">Download</button>
          <button class="btn" id="btnClose">Close</button>
        </div>
      </div>
      <div class="sheet-body">
        <div class="center" id="loading">
          <div>
            <div class="spinner" style="margin:0 auto 12px"></div>
            <div class="small" id="loadMsg">Calling model…</div>
          </div>
        </div>
        <iframe id="render" title="Model Output" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
      </div>
    </div>
  </div>


  <script>
    // ---------- Chip toggles ----------
    document.querySelectorAll('button.chip').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const on = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', on ? 'false' : 'true');
      });
    });

    // ---------- Helpers ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function collectSignals(){
      const groups = {};
      $$('section.panel').forEach(sec=>{
        const g = sec.dataset.group;
        groups[g] = $$('.chip[aria-pressed="true"]', sec).map(b=>b.dataset.value);
      });
      // Inputs
      const t = $('#timeValue')?.value?.trim();
      const buf = $('#bufferValue')?.value?.trim();
      const budget = $('#budgetValue')?.value?.trim();
      const extras = [];
      if (t) extras.push(`time=${t}`);
      if (buf) extras.push(`bufferMin=${buf}`);
      if (budget) extras.push(`budgetCZK=${budget}`);

      return { ...groups, extras };
    }

    // Safe selector within a parent
    function $$(sel, parent){ return Array.from((parent||document).querySelectorAll(sel)); }

    // ---------- Prompt Builder (concise) ----------
    function buildPrompt(signals){
      const known = "defaults: Prague; iPhone; Citymove; modes Drive/PT/Walk/Brompton(flat).";
      const s = [
        `mission:[${(signals.mission||[]).join(',')}]`,
        `assets:[${(signals.assets||[]).join(',')}]`,
        `rules:[${(signals.rules||[]).join(',')}]`,
        `world:[${(signals.outthere||[]).join(',')}]`,
        `habits:[${(signals.habits||[]).join(',')}]`,
        signals.extras?.length?`meta:[${signals.extras.join(',')}]`:""
      ].filter(Boolean).join(' ');

      const rulebookBrief =
        "Follow 5-signal rulebook (Mission&Time, Assets&Access, Rules&Payload, OutThereNow, Habits&People)."+
        " Policy: high→one primary; mid→primary+2 alternates; low→two contrasted cards; very low→neutral chips."+
        " Microcopy: goal first, one-line reason, verb buttons. Use minimal inline CSS/JS; mobile-first; no externals.";

      // Hard output contract
      const contract =
        "OUTPUT: Return ONLY a single HTML5 document. Start with <!doctype html>. "+ 
        "No markdown, no triple backticks, no explanations. Inline CSS/JS only.";

      let prompt = `Task: Design a mobility UI for the selected situation. ${known} Signals: ${s} ${rulebookBrief} ${contract}`;

      // Auto-optimize length
      const MAX = 1400;
      if(prompt.length>MAX){
        const shorterRulebook =
          "Use 5-signal rulebook. Pick minimal components. High→primary; mid→primary+alts; low→dual; very low→neutral chips. Imperative microcopy.";
        prompt = `Task: Mobility UI. ${known} Signals: ${s} ${shorterRulebook} ${contract}`;
      }
      return prompt;
    }

    // ---------- Pollinations Call ----------
    const ENDPOINT = "https://text.pollinations.ai/";

    async function callModel(prompt){
      // Prefer Chat-style JSON; many Pollinations deployments accept this shape.
      try{
        const res = await fetch(ENDPOINT, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            messages: [
              { role:"system", content:"You are a UI generator." },
              { role:"user", content: prompt }
            ],
            temperature: 0.2
          })
        });
        const text = await res.text();
        return text;
      }catch(e){
        // Fallback GET
        const url = ENDPOINT + "?messages=" + encodeURIComponent(prompt);
        const res = await fetch(url);
        return await res.text();
      }
    }

    function extractHtmlDoc(raw){
      // Extract from the first <!doctype html
      const i = raw.toLowerCase().indexOf("<!doctype html");
      if(i>=0) return raw.slice(i);
      return null;
    }

    // ---------- UI wiring ----------
    const btnRun = $('#btnRun');
    const btnPreview = $('#btnPreview');
    const overlay = $('#overlay');
    const iframe = $('#render');
    const loading = $('#loading');
    const statusText = $('#statusText');
    const progress = $('#progress');
    const loadMsg = $('#loadMsg');
    const btnClose = $('#btnClose');
    const btnCopy = $('#btnCopy');
    const btnDownload = $('#btnDownload');

    btnPreview.addEventListener('click', ()=>{
      const sig = collectSignals();
      const prompt = buildPrompt(sig);
      alert(`Prompt (${prompt.length} chars):\n\n`+prompt);
    });

    btnRun.addEventListener('click', async ()=>{
      const sig = collectSignals();
      const prompt = buildPrompt(sig);

      statusText.textContent = "Running…";
      progress.textContent = "Building prompt and calling model…";
      overlay.style.display = "flex";
      iframe.removeAttribute('srcdoc');
      loading.style.display = "flex";
      loadMsg.textContent = "Calling model…";

      let raw="";
      try{
        raw = await callModel(prompt);
      }catch(e){
        loading.style.display="flex";
        loadMsg.textContent = "Network error.";
        statusText.textContent = "Error";
        return;
      }

      progress.textContent = `Response received (${raw.length} chars). Validating…`;
      const html = extractHtmlDoc(raw);

      if(!html){
        loading.style.display="flex";
        loadMsg.innerHTML = "The response did not start with <span class='mono'>&lt;!doctype html&gt;</span>.";
        statusText.textContent = "Error";
        statusText.previousElementSibling.className = "dot err";
        return;
      }

      // Render
      iframe.setAttribute('srcdoc', html);
      loading.style.display = "none";
      statusText.textContent = "Ready";
      statusText.previousElementSibling.className = "dot ready";
      progress.textContent = "Rendered successfully. Use Copy or Download to export the HTML document.";
      // Stash for copy/download
      iframe.dataset.lastHtml = html;
    });

    btnClose.addEventListener('click', ()=>{
      overlay.style.display = "none";
    });

    btnCopy.addEventListener('click', async ()=>{
      const html = iframe.dataset.lastHtml || "";
      if(!html){ return alert("Nothing to copy yet."); }
      try{
        await navigator.clipboard.writeText(html);
        alert("HTML copied to clipboard.");
      }catch{ alert("Clipboard failed."); }
    });

    btnDownload.addEventListener('click', ()=>{
      const html = iframe.dataset.lastHtml || "";
      if(!html){ return alert("Nothing to download yet."); }
      const blob = new Blob([html], {type:"text/html"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "rendered-ui.html";
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    });

    // Ensure overlay remains perfectly centered with 10px margins (handled by CSS).
    // Optional: open overlay when URL has ?auto
    if(location.search.includes("auto")) overlay.style.display="flex";
  </script>


</body>
</html>
