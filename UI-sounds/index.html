<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>UI Sounds — iPhone‑Ready</title>
<style>
  :root{{--bg:#0b0d10;--ink:#e7eef6;--muted:#94a6bb;--card:#0f1318;--line:#1b2330;--accent:#7df6cb}}
  *{{box-sizing:border-box}} html,body{{height:100%}} body{{margin:0;font:15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;background:var(--bg);color:var(--ink)}}
  header{{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:12px}}
  h1{{margin:0;font-size:16px}}
  .row{{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}}
  .card{{border:1px solid var(--line);background:#0f1318;border-radius:10px;padding:12px;margin:12px}}
  .grid{{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px}}
  button.sound{{padding:12px;border-radius:10px;border:1px solid var(--line);background:#121822;color:var(--ink);cursor:pointer}}
  button.sound:active{{transform:scale(.98)}}
  .ok{{color:var(--accent)}}
  .overlay{{position:fixed;inset:0;background:rgba(7,9,12,.9);display:flex;align-items:center;justify-content:center;z-index:1000}}
  .panel{{background:#0f1318;border:1px solid var(--line);border-radius:12px;padding:20px;max-width:420px;text-align:center}}
  .hint{{color:var(--muted);font-size:13px;margin-top:8px}}
  input[type="range"]{{width:220px}}
  .small{{font-size:12px;color:var(--muted)}}
</style>
</head>
<body>
  <div id="unlock" class="overlay">
    <div class="panel">
      <h2 style="margin:0 0 6px">Tap to enable sound</h2>
      <div class="hint">Required by iOS Safari for audio playback.</div>
      <div style="margin-top:14px">
        <button id="unlockBtn" class="sound">Enable</button>
      </div>
    </div>
  </div>

  <header>
    <h1>UI Sounds — iPhone‑Ready</h1>
    <div class="row">
      <label class="small">Volume <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9"></label>
      <label class="small"><input id="cut" type="checkbox" checked> Cut previous</label>
      <span id="status" class="small">Loading…</span>
    </div>
  </header>

  <main class="card">
    <div class="grid" id="grid"></div>
    <div class="row" style="margin-top:16px">
      <button id="seq" class="sound">Play quick sequence</button>
      <button id="stopAll" class="sound">Stop All</button>
    </div>
    <p class="small" style="margin-top:10px">Put your WAVs into <code>./sounds/</code>. Filenames must be <code>clip_001.wav</code>, <code>clip_002.wav</code>, …</p>
  </main>

<script>
// ===== Config =====
const FILES = ["clip_001.wav", "clip_002.wav", "clip_003.wav", "clip_004.wav", "clip_005.wav", "clip_006.wav", "clip_007.wav", "clip_008.wav", "clip_009.wav", "clip_010.wav", "clip_011.wav", "clip_012.wav"]; // served from ./sounds/
const FADE_MS = 8;          // small fade to avoid clicks
const MAX_POLYPHONY = 16;   // limit concurrent voices

// ===== Audio engine (Web Audio) =====
let ctx, masterGain;
let buffers = new Map();
let voices = new Set();
let unlocked = false;
let ready = false;

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const statusEl = $("#status");
const volEl = $("#vol");
const cutEl = $("#cut");

function dbug(msg){{ statusEl.textContent = msg; }}

function createCtx() {{
  if (!ctx || ctx.state === "closed") {{
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = ctx.createGain();
    masterGain.gain.value = parseFloat(volEl.value);
    masterGain.connect(ctx.destination);
  }}
}}

function setVolume() {{
  if (masterGain) masterGain.gain.setTargetAtTime(parseFloat(volEl.value), ctx.currentTime, 0.01);
}}

volEl.addEventListener("input", setVolume);

async function unlockAudio() {{
  if (unlocked) return;
  createCtx();
  await ctx.resume();
  unlocked = true;
  $("#unlock").style.display = "none";
  loadAll().catch(e => dbug("Load error"));
}}

$("#unlockBtn").addEventListener("click", unlockAudio);
window.addEventListener("pointerdown", unlockAudio, {{ once:true }});

async function loadAll() {{
  dbug("Loading " + FILES.length + " clips…");
  const t0 = performance.now();
  for (let i=0;i<FILES.length;i++) {{
    const url = "sounds/" + FILES[i];
    try {{
      const res = await fetch(url);
      const arr = await res.arrayBuffer();
      const buf = await ctx.decodeAudioData(arr);
      buffers.set(FILES[i], buf);
      dbug(`Loaded ${{i+1}}/${{FILES.length}}`);
    }} catch (e) {{
      console.error("Failed to load", url, e);
    }}
  }}
  ready = true;
  dbug("Ready");
  statusEl.classList.add("ok");
}}

function makeButton(file, idx) {{
  const b = document.createElement("button");
  b.className = "sound";
  b.textContent = (idx+1).toString().padStart(2,"0");
  b.title = file;
  b.addEventListener("pointerdown", (e)=>{{ play(file); }});
  return b;
}}

function renderGrid() {{
  const grid = $("#grid");
  FILES.forEach((f,i)=> grid.appendChild(makeButton(f,i)));
}}

function now() {{ return ctx.currentTime; }}

function fadeInOut(g, start, durMs) {{
  const t = start;
  const d = durMs/1000;
  const A = Math.max(FADE_MS, 1)/1000;
  g.gain.cancelScheduledValues(t);
  g.gain.setValueAtTime(0.0, t);
  g.gain.linearRampToValueAtTime(parseFloat(volEl.value), t + A);
  g.gain.setValueAtTime(parseFloat(volEl.value), t + d - A);
  g.gain.linearRampToValueAtTime(0.0, t + d);
}}

function stopAll() {{
  voices.forEach(v => {{ try {{ v.src.stop(); }} catch(_ ){{}} v.src.disconnect(); v.g.disconnect(); }});
  voices.clear();
}}

$("#stopAll").addEventListener("click", stopAll);

function play(file) {{
  if (!ready) return;
  if (voices.size >= MAX_POLYPHONY) {{
    const oldest = voices.values().next().value;
    try {{ oldest.src.stop(); }} catch(_ ){{}}
    oldest.src.disconnect(); oldest.g.disconnect(); voices.delete(oldest);
  }}
  const buf = buffers.get(file);
  if (!buf) return;

  if (cutEl.checked) {{
    for (const v of Array.from(voices)) {{
      if (v.file === file) {{ try {{ v.src.stop(); }} catch(_ ){{}} v.src.disconnect(); v.g.disconnect(); voices.delete(v); }}
    }}
  }}

  const src = ctx.createBufferSource();
  src.buffer = buf;
  const g = ctx.createGain();
  src.connect(g).connect(masterGain);

  const startTime = now();
  fadeInOut(g, startTime, buf.duration*1000);
  src.start(startTime);
  const voice = {{file, src, g}};
  voices.add(voice);

  src.onended = () => {{ try {{ src.disconnect(); g.disconnect(); }} catch(_ ){{}} voices.delete(voice); }};
}}

async function playSequence() {{
  if (!ready) return;
  let t = 0;
  for (const f of FILES) {{
    setTimeout(()=>play(f), t);
    t += 120;
  }}
}}

$("#seq").addEventListener("click", playSequence);
renderGrid();

document.addEventListener("visibilitychange", () => {{
  if (!ctx) return;
  if (document.hidden) ctx.suspend().catch(()=>{{}}); else ctx.resume().catch(()=>{{}});
}});
</script>
</body>
</html>
