<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0d10">
<title>UI Sounds — /sounds/ clip_001…</title>
<style>
  :root{--bg:#0b0d10;--ink:#e7eef6;--muted:#9ab0c6;--card:#0f1318;--line:#1b2330;--accent:#79f5cc;--accent2:#3bd4ff;--warn:#ff6b6b;--glow:0 8px 18px rgba(0,0,0,.45),0 0 0 1px #1b2330 inset,0 0 22px rgba(61,225,255,.18)}
  *{box-sizing:border-box}
  html,body{height:100%;background:#0b0d10;color:var(--ink);color-scheme:dark}
  body{margin:0;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:radial-gradient(1200px 800px at 10% 0%,#10202b 0%,#0b0d10 40%,#0b0d10 100%);-webkit-tap-highlight-color:transparent}
  header{position:sticky;top:0;background:rgba(15,19,24,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);padding:12px;z-index:10}
  h1{margin:0 0 6px;font-size:18px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:8px 12px;border-radius:999px;background:#111823}
  input[type="range"]{width:220px}
  .small{font-size:12px;color:var(--muted)}
  .card{border:1px solid var(--line);background:rgba(15,19,24,.9);border-radius:14px;padding:12px;margin:12px;box-shadow:var(--glow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}

  /* Tile: two distinct touch zones (play + remove) without enlarging overall tile */
  .tile{
    display:grid;
    grid-template-columns: 1fr 56px; /* distinct remove zone, >=44px touch */
    grid-template-rows: 48px auto;
    gap:8px 8px;
    padding:10px;
    border:1px solid var(--line);
    border-radius:14px;
    background:linear-gradient(180deg,#111823,#0f1318);
    box-shadow:var(--glow);
    position:relative;
    transition:border-color .15s ease, background .15s ease, transform .2s ease, opacity .2s ease;
  }
  .tile.confirm-remove{ border-color:var(--warn); animation:shake .18s linear 1; }
  @keyframes shake{ 0%,100%{transform:translateX(0)} 25%{transform:translateX(-2px)} 75%{transform:translateX(2px)} }

  button.play{
    grid-column:1/2; grid-row:1/2;
    border:1px solid var(--line);
    border-radius:12px;
    background:linear-gradient(180deg,#14202b,#0f1318);
    color:var(--ink); font-weight:600;
    display:flex; align-items:center; justify-content:center; gap:8px;
    cursor:pointer; user-select:none; touch-action:manipulation;
    transition:transform .06s, box-shadow .18s;
  }
  button.play:active, button.play.pressed{transform:scale(.97); box-shadow:0 0 0 1px #2ad0ff inset,0 0 30px rgba(58,208,255,.35)}

  /* Tall, clear remove zone */
  button.remove{
    grid-column:2/3; grid-row:1/3;
    border:1px solid var(--line);
    border-radius:12px;
    background:linear-gradient(180deg,#1a1d23,#151a22);
    color:#e9b2b2; font-weight:700;
    cursor:pointer; touch-action:manipulation; user-select:none;
    display:flex; align-items:center; justify-content:center; text-align:center; padding:0 6px;
    transition:transform .06s, background .15s, box-shadow .18s, border-color .15s;
  }
  button.remove:active{transform:scale(.97)}
  .tile.confirm-remove button.remove{
    background:linear-gradient(180deg,#3a1114,#2a0c0e);
    border-color:var(--warn); color:#ffdede;
  }
  .fname{grid-column:1/2; grid-row:2/3; font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  .meter{height:10px;background:#0f1722;border:1px solid var(--line);border-radius:8px;overflow:hidden;min-width:180px}
  .fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
  .ok{color:var(--accent)}

  /* Mini toast */
  .toast{
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
    background:#111823; border:1px solid var(--line); color:var(--ink);
    padding:10px 14px; border-radius:10px; box-shadow:var(--glow);
    opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease; z-index:1000;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }
</style>
</head>
<body>
  <header>
    <h1>UI Sounds — /sounds/</h1>
    <div class="row">
      <span class="pill"><span>Volume</span> <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9"></span>
      <label class="pill"><input id="cut" type="checkbox" checked> Cut previous</label>
      <span id="status" class="small">Scanning…</span>
      <span class="pill"><span>Shown</span> <strong id="shown">0</strong>/<strong id="found">0</strong></span>
      <div class="meter"><div class="fill" id="meter"></div></div>
    </div>
  </header>

  <main class="card">
    <div class="grid" id="grid"></div>
    <div class="row" style="margin-top:12px">
      <button id="seq" class="play" style="min-width:180px">▶️ Quick playthrough</button>
      <button id="stopAll" class="play" style="min-width:120px">⏹️ Stop All</button>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== Config: ONLY clip_001.wav..; stop at first gap ===== */
const DIR="sounds/"; const START=1; const PAD=3; const PREFIX="clip_"; const SUFFIX=".wav";

/* ===== Shorthands ===== */
const $=s=>document.querySelector(s);
const grid=$("#grid"), statusEl=$("#status"), shownEl=$("#shown"), foundEl=$("#found"),
      volEl=$("#vol"), cutEl=$("#cut"), meter=$("#meter"), toast=$("#toast");
document.body.addEventListener("touchstart",()=>{}, {passive:true}); // enable :active on iOS
const setStatus=(m,ok=false)=>{ statusEl.textContent=m; statusEl.classList.toggle("ok",ok); };
const showToast=(msg)=>{ toast.textContent=msg; toast.classList.add("show"); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove("show"), 1200); };

/* ===== Audio (unlock on first tap) ===== */
let ctx, masterGain, unlocked=false, buffers=new Map(), voices=new Set();
function createCtx(){ if(!ctx||ctx.state==="closed"){ ctx=new (window.AudioContext||window.webkitAudioContext)(); masterGain=ctx.createGain(); masterGain.gain.value=parseFloat(volEl.value); masterGain.connect(ctx.destination);} }
async function ensureUnlocked(){ if(unlocked){ if(ctx?.state!=="running") await ctx.resume(); return; } createCtx(); try{ const silent=ctx.createBuffer(1,1,ctx.sampleRate); const src=ctx.createBufferSource(); src.buffer=silent; src.connect(masterGain); src.start(0); src.stop(0); await ctx.resume(); unlocked=true; }catch{} }
volEl.addEventListener("input",()=>{ if(masterGain) masterGain.gain.setTargetAtTime(parseFloat(volEl.value), ctx.currentTime, .01); });

/* ===== Discovery ===== */
async function exists(name){
  try{ const r=await fetch(DIR+name,{cache:"no-store",headers:{"Range":"bytes=0-0"}}); return r.ok; }
  catch{ return false; }
}
async function discover(){
  setStatus("Scanning /sounds/…");
  const out=[];
  for(let i=START;;i++){
    const name=`${PREFIX}${String(i).padStart(PAD,"0")}${SUFFIX}`;
    if(!(await exists(name))) break; // STOP at first gap
    out.push(name);
  }
  foundEl.textContent=out.length;
  setStatus(out.length?`Found ${out.length}`:"No files found", !!out.length);
  return out;
}

/* ===== State ===== */
let allFiles=[];    // discovered
let activeFiles=[]; // shown / used by quick playthrough
const tiles = new Map(); // filename -> element

function updateCount(){ shownEl.textContent=String(activeFiles.length); }

/* ===== FLIP helpers for layout animation ===== */
function capturePositions(){
  const pos = new Map();
  grid.querySelectorAll(".tile").forEach(el=>{
    pos.set(el, el.getBoundingClientRect());
  });
  return pos;
}
function animateReflow(before){
  const els = grid.querySelectorAll(".tile");
  els.forEach(el=>{
    const first = before.get(el);
    if(!first) return;
    const last = el.getBoundingClientRect();
    const dx = first.left - last.left;
    const dy = first.top - last.top;
    if(dx || dy){
      el.style.transform = `translate(${dx}px, ${dy}px)`;
      el.style.transition = "transform .22s ease";
      requestAnimationFrame(()=>{ el.style.transform = ""; });
      el.addEventListener("transitionend", ()=>{ el.style.transition=""; }, {once:true});
    }
  });
}

/* ===== UI + Loading ===== */
function addPress(el){
  const on=()=>{ el.classList.add("pressed"); try{navigator.vibrate&&navigator.vibrate(8);}catch{} };
  const off=()=> el.classList.remove("pressed");
  ["pointerdown","touchstart","mousedown"].forEach(ev=>el.addEventListener(ev,on,{passive:true}));
  ["pointerup","pointercancel","touchend","touchcancel","mouseleave","mouseup","blur"].forEach(ev=>el.addEventListener(ev,off));
}

function stopVoicesByFile(name){
  for(const v of Array.from(voices)){ if(v.name===name){ try{v.src.stop()}catch{} v.src.disconnect(); v.g.disconnect(); voices.delete(v);} }
}

function makeTile(name){
  const t=document.createElement("div"); t.className="tile"; t.dataset.file=name;

  const play=document.createElement("button");
  play.className="play"; play.type="button"; play.innerHTML="▶️ Play";
  addPress(play);
  play.addEventListener("pointerdown", async(e)=>{
    e.stopPropagation();
    await ensureUnlocked();
    if(!buffers.has(name)) await loadOne(name);
    playSound(name, play);
  });

  const remove=document.createElement("button");
  remove.className="remove"; remove.type="button"; remove.setAttribute("aria-label","Hide");
  remove.innerHTML="✖︎<br>Hide";
  let confirmTimer=null;
  remove.addEventListener("click",(e)=>{
    e.stopPropagation();
    if(t.classList.contains("confirm-remove")){
      clearTimeout(confirmTimer); confirmTimer=null;
      performRemove(name, t);
    }else{
      t.classList.add("confirm-remove");
      remove.innerHTML="Confirm<br>✖︎";
      confirmTimer=setTimeout(()=>{
        t.classList.remove("confirm-remove");
        remove.innerHTML="✖︎<br>Hide";
      }, 1500);
    }
  });

  const label=document.createElement("div");
  label.className="fname"; label.textContent=name;

  t.appendChild(play);
  t.appendChild(remove);
  t.appendChild(label);
  tiles.set(name, t);
  return t;
}

function renderAll(){
  grid.innerHTML="";
  const before = capturePositions();
  activeFiles.forEach(n=> grid.appendChild(tiles.get(n) || makeTile(n)));
  updateCount();
  requestAnimationFrame(()=> animateReflow(before));
}

/* Removal with FLIP + fade/scale */
function performRemove(name, tile){
  const before = capturePositions();
  // visual feedback on the tile being removed
  tile.style.transition = "opacity .18s ease, transform .22s ease";
  tile.style.opacity = "0";
  tile.style.transform = "scale(.94)";
  stopVoicesByFile(name);

  // after the fade, update model + DOM and FLIP others
  setTimeout(()=>{
    // update model
    activeFiles = activeFiles.filter(f=>f!==name);
    // remove DOM
    if(tile.parentNode) tile.parentNode.removeChild(tile);
    tiles.delete(name);
    updateCount();
    // animate grid reflow
    animateReflow(before);
    showToast(`Removed ${name}`);
  }, 180);
}

/* ===== Loading ===== */
async function loadAll(files){
  setStatus(`Loading 0/${files.length}…`);
  for(let i=0;i<files.length;i++){
    try{
      const arr=await (await fetch(DIR+files[i],{cache:"no-store"})).arrayBuffer();
      if(!ctx) createCtx(); // DO NOT resume here
      const buf=await ctx.decodeAudioData(arr);
      buffers.set(files[i], buf);
      meter.style.width=Math.round(((i+1)/files.length)*100)+"%";
      setStatus(`Loading ${i+1}/${files.length}…`, i+1===files.length);
    }catch{ setStatus("Decode error "+files[i]); }
  }
  setStatus("Ready",true);
}
async function loadOne(name){
  try{
    const arr=await (await fetch(DIR+name,{cache:"no-store"})).arrayBuffer();
    if(!ctx) createCtx();
    buffers.set(name, await ctx.decodeAudioData(arr));
  }catch{}
}

/* ===== Playback ===== */
const FADE_MS=8, MAX_POLYPHONY=16;
function now(){ return ctx.currentTime; }
function fadeInOut(g,start,durMs){
  const t=start, d=durMs/1000, A=Math.max(FADE_MS,1)/1000;
  g.gain.cancelScheduledValues(t);
  g.gain.setValueAtTime(0.0, t);
  g.gain.linearRampToValueAtTime(parseFloat(volEl.value), t + A);
  g.gain.setValueAtTime(parseFloat(volEl.value), t + d - A);
  g.gain.linearRampToValueAtTime(0.0, t + d);
}
function stopAll(){ voices.forEach(v=>{ try{v.src.stop()}catch{} v.src.disconnect(); v.g.disconnect(); }); voices.clear(); }
document.getElementById("stopAll").addEventListener("click", stopAll);

function playSound(name,btn){
  if(!buffers.has(name)) return;
  if(voices.size>=MAX_POLYPHONY){ const v=voices.values().next().value; try{v.src.stop()}catch{} v.src.disconnect(); v.g.disconnect(); voices.delete(v); }
  const buf=buffers.get(name); if(!buf) return;
  if(cutEl.checked){ stopVoicesByFile(name); }
  const src=ctx.createBufferSource(), g=ctx.createGain();
  src.buffer=buf; src.connect(g).connect(masterGain);
  const t=now(); fadeInOut(g,t,buf.duration*1000); src.start(t);
  const voice={name,src,g,btn}; voices.add(voice); btn&&btn.classList.add("pressed");
  src.onended=()=>{ try{src.disconnect(); g.disconnect();}catch{} voices.delete(voice); btn&&btn.classList.remove("pressed"); };
}

/* ===== Quick Playthrough ===== */
document.getElementById("seq").addEventListener("pointerdown", async e=>{
  const b=e.currentTarget; b.classList.add("pressed");
  await ensureUnlocked();
  let t=0; const btns=[...document.querySelectorAll(".tile > .play")];
  for(let i=0;i<activeFiles.length;i++){
    const f=activeFiles[i];
    if(!buffers.has(f)) await loadOne(f);
    const bb=btns[i];
    setTimeout(()=>playSound(f,bb), t);
    t+=120;
  }
  setTimeout(()=>b.classList.remove("pressed"),220);
});

/* ===== Boot ===== */
(async()=>{
  allFiles = await discover();           // clip_001, clip_002, … stop on first miss
  activeFiles = allFiles.slice();        // start with all; user can hide
  if(activeFiles.length){
    renderAll();                         // show UI
    loadAll(activeFiles);                // preload in background (no await)
  }
})();
document.addEventListener("visibilitychange",()=>{ if(!ctx) return; if(document.hidden) ctx.suspend().catch(()=>{}); else ctx.resume().catch(()=>{}); });
</script>
</body>
</html>