<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Minute Timer — Overrun + Flash + Mute</title>
<style>
  :root{ --bg:#000; --ink:#fff; --alert:#ff0000; }
  html,body{ height:100%; }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    display:flex; align-items:center; justify-content:center;
    -webkit-font-smoothing: antialiased;
    touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    -webkit-user-select:none; user-select:none;
  }
  .wrap{ width:min(720px,92vw); display:grid; gap:18px; text-align:center; }
  .screen{
    font-size: clamp(56px, 14vw, 140px);
    line-height:1; letter-spacing:.04em; font-variant-numeric: tabular-nums;
  }
  .screen.overrun{ color:var(--alert); }
  .sub{ font-size:clamp(14px,3.5vw,18px); opacity:.75; min-height:1.2em; }

  .row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
  button{
    cursor:pointer; font:inherit; color:currentColor; background:transparent;
    border:2px solid currentColor; padding:12px 18px; border-radius:14px; min-width:84px;
  }
  button.icon{ display:inline-flex; align-items:center; gap:10px; min-width:auto; padding:10px 12px; }
  button:disabled{ opacity:.45; cursor:not-allowed; }
  button:active{ transform:translateY(1px); }

  /* Flash: hard toggle white ⇄ black, no color transition */
  body.alarm{ animation:bgflash .6s steps(2, start) infinite; }
  @keyframes bgflash{
    0%   { background:#000; }
    50%  { background:#fff; }
    100% { background:#000; }
  }
  @media (prefers-reduced-motion: reduce){ body.alarm{ animation:none; } }

  /* SVG sizing */
  .icon svg{ width:20px; height:20px; display:block; }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Countdown timer">
    <div class="screen" id="screen" aria-live="polite">00:00</div>
    <div class="sub" id="status">Set minutes with − / +, then Start.</div>
    <div class="row">
      <button id="minus">−1 min</button>
      <button id="plus">+1 min</button>
      <button id="start">Start</button>
      <button id="reset">Reset</button>
      <button id="mute" class="icon" aria-pressed="false" aria-label="Mute alarm" title="Mute alarm">
        <span id="muteIcon">
          <!-- Speaker ON -->
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9v6h4l5 4V5L7 9H3z"/><path d="M16.5 12a4.5 4.5 0 0 0-3-4.243v8.486A4.5 4.5 0 0 0 16.5 12z"/></svg>
        </span>
      </button>
    </div>
  </div>

<script>
(() => {
  const screen = document.getElementById('screen');
  const status = document.getElementById('status');
  const btnMinus = document.getElementById('minus');
  const btnPlus  = document.getElementById('plus');
  const btnStart = document.getElementById('start');
  const btnReset = document.getElementById('reset');
  const btnMute  = document.getElementById('mute');
  const muteIcon = document.getElementById('muteIcon');

  let totalSeconds = 0;     // configured time
  let remaining = 0;        // current countdown (can go negative)
  let ticker = null;        // timer handle
  let running = false;

  // Alarm state
  let alarming = false;     // flashing/sounding active
  let muted = false;
  let beepTimer = null;
  let actx = null, masterGain = null;

  function ensureAudioCtx(){
    if(!actx){
      actx = new (window.AudioContext||window.webkitAudioContext)();
      masterGain = actx.createGain();
      masterGain.gain.value = 0.2; // base volume
      masterGain.connect(actx.destination);
    } else if(actx.state === 'suspended'){
      actx.resume().catch(()=>{});
    }
  }

  function playBeep(){
    if(muted || !actx) return;
    const now = actx.currentTime;
    const osc = actx.createOscillator();
    const gain = actx.createGain();

    // Simple two-tone chirp (beep-beep) in ~300ms
    osc.type = 'square';
    osc.frequency.setValueAtTime(880, now);
    osc.frequency.setValueAtTime(660, now + 0.15);

    gain.gain.setValueAtTime(0.0, now);
    gain.gain.linearRampToValueAtTime(1.0, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.08, now + 0.28);
    gain.gain.setValueAtTime(0.0, now + 0.3);

    osc.connect(gain); gain.connect(masterGain);
    osc.start(now); osc.stop(now + 0.32);
  }

  function startBeeping(){
    stopBeeping(); // clear any previous
    ensureAudioCtx();
    const loop = () => {
      if(!alarming) return;
      playBeep();
      beepTimer = setTimeout(loop, 1000); // beep every second while alarming
    };
    loop();
  }
  function stopBeeping(){
    clearTimeout(beepTimer); beepTimer = null;
  }

  function fmt(sec){
    const sign = sec < 0 ? "-" : "";
    const asec = Math.abs(sec);
    const m = Math.floor(asec / 60);
    const s = asec % 60;
    return `${sign}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  function updateUI(){
    screen.textContent = fmt(remaining);
    btnStart.disabled = running || remaining === 0 && totalSeconds === 0;
    btnMinus.disabled = running || totalSeconds === 0;
    btnPlus.disabled  = running || totalSeconds >= 60*600; // cap 10h
  }

  function setMinutes(delta){
    if(running) return;
    stopAlarmVisuals(); // clear any previous alarm visuals when adjusting
    totalSeconds = Math.max(0, Math.min(60*600, totalSeconds + delta*60));
    remaining = totalSeconds;
    screen.classList.toggle('overrun', remaining < 0);
    status.textContent = totalSeconds ? "Ready." : "Set minutes with − / +, then Start.";
    updateUI();
  }

  function start(){
    if(running || (remaining <= 0 && totalSeconds === 0)) return;
    ensureAudioCtx();
    running = true;
    status.textContent = "Counting…";
    updateUI();

    // Ticking aligned to wall clock seconds
    let next = Date.now() + 1000;
    ticker = setTimeout(tick, Math.max(0, next - Date.now()));

    function tick(){
      if(!running) return;
      remaining = remaining - 1;

      // At zero: enter alarm mode, keep running into negatives.
      if(remaining === 0){
        // show 00:00 once before overrun
        screen.textContent = fmt(remaining);
        enterAlarm();
      }
      // After zero: overrun (negative), keep screen red.
      if(remaining <= 0){
        screen.classList.add('overrun');
      }

      screen.textContent = fmt(remaining);

      next += 1000;
      ticker = setTimeout(tick, Math.max(0, next - Date.now()));
    }
  }

  function enterAlarm(){
    alarming = true;
    document.body.classList.add('alarm');  // hard white/black flash
    startBeeping();
    status.textContent = "Time’s up. (Click anywhere to stop flashing.)";
  }

  function stopAlarmVisuals(){
    // Stop flashing + sound, but keep overrun red if timer < 0
    if(alarming){
      alarming = false;
      document.body.classList.remove('alarm');
      stopBeeping();
      status.textContent = remaining < 0 ? "Overrun." : "Ready.";
    }
  }

  function reset(){
    clearTimeout(ticker); ticker = null; running = false;
    stopAlarmVisuals();
    totalSeconds = 0; remaining = 0;
    screen.classList.remove('overrun');
    updateUI();
    status.textContent = "Set minutes with − / +, then Start.";
  }

  // --- Events
  btnMinus.addEventListener('click', () => setMinutes(-1));
  btnPlus .addEventListener('click', () => setMinutes(+1));
  btnStart.addEventListener('click', start);
  btnReset.addEventListener('click', reset);

  // Mute toggle
  btnMute.addEventListener('click', () => {
    muted = !muted;
    btnMute.setAttribute('aria-pressed', String(!muted)); // pressed = sound on
    btnMute.title = muted ? "Unmute alarm" : "Mute alarm";
    btnMute.setAttribute('aria-label', btnMute.title);

    // Swap icon
    muteIcon.innerHTML = muted
      // Speaker OFF (cross)
      ? `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9v6h4l5 4V5L7 9H3z"/><path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`
      // Speaker ON
      : `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9v6h4l5 4V5L7 9H3z"/><path d="M16.5 12a4.5 4.5 0 0 0-3-4.243v8.486A4.5 4.5 0 0 0 16.5 12z"/></svg>`;
  });

  // Stop flashing on ANY click/tap anywhere
  document.addEventListener('pointerdown', () => { stopAlarmVisuals(); }, {passive:true});

  // Keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowUp') setMinutes(+1);
    if(e.key === 'ArrowDown') setMinutes(-1);
    if(e.key === 'Enter' || e.key === ' ') { if(!running) start(); }
    if(e.key.toLowerCase() === 'r') reset();
    if(e.key.toLowerCase() === 'm') btnMute.click();
  });

  // Initial paint
  remaining = totalSeconds;
  updateUI();
})();
</script>
</body>
</html>
