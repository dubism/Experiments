<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Live Camera Palette — Stable Freeze + Immediate Palettes</title>
<style>
  :root{
    --bg:#000; --ink:#fff; --muted:#bdbdbd; --line:#222; --zoom:1;
    --sq:0px; --cbH:0px;
    --ctaW:clamp(220px,60vw,340px); --ctaH:56px;
    --ctaB:calc(16px + env(safe-area-inset-bottom));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  /* hard lock the page — no scroll, no rubberband */
  html,body{
    margin:0;background:#000;color:#fff;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    user-select:none; overflow:hidden; overscroll-behavior:none; touch-action:none;
  }

  .app{position:fixed; inset:0; display:grid; isolation:isolate; overscroll-behavior:none;}
  @media (orientation: portrait){
    .app{ grid-template-rows: var(--sq) 1fr; grid-template-columns: 1fr; }
    #videoPane{ grid-row:1; grid-column:1; } #uiPane{ grid-row:2; grid-column:1; }
  }
  @media (orientation: landscape){
    .app{ grid-template-columns: var(--sq) 1fr; grid-template-rows: 1fr; }
    #videoPane{ grid-column:1; grid-row:1; } #uiPane{ grid-column:2; grid-row:1; }
  }

  #videoPane{ position:relative; overflow:hidden; background:#000; z-index:1; transform:translateZ(0); }
  #videoPane video, #videoPane canvas{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:cover; transform:scale(var(--zoom)); transform-origin:center; display:block;
  }
  /* Hide iOS inline start button */
  #video::-webkit-media-controls-start-playback-button{ display:none !important; }
  #frozenCanvas{display:none}

  #uiPane{
    position:relative; min-width:0; min-height:0; display:flex; flex-direction:column; gap:10px;
    padding:10px 12px 12px;
    padding-bottom: calc(12px + var(--ctaH) + env(safe-area-inset-bottom));
    background:#000; z-index:2; contain:paint;
  }

  #palettePane{ display:flex; flex-direction:column; gap:10px; min-height:0; flex:1;
    border-bottom:1px solid var(--line); padding-bottom:10px; background:#000; }
  .title{display:flex;align-items:center;justify-content:space-between;color:#9aa0a6}
  .stack{
    position:relative;display:flex;flex-direction:column;gap:10px;min-height:0;flex:1;cursor:pointer;
    /* block browser scrolling while dragging here */
    touch-action:none; -webkit-touch-callout:none;
  }
  .swatches,.gradient{border:1px solid var(--line);border-radius:14px;overflow:hidden;min-height:60px;background:#000}
  .swatches{display:flex} .swatch{flex:1} .gradient{display:block}
  #openHint{display:none}

  #controlsBar{ border-top:1px solid var(--line); background:#000; padding:10px 0 0; margin-top:auto; }
  #bar{display:grid;grid-template-columns:1fr;grid-template-rows:auto;gap:10px}
  .zoomArea{grid-row:1}
  .zoomWrap{display:flex;align-items:center;gap:12px;width:100%}
  .zbtn{flex:none;width:42px;height:42px;aspect-ratio:1/1;border-radius:50%;border:1px solid var(--line);background:#121212;color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  input[type="range"].zoom{appearance:none;-webkit-appearance:none;width:100%;height:16px;border-radius:999px;background:#1a1a1a;outline:none}
  input[type="range"].zoom::-webkit-slider-thumb{appearance:none;-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:#fff;border:none;cursor:pointer;margin-top:-6px}
  input[type="range"].zoom::-webkit-slider-runnable-track{height:16px;border-radius:999px;background:#2b2b2b}
  input[type="range"].zoom::-moz-range-thumb{width:28px;height:28px;border:none;border-radius:50%;background:#fff;cursor:pointer}
  input[type="range"].zoom::-moz-range-track{height:16px;border-radius:999px;background:#2b2b2b}
  .btn{padding:12px 18px;border:1px solid var(--line);border-radius:12px;background:#0d0d0d;color:#fff;cursor:pointer}
  .btn.cta{background:#fff;color:#000;font-weight:900;border-color:#fff;font-size:18px}

  /* Fixed CTAs */
  #freezeBtn,#unfreezeBtn{
    position:fixed; left:50%; transform:translateX(-50%) translateZ(0);
    bottom:var(--ctaB); width:var(--ctaW); z-index:5000;
  }

  /* Control Center — overlay (below freeze overlay) */
  #ccWrap{
    position:fixed;
    inset: max(12px, env(safe-area-inset-top))
           max(12px, env(safe-area-inset-right))
           calc(var(--ctaH) + env(safe-area-inset-bottom) + 12px)
           max(12px, env(safe-area-inset-left));
    z-index:9000;
    transform:translateZ(0); will-change:transform;
    display:none;
  }
  #cc{
    background:rgba(0,0,0,.65);
    backdrop-filter:blur(10px);
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
    max-height:100%;
    overflow:auto; overscroll-behavior:contain; /* scroll only here; don’t bubble */
    -webkit-touch-callout:none; /* still scrolls because overflow:auto */
    opacity:0; transform:scale(.96) translateY(8px);
  }
  /* Open animation + bounce */
  #ccWrap.open #cc{ animation: ccBounceIn 360ms cubic-bezier(.2,.8,.2,1) forwards; }
  @keyframes ccBounceIn{
    0%{opacity:0;transform:scale(.96) translateY(8px)}
    60%{opacity:1;transform:scale(1.015) translateY(0)}
    100%{opacity:1;transform:scale(1) translateY(0)}
  }
  @media (prefers-reduced-motion:reduce){
    #ccWrap.open #cc{ animation:none; opacity:1; transform:none; }
  }

  /* disable selection inside CC except inputs */
  #cc, #cc *{ -webkit-user-select:none; user-select:none; }
  #cc input, #cc textarea, #cc select{ -webkit-user-select:auto; user-select:auto; }

  .small{font-variant-numeric:tabular-nums;color:#9aa0a6}
  #algoBrief{ margin:10px 4px 14px; line-height:1.45; }
  #algoBrief .a{ margin:8px 0 12px; opacity:.85; }
  #algoBrief .a.active{ opacity:1; font-weight:600; }
  .ccsep{ border:0; border-top:1px solid var(--line); opacity:.6; margin:6px 0 10px 0; }

  /* Long-press guards */
  .pressLock, .pressLock *{ -webkit-user-select:none !important; user-select:none !important; -webkit-touch-callout:none !important; }
  #pressShield{
    position:fixed; inset:0; z-index:9500;
    background:transparent; display:none; touch-action:none; pointer-events:auto;
  }

  /* Tiny inline error toast */
  #camError{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:calc(var(--ctaB) + 64px); background:rgba(255,80,80,.12);
    color:#ffbdbd; border:1px solid #492; border-color:#ff5a5a33;
    padding:8px 12px; border-radius:10px; font-size:12px; display:none; z-index:8000;
    backdrop-filter:blur(8px);
  }

  #compositeOverlay{position:fixed;inset:0;background:#000;z-index:10000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:14px}
  #compositeOverlay.open{display:flex}
  #compositeCanvas{display:none}
  #compositeImg{max-width:min(1024px,92vw);max-height:70vh;border-radius:12px;background:#000}
  .smallhint{font-size:12px;color:#9aa0a6;margin-top:6px;text-align:center;user-select:none}
</style>
</head>
<body>
  <div class="app">
    <section id="videoPane" aria-label="Camera">
      <video id="video" playsinline muted autoplay></video>
      <canvas id="frozenCanvas"></canvas>
    </section>

    <section id="uiPane" aria-label="UI">
      <div id="palettePane">
        <div class="title">
          <div id="algoName" class="small">K-Means (LAB)</div>
          <div class="small">FPS <span id="fps">0</span> · <span id="res">–</span> · <span id="status">Starting…</span></div>
        </div>
        <div class="stack" id="paletteClickable" title="Tap left/right to switch · long-press for controls · drag to change K">
          <div id="swatches" class="swatches"></div>
          <div id="gradient" class="gradient" hidden></div>
          <div id="openHint" aria-hidden="true"></div>
        </div>
      </div>

      <section id="controlsBar">
        <div id="bar">
          <div class="zoomArea">
            <div class="zoomWrap">
              <button class="zbtn" id="zoomMinus" type="button" aria-label="Zoom out">−</button>
              <input type="range" id="zoom" class="zoom" min="1" max="10" step="0.01" value="1">
              <button class="zbtn" id="zoomPlus" type="button" aria-label="Zoom in">+</button>
            </div>
          </div>
          <button class="btn cta" id="freezeBtn" type="button">FREEZE</button>
        </div>
      </section>
    </section>
  </div>

  <!-- CC overlay -->
  <div id="ccWrap" aria-modal="true" role="dialog">
    <div id="cc">
      <section id="algoBrief" class="small"></section>
      <hr class="ccsep">
      <div class="field"><div class="field-head"><span class="label">Colors (K)</span><span class="value" id="kVal">3</span></div><div class="field-body"><input type="range" id="k" min="2" max="10" value="3"></div><div class="divider"></div></div>
      <div class="field"><div class="field-head"><span class="label">Show rectangles</span><input type="checkbox" id="rects" checked></div><div class="divider"></div></div>
      <div class="field"><div class="field-head"><span class="label">Show gradient</span><input type="checkbox" id="grad" checked></div><div class="divider"></div></div>
      <div class="field"><div class="field-head"><span class="label">Processing width</span><span class="value" id="sizeVal">240 px</span></div><div class="field-body"><input type="range" id="size" min="120" max="360" step="20" value="240"></div><div class="divider"></div></div>
      <div class="field"><div class="field-head"><span class="label">Process every N frames</span><span class="value" id="throttleVal">20</span></div><div class="field-body"><input type="range" id="throttleLog" min="0" max="100" value="0"></div><div class="divider"></div></div>
    </div>
  </div>

  <!-- press shield + small error toast -->
  <div id="pressShield"></div>
  <div id="camError" role="status"></div>

  <div id="compositeOverlay">
    <canvas id="compositeCanvas"></canvas>
    <img id="compositeImg" alt="Composite preview"/>
    <div id="lpHint" class="smallhint">Long-press the image to save.</div>
    <button class="btn cta" id="unfreezeBtn" type="button">UNFREEZE</button>
  </div>

  <canvas id="off"></canvas>
  <canvas id="capFrame"></canvas>

<script>
/* ===== guards ===== */
(function(){
  window.addEventListener('error', e=>{
    try{
      const box=document.getElementById('camError');
      box.textContent = 'Script error: ' + (e.message||'unknown');
      box.style.display='block';
    }catch{}
  }, {once:true});
})();

/* ===== square sizing ===== */
(function(){
  function recalcSquare(){
    const vv = window.visualViewport;
    const vw = Math.max(0, window.innerWidth);
    const vh = Math.max(0, (vv?.height ?? window.innerHeight));
    const isLandscape = vw > vh;
    const sq = isLandscape ? vh : Math.min(vw, vh);
    document.documentElement.style.setProperty('--sq', Math.round(sq) + 'px');

    const fc = document.getElementById('frozenCanvas');
    if (fc && fc.style.display !== 'none') {
      const wrap = document.getElementById('videoPane');
      fc.width = wrap.clientWidth;
      fc.height = wrap.clientHeight;
    }
  }
  window.recalcSquare = recalcSquare;
  let raf = 0;
  const kick = () => { cancelAnimationFrame(raf); raf = requestAnimationFrame(recalcSquare); };
  addEventListener('load', kick,{passive:true});
  addEventListener('resize', kick,{passive:true});
  addEventListener('orientationchange', kick,{passive:true});
  window.visualViewport && window.visualViewport.addEventListener('resize', kick,{passive:true});
})();

/* ===== measure CTA ===== */
const controlsBar = document.getElementById('controlsBar');
function updateCbH(){ const h = Math.round(controlsBar.getBoundingClientRect().height); document.documentElement.style.setProperty('--cbH', h + 'px'); }
new ResizeObserver(updateCbH).observe(controlsBar);
addEventListener('load', updateCbH);

/* ===== worker ===== */
const workerBlob = new Blob([`/* worker code unchanged for brevity */`], {type:'application/javascript'});
const worker = new Worker(URL.createObjectURL(workerBlob), {type:'module'});
worker.addEventListener('error', e=>console.log('Worker error:', e.message));

/* ===== elements ===== */
const video=document.getElementById('video');
const frozenCanvas=document.getElementById('frozenCanvas');
const off=document.getElementById('off');
const capFrame=document.getElementById('capFrame');
const statusEl=document.getElementById('status');
const fpsEl=document.getElementById('fps');
const resEl=document.getElementById('res');
const swatchesEl=document.getElementById('swatches');
const gradientEl=document.getElementById('gradient');
const paletteClickable=document.getElementById('paletteClickable');
const kRange=document.getElementById('k'); const kVal=document.getElementById('kVal');
const sizeRange=document.getElementById('size'); const sizeVal=document.getElementById('sizeVal');
const throttleLog=document.getElementById('throttleLog'); const throttleVal=document.getElementById('throttleVal');
const rectChk=document.getElementById('rects'); const gradChk=document.getElementById('grad');
const zoomSlider=document.getElementById('zoom'); const zoomMinus=document.getElementById('zoomMinus'); const zoomPlus=document.getElementById('zoomPlus');
const freezeBtn=document.getElementById('freezeBtn');
const compositeOverlay=document.getElementById('compositeOverlay');
const compositeCanvas=document.getElementById('compositeCanvas');
const compositeImg=document.getElementById('compositeImg');
const unfreezeBtn=document.getElementById('unfreezeBtn');
const ccWrap=document.getElementById('ccWrap');
const algoNameEl=document.getElementById('algoName');
const lpHint=document.getElementById('lpHint');
const pressShield=document.getElementById('pressShield');
const camError=document.getElementById('camError');

/* ===== state ===== */
let algo='kmeans', K=+kRange.value, procWidth=+sizeRange.value, throttleN=20, uiZoom=+zoomSlider.value;
let frameCounter=0,lastT=performance.now(),pending=false, running=false;
let throttleCountdown=1; let lastPalette=[]; let ccOpen=false, pressLock=false; let rafStarted=false;
/* global drag guard to block page scroll while dragging K */
let draggingK=false;

/* ===== helpers ===== */
const TH_MIN=1, TH_MAX=150;
const sliderToN=v=>Math.max(TH_MIN,Math.min(TH_MAX,Math.round(TH_MIN*Math.exp((v/100)*Math.log(TH_MAX/TH_MIN)))));
const toHex=([r,g,b])=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
const status=t=>{ try{statusEl.textContent=t;}catch{} };
function toast(msg){ if(!msg) return; camError.textContent=msg; camError.style.display='block'; setTimeout(()=>camError.style.display='none', 4000); }

/* ===== algo switching ===== */
const ALGOS=['kmeans','hist','mediancut'];
const ALGO_LABEL={kmeans:'K-Means (LAB)',hist:'Histogram',mediancut:'Median-cut'};
const ALGO_COPY={
  kmeans:'K-Means (LAB): groups similar colors in human-perceived space. Good general capture of what the eye notices.',
  hist:'Histogram: picks colors that appear most often. Best when large areas are flat fills or the “ink load” matters.',
  mediancut:'Median-cut: slices the color range to cover it evenly. Useful when you want a balanced spread across tones.'
};
function setAlgo(next){ algo=next; algoNameEl.textContent=ALGO_LABEL[algo]; highlightAlgoDesc(algo); }
function cycleAlgo(dir){ const i=ALGOS.indexOf(algo); setAlgo(ALGOS[(i+(dir>0?1:-1)+ALGOS.length)%ALGOS.length]); }
function renderAlgoBrief(){ document.getElementById('algoBrief').innerHTML =
  `<div class="a" data-a="kmeans">${ALGO_COPY.kmeans}</div>
   <div class="a" data-a="hist">${ALGO_COPY.hist}</div>
   <div class="a" data-a="mediancut">${ALGO_COPY.mediancut}</div>`; }
function highlightAlgoDesc(a){ document.querySelectorAll('#algoBrief .a').forEach(n=>n.classList.toggle('active',n.dataset.a===a)); }

/* ===== selection guards ===== */
function lockPressSelection(){ if(pressLock) return; pressLock=true; document.body.classList.add('pressLock'); }
function unlockPressSelection(){ if(!pressLock) return; pressLock=false; document.body.classList.remove('pressLock'); const s=window.getSelection?.(); try{ s && s.removeAllRanges(); }catch{} }
document.addEventListener('selectstart',(e)=>{ if(pressLock) e.preventDefault(); },{capture:true});
document.addEventListener('selectionchange',()=>{ if(pressLock){ const s=window.getSelection?.(); try{ s && s.removeAllRanges(); }catch{} }});
document.addEventListener('contextmenu',(e)=>{ if(ccOpen||pressLock) e.preventDefault(); },{capture:true});

/* ===== CC open/close ===== */
function openCC(){ ccWrap.style.display='block'; ccWrap.classList.add('open'); ccOpen=true; }
function closeCC(){ ccWrap.style.display='none'; ccWrap.classList.remove('open'); ccOpen=false; }

/* ===== press shield helpers ===== */
function showPressShieldWithAutoRelease(){
  pressShield.style.display='block';
  const release=()=>{ hidePressShield(); document.removeEventListener('pointerup',release,true); document.removeEventListener('touchend',release,true); document.removeEventListener('mouseup',release,true); };
  document.addEventListener('pointerup',release,true);
  document.addEventListener('touchend',release,true);
  document.addEventListener('mouseup',release,true);
  clearTimeout(showPressShieldWithAutoRelease._t);
  showPressShieldWithAutoRelease._t=setTimeout(hidePressShield,1200);
}
function hidePressShield(){ pressShield.style.display='none'; clearTimeout(showPressShieldWithAutoRelease._t); }

/* ===== K-drag + gestures ===== */
let lpTimer=0,movedTooFar=false,longPressed=false,activePointerId=null;
const LP_MS=450,MOVE_TOL=10;
/* step size by height (~6 notches), clamped */
function getKStepPx(){
  const h = paletteClickable.clientHeight || 200;
  return Math.max(16, Math.min(64, Math.round(h / 6)));
}

paletteClickable.addEventListener('pointerdown', (e)=>{
  if(e.pointerType==='mouse' && e.button!==0) return;

  movedTooFar=false; longPressed=false; activePointerId=e.pointerId;
  const startX=e.clientX, startY=e.clientY;
  let lastX=startX, lastY=startY;

  // K-drag state
  let kDrag=false;
  let kAccum=0;
  const stepPx=getKStepPx();
  let ax=0, ay=-1, dirSign=+1; // axis + direction sign

  paletteClickable.setPointerCapture(e.pointerId);
  lockPressSelection();

  clearTimeout(lpTimer);
  lpTimer=setTimeout(()=>{
    if(movedTooFar || kDrag) return;
    longPressed=true;
    try{paletteClickable.releasePointerCapture(activePointerId);}catch{}
    openCC(); showPressShieldWithAutoRelease();
  }, LP_MS);

  const move=(ev)=>{
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;

    // Decide to enter K-drag (allow diagonal, but still mostly vertical)
    if(!kDrag){
      if(Math.abs(dx) > MOVE_TOL || Math.abs(dy) > MOVE_TOL){
        movedTooFar = true;
        clearTimeout(lpTimer);
      }
      // vertical-ish with relaxed dominance (0.9) to allow diagonals
      if(Math.abs(dy) > MOVE_TOL && Math.abs(dy) > Math.abs(dx) * 0.9){
        const len = Math.hypot(dx, dy) || 1;
        ax = dx / len; ay = dy / len;
        dirSign = (dy < 0) ? +1 : -1; // initial direction defines K++/K--
        kDrag = true; draggingK = true;
      }
    }

    if(kDrag){
      // Project delta onto the locked axis for smooth continuous steps
      const dpx = ev.clientX - lastX;
      const dpy = ev.clientY - lastY;
      const proj = dpx*ax + dpy*ay;
      kAccum += proj * dirSign;

      let steps = 0;
      if(kAccum >= stepPx) steps = Math.floor(kAccum / stepPx);
      else if(kAccum <= -stepPx) steps = Math.ceil(kAccum / stepPx);

      if(steps){
        const newK = Math.max(2, Math.min(10, (+kRange.value) + steps));
        if(newK !== +kRange.value){
          kRange.value = String(newK);
          kRange.dispatchEvent(new Event('input', {bubbles:true}));
        }
        kAccum -= steps * stepPx;
      }

      // prevent page scroll while dragging
      if(ev.cancelable) ev.preventDefault();
    }

    lastX = ev.clientX;
    lastY = ev.clientY;
  };

  const finish=(ev)=>{
    try{paletteClickable.releasePointerCapture(e.pointerId);}catch{}
    paletteClickable.removeEventListener('pointermove',move);
    paletteClickable.removeEventListener('pointerup',finish);
    paletteClickable.removeEventListener('pointercancel',cancel);
    clearTimeout(lpTimer); hidePressShield();

    if(!longPressed && !kDrag && !movedTooFar){
      const r=paletteClickable.getBoundingClientRect();
      const isLeft=(ev.clientX-r.left)<(r.width/2); cycleAlgo(isLeft?-1:+1);
    }
    draggingK=false;
    unlockPressSelection();
  };

  const cancel=()=>{
    clearTimeout(lpTimer); hidePressShield(); unlockPressSelection();
    try{paletteClickable.releasePointerCapture(e.pointerId);}catch{}
    paletteClickable.removeEventListener('pointermove',move);
    paletteClickable.removeEventListener('pointerup',finish);
    paletteClickable.removeEventListener('pointercancel',cancel);
    draggingK=false;
  };

  paletteClickable.addEventListener('pointermove',move);
  paletteClickable.addEventListener('pointerup',finish,{once:true});
  paletteClickable.addEventListener('pointercancel',cancel,{once:true});
});

/* also block wheel scrolling on the palette area (desktop/laptop) */
paletteClickable.addEventListener('wheel', (e)=>{ e.preventDefault(); }, {passive:false});

/* prevent global touchmove scrolling only while K-drag is active */
document.addEventListener('touchmove', (e)=>{
  if(draggingK && e.cancelable) e.preventDefault();
}, {passive:false});

['pointerdown','pointerup','click','touchstart','touchend','mousedown','mouseup','wheel'].forEach(evt=>{
  pressShield.addEventListener(evt,(e)=>{ e.stopPropagation(); e.preventDefault(); },{capture:true});
});
document.addEventListener('click',e=>{
  if(compositeOverlay.classList.contains('open')) return;
  if(ccWrap.style.display==='block' && !ccWrap.contains(e.target) && !paletteClickable.contains(e.target)) closeCC();
});
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'&&ccWrap.style.display==='block') closeCC(); });

/* ===== controls ===== */
kRange.addEventListener('input',()=>{K=+kRange.value;kVal.textContent=K;renderPalette(lastPalette);});
sizeRange.addEventListener('input',()=>{procWidth=+sizeRange.value;sizeVal.textContent=procWidth+' px';});
throttleLog.addEventListener('input',()=>{throttleN=sliderToN(+throttleLog.value);throttleVal.textContent=String(throttleN);});
rectChk.addEventListener('change',()=>renderPalette(lastPalette));
gradChk.addEventListener('change',()=>renderPalette(lastPalette));
function setZoom(v){ uiZoom=Math.max(1,Math.min(10,v)); zoomSlider.value=uiZoom; document.documentElement.style.setProperty('--zoom',uiZoom); }
zoomSlider.addEventListener('input',()=>setZoom(+zoomSlider.value));
zoomMinus.addEventListener('click',()=>setZoom(+zoomSlider.value-0.25));
zoomPlus .addEventListener('click',()=>setZoom(+zoomSlider.value+0.25));

/* ===== crop ===== */
function computeSquareCrop(){
  const vw=video.videoWidth||0, vh=video.videoHeight||0; if(!vw||!vh) return {sx:0,sy:0,sw:0,sh:0};
  const z=Math.max(1,uiZoom), base=Math.min(vw,vh), sw=Math.round(base/z), sh=sw,
        sx=Math.floor((vw-sw)/2), sy=Math.floor((vh-sh)/2);
  return {sx,sy,sw,sh};
}

/* ===== worker handler / loop / render etc. — unchanged from your last version ===== */

/* =========================================================================
   ROBUST CAMERA STARTER + AUTO-RECOVERY (unchanged)
   ========================================================================= */

/* ===== freeze / unfreeze wiring ===== */
freezeBtn.addEventListener('click', freezeNow);
unfreezeBtn.addEventListener('click', unfreeze);
</script>
</body>
</html>