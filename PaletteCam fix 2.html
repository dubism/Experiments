<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Live Camera Palette — Stable Freeze + Immediate Palettes</title>
<style>
  :root{
    --bg:#000; --ink:#fff; --muted:#bdbdbd; --line:#222; --zoom:1;
    --sq:0px; --cbH:0px;
    --ctaW:clamp(220px,60vw,340px); --ctaH:56px;
    --ctaB:calc(16px + env(safe-area-inset-bottom));
  }
  *{box-sizing:border-box}
  html,body{height:100dvh}
  html,body{
    margin:0;background:#000;color:#fff;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    user-select:none; overflow:hidden; overscroll-behavior:none; touch-action:none;
    -webkit-text-size-adjust:100%;
  }

  .app{position:fixed; inset:0; display:grid; isolation:isolate; overscroll-behavior:none;}
  @media (orientation: portrait){
    .app{ grid-template-rows: var(--sq) 1fr; grid-template-columns: 1fr; }
    #videoPane{ grid-row:1; grid-column:1; } #uiPane{ grid-row:2; grid-column:1; }
  }
  @media (orientation: landscape){
    .app{ grid-template-columns: var(--sq) 1fr; grid-template-rows: 1fr; }
    #videoPane{ grid-column:1; grid-row:1; } #uiPane{ grid-column:2; grid-row:1; }
  }

  #videoPane{
    position:relative; overflow:hidden; background:#000; z-index:1;
    contain:layout paint size; clip-path: inset(0);
    -webkit-user-drag:none;
  }
  #videoPane video, #videoPane canvas{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:cover; transform:scale(var(--zoom)); transform-origin:center; display:block;
    backface-visibility:hidden; will-change:transform;
    -webkit-user-drag:none; pointer-events:none;
  }
  #video::-webkit-media-controls-start-playback-button{ display:none !important; }
  #frozenCanvas{display:none}

  #uiPane{
    position:relative; min-width:0; min-height:0; display:flex; flex-direction:column; gap:10px;
    padding:10px 12px 12px;
    padding-bottom: calc(12px + var(--ctaH) + env(safe-area-inset-bottom));
    background:#000; z-index:2; contain:paint;
  }

  #palettePane{ display:flex; flex-direction:column; gap:10px; min-height:0; flex:1;
    border-bottom:1px solid var(--line); padding-bottom:10px; background:#000; }
  .title{display:flex;align-items:center;justify-content:space-between;color:#9aa0a6}
  .stack{
    position:relative;display:flex;flex-direction:column;gap:10px;min-height:0;flex:1;cursor:pointer;
    touch-action:none; -webkit-touch-callout:none; -webkit-user-drag:none;
  }
  .swatches,.gradient{border:1px solid var(--line);border-radius:14px;overflow:hidden;min-height:60px;background:#000}
  .swatches{display:flex} .swatch{flex:1} .gradient{display:block}
  #openHint{display:none}

  #controlsBar{ border-top:1px solid var(--line); background:#000; padding:10px 0 0; margin-top:auto; }
  #bar{display:grid;grid-template-columns:1fr;grid-template-rows:auto;gap:10px}
  .zoomArea{grid-row:1}
  .zoomWrap{display:flex;align-items:center;gap:12px;width:100%}
  .zbtn{flex:none;width:42px;height:42px;aspect-ratio:1/1;border-radius:50%;border:1px solid var(--line);background:#121212;color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  input[type="range"].zoom{appearance:none;-webkit-appearance:none;width:100%;height:16px;border-radius:999px;background:#1a1a1a;outline:none}
  input[type="range"].zoom::-webkit-slider-thumb{appearance:none;-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:#fff;border:none;cursor:pointer;margin-top:-6px}
  input[type="range"].zoom::-webkit-slider-runnable-track{height:16px;border-radius:999px;background:#2b2b2b}
  input[type="range"].zoom::-moz-range-thumb{width:28px;height:28px;border:none;border-radius:50%;background:#fff;cursor:pointer}
  input[type="range"].zoom::-moz-range-track{height:16px;border-radius:999px;background:#2b2b2b}
  .btn{padding:12px 18px;border:1px solid var(--line);border-radius:12px;background:#0d0d0d;color:#fff;cursor:pointer}
  .btn.cta{background:#fff;color:#000;font-weight:900;border-color:#fff;font-size:18px}

  #freezeBtn,#unfreezeBtn{
    position:fixed; left:50%; transform:translateX(-50%) translateZ(0);
    bottom:var(--ctaB); width:var(--ctaW); z-index:5000;
  }

  #ccWrap{
    position:fixed;
    inset: max(12px, env(safe-area-inset-top))
           max(12px, env(safe-area-inset-right))
           calc(var(--ctaH) + env(safe-area-inset-bottom) + 12px)
           max(12px, env(safe-area-inset-left));
    z-index:9000;
    transform:translateZ(0); will-change:transform;
    display:none;
  }
  #cc{
    background:rgba(0,0,0,.65);
    backdrop-filter:blur(10px);
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
    max-height:100%;
    overflow:auto; overscroll-behavior:contain;
    -webkit-touch-callout:none;
    opacity:0; transform:scale(.96) translateY(8px);
  }
  #ccWrap.open #cc{ animation: ccBounceIn 360ms cubic-bezier(.2,.8,.2,1) forwards; }
  @keyframes ccBounceIn{
    0%{opacity:0;transform:scale(.96) translateY(8px)}
    60%{opacity:1;transform:scale(1.015) translateY(0)}
    100%{opacity:1;transform:scale(1) translateY(0)}
  }
  @media (prefers-reduced-motion:reduce){
    #ccWrap.open #cc{ animation:none; opacity:1; transform:none; }
  }

  #cc, #cc *{ -webkit-user-select:none; user-select:none; }
  #cc input, #cc textarea, #cc select{ -webkit-user-select:auto; user-select:auto; }

  .small{font-variant-numeric:tabular-nums;color:#9aa0a6}
  #algoBrief{ margin:10px 4px 14px; line-height:1.45; }
  #algoBrief .a{ margin:8px 0 12px; opacity:.85; }
  #algoBrief .a.active{ opacity:1; font-weight:600; }
  .ccsep{ border:0; border-top:1px solid var(--line); opacity:.6; margin:6px 0 10px 0; }

  .pressLock, .pressLock *{ -webkit-user-select:none !important; user-select:none !important; -webkit-touch-callout:none !important; }
  #pressShield{
    position:fixed; inset:0; z-index:9500;
    background:transparent; display:none; touch-action:none; pointer-events:auto;
  }

  #camError{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:calc(var(--ctaB) + 64px); background:rgba(255,80,80,.12);
    color:#ffbdbd; border:1px solid #492; border-color:#ff5a5a33;
    padding:8px 12px; border-radius:10px; font-size:12px; display:none; z-index:8000;
    backdrop-filter:blur(8px);
  }

  #compositeOverlay{position:fixed;inset:0;background:#000;z-index:10000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:14px}
  #compositeOverlay.open{display:flex}
  #compositeCanvas{display:none}
  #compositeImg{max-width:min(1024px,92vw);max-height:70vh;border-radius:12px;background:#000}
  .smallhint{font-size:12px;color:#9aa0a6;margin-top:6px;text-align:center;user-select:none}

  #off,#capFrame{ display:none !important; width:0 !important; height:0 !important; }
</style>
</head>
<body>
  <div class="app">
    <section id="videoPane" aria-label="Camera">
      <video id="video" playsinline muted autoplay></video>
      <canvas id="frozenCanvas"></canvas>
    </section>

    <section id="uiPane" aria-label="UI">
      <div id="palettePane">
        <div class="title">
          <div id="algoName" class="small">K-Means (LAB)</div>
          <div class="small">FPS <span id="fps">0</span> · <span id="res">–</span> · <span id="status">Starting…</span></div>
        </div>
        <div class="stack" id="paletteClickable" title="Tap left/right to switch · long-press for controls · drag to change K" draggable="false">
          <div id="swatches" class="swatches"></div>
          <div id="gradient" class="gradient" hidden></div>
          <div id="openHint" aria-hidden="true"></div>
        </div>
      </div>

      <section id="controlsBar">
        <div id="bar">
          <div class="zoomArea">
            <div class="zoomWrap">
              <button class="zbtn" id="zoomMinus" type="button" aria-label="Zoom out">−</button>
              <input type="range" id="zoom" class="zoom" min="1" max="10" step="0.01" value="1">
              <button class="zbtn" id="zoomPlus" type="button" aria-label="Zoom in">+</button>
            </div>
          </div>
          <button class="btn cta" id="freezeBtn" type="button">FREEZE</button>
        </div>
      </section>
    </section>
  </div>

  <div id="ccWrap" aria-modal="true" role="dialog">
    <div id="cc">
      <section id="algoBrief" class="small"></section>
      <hr class="ccsep">
      <div class="field"><div class="field-head"><span class="label">Colors (K)</span><span class="value" id="kVal">3</span></div><div class="field-body"><input type="range" id="k" min="2" max="10" value="3"></div><div class="divider"></div></div>
      <div class="field"><div class="field-head"><span class="label">Show rectangles</span><input type="checkbox" id="rects" checked></div><div class="divider"></div></div>
      <div class="field"><div class="field-head"><span class="label">Show gradient</span><input type="checkbox" id="grad" checked></div><div class="divider"></div></div>
      <div class="field"><div class="field-head"><span class="label">Processing width</span><span class="value" id="sizeVal">240 px</span></div><div class="field-body"><input type="range" id="size" min="120" max="360" step="20" value="240"></div><div class="divider"></div></div>
      <div class="field"><div class="field-head"><span class="label">Process every N frames</span><span class="value" id="throttleVal">20</span></div><div class="field-body"><input type="range" id="throttleLog" min="0" max="100" value="0"></div><div class="divider"></div></div>
    </div>
  </div>

  <div id="pressShield"></div>
  <div id="camError" role="status"></div>

  <div id="compositeOverlay">
    <canvas id="compositeCanvas"></canvas>
    <img id="compositeImg" alt="Composite preview"/>
    <div id="lpHint" class="smallhint">Long-press the image to save.</div>
    <button class="btn cta" id="unfreezeBtn" type="button">UNFREEZE</button>
  </div>

  <canvas id="off"></canvas>
  <canvas id="capFrame"></canvas>

<script>
/* ===== error toast ===== */
(function(){
  window.addEventListener('error', e=>{
    try{
      const box=document.getElementById('camError');
      box.textContent = 'Script error: ' + (e.message||'unknown');
      box.style.display='block';
    }catch{}
  }, {once:true});
})();

/* ===== square sizing ===== */
(function(){
  function recalcSquare(){
    const vv = window.visualViewport;
    const vw = Math.max(0, window.innerWidth);
    const vh = Math.max(0, (vv?.height ?? window.innerHeight));
    const isLandscape = vw > vh;
    const sq = isLandscape ? vh : Math.min(vw, vh);
    document.documentElement.style.setProperty('--sq', Math.round(sq) + 'px');

    const fc = document.getElementById('frozenCanvas');
    if (fc && fc.style.display !== 'none') {
      const wrap = document.getElementById('videoPane');
      fc.width = wrap.clientWidth;
      fc.height = wrap.clientHeight;
    }
  }
  window.recalcSquare = recalcSquare;
  let raf = 0;
  const kick = () => { cancelAnimationFrame(raf); raf = requestAnimationFrame(recalcSquare); };
  addEventListener('load', kick,{passive:true});
  addEventListener('resize', kick,{passive:true});
  addEventListener('orientationchange', kick,{passive:true});
  window.visualViewport && window.visualViewport.addEventListener('resize', kick,{passive:true});
})();

/* ===== measure CTA ===== */
const controlsBar = document.getElementById('controlsBar');
function updateCbH(){ const h = Math.round(controlsBar.getBoundingClientRect().height); document.documentElement.style.setProperty('--cbH', h + 'px'); }
new ResizeObserver(updateCbH).observe(controlsBar);
addEventListener('load', updateCbH);

/* ===== elements ===== */
const video=document.getElementById('video');
const frozenCanvas=document.getElementById('frozenCanvas');
const statusEl=document.getElementById('status');
const fpsEl=document.getElementById('fps');
const resEl=document.getElementById('res');
const swatchesEl=document.getElementById('swatches');
const gradientEl=document.getElementById('gradient');
const paletteClickable=document.getElementById('paletteClickable');
const kRange=document.getElementById('k'); const kVal=document.getElementById('kVal');
const sizeRange=document.getElementById('size'); const sizeVal=document.getElementById('sizeVal');
const throttleLog=document.getElementById('throttleLog'); const throttleVal=document.getElementById('throttleVal');
const rectChk=document.getElementById('rects'); const gradChk=document.getElementById('grad');
const zoomSlider=document.getElementById('zoom'); const zoomMinus=document.getElementById('zoomMinus'); const zoomPlus=document.getElementById('zoomPlus');
const freezeBtn=document.getElementById('freezeBtn');
const compositeOverlay=document.getElementById('compositeOverlay');
const compositeCanvas=document.getElementById('compositeCanvas');
const compositeImg=document.getElementById('compositeImg');
const unfreezeBtn=document.getElementById('unfreezeBtn');
const ccWrap=document.getElementById('ccWrap');
const algoNameEl=document.getElementById('algoName');
const lpHint=document.getElementById('lpHint');
const pressShield=document.getElementById('pressShield');
const camError=document.getElementById('camError');
const off=document.getElementById('off');

/* ===== state ===== */
let algo='kmeans', K=+kRange.value, procWidth=+sizeRange.value, uiZoom=+zoomSlider.value;
let throttleN=20, frameCounter=0, lastT=performance.now(), fps=0;
let ccOpen=false, pressLock=false, draggingK=false;
let lastPalette=[];

/* ===== helpers ===== */
const TH_MIN=1, TH_MAX=150;
const sliderToN=v=>Math.max(TH_MIN,Math.min(TH_MAX,Math.round(TH_MIN*Math.exp((v/100)*Math.log(TH_MAX/TH_MIN)))));
const toHex=([r,g,b])=>'#'+[r,g,b].map(v=>Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0')).join('');
const status=t=>{ try{statusEl.textContent=t;}catch{} };
function toast(msg){ if(!msg) return; camError.textContent=msg; camError.style.display='block'; setTimeout(()=>camError.style.display='none', 4000); }

/* ===== algo labels (we compute kmeans for all for now) ===== */
const ALGOS=['kmeans','hist','mediancut'];
const ALGO_LABEL={kmeans:'K-Means (LAB)',hist:'Histogram',mediancut:'Median-cut'};
const ALGO_COPY={
  kmeans:'K-Means (RGB-approx): general capture of dominant hues.',
  hist:'Histogram (approx via k-means): favors frequently occurring colors.',
  mediancut:'Median-cut (approx via k-means): balanced spread.'
};
function setAlgo(next){ algo=next; algoNameEl.textContent=ALGO_LABEL[algo]; highlightAlgoDesc(algo); }
function cycleAlgo(dir){ const i=ALGOS.indexOf(algo); setAlgo(ALGOS[(i+(dir>0?1:-1)+ALGOS.length)%ALGOS.length]); }
function renderAlgoBrief(){ document.getElementById('algoBrief').innerHTML =
  `<div class="a" data-a="kmeans">${ALGO_COPY.kmeans}</div>
   <div class="a" data-a="hist">${ALGO_COPY.hist}</div>
   <div class="a" data-a="mediancut">${ALGO_COPY.mediancut}</div>`; }
function highlightAlgoDesc(a){ document.querySelectorAll('#algoBrief .a').forEach(n=>n.classList.toggle('active',n.dataset.a===a)); }

/* ===== selection guards ===== */
function lockPressSelection(){ if(pressLock) return; pressLock=true; document.body.classList.add('pressLock'); }
function unlockPressSelection(){ if(!pressLock) return; pressLock=false; document.body.classList.remove('pressLock'); const s=window.getSelection?.(); try{ s && s.removeAllRanges(); }catch{} }
document.addEventListener('selectstart',(e)=>{ if(pressLock) e.preventDefault(); },{capture:true});
document.addEventListener('selectionchange',()=>{ if(pressLock){ const s=window.getSelection?.(); try{ s && s.removeAllRanges(); }catch{} }});
document.addEventListener('contextmenu',(e)=>{ if(ccOpen||pressLock) e.preventDefault(); },{capture:true});

/* ===== CC open/close ===== */
function openCC(){ ccWrap.style.display='block'; ccWrap.classList.add('open'); ccOpen=true; }
function closeCC(){ ccWrap.style.display='none'; ccWrap.classList.remove('open'); ccOpen=false; }

/* ===== press shield helpers ===== */
function showPressShieldWithAutoRelease(){
  pressShield.style.display='block';
  const release=()=>{ hidePressShield(); document.removeEventListener('pointerup',release,true); document.removeEventListener('touchend',release,true); document.removeEventListener('mouseup',release,true); };
  document.addEventListener('pointerup',release,true);
  document.addEventListener('touchend',release,true);
  document.addEventListener('mouseup',release,true);
  clearTimeout(showPressShieldWithAutoRelease._t);
  showPressShieldWithAutoRelease._t=setTimeout(hidePressShield,1200);
}
function hidePressShield(){ pressShield.style.display='none'; clearTimeout(showPressShieldWithAutoRelease._t); }

/* ===== global scroll lock during K-drag ===== */
function noScroll(e){ if(e.cancelable) e.preventDefault(); }
function lockScroll(){ document.addEventListener('touchmove', noScroll, {passive:false, capture:true}); document.addEventListener('wheel', noScroll, {passive:false, capture:true}); }
function unlockScroll(){ document.removeEventListener('touchmove', noScroll, {capture:true}); document.removeEventListener('wheel', noScroll, {capture:true}); }

/* ===== K-drag + gestures ===== */
let lpTimer=0,movedTooFar=false,longPressed=false;
const LP_MS=450,MOVE_TOL=10;
function getKStepPx(){ const h = paletteClickable.clientHeight || 200; return Math.max(14, Math.min(56, Math.round(h / 6))); }

paletteClickable.addEventListener('pointerdown', (e)=>{
  if(e.pointerType==='mouse' && e.button!==0) return;

  movedTooFar=false; longPressed=false;
  const startX=e.clientX, startY=e.clientY;
  let lastX=startX, lastY=startY;

  let kDrag=false; draggingK=false;
  let kAccum=0;
  const stepPx=getKStepPx();
  let ax=0, ay=-1, dirSign=+1;

  paletteClickable.setPointerCapture(e.pointerId);
  lockPressSelection(); lockScroll();

  clearTimeout(lpTimer);
  lpTimer=setTimeout(()=>{
    if(movedTooFar || kDrag) return;
    longPressed=true;
    try{paletteClickable.releasePointerCapture(e.pointerId);}catch{}
    openCC(); showPressShieldWithAutoRelease();
  }, LP_MS);

  const move=(ev)=>{
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;

    if(!kDrag){
      if(Math.abs(dx) > MOVE_TOL || Math.abs(dy) > MOVE_TOL){ movedTooFar = true; clearTimeout(lpTimer); }
      if(Math.abs(dy) > MOVE_TOL && Math.abs(dy) > Math.abs(dx) * 0.7){
        const len = Math.hypot(dx, dy) || 1;
        ax = dx / len; ay = dy / len;
        dirSign = (dy < 0) ? +1 : -1;
        kDrag = true; draggingK = true;
      }
    }

    if(kDrag){
      const dpx = ev.clientX - lastX;
      const dpy = ev.clientY - lastY;
      const proj = dpx*ax + dpy*ay;
      kAccum += proj * dirSign;

      let steps = 0;
      if(kAccum >= stepPx) steps = Math.floor(kAccum / stepPx);
      else if(kAccum <= -stepPx) steps = Math.ceil(kAccum / stepPx);

      if(steps){
        const newK = Math.max(2, Math.min(10, (+kRange.value) + steps));
        if(newK !== +kRange.value){
          kRange.value = String(newK);
          kVal.textContent=newK;
          K=newK;
        }
        kAccum -= steps * stepPx;
      }
      if(ev.cancelable) ev.preventDefault();
    }

    lastX = ev.clientX; lastY = ev.clientY;
  };

  const finish=(ev)=>{
    try{paletteClickable.releasePointerCapture(e.pointerId);}catch{}
    paletteClickable.removeEventListener('pointermove',move);
    paletteClickable.removeEventListener('pointerup',finish);
    paletteClickable.removeEventListener('pointercancel',cancel);
    clearTimeout(lpTimer); hidePressShield(); unlockScroll();

    if(!longPressed && !kDrag && !movedTooFar){
      const r=paletteClickable.getBoundingClientRect();
      const isLeft=(ev.clientX-r.left)<(r.width/2); cycleAlgo(isLeft?-1:+1);
    }
    draggingK=false; unlockPressSelection();
  };

  const cancel=()=>{
    clearTimeout(lpTimer); hidePressShield(); unlockScroll(); unlockPressSelection();
    try{paletteClickable.releasePointerCapture(e.pointerId);}catch{}
    paletteClickable.removeEventListener('pointermove',move);
    paletteClickable.removeEventListener('pointerup',finish);
    paletteClickable.removeEventListener('pointercancel',cancel);
    draggingK=false;
  };

  paletteClickable.addEventListener('pointermove',move);
  paletteClickable.addEventListener('pointerup',finish,{once:true});
  paletteClickable.addEventListener('pointercancel',cancel,{once:true});
});

paletteClickable.addEventListener('wheel', (e)=>{ e.preventDefault(); }, {passive:false});

['pointerdown','pointerup','click','touchstart','touchend','mousedown','mouseup','wheel'].forEach(evt=>{
  pressShield.addEventListener(evt,(e)=>{ e.stopPropagation(); e.preventDefault(); },{capture:true});
});
document.addEventListener('click',e=>{
  if(compositeOverlay.classList.contains('open')) return;
  if(ccWrap.style.display==='block' && !ccWrap.contains(e.target) && !paletteClickable.contains(e.target)) closeCC();
});
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'&&ccWrap.style.display==='block') closeCC(); });

/* ===== controls ===== */
kRange.addEventListener('input',()=>{K=+kRange.value;kVal.textContent=K;});
sizeRange.addEventListener('input',()=>{procWidth=+sizeRange.value;sizeVal.textContent=procWidth+' px';});
throttleLog.addEventListener('input',()=>{throttleN=sliderToN(+throttleLog.value);throttleVal.textContent=String(throttleN);});
rectChk.addEventListener('change',()=>renderPalette(lastPalette));
gradChk.addEventListener('change',()=>renderPalette(lastPalette));
function setZoom(v){ uiZoom=Math.max(1,Math.min(10,v)); zoomSlider.value=uiZoom; document.documentElement.style.setProperty('--zoom',uiZoom); }
zoomSlider.addEventListener('input',()=>setZoom(+zoomSlider.value));
zoomMinus.addEventListener('click',()=>setZoom(+zoomSlider.value-0.25));
zoomPlus .addEventListener('click',()=>setZoom(+zoomSlider.value+0.25));

/* ===== crop helper (square, center, obey uiZoom) ===== */
function computeSquareCrop(){
  const vw=video.videoWidth||0, vh=video.videoHeight||0; if(!vw||!vh) return {sx:0,sy:0,sw:0,sh:0};
  const z=Math.max(1,uiZoom), base=Math.min(vw,vh), sw=Math.round(base/z), sh=sw,
        sx=Math.floor((vw-sw)/2), sy=Math.floor((vh-sh)/2);
  return {sx,sy,sw,sh};
}

/* ===== simple on-thread K-Means palette (fast, few iters) ===== */
function kmeansPalette(imgData, k=3, maxIter=6, sampleStep=4){
  const data = imgData.data;
  const pts = [];
  for(let i=0;i<data.length;i+=4*sampleStep){
    const a=data[i+3]; if(a<250) continue;
    pts.push([data[i], data[i+1], data[i+2]]);
  }
  if(pts.length===0){ return []; }

  // init: pick k random unique points
  const cent=[]; const used=new Set();
  while(cent.length<k && cent.length<pts.length){
    const idx = (Math.random()*pts.length)|0;
    if(used.has(idx)) continue; used.add(idx); cent.push(pts[idx].slice());
  }
  const assign=new Array(pts.length).fill(0);

  for(let it=0; it<maxIter; it++){
    // assign
    for(let i=0;i<pts.length;i++){
      let best=0, bd=1e12;
      const p=pts[i];
      for(let c=0;c<cent.length;c++){
        const d0=p[0]-cent[c][0], d1=p[1]-cent[c][1], d2=p[2]-cent[c][2];
        const d=d0*d0+d1*d1+d2*d2;
        if(d<bd){ bd=d; best=c; }
      }
      assign[i]=best;
    }
    // recompute
    const sum=Array.from({length:cent.length},()=>[0,0,0,0]);
    for(let i=0;i<pts.length;i++){
      const a=assign[i]; const p=pts[i]; const s=sum[a]; s[0]+=p[0]; s[1]+=p[1]; s[2]+=p[2]; s[3]++;
    }
    for(let c=0;c<cent.length;c++){
      if(sum[c][3]>0){
        cent[c][0]=sum[c][0]/sum[c][3];
        cent[c][1]=sum[c][1]/sum[c][3];
        cent[c][2]=sum[c][2]/sum[c][3];
      }else{
        // re-seed empty cluster
        const idx=(Math.random()*pts.length)|0;
        cent[c]=pts[idx].slice();
      }
    }
  }
  // population for ordering
  const pop=new Array(cent.length).fill(0);
  for(let i=0;i<assign.length;i++) pop[assign[i]]++;
  const palette = cent.map((c,i)=>({rgb:c, n:pop[i]}))
                      .sort((a,b)=>b.n-a.n)
                      .map(o=>o.rgb);
  return palette;
}

/* ===== palette render ===== */
function renderPalette(pal){
  lastPalette = Array.isArray(pal) ? pal : lastPalette;
  swatchesEl.innerHTML='';
  const showRects = rectChk.checked!==false;
  const showGrad  = gradChk.checked!==false;

  if(showRects){
    lastPalette.forEach(rgb=>{
      const d=document.createElement('div');
      d.className='swatch';
      d.style.background=toHex(rgb);
      swatchesEl.appendChild(d);
    });
    swatchesEl.style.display='';
  }else{
    swatchesEl.style.display='none';
  }

  if(showGrad && lastPalette.length){
    const stops = lastPalette.map(rgb=>toHex(rgb)).join(', ');
    gradientEl.style.background = `linear-gradient(90deg, ${stops})`;
    gradientEl.hidden = false;
  }else{
    gradientEl.hidden = true;
  }
}

/* ===== processing loop ===== */
const offCtx = off.getContext('2d', {willReadFrequently:true});
function tick(now){
  // fps
  const dt = now - lastT;
  if(dt>=500){ fps = Math.round((frameCounter*1000)/dt); fpsEl.textContent=String(fps); frameCounter=0; lastT=now; }
  frameCounter++;

  if(video.readyState>=2){
    // throttle
    if(tick._skip===undefined) tick._skip=0;
    if(tick._skip<=0){
      const {sx,sy,sw,sh} = computeSquareCrop();
      if(sw>0){
        off.width = procWidth; off.height = procWidth;
        offCtx.drawImage(video, sx,sy,sw,sh, 0,0,procWidth,procWidth);
        const img = offCtx.getImageData(0,0,procWidth,procWidth);
        const pal = kmeansPalette(img, K, 6, 4);
        if(pal && pal.length){ renderPalette(pal); }
      }
      tick._skip = throttleN;
    }else{
      tick._skip--;
    }
  }
  requestAnimationFrame(tick);
}

/* ===== camera start ===== */
async function startCamera(){
  try{
    status('Requesting camera…');
    const cstr = {
      audio:false,
      video:{
        facingMode:{ideal:'environment'},
        width:{ideal:1280}, height:{ideal:1280}, frameRate:{ideal:30}
      }
    };
    const stream = await navigator.mediaDevices.getUserMedia(cstr);
    video.setAttribute('playsinline','');
    video.muted = true;
    video.srcObject = stream;

    await new Promise((res)=>video.addEventListener('loadedmetadata', res, {once:true}));
    try{ await video.play(); }catch(_){}
    resEl.textContent = `${video.videoWidth}×${video.videoHeight}`;
    status('Live');
  }catch(err){
    console.error(err);
    status('Camera error');
    toast(err?.message || 'Camera failed');
  }
}

/* ===== freeze / unfreeze ===== */
function freezeNow(){
  try{
    const wrap = document.getElementById('videoPane');
    const w = wrap.clientWidth, h = wrap.clientHeight;
    compositeCanvas.width = w; compositeCanvas.height = h;
    const ctx = compositeCanvas.getContext('2d', {willReadFrequently:true});
    const vw = video.videoWidth || 0, vh = video.videoHeight || 0;
    if(vw && vh){
      const z = Math.max(1, uiZoom);
      const base = Math.min(vw, vh);
      const sw = Math.round(base / z);
      const sx = Math.floor((vw - sw)/2);
      const sy = Math.floor((vh - sw)/2);
      ctx.drawImage(video, sx, sy, sw, sw, 0, 0, w, h);
    }else{
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
    }
    compositeImg.src = compositeCanvas.toDataURL('image/jpeg', 0.9);
    compositeOverlay.classList.add('open');
    status('Frozen');
  }catch(e){
    toast('Freeze failed: ' + (e?.message||'unknown'));
  }
}
function unfreeze(){
  compositeOverlay.classList.remove('open');
  status('Live');
}

/* ===== wire up + start ===== */
renderAlgoBrief(); highlightAlgoDesc(algo);
throttleVal.textContent=String(throttleN);
sizeVal.textContent=procWidth+' px';

freezeBtn.addEventListener('click', freezeNow);
unfreezeBtn.addEventListener('click', unfreeze);

window.addEventListener('pageshow', ()=>{
  startCamera();
  requestAnimationFrame(tick);
}, {once:true});
</script>
</body>
</html>