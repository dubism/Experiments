<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>HDR Image — Upload + Toggle Controls (iOS 26)</title>
<meta name="color-scheme" content="dark light">
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:14px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:#0b0b0d; color:#e9ecf1; display:flex; flex-direction:column;
  }

  .controls{
    position:sticky; top:0; z-index:10; padding:12px 16px; gap:10px; display:grid;
    background:rgba(12,12,14,.72); backdrop-filter:blur(10px) saturate(120%);
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  .row{display:flex;flex-wrap:wrap;gap:14px 18px;align-items:center}
  .label{display:inline-flex;gap:8px;align-items:center;white-space:nowrap;font-variant-numeric:tabular-nums}
  input[type="range"]{inline-size:200px;accent-color:#62c1ff}
  .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06)}
  .warn{color:#ffd8a8}
  .muted{color:#b7bcc7}

  .stage{flex:1;display:grid;place-items:center;padding:20px 16px 40px}

  /* The frame now gets an explicit width/height from JS */
  .frame{
    position:relative; width:min(92vw,1200px); height:56.25vw; /* temporary 16:9 until image loads */
    max-width:1200px; max-height:80vh;
    background:#0f1013; border:1px solid rgba(255,255,255,.08);
    border-radius:12px; overflow:hidden;
    transition:width .12s ease,height .12s ease;
  }

  .base,.hdr{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  }
  .base{ filter:url(#tonecurve) }         /* toggled by JS */
  .hdr { pointer-events:none; z-index:2; dynamic-range-limit:no-limit }

  .frame img{
    display:block; width:auto; height:auto; max-width:100%; max-height:100%;
    object-fit:contain; background:#0a0b0e;
  }

  .hdr-off .hdrBadge{display:none}
  .hdr-off .fallback{display:inline}

  .tips{max-width:920px;margin:14px auto 28px;padding:0 16px;color:#bfc4cf}
</style>
</head>
<body>

<div class="controls">
  <div class="row">
    <input id="file" type="file" accept="image/*" />
    <span class="tag hdrBadge">HDR overlay: <strong>no-limit</strong></span>
    <span class="tag fallback" style="display:none">⚠️ <span class="warn">No <code>dynamic-range-limit</code>. Showing SDR only.</span></span>
    <span class="muted">Tip: use a HEIC from Photos for real HDR.</span>
  </div>
  <div class="row">
    <label class="label"><input id="enableTone" type="checkbox" checked /> Apply tone-curve</label>
    <span class="label">Black
      <input id="black" type="range" min="0" max="0.20" step="0.002" value="0.02" />
      <span id="blackVal" class="tag">0.020</span>
    </span>
    <span class="label">Mid (γ)
      <input id="gamma" type="range" min="0.40" max="2.50" step="0.02" value="1.00" />
      <span id="gammaVal" class="tag">1.00</span>
    </span>
    <span class="label">White
      <input id="white" type="range" min="0.80" max="1.20" step="0.01" value="1.00" />
      <span id="whiteVal" class="tag">1.00</span>
    </span>
  </div>
</div>

<div class="tips">
  Upload one image. The base (SDR) can have a tone curve. The overlay shows the same file with HDR/EDR if available. Controls never affect the HDR overlay.
</div>

<div class="stage">
  <div class="frame" id="frame">
    <div class="base"><img id="imgBase"
      src="https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1600&q=85"
      alt="Base SDR"></div>

    <div class="hdr"><img id="imgHdr"
      src="https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1600&q=100"
      alt="HDR overlay"></div>
  </div>
</div>

<svg width="0" height="0" style="position:absolute">
  <filter id="tonecurve" color-interpolation-filters="sRGB">
    <feComponentTransfer>
      <feFuncR id="funcR" type="gamma" amplitude="1" exponent="1" offset="0"/>
      <feFuncG id="funcG" type="gamma" amplitude="1" exponent="1" offset="0"/>
      <feFuncB id="funcB" type="gamma" amplitude="1" exponent="1" offset="0"/>
    </feComponentTransfer>
  </filter>
</svg>

<script>
(function(){
  const body = document.body;
  const supportsHDR = CSS.supports('dynamic-range-limit: no-limit');
  if (!supportsHDR) {
    body.classList.add('hdr-off');
    document.querySelector('.fallback').style.display = 'inline';
  }

  const frame   = document.getElementById('frame');
  const fileInp = document.getElementById('file');
  const imgBase = document.getElementById('imgBase');
  const imgHdr  = document.getElementById('imgHdr');

  // --- Fit frame to image intrinsic size, constrained by viewport ---
  function fitFrameToImage(naturalW, naturalH){
    // available box
    const maxW = Math.min(window.innerWidth * 0.92, 1200);
    const maxH = window.innerHeight * 0.80;

    const scale = Math.min(maxW / naturalW, maxH / naturalH, 1e9);
    const w = Math.max(1, Math.floor(naturalW * scale));
    const h = Math.max(1, Math.floor(naturalH * scale));

    frame.style.width  = w + 'px';
    frame.style.height = h + 'px';
  }

  function onAnyImageLoad(img){
    const nw = img.naturalWidth || 1600;
    const nh = img.naturalHeight || 900;
    fitFrameToImage(nw, nh);
  }

  // Initial sizing based on default image once it loads
  if (imgBase.complete) onAnyImageLoad(imgBase);
  else imgBase.addEventListener('load', () => onAnyImageLoad(imgBase));

  // Resize frame when viewport changes
  window.addEventListener('resize', () => {
    const ref = imgBase.naturalWidth ? imgBase : imgHdr;
    onAnyImageLoad(ref);
  }, {passive:true});

  // File upload → use same blob for base & hdr, then size frame
  fileInp.addEventListener('change', () => {
    const f = fileInp.files && fileInp.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    imgBase.onload = () => onAnyImageLoad(imgBase);
    imgHdr.onload  = () => onAnyImageLoad(imgHdr);
    imgBase.src = url;
    imgHdr.src  = url;
  });

  // ---- Tone-curve controls (SDR only) ----
  const enableTone = document.getElementById('enableTone');
  const black = document.getElementById('black');
  const white = document.getElementById('white');
  const gamma = document.getElementById('gamma');
  const blackVal = document.getElementById('blackVal');
  const whiteVal = document.getElementById('whiteVal');
  const gammaVal = document.getElementById('gammaVal');

  const funcR = document.getElementById('funcR');
  const funcG = document.getElementById('funcG');
  const funcB = document.getElementById('funcB');

  function updateToneCurve(){
    const baseWrap = document.querySelector('.base');
    if (!enableTone.checked) {
      baseWrap.style.filter = 'none';
    } else {
      baseWrap.style.filter = 'url(#tonecurve)';
      const b = parseFloat(black.value);
      const w = parseFloat(white.value);
      const g = parseFloat(gamma.value);
      const denom = Math.max(0.001, (w - b));
      const A = 1 / denom;
      const O = -b / denom;
      [funcR, funcG, funcB].forEach(fn => {
        fn.setAttribute('amplitude', A.toFixed(6));
        fn.setAttribute('exponent',  g.toFixed(4));
        fn.setAttribute('offset',    O.toFixed(6));
      });
    }
    blackVal.textContent = parseFloat(black.value).toFixed(3);
    whiteVal.textContent = parseFloat(white.value).toFixed(3);
    gammaVal.textContent = parseFloat(gamma.value).toFixed(2);
  }
  [enableTone, black, white, gamma].forEach(el => el.addEventListener('input', updateToneCurve));
  updateToneCurve();
})();
</script>
</body>
</html>