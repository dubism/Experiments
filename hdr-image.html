<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>HDR Image — Upload + Toggle (iOS 26)</title>
<meta name="color-scheme" content="dark light">
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:14px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:#0b0b0d; color:#e9ecf1; display:flex; flex-direction:column;
  }

  .controls{
    position:sticky; top:0; z-index:10; padding:12px 16px; gap:10px; display:grid;
    background:rgba(12,12,14,.72); backdrop-filter:blur(10px) saturate(120%);
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  .row{display:flex; flex-wrap:wrap; gap:14px 18px; align-items:center}
  .label{display:inline-flex; gap:8px; align-items:center; white-space:nowrap; font-variant-numeric:tabular-nums}
  input[type="range"]{inline-size:200px; accent-color:#62c1ff}
  .tag{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06)}
  .warn{color:#ffd8a8} .muted{color:#b7bcc7}

  .stage{flex:1; display:grid; place-items:center; padding:20px 16px 40px}
  .frame{
    position:relative;
    width:min(92vw,1200px); height:56.25vw; /* temp 16:9 until img loads */
    max-width:1200px; max-height:80vh;
    background:#0f1013; border:1px solid rgba(255,255,255,.08);
    border-radius:12px; overflow:hidden;
    transition:width .12s ease, height .12s ease;
  }

  .base,.hdr{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  }
  .base{ filter:url(#tonecurve) }      /* toggled by JS */
  .hdr { pointer-events:none; z-index:2; dynamic-range-limit:no-limit }

  .frame img{
    display:block; width:auto; height:auto; max-width:100%; max-height:100%;
    object-fit:contain; background:#0a0b0e;
  }

  .hdr-off .hdrBadge{display:none}
  .hdr-off .fallback{display:inline}

  .tips{max-width:920px; margin:12px auto 24px; padding:0 16px; color:#bfc4cf}
</style>
</head>
<body>

<div class="controls">
  <div class="row">
    <input id="file" type="file" accept="image/heic,image/heif,image/avif,image/jpeg,image/png,image/webp,image/*" />
    <label class="label"><input id="toggleHdr" type="checkbox" checked /> Show HDR overlay</label>
    <span class="tag hdrBadge">HDR overlay: <strong>no-limit</strong></span>
    <span class="tag fallback" style="display:none">⚠️ <span class="warn">No <code>dynamic-range-limit</code>. Showing SDR only.</span></span>
    <span class="muted">To see HDR “pop”, upload a HEIC from Photos.</span>
  </div>
  <div class="row">
    <label class="label"><input id="enableTone" type="checkbox" checked /> Apply SDR tone-curve</label>
    <span class="label">Black
      <input id="black" type="range" min="0" max="0.20" step="0.002" value="0.02" />
      <span id="blackVal" class="tag">0.020</span>
    </span>
    <span class="label">Mid (γ)
      <input id="gamma" type="range" min="0.40" max="2.50" step="0.02" value="1.00" />
      <span id="gammaVal" class="tag">1.00</span>
    </span>
    <span class="label">White
      <input id="white" type="range" min="0.80" max="1.20" step="0.01" value="1.00" />
      <span id="whiteVal" class="tag">1.00</span>
    </span>
  </div>
</div>

<div class="tips">
  Toggle <strong>Show HDR overlay</strong> to compare HDR vs SDR. With HDR off, the sliders should update live.
</div>

<div class="stage">
  <div class="frame" id="frame">
    <div class="base"><img id="imgBase"
      src="https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1600&q=85"
      alt="Base SDR"></div>
    <div class="hdr" id="hdrLayer"><img id="imgHdr"
      src="https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1600&q=100"
      alt="HDR overlay"></div>
  </div>
</div>

<!-- Tone curve (SDR only) -->
<svg width="0" height="0" style="position:absolute">
  <filter id="tonecurve" color-interpolation-filters="linearRGB">
    <feComponentTransfer>
      <feFuncR id="funcR" type="gamma" amplitude="1" exponent="1" offset="0"/>
      <feFuncG id="funcG" type="gamma" amplitude="1" exponent="1" offset="0"/>
      <feFuncB id="funcB" type="gamma" amplitude="1" exponent="1" offset="0"/>
    </feComponentTransfer>
  </filter>
</svg>

<script>
(function(){
  const supportsHDR = CSS.supports('dynamic-range-limit: no-limit');
  if (!supportsHDR) {
    document.body.classList.add('hdr-off');
    document.querySelector('.fallback').style.display = 'inline';
  }

  const frame     = document.getElementById('frame');
  const hdrLayer  = document.getElementById('hdrLayer');
  const fileInput = document.getElementById('file');
  const imgBase   = document.getElementById('imgBase');
  const imgHdr    = document.getElementById('imgHdr');

  function fitFrameToImage(nw, nh){
    const maxW = Math.min(window.innerWidth * 0.92, 1200);
    const maxH = window.innerHeight * 0.80;
    const scale = Math.min(maxW / nw, maxH / nh);
    frame.style.width  = Math.max(1, Math.floor(nw * scale)) + 'px';
    frame.style.height = Math.max(1, Math.floor(nh * scale)) + 'px';
  }
  function onImgLoad(img){
    const nw = img.naturalWidth || 1600, nh = img.naturalHeight || 900;
    fitFrameToImage(nw, nh);
  }
  if (imgBase.complete) onImgLoad(imgBase); else imgBase.addEventListener('load', () => onImgLoad(imgBase));
  window.addEventListener('resize', () => onImgLoad(imgBase), {passive:true});

  fileInput.addEventListener('change', () => {
    const f = fileInput.files && fileInput.files[0]; if (!f) return;
    const url = URL.createObjectURL(f);
    imgBase.onload = () => onImgLoad(imgBase);
    imgHdr.onload  = () => onImgLoad(imgHdr);
    imgBase.src = url;
    imgHdr.src  = url;
  });

  // --- SDR tone-curve controls (live) ---
  const enableTone = document.getElementById('enableTone');
  const black = document.getElementById('black');
  const white = document.getElementById('white');
  const gamma = document.getElementById('gamma');
  const blackVal = document.getElementById('blackVal');
  const whiteVal = document.getElementById('whiteVal');
  const gammaVal = document.getElementById('gammaVal');
  const funcR = document.getElementById('funcR');
  const funcG = document.getElementById('funcG');
  const funcB = document.getElementById('funcB');
  const baseWrap = document.querySelector('.base');

  function applyFilterParams(){
    const b = parseFloat(black.value);
    const w = parseFloat(white.value);
    const g = parseFloat(gamma.value);
    const denom = Math.max(0.001, (w - b));
    const A = 1 / denom;
    const O = -b / denom;
    [funcR, funcG, funcB].forEach(fn => {
      fn.setAttribute('amplitude', A.toFixed(6));
      fn.setAttribute('exponent',  g.toFixed(4));
      fn.setAttribute('offset',    O.toFixed(6));
    });
  }

  function refreshFilter() {
    // Force Safari to re-evaluate the SVG filter
    const prev = baseWrap.style.filter;
    baseWrap.style.filter = 'none';
    requestAnimationFrame(() => { baseWrap.style.filter = prev || 'url(#tonecurve)'; });
  }

  function updateToneCurve(){
    if (!enableTone.checked) {
      baseWrap.style.filter = 'none';
    } else {
      baseWrap.style.filter = 'url(#tonecurve)';
      applyFilterParams();
      refreshFilter(); // <<< key fix for live updates
    }
    blackVal.textContent = parseFloat(black.value).toFixed(3);
    whiteVal.textContent = parseFloat(white.value).toFixed(3);
    gammaVal.textContent = parseFloat(gamma.value).toFixed(2);
  }

  [enableTone, black, white, gamma].forEach(el => el.addEventListener('input', updateToneCurve, {passive:true}));
  updateToneCurve();

  // --- HDR overlay visibility toggle ---
  const toggleHdr = document.getElementById('toggleHdr');
  function updateHdrVisibility(){ hdrLayer.style.display = toggleHdr.checked ? '' : 'none'; }
  toggleHdr.addEventListener('input', updateHdrVisibility, {passive:true});
  updateHdrVisibility();
})();
</script>
</body>
</html>