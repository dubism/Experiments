<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WebGPU Sanity</title>
<style>
  html,body{margin:0;height:100vh;background:#444} /* 1) plain CSS */
  #wrap{position:fixed;inset:0}
  canvas{display:block;width:100vw;height:100vh;touch-action:none}
</style>
<div id="wrap">
  <canvas id="c2d"></canvas>
  <canvas id="wgpu"></canvas>
</div>
<script>
(async () => {
  // 2) 2D canvas sanity
  const c2d = document.getElementById('c2d');
  c2d.width = c2d.clientWidth; c2d.height = c2d.clientHeight;
  const g2d = c2d.getContext('2d');
  g2d.fillStyle = '#0a0'; g2d.fillRect(0,0,c2d.width,c2d.height);

  // 3) WebGPU clear to MAGENTA (no shaders)
  const cv = document.getElementById('wgpu');

  // NOTE: avoid dvh here; some iOS builds report 0 on first layout.
  function size() {
    const w = Math.max(2, cv.clientWidth|0);
    const h = Math.max(2, cv.clientHeight|0);
    if (cv.width!==w || cv.height!==h){ cv.width=w; cv.height=h; return true; }
    return false;
  }
  addEventListener('resize', () => { if (size()) configure(); }, {passive:true});
  size();

  if (!('gpu' in navigator)) { console.error('No WebGPU'); return; }
  const adapter = await navigator.gpu.requestAdapter();
  if (!adapter) { console.error('Adapter null'); return; }
  const device = await adapter.requestDevice();
  const ctx = cv.getContext('webgpu', {alphaMode:'opaque'});
  const format = navigator.gpu.getPreferredCanvasFormat();

  function configure(){ ctx.configure({device, format, alphaMode:'opaque'}); }
  configure();

  function frame(){
    // guard: if a relayout changed backing size without a configure, reconfigure
    configure();

    const enc = device.createCommandEncoder();
    const pass = enc.beginRenderPass({
      colorAttachments: [{
        view: ctx.getCurrentTexture().createView(),
        loadOp: 'clear',
        clearValue: {r:1,g:0,b:1,a:1}, // MAGENTA
        storeOp: 'store'
      }]
    });
    pass.end();
    device.queue.submit([enc.finish()]);
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
})();
</script>