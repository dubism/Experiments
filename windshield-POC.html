// replace existing requestMotion + init permission wiring

async function requestDeviceSensors() {
  // Must be called from a user gesture (click/tap)
  const notes = sel => (document.querySelector('#notes').textContent = sel);

  function ok(label){ S.sensors.permission='granted'; S.sensors.source='none'; notes(`permission: ${label}`); return 'granted'; }
  function no(label){ S.sensors.permission='denied'; notes(`denied: ${label}`); return 'denied'; }

  try {
    // iOS style gate for BOTH Orientation and Motion; whichever exists first
    const Ori = window.DeviceOrientationEvent;
    const Mot = window.DeviceMotionEvent;

    // Prefer Orientation gate; if not present, try Motion; if neither, assume allowed.
    if (Ori && typeof Ori.requestPermission === 'function') {
      const res = await Ori.requestPermission();
      if (res !== 'granted') return no(`DeviceOrientation: ${res}`);
      // Some iOS builds need both gates; try Motion if available but ignore errors.
      if (Mot && typeof Mot.requestPermission === 'function') {
        try { await Mot.requestPermission(); } catch {}
      }
      return ok('iOS orientation');
    } else if (Mot && typeof Mot.requestPermission === 'function') {
      const res = await Mot.requestPermission();
      if (res !== 'granted') return no(`DeviceMotion: ${res}`);
      return ok('iOS motion');
    } else {
      // No explicit permission API → treat as granted (Chrome/Android, desktop)
      return ok('no gate (assumed)');
    }
  } catch (err) {
    console.warn('Permission error', err);
    return no(err?.message || 'exception');
  }
}

async function requestMotion() {
  const res = await requestDeviceSensors();
  // Hide overlay only if user can proceed (granted or no gate).
  if (res === 'granted') {
    overlay.hidden = true;
    S.sensors.permission = 'granted';
  } else {
    // Keep overlay visible and show a hint
    overlay.querySelector('div').insertAdjacentHTML('beforeend',
      `<div style="margin-top:.75rem; font-size:.9rem; opacity:.8">
         Tip: Use https/localhost and enable “Motion & Orientation Access” in Safari settings.
       </div>`);
  }
}

// add a "Run without sensors" option so users aren't stuck
const skipBtn = document.createElement('button');
skipBtn.textContent = 'Run without sensors';
skipBtn.style.marginLeft = '0.75rem';
skipBtn.onclick = () => { S.sensors.permission='denied'; overlay.hidden = true; };
btnPerm.after(skipBtn);

// in init(), keep this logic but call setupSensors() AFTER wiring the buttons:
if (!NO_SENSORS) {
  const Any = window.DeviceOrientationEvent;
  const needsPrompt = Any && typeof Any.requestPermission === 'function'
                   || (window.DeviceMotionEvent && typeof window.DeviceMotionEvent.requestPermission === 'function');
  if (needsPrompt) {
    overlay.hidden = false;
    btnPerm.onclick = requestMotion;
  } else {
    overlay.hidden = true;
    S.sensors.permission = 'granted';
  }
  setupSensors();
} else {
  S.sensors.permission = 'denied';
}
