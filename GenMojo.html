<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Emoji Story Mixer</title>
<style>
  :root{
    --t1:#7fd1ff40; --t2:#ff86d640; --t3:#7dffcc40; --t4:#b59bff40;
    --ring2:#00000012; --shadow:0 8px 24px #0000001e,0 2px 8px #00000012;
    --shadow-strong:0 14px 40px #00000026,0 4px 16px #0000001f;
    --ease:cubic-bezier(.2,.8,.2,1);
    --emerald:#9af2d3; --emerald-mid:#48d9ad; --emerald-deep:#0ca678;
  }
  html,body{height:100%;margin:0}
  body{
    background:
      radial-gradient(60vmax 60vmax at 15% 10%, var(--t1), transparent 60%),
      radial-gradient(70vmax 60vmax at 85% 20%, var(--t2), transparent 60%),
      radial-gradient(60vmax 70vmax at 20% 85%, var(--t3), transparent 60%),
      radial-gradient(70vmax 70vmax at 80% 85%, var(--t4), transparent 60%),
      conic-gradient(from 0deg at 50% 50%, #e9f3ff, #ffe9f7, #e9fff6, #f7f3ff, #e9f3ff);
    background-attachment:fixed; animation:hue 24s linear infinite alternate;
    overflow:hidden; touch-action:none; -webkit-tap-highlight-color:transparent;
    user-select:none;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
  }
  @keyframes hue{to{filter:hue-rotate(12deg) saturate(1.05)}}

  /* ambient pulse overlay when waiting */
  .waitFX{position:fixed; inset:0; pointer-events:none; z-index:1; opacity:0; mix-blend-mode:overlay}
  .waiting .waitFX{
    opacity:.35;
    background:
      radial-gradient(120vmax 120vmax at 20% 15%, #7ff0cf33, transparent 60%),
      radial-gradient(120vmax 120vmax at 80% 25%, #b39bff33, transparent 60%),
      radial-gradient(120vmax 120vmax at 30% 80%, #ff9bd433, transparent 60%);
    animation:breath 2.6s ease-in-out infinite, hueShift 8s linear infinite;
  }
  @keyframes breath{0%{opacity:.18}50%{opacity:.42}100%{opacity:.18}}
  @keyframes hueShift{to{filter:hue-rotate(45deg)}}

  .stage{position:fixed; inset:0; display:grid; place-items:center; z-index:2}

  .cauldron-wrap{ position:relative; width:min(64vmin,520px); aspect-ratio:1; z-index:20; display:grid; place-items:center; }
  .cauldron{
    position:relative; width:100%; height:100%; border-radius:50%;
    background:radial-gradient(120% 120% at 70% 30%, #ffffffc0, #ffffff60 45%, #ffffff30 60%, #ffffff12 75%, #ffffff06 100%);
    box-shadow:var(--shadow-strong), inset 0 1px 0 #ffffffa0, inset 0 -20px 60px #0000000b;
    outline:1px solid var(--ring2);
    overflow:hidden; display:grid; place-items:center; transform:translateZ(0);
  }
  .waiting .cauldron{ animation:rot 8s linear infinite, pulse 2.2s ease-in-out infinite; }
  @keyframes rot{to{transform:rotate(360deg)}}
  @keyframes pulse{0%{filter:saturate(1) brightness(1)}50%{filter:saturate(1.08) brightness(1.06)}100%{filter:saturate(1) brightness(1)}}

  .ring{ position:absolute; inset:6%; border-radius:50%; border:1px dashed #00000018; outline:1px solid #ffffff90; outline-offset:-1px; box-shadow:inset 0 0 0 6px #ffffff10; pointer-events:none }
  .cauldron.over{ box-shadow:0 0 0 12px #00c8ff30, var(--shadow-strong) }

  /* chips */
  .chip, .seed, .plus{
    width:56px; height:56px; border-radius:50%;
    display:grid; place-items:center; user-select:none;
    background:radial-gradient(120% 120% at 30% 30%, #ffffffcc, #ffffff9a 60%, #ffffff7a 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffffc8, 0 0 0 1px #0001;
  }
  .seed{ position:absolute; transform:translate(-50%,-50%); pointer-events:auto; animation:float var(--dur,9s) ease-in-out infinite var(--delay,0s); }
  @keyframes float{0%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px)))}50%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px) - 6px))}100%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px)))}}
  .seed .e, .chip .e, .plus .e{font-size:28px}

  .placed{
    position:absolute; width:12vmin; max-width:72px; aspect-ratio:1; border-radius:50%;
    display:grid; place-items:center; cursor:grab;
    background:radial-gradient(120% 120% at 30% 30%, #ffffffc0, #ffffff80 60%, #ffffff50 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffffb8;
    transform:translate(-50%,-50%) scale(1);
    transition:transform .25s var(--ease), opacity .25s var(--ease);
    z-index:40; /* above image */
  }
  .placed .e{font-size:clamp(24px, 8vmin, 44px); filter:drop-shadow(0 1px 0 #ffffffcc)}
  .placed.dropin{ animation:drop .38s var(--ease) }
  @keyframes drop{0%{transform:translate(-50%,-50%) scale(.72)}70%{transform:translate(-50%,-50%) scale(1.14)}100%{transform:translate(-50%,-50%) scale(1)}}
  .placed.fadeout{ animation:fadeout .25s var(--ease) forwards }
  @keyframes fadeout{to{ transform:translate(-50%,-50%) scale(.82); opacity:0 }}
  .on-rim{ pointer-events:none; }

  /* image */
  .image-wrap{ position:absolute; inset:0; border-radius:50%; overflow:hidden; z-index:30; }
  .result-img{ width:100%; height:100%; object-fit:cover; display:block; opacity:0; transform:scale(.92); transition:opacity .6s var(--ease), transform .8s var(--ease) .1s; pointer-events:auto; -webkit-touch-callout:default; user-select:none; }
  .result-img.revealed{ opacity:1; transform:scale(1) }

  /* cancel ON rim */
  .cancel{
    position:absolute; width:56px; height:56px; border-radius:50%; display:grid; place-items:center;
    background:radial-gradient(120% 120% at 30% 30%, #fff, #f6f7fb 60%, #e9eef9 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffff; font-size:26px; cursor:pointer;
    transform:translate(-50%,-50%); z-index:9999; opacity:0; transition:opacity .2s var(--ease);
  }
  .cancel.show{opacity:1}

  /* footer circles */
  .footer{ position:fixed; left:16px; right:16px; bottom:16px; z-index:50; display:flex; gap:14px; align-items:center; justify-content:center; }
  .circle-btn{ width:72px; height:72px; border-radius:50%; display:grid; place-items:center; cursor:pointer; user-select:none; }
  .plus{ box-shadow:var(--shadow), inset 0 1px 0 #ffffff; }
  .cta{
    background:
      radial-gradient(160% 180% at 75% 130%, #a9ffe955, transparent 60%),
      radial-gradient(120% 140% at 20% 10%, #ffffffb0, transparent 55%),
      linear-gradient(145deg, var(--emerald), var(--emerald-mid), var(--emerald-deep));
    box-shadow:
      0 18px 40px rgba(12,166,120,.34),
      0 8px 18px rgba(0,0,0,.18) inset,
      0 -10px 24px rgba(0,0,0,.22) inset;
    transition:transform .18s var(--ease), filter .18s var(--ease);
    position:relative; overflow:hidden;
  }
  .cta::after{ content:""; position:absolute; inset:-60%; background: conic-gradient(from 0deg, #7ff0cf66, #b39bff66, #ff9bd466, #7ff0cf66); animation:ctaSpin 6s linear infinite; mix-blend-mode:overlay; pointer-events:none; }
  @keyframes ctaSpin{to{transform:rotate(360deg)}}
  .cta:hover{ transform:translateY(-1px) scale(1.05) }
  .cta:active{ transform:translateY(0) scale(.98) }
  .cta .e{ font-size:36px; filter: drop-shadow(0 1px 0 #fff6) }

  .locked .seed, .locked .cta, .locked .plus { pointer-events:none; filter:saturate(.4) opacity(.7) }
</style>
</head>
<body>
  <div class="waitFX" id="waitFX"></div>

  <div class="stage">
    <div class="seeds" id="seeds"></div>

    <div class="cauldron-wrap" id="wrap">
      <div class="cauldron" id="cauldron">
        <div class="ring"></div>

        <div class="image-wrap">
          <img id="image" class="result-img" alt="AI result" draggable="false"/>
        </div>

        <button class="cancel" id="cancel" aria-label="reset">❌</button>
      </div>
    </div>
  </div>

  <!-- footer: + picker & CTA, both circular -->
  <div class="footer">
    <button class="circle-btn plus" id="openPicker" aria-label="add"><span class="e">➕</span></button>
    <button class="circle-btn cta" id="cta" aria-label="generate"><span class="e">✨</span></button>
  </div>

  <!-- ===== Emoji Picker Component (as provided) ===== -->
  <emoji-picker id="picker"></emoji-picker>
  <script>
  customElements.define('emoji-picker', class extends HTMLElement {
    #shadow = this.attachShadow({ mode: 'closed' });
    #data; #current = ''; #filtered = []; #focusIndex = 0;
    constructor(){
      super();
      this.#shadow.innerHTML = `
        <style>
          :host{all:initial}
          .picker{
            position:fixed;inset:auto 0 0 0;margin:auto;width:min(760px,96vw);height:min(70vh,720px);
            background:linear-gradient(180deg,#101624,#0e1320);border:1px solid #1c2432;border-radius:16px;
            box-shadow:0 10px 30px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.04) inset;
            display:grid;grid-template-rows:auto 1fr;opacity:0;transform:translateY(24px) scale(.98);pointer-events:none;
            transition:opacity 180ms cubic-bezier(.2,.7,.2,1),transform 260ms cubic-bezier(.2,.8,.2,1);z-index:99999
          }
          .show{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
          .tabs{display:flex;gap:8px;overflow:auto;padding:8px 12px;border-bottom:1px solid #1c2432;background:#0f1421}
          .tab{position:relative;display:inline-grid;place-items:center;width:42px;height:42px;border-radius:999px;border:1px solid #1c2432;background:#0f1421;cursor:pointer;user-select:none;transition:transform .08s ease}
          .tab:active{transform:translateY(1px)}
          .tab[aria-selected="true"]{outline:2px solid #6ee7ff}
          .scroller{position:relative;overflow:auto;padding:12px}
          .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(44px,1fr));gap:10px;align-content:start}
          .cell{display:grid;place-items:center;height:48px;border-radius:10px;background:#0e1420;border:1px solid transparent;transition:transform .08s ease, background 180ms cubic-bezier(.2,.7,.2,1), border-color 180ms cubic-bezier(.2,.7,.2,1);opacity:0;animation:fadein .25s cubic-bezier(.2,.7,.2,1) both}
          @keyframes fadein{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
          .cell:focus{outline:2px solid #6ee7ff}
          .cell:hover{border-color:#27334a}
          .cell:active{transform:translateY(1px)}
          .emo{font-size:28px;line-height:1}
        </style>
        <div class="picker" role="dialog" aria-modal="true" aria-label="Emoji picker">
          <div class="tabs" part="tabs" role="tablist"></div>
          <div class="scroller"><div class="grid" role="listbox" aria-label="Emoji results"></div></div>
        </div>`;
      this.#data = {
        people:{icon:"🙂",items:["😀","😃","😄","😁","😆","😉","😊","😍","🤔","😎","😭","🤣","🤗","🤨","😴","🤯","🤐","🥳"]},
        hands:{icon:"🖐️",items:["👍","👎","👏","🙏","👋","🤝","✌️","☝️","👉","👈","👆","👇"]},
        emotion:{icon:"❤️",items:["❤️","🧡","💛","💚","💙","💜","🖤","🤍","💔","💥","✨","🔥","💤"]},
        animals:{icon:"🐱",items:["🐶","🐱","🐭","🐹","🐰","🦊","🐻","🐼","🐨","🐯","🦁","🐮","🐷","🐸","🐵","🐣","🐧","🐦","🦉","🦄","🐛","🦋","🐝","🐢","🐙"]},
        food:{icon:"🍕",items:["🍎","🍌","🍉","🍇","🍓","🍒","🍍","🥝","🍅","🥑","🍔","🍟","🍕","🌮","🍣","🍜","🍰","🍪","🍩","☕"]},
        activities:{icon:"🎉",items:["⚽","🏀","🏈","🎾","🏓","🥊","🎸","🎧","🎲","🎮","🎯","🏆"]},
        travel:{icon:"✈️",items:["🚗","🚕","🚌","🚄","🚆","🛩️","✈️","🚀","🛳️","⛵","🚲","🏝️"]},
        objects:{icon:"💡",items:["💡","🔒","🔑","🧭","🕰️","⏰","📱","💻","🖱️","🖊️","📎","📦","🧯","🧰"]},
        symbols:{icon:"🔣",items:["✅","❌","⚠️","ℹ️","♻️","➕","➖","➗","✳️","⭐","🆕","🆗"]},
        flags:{icon:"🏳️‍🌈",items:["🏁","🏳️","🏴","🏳️‍🌈","🇪🇺","🇨🇿","🇸🇰","🇩🇪","🇪🇸","🇺🇸","🇬🇧"]}
      };
    }
    connectedCallback(){
      this.r = { root: this.#qs('.picker'), tabs: this.#qs('.tabs'), grid: this.#qs('.grid'), scroll: this.#qs('.scroller') };
      this.#buildTabs(); this.#setCategory(Object.keys(this.#data)[0]);
      window.addEventListener('keydown', this.#esc);
      this.r.scroll.addEventListener('scroll', ()=> this.#render(true));
    }
    disconnectedCallback(){ window.removeEventListener('keydown', this.#esc); }
    open(){ this.r.root.classList.add('show'); this.#render(); }
    close(){ this.r.root.classList.remove('show'); }
    get opened(){ return this.r.root.classList.contains('show'); }
    set data(o){ if(o){ this.#data=o; this.#buildTabs(); this.#setCategory(Object.keys(this.#data)[0]); } }
    get data(){ return this.#data; }
    #qs(s){ return this.#shadow.querySelector(s); }
    #esc = (e)=>{ if(e.key==='Escape' && this.opened) this.close(); };
    #buildTabs(){ this.r.tabs.innerHTML=''; for(const [id,cat] of Object.entries(this.#data)){ const b=document.createElement('button'); b.className='tab'; b.setAttribute('role','tab'); b.dataset.id=id; b.innerHTML=`<span class="emo">${cat.icon}</span>`; b.onclick=()=>this.#setCategory(id); this.r.tabs.appendChild(b);} }
    #setCategory(id){ this.#current=id; [...this.r.tabs.children].forEach(el=>el.setAttribute('aria-selected', el.dataset.id===id?'true':'false')); this.#filtered=this.#data[id].items.slice(); this.r.scroll.scrollTop=0; this.#render(); }
    #render(keep=false){
      const grid=this.r.grid;
      if(!keep) grid.innerHTML='';
      const cols=getComputedStyle(grid).gridTemplateColumns.split(' ').length||8;
      const ROW_H=58, total=this.#filtered.length, rows=Math.ceil(total/cols);
      const top=this.r.scroll.scrollTop, vh=this.r.scroll.clientHeight;
      const firstRow=Math.max(0, Math.floor(top/ROW_H)-3);
      const lastRow=Math.min(rows, firstRow+Math.ceil(vh/ROW_H)+6);
      const start=firstRow*cols, end=Math.min(total, lastRow*cols);
      grid.innerHTML='';
      for(let i=0;i<start;i++){ const s=document.createElement('div'); s.style.visibility='hidden'; grid.appendChild(s);}
      for(let i=start;i<end;i++){ const ch=this.#filtered[i]; const btn=document.createElement('button'); btn.type='button'; btn.className='cell'; btn.setAttribute('role','option'); btn.dataset.index=i; btn.innerHTML=`<span class="emo">${ch}</span>`; btn.onclick=()=>this.#choose(ch); grid.appendChild(btn); }
      for(let i=end;i<rows*cols;i++){ const s=document.createElement('div'); s.style.visibility='hidden'; grid.appendChild(s);}
    }
    #choose(ch){ this.dispatchEvent(new CustomEvent('emoji-pick',{detail:{emoji:ch},bubbles:true,composed:true})); this.close(); }
  });
  </script>
  <!-- ===== End Picker ===== -->

<script>
/* ---------- Core interaction ---------- */

/* fixed startup set (includes 🐛) */
const START_EMOJIS = ["🐛","🐶","🐱","🦊","🐼","🦄","🦋","🐝","🐢","🐙","🌸","🌿","🌈","🌊","⭐","☀️","🌙","⚡","🔥","💧","❤️","😊","😁","😉","🎵","🎨","📷","🧸"];

/* prompt words */
const WORDS = new Map(Object.entries({
  "🐛":"a caterpillar","🐶":"a dog","🐱":"a cat","🦊":"a fox","🐼":"a panda","🦄":"a unicorn","🦋":"a butterfly","🐝":"a bee","🐢":"a turtle","🐙":"an octopus",
  "🌸":"a cherry blossom","🌿":"green leaves","🌈":"a rainbow","🌊":"ocean waves","⭐":"a starry sky","☀️":"sunlight","🌙":"moonlight","⚡":"lightning","🔥":"flames","💧":"a water droplet",
  "❤️":"a red heart","😊":"a smile","😁":"joy","😉":"a playful wink","🎵":"a music note","🎨":"paint","📷":"a camera","🧸":"a teddy bear"
}));

/* DOM refs */
const cauldron = document.getElementById('cauldron');
const imageEl  = document.getElementById('image');
const seedsEl  = document.getElementById('seeds');
const cta      = document.getElementById('cta');
const plusBtn  = document.getElementById('openPicker');
const cancelBtn= document.getElementById('cancel');
const picker   = document.getElementById('picker');

/* state */
let seeds = [];     // {id, emoji, x, y}
let placed = [];    // {id, emoji, x%, y%}
let dragging = null;

/* init */
window.addEventListener('load', resetApp);

function resetApp(){
  placed = [];
  imageEl.src = ""; imageEl.classList.remove('revealed');
  document.body.classList.remove('locked','waiting');
  cancelBtn.classList.remove('show');
  initSeeds(); renderSeeds(); renderPlaced(false);
}

/* deterministic scatter around viewport avoiding bowl/footer circles */
function initSeeds(){
  const vw = innerWidth, vh = innerHeight;
  const bowl = cauldron.getBoundingClientRect();
  const R = bowl.width/2, cx = bowl.left + R, cy = bowl.top + R;
  const seedR = 28, minDist = seedR*2 + 16;
  const footer = document.querySelector('.footer').getBoundingClientRect();
  const avoid = [
    {left: cx-R-24, top: cy-R-24, right: cx+R+24, bottom: cy+R+24},
    {left: footer.left-24, top: footer.top-24, right: footer.right+24, bottom: footer.bottom+24}
  ];
  let s=12345; const rnd=()=> (s=(1103515245*s+12345)%2**31)/2**31;

  seeds = []; let i=0, tries=0;
  while (i<START_EMOJIS.length && tries++<6000){
    const x = 20 + rnd()*(vw-40), y = 20 + rnd()*(vh-40);
    const blocked = avoid.some(ar => x>ar.left-seedR && x<ar.right+seedR && y>ar.top-seedR && y<ar.bottom+seedR);
    if (blocked) continue;
    let ok=true; for(const s of seeds){ if (Math.hypot(x-s.x,y-s.y)<minDist){ok=false;break;} }
    if (!ok) continue;
    seeds.push({id:crypto.randomUUID(), emoji:START_EMOJIS[i++], x, y});
  }
}
function renderSeeds(){
  seedsEl.innerHTML = '';
  for(const s of seeds){
    const n = document.createElement('button');
    n.className = 'seed';
    n.style.left = s.x+'px'; n.style.top = s.y+'px';
    n.style.setProperty('--delay', `${(-Math.random()*6).toFixed(2)}s`);
    n.style.setProperty('--dur', `${(7+Math.random()*4).toFixed(2)}s`);
    n.style.setProperty('--fx', `${(Math.random()*14-7).toFixed(1)}px`);
    n.style.setProperty('--fy', `${(Math.random()*8-4).toFixed(1)}px`);
    n.dataset.id = s.id;
    n.innerHTML = `<span class="e">${s.emoji}</span>`;
    seedsEl.appendChild(n);
    n.addEventListener('pointerdown', e => startDragSeed(e, s.id));
  }
}

/* picker: open & handle pick */
plusBtn.addEventListener('click', ()=> picker.open());
picker.addEventListener('emoji-pick', e=>{
  const emo = e.detail.emoji;
  const pos = spotInsideBowl();
  placed.push({id:crypto.randomUUID(), emoji:emo, x:pos.x, y:pos.y});
  renderPlaced(true);
});

/* drag logic */
function startDragSeed(ev, id){
  if (document.body.classList.contains('locked')) return;
  ev.preventDefault();
  const idx = seeds.findIndex(s=>s.id===id); if (idx<0) return;
  const ghost = makeGhost(seeds[idx].emoji);
  dragging = {type:'seed', idx, emoji:seeds[idx].emoji, ghostEl:ghost};
  pointerMove(ev); window.addEventListener('pointermove', pointerMove); window.addEventListener('pointerup', pointerUp);
}
function startDragPlaced(ev, id){
  if (document.body.classList.contains('locked')) return;
  ev.preventDefault();
  const idx = placed.findIndex(p=>p.id===id); if (idx<0) return;
  const ghost = makeGhost(placed[idx].emoji);
  dragging = {type:'placed', idx, emoji:placed[idx].emoji, ghostEl:ghost};
  pointerMove(ev); window.addEventListener('pointermove', pointerMove); window.addEventListener('pointerup', pointerUp);
}
function makeGhost(emoji){
  const g = document.createElement('div');
  g.className='chip'; g.style.position='fixed'; g.style.zIndex=9999;
  g.style.transform='translate(-50%,-50%) scale(1.0)'; g.style.boxShadow='var(--shadow-strong), 0 0 0 2px #00c8ff30';
  g.innerHTML = `<span class="e">${emoji}</span>`; document.body.appendChild(g); return g;
}
function pointerMove(ev){
  if (!dragging) return;
  dragging.ghostEl.style.left = ev.clientX+'px'; dragging.ghostEl.style.top  = ev.clientY+'px';
  const {inside} = coordsInCauldron(ev.clientX, ev.clientY);
  dragging.ghostEl.style.transform = `translate(-50%,-50%) scale(${inside?1.26:1.04})`; cauldron.classList.toggle('over', inside);
}
function pointerUp(ev){
  if (!dragging) return cleanupDrag();
  const {inside, px, py} = coordsInCauldron(ev.clientX, ev.clientY); cauldron.classList.remove('over');
  if (inside){
    if (dragging.type==='seed'){
      placed.push({id:crypto.randomUUID(), emoji:dragging.emoji, x:px, y:py}); renderPlaced(true);
      const node = [...seedsEl.children][dragging.idx]; if (node) node.remove(); seeds.splice(dragging.idx,1);
    } else { placed[dragging.idx].x = px; placed[dragging.idx].y = py; renderPlaced(false); }
  } else if (dragging.type==='placed'){
    const id = placed[dragging.idx].id; const node = cauldron.querySelector(`.placed[data-id="${id}"]`);
    if (node){ node.classList.add('fadeout'); setTimeout(()=>node.remove(),260); } placed.splice(dragging.idx,1);
  }
  cleanupDrag();
}
function cleanupDrag(){ window.removeEventListener('pointermove', pointerMove); window.removeEventListener('pointerup', pointerUp); dragging?.ghostEl?.remove(); dragging=null; }

function renderPlaced(playDrop=false){
  Array.from(cauldron.querySelectorAll('.placed')).forEach(n=>n.remove());
  for (const p of placed){
    const n = document.createElement('div'); n.className='placed'; n.dataset.id=p.id;
    n.style.left=p.x+'%'; n.style.top=p.y+'%'; n.innerHTML=`<span class="e">${p.emoji}</span>`;
    if (playDrop) n.classList.add('dropin'); n.addEventListener('pointerdown', e=>startDragPlaced(e, p.id)); cauldron.appendChild(n);
  }
}

/* geometry */
function coordsInCauldron(cx, cy){
  const r = cauldron.getBoundingClientRect(); const mx = cx - (r.left + r.width/2); const my = cy - (r.top  + r.height/2);
  const dist = Math.hypot(mx,my); const inside = dist <= r.width/2;
  const px = ((mx + r.width/2) / r.width) * 100; const py = ((my + r.height/2) / r.height) * 100;
  return {inside, px: Math.max(6, Math.min(94, px)), py: Math.max(6, Math.min(94, py))};
}
function spotInsideBowl(){
  const bowl = cauldron.getBoundingClientRect(); const maxTries=400; let tries=0;
  while(tries++<maxTries){
    const px = 8 + Math.random()*84, py = 8 + Math.random()*84;
    const cx = bowl.left + px/100*bowl.width, cy = bowl.top + py/100*bowl.height;
    const d = Math.hypot(cx-(bowl.left+bowl.width/2), cy-(bowl.top+bowl.height/2)); if (d > bowl.width/2 - 40) continue;
    let ok=true; for(const p of placed){ const dx=(p.x-px)/100*bowl.width, dy=(p.y-py)/100*bowl.height; if (Math.hypot(dx,dy)<66){ok=false;break;} }
    if (ok) return {x:px,y:py};
  } return {x:50,y:50};
}

/* move to exact rim in % coords */
function moveToRimPercent(x,y){
  const cx=50, cy=50, r=44; // ~edge
  const ang = Math.atan2(y-cy, x-cx);
  return { x: cx + Math.cos(ang)*r, y: cy + Math.sin(ang)*r };
}
function tuckPlacedToRim(){
  placed.forEach(p=>{
    const target = moveToRimPercent(p.x,p.y);
    const node = cauldron.querySelector(`.placed[data-id="${p.id}"]`); if (!node) return;
    node.animate([{ left:p.x+'%', top:p.y+'%', transform:'translate(-50%,-50%) scale(1)' }, { left:target.x+'%', top:target.y+'%', transform:'translate(-50%,-50%) scale(.96)'}], {duration:520, easing:'cubic-bezier(.2,.8,.2,1)'});
    p.x = target.x; p.y = target.y; node.style.left=p.x+'%'; node.style.top=p.y+'%'; node.classList.add('on-rim');
  });
  // place ❌ at top-right rim
  const rim = moveToRimPercent(90,10);
  cancelBtn.style.left = rim.x+'%'; cancelBtn.style.top = rim.y+'%'; cancelBtn.classList.add('show');
}

/* prompt — cinematic story */
function buildPrompt(){
  if (!placed.length) return "";
  const nameOf = e => WORDS.get(e) || `the ${e} symbol`;
  const dirOf = (x,y)=> {
    const ang = (Math.atan2(y-50,x-50)*180/Math.PI+360)%360;
    const dirs=["right","top-right","top","top-left","left","bottom-left","bottom","bottom-right"];
    return dirs[Math.round((360-ang)/45)%8];
  };
  const parts = placed.map(p => `${nameOf(p.emoji)} at the ${dirOf(p.x,p.y)}`);
  return `Create a cinematic, single-image story that blends all elements into one action: ${parts.join(', ')}. Interpret emojis as real objects, scenes, colors, or emotions (not glyphs). Coherent lighting, depth, motion; one consistent style; no text.`;
}

/* Pollinations */
async function callPollinations(prompt){
  const url = "https://image.pollinations.ai/prompt/" + encodeURIComponent(prompt) + "?width=768&height=768";
  const res = await fetch(url,{mode:"cors"}); if(!res.ok) throw new Error('Pollinations error');
  const blob = await res.blob(); return URL.createObjectURL(blob);
}

/* CTA + Cancel */
cta.addEventListener('click', async ()=>{
  if (document.body.classList.contains('locked')) return;
  const prompt = buildPrompt();
  if(!prompt){
    cauldron.animate([{transform:'translateX(0)'},{transform:'translateX(-7px)'},{transform:'translateX(7px)'},{transform:'translateX(0)'}],
      {duration:280,easing:'cubic-bezier(.3,.8,.2,1)'}); return;
  }
  document.body.classList.add('waiting');
  try{
    const imgURL = await callPollinations(prompt);
    imageEl.src = imgURL;
    imageEl.onload = () => {
      imageEl.classList.add('revealed');
      tuckPlacedToRim();
      document.body.classList.remove('waiting');
      document.body.classList.add('locked');
    };
  }catch(e){ console.warn(e); document.body.classList.remove('waiting'); }
});
cancelBtn.addEventListener('click', resetApp);

/* helpers */
function pulse(el){ el.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:220,easing:'cubic-bezier(.3,.8,.2,1)'}); }
document.addEventListener('gesturestart', e=>e.preventDefault());
</script>
</body>
</html>