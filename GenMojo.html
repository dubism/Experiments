<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Emoji Story Mixer ‚Äî Orbit Reveal</title>
<style>
  :root{
    --t1:#7fd1ff40; --t2:#ff86d640; --t3:#7dffcc40; --t4:#b59bff40;
    --ring2:#00000012; --shadow:0 8px 24px #0000001e,0 2px 8px #00000012;
    --shadow-strong:0 14px 40px #00000026,0 4px 16px #0000001f;
    --ease:cubic-bezier(.2,.8,.2,1);
    --emerald:#9af2d3; --emerald-mid:#48d9ad; --emerald-deep:#0ca678;
  }
  html,body{height:100%;margin:0}
  body{
    background:
      radial-gradient(60vmax 60vmax at 15% 10%, var(--t1), transparent 60%),
      radial-gradient(70vmax 60vmax at 85% 20%, var(--t2), transparent 60%),
      radial-gradient(60vmax 70vmax at 20% 85%, var(--t3), transparent 60%),
      radial-gradient(70vmax 70vmax at 80% 85%, var(--t4), transparent 60%),
      conic-gradient(from 0deg at 50% 50%, #e9f3ff, #ffe9f7, #e9fff6, #f7f3ff, #e9f3ff);
    background-attachment:fixed; animation:hue 24s linear infinite alternate;
    overflow:hidden; touch-action:none; -webkit-tap-highlight-color:transparent;
    user-select:none;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
  }
  @keyframes hue{to{filter:hue-rotate(12deg) saturate(1.05)}}

  .stage{position:fixed; inset:0; display:grid; place-items:center; z-index:2}

  .cauldron-wrap{ position:relative; width:min(64vmin,520px); aspect-ratio:1; z-index:20; display:grid; place-items:center; }
  .cauldron{
    position:relative; width:100%; height:100%; border-radius:50%;
    background:radial-gradient(120% 120% at 70% 30%, #ffffffc0, #ffffff60 45%, #ffffff30 60%, #ffffff12 75%, #ffffff06 100%);
    box-shadow:var(--shadow-strong), inset 0 1px 0 #ffffffa0, inset 0 -20px 60px #0000000b;
    outline:1px solid var(--ring2);
    overflow:hidden; display:grid; place-items:center;
  }
  .ring{ position:absolute; inset:6%; border-radius:50%; border:1px dashed #00000018; outline:1px solid #ffffff90; outline-offset:-1px; box-shadow:inset 0 0 0 6px #ffffff10; pointer-events:none }
  .cauldron.over{ box-shadow:0 0 0 12px #00c8ff30, var(--shadow-strong) }

  /* chips */
  .seed,.chip{
    width:56px; height:56px; border-radius:50%;
    display:grid; place-items:center; user-select:none;
    background:radial-gradient(120% 120% at 30% 30%, #ffffffcc, #ffffff9a 60%, #ffffff7a 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffffc8, 0 0 0 1px #0001;
  }
  .seed{ position:absolute; transform:translate(-50%,-50%); pointer-events:auto; animation:float var(--dur,9s) ease-in-out infinite var(--delay,0s); }
  @keyframes float{0%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px)))}50%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px) - 6px))}100%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px)))}}
  .seed .e, .placed .e, .plus .e, .cta .e{font-size:28px}

  .placed{
    position:absolute; width:12vmin; max-width:72px; aspect-ratio:1; border-radius:50%;
    display:grid; place-items:center; cursor:grab;
    background:radial-gradient(120% 120% at 30% 30%, #ffffffc0, #ffffff80 60%, #ffffff50 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffffb8;
    transform:translate(-50%,-50%) scale(1);
    transition:transform .25s var(--ease), opacity .25s var(--ease), left .25s var(--ease), top .25s var(--ease);
    z-index:40; /* above image */
  }
  .placed.dropin{ animation:drop .38s var(--ease) }
  @keyframes drop{0%{transform:translate(-50%,-50%) scale(.72)}70%{transform:translate(-50%,-50%) scale(1.14)}100%{transform:translate(-50%,-50%) scale(1)}}
  .placed.fadeout{ animation:fadeout .25s var(--ease) forwards }
  @keyframes fadeout{to{ transform:translate(-50%,-50%) scale(.82); opacity:0 }}
  .on-rim{ pointer-events:none; }

  /* image */
  .image-wrap{ position:absolute; inset:0; border-radius:50%; overflow:hidden; z-index:30; }
  .result-img{
    width:100%; height:100%; object-fit:cover; display:block;
    opacity:0; transform:scale(.2); /* reveal from 20% */
    transition:opacity .6s var(--ease), transform .9s cubic-bezier(.22,1.2,.22,1);
    pointer-events:auto; -webkit-touch-callout:default; user-select:none;
  }
  .result-img.revealed{ opacity:1; transform:scale(1) }

  /* cancel ON rim */
  .cancel{
    position:absolute; width:56px; height:56px; border-radius:50%; display:grid; place-items:center;
    background:radial-gradient(120% 120% at 30% 30%, #fff, #f6f7fb 60%, #e9eef9 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffff; font-size:26px; cursor:pointer;
    transform:translate(-50%,-50%); z-index:9999; opacity:0; transition:opacity .2s var(--ease);
  }
  .cancel.show{opacity:1}

  /* orbit */
  .orbit{ position:absolute; inset:0; border-radius:50%; pointer-events:none; z-index:39; }
  .orbit.spin{ animation:orbitRot 8s linear infinite; }
  @keyframes orbitRot{ to{ transform:rotate(360deg) } }
  .pulsing{ animation:pulseDots 1.8s ease-in-out infinite }
  @keyframes pulseDots{ 0%{ transform:translate(-50%,-50%) scale(1); opacity:1 } 50%{ transform:translate(-50%,-50%) scale(.94); opacity:.82 } 100%{ transform:translate(-50%,-50%) scale(1); opacity:1 } }

  /* footer */
  .footer{ position:fixed; left:16px; right:16px; bottom:16px; z-index:50; display:flex; gap:14px; align-items:center; justify-content:center; }
  .circle-btn{ width:72px; height:72px; border-radius:50%; display:grid; place-items:center; cursor:pointer; user-select:none; }
  .plus{
    background:radial-gradient(120% 120% at 30% 30%, #ffffffcc, #ffffff9a 60%, #ffffff7a 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffffc8, 0 0 0 1px #0001;
  }
  .cta{
    background:
      radial-gradient(160% 180% at 75% 130%, #a9ffe955, transparent 60%),
      radial-gradient(120% 140% at 20% 10%, #ffffffb0, transparent 55%),
      linear-gradient(145deg, var(--emerald), var(--emerald-mid), var(--emerald-deep));
    box-shadow: 0 18px 40px rgba(12,166,120,.34), 0 8px 18px rgba(0,0,0,.18) inset, 0 -10px 24px rgba(0,0,0,.22) inset;
    transition:transform .18s var(--ease), filter .18s var(--ease);
    position:relative; overflow:hidden;
  }
  .cta::after{ content:""; position:absolute; inset:-60%; background: conic-gradient(from 0deg, #7ff0cf66, #b39bff66, #ff9bd466, #7ff0cf66); animation:ctaSpin 6s linear infinite; mix-blend-mode:overlay; pointer-events:none; }
  @keyframes ctaSpin{to{transform:rotate(360deg)}}
  .cta:hover{ transform:translateY(-1px) scale(1.05) }
  .cta:active{ transform:translateY(0) scale(.98) }
  .cta .e{ font-size:36px; filter: drop-shadow(0 1px 0 #fff6) }

  .locked .seed, .locked .cta, .locked .plus { pointer-events:none; filter:saturate(.4) opacity(.7) }
</style>
</head>
<body>
  <div class="stage">
    <div class="seeds" id="seeds"></div>

    <div class="cauldron-wrap" id="wrap">
      <div class="cauldron" id="cauldron">
        <div class="ring"></div>

        <div class="image-wrap">
          <img id="image" class="result-img" alt="AI result" draggable="false"/>
        </div>

        <div class="orbit" id="orbit"></div>

        <button class="cancel" id="cancel" aria-label="reset">‚ùå</button>
      </div>
    </div>
  </div>

  <div class="footer">
    <button class="circle-btn plus" id="openPicker" aria-label="add"><span class="e">‚ûï</span></button>
    <button class="circle-btn cta" id="cta" aria-label="generate"><span class="e">‚ú®</span></button>
  </div>

  <!-- Emoji Picker (light theme + rounded tabs) -->
  <emoji-picker id="picker"></emoji-picker>
  <script>
  customElements.define('emoji-picker', class extends HTMLElement {
    #s=this.attachShadow({mode:'closed'}); #data; #cat='people';
    constructor(){ super();
      this.#s.innerHTML = `<style>
        :host{all:initial}
        .p{
          position:fixed; inset:auto 0 0 0; margin:auto; width:min(760px,96vw); height:min(70vh,720px);
          background:linear-gradient(180deg, #ffffffb8, #f6fbffb8);
          border:1px solid #ffffffa0; border-radius:18px;
          box-shadow:0 12px 40px rgba(0,0,0,.18), 0 1px 0 rgba(255,255,255,.6) inset;
          backdrop-filter: blur(10px) saturate(1.05);
          display:grid; grid-template-rows:auto 1fr; opacity:0; transform:translateY(24px) scale(.98); pointer-events:none;
          transition:opacity 180ms cubic-bezier(.2,.7,.2,1), transform 260ms cubic-bezier(.2,.8,.2,1); z-index:99999;
        }
        .show{opacity:1; transform:translateY(0) scale(1); pointer-events:auto}
        .tabs{
          display:flex; gap:8px; overflow:auto; padding:10px 12px;
          background:linear-gradient(180deg,#ffffffee,#f7fbffee);
          border-bottom:1px solid #ffffffaa;
          border-top-left-radius:18px; border-top-right-radius:18px; /* rounded bar ends */
        }
        .t{
          width:42px; height:42px; border-radius:999px;
          border:1px solid #ffffffc4; background:radial-gradient(120% 120% at 30% 30%, #ffffff, #f0f6ff 70%);
          box-shadow:var(--shadow, 0 6px 16px rgba(0,0,0,.08)), inset 0 1px 0 #ffffff;
          cursor:pointer;
        }
        .s{ position:relative; overflow:auto; padding:12px; border-bottom-left-radius:18px; border-bottom-right-radius:18px; }
        .g{ display:grid; grid-template-columns:repeat(auto-fill,minmax(44px,1fr)); gap:10px; align-content:start }
        .c{
          display:grid; place-items:center; height:48px; border-radius:12px;
          background:radial-gradient(120% 120% at 30% 30%, #ffffff, #f3f7ff 70%);
          border:1px solid #ffffffc8; box-shadow:0 1px 0 #ffffff inset;
          transition:transform .08s ease, box-shadow .18s ease;
        }
        .c:hover{ box-shadow:0 0 0 2px #bfe6ff; }
      </style>
      <div class="p">
        <div class="tabs"></div>
        <div class="s"><div class="g"></div></div>
      </div>`;
      this.#data = {
        people:{icon:"üôÇ",items:["üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòâ","üòä","üòç","ü§î","üòé","üò≠","ü§£","ü§ó","üò¥","ü•≥"]},
        animals:{icon:"üê±",items:["üê∂","üê±","ü¶ä","üêº","ü¶Ñ","üêõ","ü¶ã","üêù","üê¢","üêô"]},
        nature:{icon:"üå∏",items:["üå∏","üåø","üåà","üåä","‚≠ê","‚òÄÔ∏è","üåô","‚ö°","üî•","üíß"]},
        symbols:{icon:"‚ù§Ô∏è",items:["‚ù§Ô∏è","üòä","üòÅ","üòâ","üéµ","üé®","üì∑","üß∏","‚ú®","‚úÖ","‚ùå"]}
      };
    }
    connectedCallback(){
      this.r={p:this.#s.querySelector('.p'),tabs:this.#s.querySelector('.tabs'),g:this.#s.querySelector('.g')};
      this.renderTabs(); this.renderGrid();
    }
    renderTabs(){ this.r.tabs.innerHTML=''; for(const [k,v] of Object.entries(this.#data)){ const b=document.createElement('button'); b.className='t'; b.textContent=v.icon; b.onclick=()=>{this.#cat=k; this.renderGrid();}; this.r.tabs.appendChild(b);} }
    renderGrid(){ this.r.g.innerHTML=''; for(const ch of this.#data[this.#cat].items){ const c=document.createElement('button'); c.className='c'; c.innerHTML=`<span style="font-size:28px">${ch}</span>`; c.onclick=()=>{ this.dispatchEvent(new CustomEvent('emoji-pick',{detail:{emoji:ch},bubbles:true,composed:true})); this.close(); }; this.r.g.appendChild(c); } }
    open(){ this.r.p.classList.add('show'); }
    close(){ this.r.p.classList.remove('show'); }
  });
  </script>

<script>
/* ---------- Core interaction + orbit/reveal choreography ---------- */

/* fixed startup set */
const START_EMOJIS = ["üêõ","üê∂","üê±","ü¶ä","üêº","ü¶Ñ","ü¶ã","üêù","üê¢","üêô","üå∏","üåø","üåà","üåä","‚≠ê","‚òÄÔ∏è","üåô","‚ö°","üî•","üíß","‚ù§Ô∏è","üòä","üòÅ","üòâ","üéµ","üé®","üì∑","üß∏"];

/* nouns for emojis */
const WORDS = new Map(Object.entries({
  "üêõ":"a caterpillar","üê∂":"a dog","üê±":"a cat","ü¶ä":"a fox","üêº":"a panda","ü¶Ñ":"a unicorn","ü¶ã":"a butterfly","üêù":"a bee","üê¢":"a turtle","üêô":"an octopus",
  "üå∏":"a cherry blossom","üåø":"green leaves","üåà":"a rainbow","üåä":"ocean waves","‚≠ê":"a starry sky","‚òÄÔ∏è":"sunlight","üåô":"moonlight","‚ö°":"lightning","üî•":"flames","üíß":"a water droplet",
  "‚ù§Ô∏è":"a red heart","üòä":"a smile","üòÅ":"joy","üòâ":"a playful wink","üéµ":"a music note","üé®":"paint","üì∑":"a camera","üß∏":"a teddy bear","‚ú®":"sparkles"
}));

/* DOM */
const cauldron = document.getElementById('cauldron');
const imageEl  = document.getElementById('image');
const seedsEl  = document.getElementById('seeds');
const cta      = document.getElementById('cta');
const plusBtn  = document.getElementById('openPicker');
const cancelBtn= document.getElementById('cancel');
const picker   = document.getElementById('picker');
const orbit    = document.getElementById('orbit');

/* STATE */
let seeds = [];     // {id, emoji, x, y}
let placed = [];    // {id, emoji, x%, y%}
let dragging = null;

/* INIT */
window.addEventListener('load', resetApp);

function resetApp(){
  placed = [];
  imageEl.src = ""; imageEl.classList.remove('revealed');
  document.body.classList.remove('locked');
  cancelBtn.classList.remove('show');
  orbit.classList.remove('spin'); orbit.innerHTML='';
  initSeeds(); renderSeeds(); renderPlaced(false);
}

/* scatter seeds (avoid bowl/footer) */
function initSeeds(){
  const vw = innerWidth, vh = innerHeight;
  const bowl = cauldron.getBoundingClientRect();
  const R = bowl.width/2, cx = bowl.left + R, cy = bowl.top + R;
  const seedR = 28, minDist = seedR*2 + 16;
  const footer = document.querySelector('.footer').getBoundingClientRect();
  const avoid = [
    {left: cx-R-24, top: cy-R-24, right: cx+R+24, bottom: cy+R+24},
    {left: footer.left-24, top: footer.top-24, right: footer.right+24, bottom: footer.bottom+24}
  ];
  let s=12345; const rnd=()=> (s=(1103515245*s+12345)%2**31)/2**31;

  seeds = []; let i=0, tries=0;
  while (i<START_EMOJIS.length && tries++<6000){
    const x = 20 + rnd()*(vw-40), y = 20 + rnd()*(vh-40);
    const blocked = avoid.some(ar => x>ar.left-seedR && x<ar.right+seedR && y>ar.top-seedR && y<ar.bottom+seedR);
    if (blocked) continue;
    let ok=true; for(const s of seeds){ if (Math.hypot(x-s.x,y-s.y)<minDist){ok=false;break;} }
    if (!ok) continue;
    seeds.push({id:crypto.randomUUID(), emoji:START_EMOJIS[i++], x, y});
  }
}
function renderSeeds(){
  seedsEl.innerHTML = '';
  for(const s of seeds){
    const n = document.createElement('button');
    n.className = 'seed';
    n.style.left = s.x+'px'; n.style.top = s.y+'px';
    n.style.setProperty('--delay', `${(-Math.random()*6).toFixed(2)}s`);
    n.style.setProperty('--dur', `${(7+Math.random()*4).toFixed(2)}s`);
    n.style.setProperty('--fx', `${(Math.random()*14-7).toFixed(1)}px`);
    n.style.setProperty('--fy', `${(Math.random()*8-4).toFixed(1)}px`);
    n.dataset.id = s.id;
    n.innerHTML = `<span class="e">${s.emoji}</span>`;
    seedsEl.appendChild(n);
    n.addEventListener('pointerdown', e => startDragSeed(e, s.id));
  }
}

/* picker */
plusBtn.addEventListener('click', ()=> picker.open());
picker.addEventListener('emoji-pick', e=>{
  const emo = e.detail.emoji;
  const pos = spotInsideBowl();
  placed.push({id:crypto.randomUUID(), emoji:emo, x:pos.x, y:pos.y});
  renderPlaced(true);
});

/* drag */
function startDragSeed(ev, id){
  if (document.body.classList.contains('locked')) return;
  ev.preventDefault();
  const idx = seeds.findIndex(s=>s.id===id); if (idx<0) return;
  const ghost = makeGhost(seeds[idx].emoji);
  dragging = {type:'seed', idx, emoji:seeds[idx].emoji, ghostEl:ghost};
  pointerMove(ev); window.addEventListener('pointermove', pointerMove); window.addEventListener('pointerup', pointerUp);
}
function startDragPlaced(ev, id){
  if (document.body.classList.contains('locked')) return;
  ev.preventDefault();
  const idx = placed.findIndex(p=>p.id===id); if (idx<0) return;
  const ghost = makeGhost(placed[idx].emoji);
  dragging = {type:'placed', idx, emoji:placed[idx].emoji, ghostEl:ghost};
  pointerMove(ev); window.addEventListener('pointermove', pointerMove); window.addEventListener('pointerup', pointerUp);
}
function makeGhost(emoji){
  const g = document.createElement('div');
  g.className='chip'; g.style.position='fixed'; g.style.zIndex=9999;
  g.style.transform='translate(-50%,-50%) scale(1.0)'; g.style.boxShadow='var(--shadow-strong), 0 0 0 2px #00c8ff30';
  g.innerHTML = `<span class="e">${emoji}</span>`; document.body.appendChild(g); return g;
}
function pointerMove(ev){
  if (!dragging) return;
  dragging.ghostEl.style.left = ev.clientX+'px'; dragging.ghostEl.style.top  = ev.clientY+'px';
  const {inside} = coordsInCauldron(ev.clientX, ev.clientY);
  dragging.ghostEl.style.transform = `translate(-50%,-50%) scale(${inside?1.26:1.04})`; cauldron.classList.toggle('over', inside);
}
function pointerUp(ev){
  if (!dragging) return cleanupDrag();
  const {inside, px, py} = coordsInCauldron(ev.clientX, ev.clientY); cauldron.classList.remove('over');
  if (inside){
    if (dragging.type==='seed'){
      placed.push({id:crypto.randomUUID(), emoji:dragging.emoji, x:px, y:py}); renderPlaced(true);
      const node = [...seedsEl.children][dragging.idx]; if (node) node.remove(); seeds.splice(dragging.idx,1);
    } else { placed[dragging.idx].x = px; placed[dragging.idx].y = py; renderPlaced(false); }
  } else if (dragging.type==='placed'){
    const id = placed[dragging.idx].id; const node = cauldron.querySelector(`.placed[data-id="${id}"]`);
    if (node){ node.classList.add('fadeout'); setTimeout(()=>node.remove(),260); } placed.splice(dragging.idx,1);
  }
  cleanupDrag();
}
function cleanupDrag(){ window.removeEventListener('pointermove', pointerMove); window.removeEventListener('pointerup', pointerUp); dragging?.ghostEl?.remove(); dragging=null; }

function renderPlaced(playDrop=false){
  Array.from(cauldron.querySelectorAll('.placed')).forEach(n=>n.remove());
  for (const p of placed){
    const n = document.createElement('div'); n.className='placed'; n.dataset.id=p.id;
    n.style.left=p.x+'%'; n.style.top=p.y+'%'; n.innerHTML=`<span class="e">${p.emoji}</span>`;
    if (playDrop) n.classList.add('dropin'); n.addEventListener('pointerdown', e=>startDragPlaced(e, p.id)); cauldron.appendChild(n);
  }
}

/* geometry */
function coordsInCauldron(cx, cy){
  const r = cauldron.getBoundingClientRect(); const mx = cx - (r.left + r.width/2); const my = cy - (r.top  + r.height/2);
  const dist = Math.hypot(mx,my); const inside = dist <= r.width/2;
  const px = ((mx + r.width/2) / r.width) * 100; const py = ((my + r.height/2) / r.height) * 100;
  return {inside, px: Math.max(6, Math.min(94, px)), py: Math.max(6, Math.min(94, py))};
}
function spotInsideBowl(){
  const bowl = cauldron.getBoundingClientRect(); const maxTries=400; let tries=0;
  while(tries++<maxTries){
    const px = 8 + Math.random()*84, py = 8 + Math.random()*84;
    const cx = bowl.left + px/100*bowl.width, cy = bowl.top + py/100*bowl.height;
    const d = Math.hypot(cx-(bowl.left+bowl.width/2), cy-(bowl.top+bowl.height/2)); if (d > bowl.width/2 - 40) continue;
    let ok=true; for(const p of placed){ const dx=(p.x-px)/100*bowl.width, dy=(p.y-py)/100*bowl.height; if (Math.hypot(dx,dy)<66){ok=false;break;} }
    if (ok) return {x:px,y:py};
  } return {x:50,y:50};
}

/* rim placement */
function moveToRimPercent(x,y){
  const cx=50, cy=50, r=44;
  const ang = Math.atan2(y-cy, x-cx);
  return { x: cx + Math.cos(ang)*r, y: cy + Math.sin(ang)*r };
}

/* orbit choreography */
function startOrbit(){
  if (!placed.length){ placed.push({id:crypto.randomUUID(), emoji:"‚ú®", x:50, y:60}); renderPlaced(true); }
  const N = placed.length, innerR = 24;
  for (let i=0;i<N;i++){
    const ang = (i/N) * Math.PI*2;
    const tx = 50 + Math.cos(ang)*innerR;
    const ty = 50 + Math.sin(ang)*innerR;
    const node = cauldron.querySelector(`.placed[data-id="${placed[i].id}"]`);
    if (!node) continue;
    node.animate([{ left: placed[i].x+'%', top: placed[i].y+'%', transform:'translate(-50%,-50%) scale(1)' },{ left: tx+'%', top: ty+'%', transform:'translate(-50%,-50%) scale(.96)'}], {duration:420, easing:'cubic-bezier(.2,.8,.2,1)'});
    placed[i].x = tx; placed[i].y = ty; node.style.left = tx+'%'; node.style.top = ty+'%'; node.classList.add('pulsing');
  }
  orbit.classList.add('spin');
}
function endOrbitToRim(){
  orbit.classList.remove('spin');
  placed.forEach(p=>{
    const node = cauldron.querySelector(`.placed[data-id="${p.id}"]`); if (!node) return;
    const target = moveToRimPercent(p.x,p.y);
    node.animate([{ left: p.x+'%', top: p.y+'%', transform:'translate(-50%,-50%) scale(.96)' },{ left: target.x+'%', top: target.y+'%', transform:'translate(-50%,-50%) scale(.96)'}], {duration:560, easing:'cubic-bezier(.2,.8,.2,1)'});
    p.x = target.x; p.y = target.y; node.style.left=p.x+'%'; node.style.top=p.y+'%'; node.classList.add('on-rim'); node.classList.remove('pulsing');
  });
  const rim = moveToRimPercent(90,10);
  cancelBtn.style.left = rim.x+'%'; cancelBtn.style.top = rim.y+'%'; cancelBtn.classList.add('show');
  requestAnimationFrame(()=> imageEl.classList.add('revealed'));
}

/* ---------- PROMPT CORE (Variant #9) ---------- */
function buildPrompt(){
  if (!placed.length) return "";

  // 1) elements text (no positions)
  const elements = placed.map(p => WORDS.get(p.emoji) || `the ${p.emoji} symbol`);

  // 2) relationship cue to enforce narrative (picked by count)
  const cues2 = ["tension","harmony","transformation","pursuit","reunion"];
  const cues3 = ["tension","harmony","transformation","pursuit","reunion","contrast","metamorphosis"];
  const r = (arr)=> arr[Math.floor(Math.random()*arr.length)];
  const cue = elements.length<=2 ? r(cues2) : r(cues3);

  // Final template (no positional language)
  return `Combine ${elements.join(', ')} into a story-rich, cinematic composition. Show ${cue} between them, as if captured in a single dramatic movie frame. Interpret emojis as real objects, scenes, colors, or emotions ‚Äî not glyphs. Use coherent lighting, depth and motion in one consistent style. No text.`;
}

/* Pollinations */
async function callPollinations(prompt){
  const url = "https://image.pollinations.ai/prompt/" + encodeURIComponent(prompt) + "?width=768&height=768";
  const res = await fetch(url,{mode:"cors"}); if(!res.ok) throw new Error('Pollinations error');
  const blob = await res.blob(); return URL.createObjectURL(blob);
}

/* CTA + Cancel */
cta.addEventListener('click', async ()=>{
  if (document.body.classList.contains('locked')) return;
  const prompt = buildPrompt();
  if(!prompt){
    cauldron.animate([{transform:'translateX(0)'},{transform:'translateX(-7px)'},{transform:'translateX(7px)'},{transform:'translateX(0)'}],
      {duration:280,easing:'cubic-bezier(.3,.8,.2,1)'}); return;
  }
  startOrbit();
  try{
    const imgURL = await callPollinations(prompt);
    imageEl.src = imgURL;
    imageEl.onload = () => {
      endOrbitToRim();
      document.body.classList.add('locked');
    };
  }catch(e){ console.warn(e); }
});
cancelBtn.addEventListener('click', resetApp);

/* helpers */
function pulse(el){ el.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:220,easing:'cubic-bezier(.3,.8,.2,1)'}); }
document.addEventListener('gesturestart', e=>e.preventDefault());
</script>
</body>
</html>