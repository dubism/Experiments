<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Emoji Story Mixer — interactive bowl, live re-render</title>
<style>
  :root{
    --t1:#7fd1ff40; --t2:#ff86d640; --t3:#7dffcc40; --t4:#b59bff40;
    --ring2:#00000012; --shadow:0 8px 24px #0000001e,0 2px 8px #00000012;
    --shadow-strong:0 14px 40px #00000026,0 4px 16px #0000001f;
    --ease:cubic-bezier(.2,.8,.2,1);
    --emerald:#9af2d3; --emerald-mid:#48d9ad; --emerald-deep:#0ca678;
    --ink:#0a0b0d;
    --progress:0;
    --shake-ampl:0;   /* 0→1 ramp while waiting */
    --blur:0px;       /* 0→3px ramp while waiting */
  }
  @property --shake-ampl{syntax:'<number>';initial-value:0;inherits:false}
  @property --blur{syntax:'<length>';initial-value:0px;inherits:false}

  html,body{height:100%;margin:0}
  body{
    background:
      radial-gradient(60vmax 60vmax at 15% 10%, var(--t1), transparent 60%),
      radial-gradient(70vmax 60vmax at 85% 20%, var(--t2), transparent 60%),
      radial-gradient(60vmax 70vmax at 20% 85%, var(--t3), transparent 60%),
      radial-gradient(70vmax 70vmax at 80% 85%, var(--t4), transparent 60%),
      conic-gradient(from 0deg at 50% 50%, #e9f3ff, #ffe9f7, #e9fff6, #f7f3ff, #e9f3ff);
    background-attachment:fixed; animation:hue 24s linear infinite alternate;
    overflow:hidden; touch-action:none; -webkit-tap-highlight-color:transparent;
    user-select:none; color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
  }
  @keyframes hue{to{filter:hue-rotate(12deg) saturate(1.05)}}

  /* Layout: center (bowl) → carousel → footer */
  .stage{position:fixed; inset:0; display:grid; grid-template-rows:1fr auto auto; z-index:2}

  /* ---------- BOWL ---------- */
  .centerWrap{ display:grid; place-items:center; }
  .cauldron-wrap{
    position:relative; width:min(64vmin,520px); aspect-ratio:1;
    display:grid; place-items:center;
    animation:shake-linear 700ms linear infinite;
    /* amplitude is controlled by --shake-ampl which ramps from 0→1 while waiting */
    transform:translate(0,0);
  }
  @keyframes shake-linear{
    0%  { transform: translate( calc( 0px * var(--shake-ampl)),  calc( 0px * var(--shake-ampl))); }
    12% { transform: translate( calc( 2px * var(--shake-ampl)),  calc(-2px * var(--shake-ampl))); }
    25% { transform: translate( calc(-2px * var(--shake-ampl)),  calc( 2px * var(--shake-ampl))); }
    37% { transform: translate( calc( 2px * var(--shake-ampl)),  calc( 2px * var(--shake-ampl))); }
    50% { transform: translate( calc(-2px * var(--shake-ampl)),  calc(-2px * var(--shake-ampl))); }
    62% { transform: translate( calc( 1px * var(--shake-ampl)),  calc(-1px * var(--shake-ampl))); }
    75% { transform: translate( calc(-1px * var(--shake-ampl)),  calc( 1px * var(--shake-ampl))); }
    87% { transform: translate( calc( 1px * var(--shake-ampl)),  calc( 1px * var(--shake-ampl))); }
    100%{ transform: translate( calc( 0px * var(--shake-ampl)),  calc( 0px * var(--shake-ampl))); }
  }

  .cauldron{
    position:relative; width:100%; height:100%; border-radius:50%;
    background:radial-gradient(120% 120% at 70% 30%, #ffffffc0, #ffffff60 45%, #ffffff30 60%, #ffffff12 75%, #ffffff06 100%);
    box-shadow:var(--shadow-strong), inset 0 1px 0 #ffffffa0, inset 0 -20px 60px #0000000b;
    outline:1px solid var(--ring2);
    overflow:hidden; display:grid; place-items:center;
  }
  .ring{ position:absolute; inset:6%; border-radius:50%; border:1px dashed #00000018; outline:1px solid #ffffff90; outline-offset:-1px; box-shadow:inset 0 0 0 6px #ffffff10; pointer-events:none }
  .cauldron.over{ box-shadow:0 0 0 12px #00c8ff30, var(--shadow-strong) }

  /* Brew (everything inside bowl; gets blur + gentle “breathe+spin”) */
  .brew{ position:absolute; inset:0; border-radius:50%; overflow:hidden; filter:blur(var(--blur)) saturate(1.06); }
  @keyframes breatheSpin {
    0%   { transform: scale(.985) rotate(-1.2deg); }
    50%  { transform: scale(1.015) rotate( 1.2deg); }
    100% { transform: scale(.985) rotate(-1.2deg); }
  }
  .waiting .brew{ animation: breatheSpin 1.3s ease-in-out infinite; }

  /* Waiting visuals (continuous stirring; no “timer” feel) */
  .liquid, .beams { position:absolute; inset:10%; border-radius:50%; pointer-events:none; opacity:0; }
  .waiting .liquid{ opacity:1; }
  .waiting .beams{ opacity:.8; }
  .liquid{
    background:
      radial-gradient(40% 60% at 30% 30%, #ffffffd0, #ffffff10 70%),
      conic-gradient(from 0deg, #bffbe7 0 40%, #dfe8ff 40% 70%, #ffdff2 70% 100%);
    mix-blend-mode:soft-light; filter:saturate(1.1);
    animation:swirl 3.6s linear infinite;
  }
  @keyframes swirl{to{transform:rotate(360deg)}}
  .beams{
    background: conic-gradient(from 0deg, #ffffff00 0 8%, #ffffff55 10% 12%, #ffffff00 14% 26%, #ffffff55 28% 30%, #ffffff00 32% 44%, #ffffff55 46% 48%, #ffffff00 50% 100%);
    animation:beams 2.6s linear infinite; filter:blur(6px);
  }
  @keyframes beams{to{transform:rotate(-360deg)}}

  /* Image */
  .image-wrap{ position:absolute; inset:0; border-radius:50%; overflow:hidden; z-index:10; }
  .result-img{
    width:100%; height:100%; object-fit:cover; display:block;
    opacity:0; transform:scale(.2);
    transition:opacity .6s var(--ease), transform .9s cubic-bezier(.22,1.2,.22,1);
    pointer-events:auto; -webkit-touch-callout:default; user-select:none;
  }
  .result-img.revealed{ opacity:1; transform:scale(1) }

  /* Tokens overlay (always interactive) */
  .overlay{ position:absolute; inset:0; pointer-events:none; z-index:30; }
  .seeds{ position:fixed; inset:0; z-index:25; pointer-events:none; }

  .seed,.chip,.plus,.cancel,.cta{
    width:56px; height:56px; border-radius:50%;
    display:grid; place-items:center; user-select:none;
    background:radial-gradient(120% 120% at 30% 30%, #ffffffcc, #ffffff9a 60%, #ffffff7a 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffffc8, 0 0 0 1px #0001;
  }
  .seed{ position:absolute; transform:translate(-50%,-50%); pointer-events:auto; animation:float var(--dur,9s) ease-in-out infinite var(--delay,0s); }
  @keyframes float{
    0%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px)))} 
    50%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px) - 6px))}
    100%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px)))}
  }
  .seed .e{font-size:36px}

  .placed{
    position:absolute; width:12vmin; max-width:80px; aspect-ratio:1; border-radius:50%;
    display:grid; place-items:center; cursor:grab; pointer-events:auto;
    background:radial-gradient(120% 120% at 30% 30%, #ffffffc0, #ffffff80 60%, #ffffff50 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffffb8;
    transform:translate(-50%,-50%) scale(1);
    transition:transform .25s var(--ease), opacity .25s var(--ease), box-shadow .2s var(--ease);
  }
  .placed:active{ transform:translate(-50%,-50%) scale(.95); box-shadow:0 0 0 2px #00c8ff33, var(--shadow) }
  .placed .e{font-size:clamp(34px, 9vmin, 64px)}
  .placed.dropin{ animation:drop .38s var(--ease) }
  @keyframes drop{0%{transform:translate(-50%,-50%) scale(.72)}70%{transform:translate(-50%,-50%) scale(1.14)}100%{transform:translate(-50%,-50%) scale(1)}}
  .placed.fadeout{ animation:fadeout .25s var(--ease) forwards }
  @keyframes fadeout{to{ transform:translate(-50%,-50%) scale(.82); opacity:0 }}

  /* Waiting micro-pulse on placed chips */
  .waitPulse{ animation:chipPulse 1.8s ease-in-out infinite; }
  @keyframes chipPulse{
    0%  { transform:translate(calc(-50% + 0px),   calc(-50% + 0px)) scale(1);    opacity:1 }
    50% { transform:translate(calc(-50% + var(--ix,0px)), calc(-50% + var(--iy,0px))) scale(.94); opacity:.9 }
    100%{ transform:translate(calc(-50% + 0px),   calc(-50% + 0px)) scale(1);    opacity:1 }
  }

  /* ---------- KIND CAROUSEL (moved below bowl) ---------- */
  .kindWrap{
    position:relative; z-index:60; padding:10px 0 16px; display:grid; place-items:center;
  }
  .kindShell{
    width:min(92vw, 820px);
    background:linear-gradient(180deg,#ffffffee,#f6fbffee);
    border:1px solid #ffffffcc; border-radius:18px;
    box-shadow:
      0 20px 36px rgba(0,0,0,.18),
      0 2px 0 rgba(255,255,255,.7) inset,
      0 -10px 30px rgba(0,0,0,.06) inset;
    backdrop-filter:saturate(1.05) blur(8px);
    transform:perspective(1000px) rotateX(6deg);
  }
  .kindRail{
    display:flex; gap:16px; padding:12px 20px; margin:0 auto;
    overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch;
    max-width:100%; scrollbar-width:none; scroll-padding-inline:50vw;
  }
  .kindRail::-webkit-scrollbar{display:none}
  .spacer{ flex:0 0 60vw; }
  .kchip{
    flex:0 0 auto; width:64px; height:64px; border-radius:50%;
    display:grid; place-items:center; scroll-snap-align:center;
    background:radial-gradient(120% 120% at 30% 30%, #ffffff, #f0f6ff 70%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffff;
    transform:translateZ(0) scale(.9);
    transition:transform .18s var(--ease), filter .18s var(--ease), box-shadow .18s var(--ease);
    position:relative; touch-action:manipulation;
  }
  .kchip .e{font-size:34px}
  .kchip:active{ transform:scale(.86) }
  .kchip.active{
    transform:scale(1.32) translateZ(20px);
    box-shadow:0 22px 48px rgba(100,150,255,.30), 0 0 0 2px #ffffff inset, 0 0 0 10px #a6d1ff66;
    filter:saturate(1.25);
  }
  .kchip.active::after{
    content:""; position:absolute; inset:-22%; border-radius:50%;
    background:conic-gradient(#b8f0ff66, #e9d0ff66, #b8f0ff66);
    mix-blend-mode:overlay; animation:shine 4s linear infinite; pointer-events:none;
  }
  @keyframes shine{to{transform:rotate(360deg)}}

  /* ---------- Footer (buttons) ---------- */
  .footer{
    position:fixed; left:16px; right:16px; bottom:16px; z-index:50;
    display:flex; gap:14px; align-items:center; justify-content:center;
  }
  .circle-btn{ width:72px; height:72px; min-width:72px; min-height:72px; border-radius:50%; display:grid; place-items:center; cursor:pointer; user-select:none; touch-action:manipulation; }

  .plus{ transition:transform .18s var(--ease); }
  .plus:active{ transform:scale(.96) }

  .cta{
    position:relative; overflow:hidden; clip-path:circle(50% at 50% 50%);
    background:
      radial-gradient(160% 180% at 75% 130%, #a9ffe955, transparent 60%),
      radial-gradient(120% 140% at 20% 10%, #ffffffb0, transparent 55%),
      linear-gradient(145deg, var(--emerald), var(--emerald-mid), var(--emerald-deep));
    box-shadow: 0 18px 40px rgba(12,166,120,.34), 0 8px 18px rgba(0,0,0,.18) inset, 0 -10px 24px rgba(0,0,0,.22) inset;
    transition:transform .18s var(--ease), filter .18s var(--ease);
    -webkit-mask-image: -webkit-radial-gradient(white, black);
    contain:paint;
  }
  .cta::after{
    content:""; position:absolute; inset:-60%; border-radius:50%;
    background: conic-gradient(from 0deg, #7ff0cf66, #b39bff66, #ff9bd466, #7ff0cf66);
    animation:ctaSpin 6s linear infinite; mix-blend-mode:overlay; pointer-events:none;
  }
  @keyframes ctaSpin{to{transform:rotate(360deg)}}
  .cta:hover{ transform:translateY(-1px) scale(1.05) }
  .cta:active{ transform:translateY(0) scale(.98) }
  .cta .e{ font-size:40px; filter: drop-shadow(0 1px 0 #fff6) }

  .cta .ripple{
    position:absolute; left:var(--x); top:var(--y); width:10px; height:10px; border-radius:50%;
    transform:translate(-50%,-50%); pointer-events:none; background:#ffffff; opacity:.45;
    animation:ripple .6s ease-out forwards;
  }
  @keyframes ripple{ from{transform:translate(-50%,-50%) scale(.2); opacity:.5} to{transform:translate(-50%,-50%) scale(8); opacity:0} }

  .status{
    position:fixed; left:0; right:0; bottom:110px; display:grid; place-items:center; z-index:40; pointer-events:none;
    font-size:14px; font-weight:600; letter-spacing:.2px; color:#19443a;
    text-shadow:0 1px 0 #ffffffa8;
    opacity:0; transform:translateY(8px); transition:opacity .2s var(--ease), transform .25s var(--ease);
  }
  .waiting .status{ opacity:1; transform:translateY(0) }
</style>
</head>
<body>
  <div class="stage">

    <!-- Bowl -->
    <div class="centerWrap">
      <div class="seeds" id="seeds"></div>
      <div class="cauldron-wrap" id="cauldronWrap">
        <div class="cauldron" id="cauldron" aria-live="polite" aria-busy="false">
          <div class="ring"></div>
          <div class="brew">
            <div class="liquid" aria-hidden="true"></div>
            <div class="beams" aria-hidden="true"></div>
            <div class="image-wrap">
              <img id="image" class="result-img" alt="AI result" draggable="false"/>
            </div>
          </div>
        </div>
        <div class="overlay" id="overlay"></div>
      </div>
    </div>

    <!-- KIND CAROUSEL (moved below bowl, above buttons) -->
    <div class="kindWrap">
      <div class="kindShell">
        <div class="kindRail" id="kindRail"><div class="spacer"></div><div class="spacer"></div></div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="footer">
      <button class="circle-btn plus" id="openPicker" aria-label="add"><span class="e">➕</span></button>
      <button class="circle-btn cta" id="cta" aria-label="generate"><span class="e">✨</span></button>
      <button class="circle-btn cancel" id="cancel" aria-label="reset"><span class="e">❌</span></button>
    </div>
  </div>

  <div class="status" id="status">Mixing…</div>
  <emoji-picker id="picker"></emoji-picker>

<script>
/* ---------- Data ---------- */
const START_EMOJIS=["🐛","🐶","🐱","🦊","🐼","🦄","🦋","🐝","🐢","🐙","🌸","🌿","🌈","🌊","⭐","☀️","🌙","⚡","🔥","💧","❤️","😊","😁","😉","🎵","🎨","📷","🧸"];
const WORDS=new Map(Object.entries({"🐛":"a caterpillar","🐶":"a dog","🐱":"a cat","🦊":"a fox","🐼":"a panda","🦄":"a unicorn","🦋":"a butterfly","🐝":"a bee","🐢":"a turtle","🐙":"an octopus","🌸":"a cherry blossom","🌿":"green leaves","🌈":"a rainbow","🌊":"ocean waves","⭐":"a starry sky","☀️":"sunlight","🌙":"moonlight","⚡":"lightning","🔥":"flames","💧":"a water droplet","❤️":"a red heart","😊":"a smile","😁":"joy","😉":"a playful wink","🎵":"a music note","🎨":"paint","📷":"a camera","🧸":"a teddy bear","✨":"sparkles"}));
const KIND_EMOJIS=["🥺","🤯","🤬","😳","🫣","😬","🤮","😈","🤑","💩","🧓","🥷","🧚‍♀️","👾"];
let activeKind=null;

/* ---------- DOM ---------- */
const cauldron=document.getElementById('cauldron');
const overlay=document.getElementById('overlay');
const imageEl=document.getElementById('image');
const seedsEl=document.getElementById('seeds');
const cta=document.getElementById('cta');
const cancelBtn=document.getElementById('cancel');
const picker=document.getElementById('picker');
const kindRail=document.getElementById('kindRail');
const statusEl=document.getElementById('status');

let seeds=[]; let placed=[]; let dragging=null; let snapTimer=null; let lastActiveKind=null;
let progressTicker=null, sparkTimer=null;
let genTimer=null, genSerial=0, latestSerial=0;

window.addEventListener('load',()=>{ buildKindRail(); resetApp(); });

/* ---------- Carousel ---------- */
function buildKindRail(){
  KIND_EMOJIS.forEach(k=>{
    const b=document.createElement('button'); b.className='kchip'; b.dataset.kind=k;
    b.innerHTML=`<span class="e">${k}</span>`; b.addEventListener('click',()=>centerChip(b));
    kindRail.insertBefore(b, kindRail.lastElementChild);
  });
  setTimeout(()=>centerChip(kindRail.querySelector('.kchip')),0);
  kindRail.addEventListener('scroll', onRailScroll, {passive:true});
  requestAnimationFrame(updateActiveChipVisual);
}
function centerChip(chip){
  const R=kindRail.getBoundingClientRect(), C=chip.getBoundingClientRect();
  kindRail.scrollBy({left:(C.left+C.width/2)-(R.left+R.width/2), behavior:'smooth'});
}
function onRailScroll(){
  updateActiveChipVisual();
  if(snapTimer) clearTimeout(snapTimer);
  snapTimer=setTimeout(()=>{
    const active=getActiveChip(); if(!active) return;
    const k=active.dataset.kind; activeKind=k;
    if(lastActiveKind!==k){ lastActiveKind=k; scheduleGenerate('kind-change'); }
  },240);
}
function getActiveChip(){ const R=kindRail.getBoundingClientRect(), cx=R.left+R.width/2; let best=null, d=1e9;
  for(const chip of kindRail.querySelectorAll('.kchip')){ const r=chip.getBoundingClientRect(), c=r.left+r.width/2, dd=Math.abs(c-cx); if(dd<d){d=dd; best=chip;} }
  return best;
}
function updateActiveChipVisual(){ const a=getActiveChip(); for(const c of kindRail.querySelectorAll('.kchip')) c.classList.toggle('active', c===a); }

/* ---------- Core ---------- */
function resetApp(){
  placed=[]; imageEl.src=""; imageEl.classList.remove('revealed');
  document.body.classList.remove('waiting'); document.documentElement.style.setProperty('--shake-ampl','0');
  document.documentElement.style.setProperty('--blur','0px');
  cauldron.setAttribute('aria-busy','false'); statusEl.textContent='';
  overlay.innerHTML='';
  if(genTimer){ clearTimeout(genTimer); genTimer=null; }
  clearInterval(progressTicker); clearInterval(sparkTimer);
  initSeeds(); renderSeeds(); renderPlaced(false);
}

/* Helpers */
function rect(el){ const r=el.getBoundingClientRect(); return {left:r.left,top:r.top,right:r.right,bottom:r.bottom,width:r.width,height:r.height}; }

/* Scatter seeds avoiding UI */
function initSeeds(){
  const vw=window.innerWidth, vh=window.innerHeight;
  const bowl   = rect(cauldron);
  const rail   = rect(kindRail);
  const footer = rect(document.querySelector('.footer'));
  const avoid = [
    { left:bowl.left-24,   top:bowl.top-24,   right:bowl.right+24,   bottom:bowl.bottom+24 },
    { left:rail.left-12,   top:rail.top-12,   right:rail.right+12,   bottom:rail.bottom+12 },
    { left:footer.left-12, top:footer.top-12, right:footer.right+12, bottom:footer.bottom+12 }
  ];
  const CHIP_R = 28, PAD = 16, MIN_D  = CHIP_R*2 + 14;

  function hitsAvoid(x,y){
    return avoid.some(a => x > a.left-CHIP_R && x < a.right+CHIP_R && y > a.top-CHIP_R && y < a.bottom+CHIP_R);
  }
  function farEnough(x,y){ for(const p of seeds){ if(Math.hypot(x-p.x, y-p.y) < MIN_D) return false; } return true; }

  seeds = []; let i = 0, attempts = 0, maxAttempts = 8000;
  while (i < START_EMOJIS.length && attempts++ < maxAttempts){
    const x = PAD + Math.random()*(vw - PAD*2);
    const y = PAD + Math.random()*(vh - PAD*2);
    if (hitsAvoid(x,y)) continue; if (!farEnough(x,y)) continue;
    seeds.push({ id:crypto.randomUUID(), emoji: START_EMOJIS[i++], x, y });
  }
}

/* Re-scatter on resize if empty bowl */
let resizeT;
window.addEventListener('resize', () => {
  clearTimeout(resizeT);
  resizeT = setTimeout(()=>{ if (placed.length===0){ initSeeds(); renderSeeds(); } }, 120);
});

function renderSeeds(){
  seedsEl.innerHTML='';
  for(const s of seeds){
    const n=document.createElement('button'); n.className='seed';
    n.style.left=s.x+'px'; n.style.top=s.y+'px';
    n.style.setProperty('--delay', `${(-Math.random()*6).toFixed(2)}s`);
    n.style.setProperty('--dur', `${(7+Math.random()*4).toFixed(2)}s`);
    n.style.setProperty('--fx', `${(Math.random()*14-7).toFixed(1)}px`);
    n.style.setProperty('--fy', `${(Math.random()*8-4).toFixed(1)}px`);
    n.dataset.id=s.id; n.innerHTML=`<span class="e">${s.emoji}</span>`;
    n.addEventListener('pointerdown', e=>startDragSeed(e,s.id));
    seedsEl.appendChild(n);
  }
}

/* Picker */
document.getElementById('openPicker').addEventListener('click',()=>picker.open());
picker.addEventListener('emoji-pick',e=>{
  const emo=e.detail.emoji; const pos=spotInsideBowl();
  placed.push({id:crypto.randomUUID(), emoji:emo, x:pos.x, y:pos.y});
  renderPlaced(true);
  scheduleGenerate('picker-add');
});

/* Dragging (always interactive) */
function startDragSeed(ev,id){ ev.preventDefault();
  const idx=seeds.findIndex(s=>s.id===id); if(idx<0) return;
  const ghost=makeGhost(seeds[idx].emoji);
  dragging={type:'seed', idx, emoji:seeds[idx].emoji, ghostEl:ghost};
  pointerMove(ev); addEventListener('pointermove', pointerMove); addEventListener('pointerup', pointerUp);
}
function startDragPlaced(ev,id){ ev.preventDefault();
  const idx=placed.findIndex(p=>p.id===id); if(idx<0) return;
  const ghost=makeGhost(placed[idx].emoji);
  dragging={type:'placed', idx, emoji:placed[idx].emoji, ghostEl:ghost};
  pointerMove(ev); addEventListener('pointermove', pointerMove); addEventListener('pointerup', pointerUp);
}
function makeGhost(emoji){ const g=document.createElement('div'); g.className='chip'; g.style.position='fixed'; g.style.zIndex=9999;
  g.style.transform='translate(-50%,-50%) scale(1.0)'; g.style.boxShadow='var(--shadow-strong), 0 0 0 2px #00c8ff30';
  g.innerHTML=`<span class="e" style="font-size:36px">${emoji}</span>`; document.body.appendChild(g); return g; }
function pointerMove(ev){ if(!dragging) return;
  dragging.ghostEl.style.left=ev.clientX+'px'; dragging.ghostEl.style.top=ev.clientY+'px';
  const {inside}=coordsInCauldron(ev.clientX,ev.clientY);
  dragging.ghostEl.style.transform=`translate(-50%,-50%) scale(${inside?1.26:1.04})`;
  cauldron.classList.toggle('over',inside);
}
function pointerUp(ev){
  if(!dragging) return cleanupDrag();
  const {inside,px,py}=coordsInCauldron(ev.clientX,ev.clientY); cauldron.classList.remove('over');
  if(inside){
    if(dragging.type==='seed'){
      placed.push({id:crypto.randomUUID(), emoji:dragging.emoji, x:px, y:py});
      renderPlaced(true);
      const node=[...seedsEl.children][dragging.idx]; if(node) node.remove(); seeds.splice(dragging.idx,1);
      scheduleGenerate('seed-add');
    }else{ placed[dragging.idx].x=px; placed[dragging.idx].y=py; renderPlaced(false); }
  }else if(dragging.type==='placed'){
    const id=placed[dragging.idx].id; const node=overlay.querySelector(`.placed[data-id="${id}"]`);
    if(node){ node.classList.add('fadeout'); setTimeout(()=>node.remove(),260); }
    placed.splice(dragging.idx,1);
    renderPlaced(false);
    scheduleGenerate('placed-remove');
  }
  cleanupDrag();
}
function cleanupDrag(){ removeEventListener('pointermove', pointerMove); removeEventListener('pointerup', pointerUp); dragging?.ghostEl?.remove(); dragging=null; }

function renderPlaced(playDrop=false){
  overlay.innerHTML='';
  for(const p of placed){
    const n=document.createElement('div'); n.className='placed'; n.dataset.id=p.id;
    n.style.left=p.x+'%'; n.style.top=p.y+'%'; n.innerHTML=`<span class="e">${p.emoji}</span>`;
    if(playDrop) n.classList.add('dropin');
    n.addEventListener('pointerdown', e=>startDragPlaced(e,p.id));
    overlay.appendChild(n);
  }
}

/* Geometry */
function coordsInCauldron(cx,cy){
  const r=cauldron.getBoundingClientRect(); const mx=cx-(r.left+r.width/2); const my=cy-(r.top+r.height/2);
  const inside=Math.hypot(mx,my)<=r.width/2;
  const px=((mx+r.width/2)/r.width)*100; const py=((my+r.height/2)/r.height)*100;
  return {inside, px:Math.max(6,Math.min(94,px)), py:Math.max(6,Math.min(94,py))};
}
function spotInsideBowl(){
  const r=cauldron.getBoundingClientRect(); let tries=0;
  while(tries++<300){ const px=8+Math.random()*84, py=8+Math.random()*84;
    const cx=r.left+px/100*r.width, cy=r.top+py/100*r.height;
    if(Math.hypot(cx-(r.left+r.width/2),cy-(r.top+r.height/2))<r.width/2-40) return {x:px,y:py};
  } return {x:50,y:50};
}

/* ====== Waiting visuals (continuous; no “timer” UI) ====== */
function ensureWaiting(){
  if(!document.body.classList.contains('waiting')){
    document.body.classList.add('waiting');
    cauldron.setAttribute('aria-busy','true');
    statusEl.textContent='Mixing…';

    // ramp blur & shake over ~3s (pure CSS variables)
    document.documentElement.style.setProperty('--shake-ampl','0');
    document.documentElement.style.setProperty('--blur','0px');
    // just touching the class starts CSS animations declared in styles

    // subtle chip pulses inward while waiting
    const bowl=cauldron.getBoundingClientRect(); const cx=50, cy=50;
    for(const p of placed){
      const node=overlay.querySelector(`.placed[data-id="${p.id}"]`); if(!node) continue;
      const dxPct=(cx-p.x)*0.12, dyPct=(cy-p.y)*0.12;
      const ix=dxPct/100*bowl.width, iy=dyPct/100*bowl.height;
      node.style.setProperty('--ix', ix.toFixed(2)+'px'); node.style.setProperty('--iy', iy.toFixed(2)+'px');
      node.classList.add('waitPulse');
    }

    // continuous ambient “sparks” (kept soft; not a timer)
    clearInterval(sparkTimer);
    sparkTimer=setInterval(spawnSparks, 260);
  }
}
function stopWaiting(){
  document.body.classList.remove('waiting');
  cauldron.setAttribute('aria-busy','false');
  statusEl.textContent='';
  clearInterval(sparkTimer);
  document.documentElement.style.setProperty('--shake-ampl','0');
  document.documentElement.style.setProperty('--blur','0px');
}
function spawnSparks(){
  const r=cauldron.getBoundingClientRect();
  const center={x:r.left+r.width/2, y:r.top+r.height/2};
  for(let i=0;i<5;i++){
    const s=document.createElement('div'); s.className='spark';
    const ang=Math.random()*Math.PI*2, dist=(r.width*0.16)+(Math.random()*r.width*0.12);
    const dx=Math.cos(ang)*dist, dy=Math.sin(ang)*dist;
    s.style.position='fixed'; s.style.left=center.x+'px'; s.style.top=center.y+'px';
    s.style.width='10px'; s.style.height='10px'; s.style.borderRadius='50%'; s.style.background='#fff';
    s.style.boxShadow='0 0 16px #9ff4db, 0 0 4px #fff inset'; s.style.opacity='0'; s.style.pointerEvents='none';
    s.animate([
      {transform:'translate(0,0) scale(.6)', opacity:0},
      {opacity:.95, offset:.08},
      {transform:`translate(${dx.toFixed(1)}px, ${dy.toFixed(1)}px) scale(0)`, opacity:0}
    ],{duration:900+Math.random()*400, easing:'var(--ease)', fill:'forwards'});
    document.body.appendChild(s); setTimeout(()=>s.remove(),1200);
  }
}

/* Arrange on rim (keep interactive) */
function arrangeOnRim(){
  const n=placed.length; if(!n) return;
  const cx=50, cy=50, r=44;
  placed.forEach((p,i)=>{
    const ang = -Math.PI/2 + i*(2*Math.PI/n);
    const tx = cx + Math.cos(ang)*r, ty = cy + Math.sin(ang)*r;
    const node=overlay.querySelector(`.placed[data-id="${p.id}"]`); if(!node) return;
    node.classList.remove('waitPulse');
    node.animate([
      {left:p.x+'%', top:p.y+'%', transform:'translate(-50%,-50%) scale(.96)', opacity:1},
      {left:tx+'%', top:ty+'%', transform:'translate(-50%,-50%) scale(.96)', opacity:1}
    ],{duration:560, easing:'cubic-bezier(.2,.8,.2,1)'});
    p.x=tx; p.y=ty; node.style.left=p.x+'%'; node.style.top=p.y+'%';
  });
}

/* Prompt */
function buildElementsList(){ return placed.map(p=>WORDS.get(p.emoji)||`the ${p.emoji} symbol`); }
function buildPrompt(){
  const elements=buildElementsList();
  if(activeKind){ return kindPrompt(activeKind, elements); }
  return `Combine ${elements.join(', ')} into a story-rich, cinematic composition. Show harmony between them in one dramatic movie frame. Interpret emojis as real objects, scenes, colors, or emotions — not glyphs. Coherent lighting and depth. No text.`;
}
function kindPrompt(kind,elements){ if(!elements.length){elements=["a caterpillar","a unicorn","a rainbow"];}
  const join=elements.join(', ');
  const T={
    "🥺":`Render ${join} as soft, oversized plush characters in a toy-box world. Hyper-cute proportions, glossy eyes, pastel lighting, gentle vignetting, cinematic depth of field. No text.`,
    "🤯":`Explode ${join} into a mind-bending collage of fractured geometry and neon afterimages. Motion trails, prismatic aberrations, impossible perspective, energy bursting outward. Single coherent frame. No text.`,
    "🤬":`Depict ${join} as a rebellious street mural mid-creation: spray-paint strokes, ripped posters, bold stencils, chaotic drips. Gritty textures, strong contrast, wide-angle drama. No text.`,
    "😳":`Stage ${join} under a harsh spotlight on an empty stage, caught mid-awkward moment. Blush tones, nervous motion blur, exaggerated expressions; deep shadows and theatrical haze. No text.`,
    "🫣":`Show ${join} peeking from behind objects in a suspenseful scene. Partial reveals, occlusion, layered depth, film-grain, rim lighting, and reflective surfaces. Single frame; no text.`,
    "😬":`Create a cringe-comedy claymation still of ${join}. Hand-made textures, fingerprints, slightly off symmetry, stop-motion lighting and comedic timing. No text.`,
    "🤮":`Fuse ${join} into a gooey monster made of slime and confetti. Viscous translucency, specular highlights, playful gross-out humor—colorful and cartoonish, not realistic gore. No text.`,
    "😈":`Portray ${join} as mischievous heist crew mid-escape: dynamic angles, neon city at night, reflections, cheeky grins, motion blur. Stylish, comic-noir energy. No text.`,
    "🤑":`Transform ${join} into a baroque treasure spectacle: gold leaf, jeweled inlays, reflective metals, extravagant composition, luxurious bokeh. No text.`,
    "💩":`Turn ${join} into slapstick puppets in a messy comedy scene. Over-the-top expressions, splat effects, vibrant props, freeze-frame humor. No text.`,
    "🧓":`Illustrate ${join} as folklore icons woven into an embroidered tapestry. Natural dyes, textile grain, warm candlelight. No text.`,
    "🥷":`Depict ${join} as panels of a high-speed ninja chase, compressed into one dramatic poster. Ink brush motion slashes, moonlit rooftops. No text.`,
    "🧚‍♀️":`Reimagine ${join} in a bioluminescent woodland: tiny fairies, floating spores, iridescent wings, dreamy lens bloom. No text.`,
    "👾":`Glitch-meld ${join} into a retro arcade boss: pixel surfaces, CRT bloom, chroma bleed, synthwave palette, vapor haze. No text.`
  };
  return T[kind] ?? `Combine ${join} into a story-rich, cinematic composition. Show harmony between them in one dramatic movie frame. Interpret emojis as real objects, scenes, colors, or emotions — not glyphs. Coherent lighting and depth. No text.`;
}

/* Pollinations (keyless) */
async function callPollinations(prompt){
  const url="https://image.pollinations.ai/prompt/"+encodeURIComponent(prompt)+"?width=768&height=768";
  const res=await fetch(url,{mode:"cors"}); if(!res.ok) throw new Error('Pollinations error');
  const blob=await res.blob(); return URL.createObjectURL(blob);
}

/* ====== Generation control ====== */
function scheduleGenerate(reason){
  ensureWaiting();
  imageEl.classList.remove('revealed'); // fade old image while waiting new
  if(genTimer) clearTimeout(genTimer);
  genTimer=setTimeout(()=>generateNow(reason), 420); // coalesce quick edits
}
async function generateNow(reason){
  genTimer=null;
  const serial=++genSerial; latestSerial=serial;
  const prompt=buildPrompt();

  try{
    const imgURL=await callPollinations(prompt);
    if(serial!==latestSerial) return;
    imageEl.src=imgURL;
    imageEl.onload=()=>{
      if(serial!==latestSerial) return;
      stopWaiting();
      arrangeOnRim();
      requestAnimationFrame(()=> imageEl.classList.add('revealed'));
    };
  }catch(e){
    console.warn(e);
    stopWaiting();
    statusEl.textContent='Generation failed. Try again.';
  }
}

/* CTA = immediate generate */
cta.addEventListener('click', (e)=>{
  const r=document.createElement('span'); r.className='ripple';
  const rect=e.currentTarget.getBoundingClientRect();
  r.style.setProperty('--x', (e.clientX-rect.left)+'px');
  r.style.setProperty('--y', (e.clientY-rect.top)+'px');
  e.currentTarget.appendChild(r);
  setTimeout(()=>r.remove(),650);

  ensureWaiting(); imageEl.classList.remove('revealed');
  if(genTimer){ clearTimeout(genTimer); genTimer=null; }
  generateNow('cta');
});

/* Cancel = full reset */
cancelBtn.addEventListener('click', resetApp);

/* iOS zoom guard */
document.addEventListener('gesturestart', e=>e.preventDefault());

/* ======= Custom <emoji-picker> ======= */
customElements.define('emoji-picker', class extends HTMLElement {
  #s=this.attachShadow({mode:'closed'}); #data; #cat='all';
  constructor(){ super();
    this.#s.innerHTML=`<style>
      :host{all:initial}
      .p{position:fixed; inset:auto 0 0 0; margin:auto; width:min(860px,96vw); height:min(72vh,760px);
        background:linear-gradient(180deg, #ffffffcc, #f6fbffcc); border:1px solid #ffffffa0; border-radius:18px;
        box-shadow:0 16px 48px rgba(0,0,0,.2), 0 1px 0 rgba(255,255,255,.6) inset; backdrop-filter: blur(12px) saturate(1.05);
        display:grid; grid-template-rows:auto 1fr; opacity:0; transform:translateY(24px) scale(.98); pointer-events:none;
        transition:opacity 180ms cubic-bezier(.2,.7,.2,1), transform 260ms cubic-bezier(.2,.8,.2,1); z-index:99999}
      .show{opacity:1; transform:translateY(0) scale(1); pointer-events:auto}
      .bar{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px;
        background:linear-gradient(180deg,#ffffffee,#f7fbffee); border-bottom:1px solid #ffffffaa; border-top-left-radius:18px; border-top-right-radius:18px;}
      .tabs{display:flex; gap:8px; overflow:auto; padding:0 4px}
      .t,.close{width:42px; height:42px; border-radius:999px; border:1px solid #ffffffc4;
        background:radial-gradient(120% 120% at 30% 30%, #ffffff, #f0f6ff 70%); box-shadow:0 6px 16px rgba(0,0,0,.08), inset 0 1px 0 #ffffff; cursor:pointer; display:grid; place-items:center;}
      .scroller{position:relative; overflow:auto; padding:12px; border-bottom-left-radius:18px; border-bottom-right-radius:18px;}
      .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(48px,1fr)); gap:10px; align-content:start}
      .cell{display:grid; place-items:center; height:54px; border-radius:12px; background:radial-gradient(120% 120% at 30% 30%, #ffffff, #f3f7ff 70%); border:1px solid #ffffffc8; box-shadow:0 1px 0 #ffffff inset;}
      .emo{font-size:34px; line-height:1}
    </style>
    <div class="p">
      <div class="bar"><div class="tabs"></div><button class="close" title="Close">✖️</button></div>
      <div class="scroller"><div class="grid"></div></div>
    </div>`;
  }
  connectedCallback(){
    this.r={root:this.#s.querySelector('.p'),tabs:this.#s.querySelector('.tabs'),grid:this.#s.querySelector('.grid'),scroll:this.#s.querySelector('.scroller'),close:this.#s.querySelector('.close')};
    this.#data=this.#catalog(); this.#tabs(); this.#set('all');
    this.r.close.addEventListener('click',()=>this.close());
  }
  open(){ this.r.root.classList.add('show'); }
  close(){ this.r.root.classList.remove('show'); }
  #tabs(){ this.r.tabs.innerHTML=''; for(const [id,cat] of Object.entries(this.#data)){ const b=document.createElement('button'); b.className='t'; b.dataset.id=id; b.innerHTML=`<span style="font-size:20px">${cat.icon}</span>`; b.onclick=()=>this.#set(id); this.r.tabs.appendChild(b);} }
  #set(id){ this.#cat=id; this.r.grid.innerHTML=''; for(const ch of this.#data[id].items){ const btn=document.createElement('button'); btn.className='cell'; btn.innerHTML=`<span class="emo">${ch}</span>`; btn.onclick=()=>{ this.dispatchEvent(new CustomEvent('emoji-pick',{detail:{emoji:ch},bubbles:true,composed:true})); this.close(); }; this.r.grid.appendChild(btn);} }
  #catalog(){
    const SKA=0x1F3FB, SKB=0x1F3FF;
    const blocks=[[0x1F600,0x1F64F],[0x1F300,0x1F5FF],[0x1F680,0x1F6FF],[0x1F900,0x1F9FF],[0x1FA70,0x1FAFF],[0x2600,0x26FF],[0x2700,0x27BF]];
    const pict=[]; for(const [a,b] of blocks){ for(let cp=a; cp<=b; cp++){ if(cp>=SKA&&cp<=SKB) continue; const ch=String.fromCodePoint(cp); if(!(/\s/.test(ch))) pict.push(ch);} }
    const CODES=("AD AE AF AG AI AL AM AO AQ AR AS AT AU AW AX AZ BA BB BD BE BF BG BH BI BJ BL BM BN BO BQ BR BS BT BV BW BY BZ CA CC CD CF CG CH CI CK CL CM CN CO CR CU CV CW CX CY CZ DE DJ DK DM DO DZ EC EE EG EH ER ES ET FI FJ FK FM FO FR GA GB GD GE GF GG GH GI GL GM GN GP GQ GR GS GT GU GW GY HK HM HN HR HT HU ID IE IL IM IN IO IQ IR IS IT JE JM JO JP KE KG KH KI KM KN KP KR KW KY KZ LA LB LC LI LI LK LR LS LT LU LV LY MA MC MD ME MF MG MH MK ML MM MN MO MP MQ MR MS MT MU MV MW MX MY MZ NA NC NE NF NG NI NL NO NP NR NU NZ OM PA PE PF PG PH PK PL PM PN PR PS PT PW PY QA RE RO RS RU RW SA SB SC SD SE SG SH SI SJ SK SL SM SN SO SR SS ST SV SX SY SZ TC TD TF TG TH TJ TK TL TM TN TO TR TT TV TW TZ UA UG UM US UY UZ VA VC VE VG VI VN VU WF WS XK YE YT ZA ZM ZW").split(" ");
    const RI=0x1F1E6, flag=cc=>String.fromCodePoint(RI+(cc.charCodeAt(0)-65), RI+(cc.charCodeAt(1)-65));
    const flags=CODES.map(flag);
    return { all:{icon:"🧭",items:pict}, flags:{icon:"🏳️",items:flags} };
  }
});
</script>
</body>
</html>