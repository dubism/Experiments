<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Human Sounds ‚Äî Full-Touch Playground</title>
<style>
  :root{
    --bg:#f8fafc; --ink:#1a2230; --muted:#5d6b7c;
    --card:#ffffff; --line:#e6eaf1; --shadow:0 8px 24px rgba(18,24,40,.06), 0 1px 0 rgba(18,24,40,.06);
    --peach:#ffd9c2; --mint:#c9f1e5; --sky:#d6e9ff; --rose:#ffd6e2; --lemon:#fbf3bf; --lilac:#e7dcff; --sage:#dff2d9; --sea:#d4f0ff;
    --accent:#8a8cf7;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font: 16px/1.5 ui-sans-serif, system-ui, Inter, Roboto, "Segoe UI", Helvetica, Arial, sans-serif;
    color:var(--ink); background:var(--bg);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    touch-action:manipulation;
  }
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(8px);
    background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.6));
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:24px 18px}
  h1{margin:0; font-size:28px; letter-spacing:.2px}
  .sub{color:var(--muted); margin-top:6px; font-size:14px}

  .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; margin-top:18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); padding:16px; position:relative}
  .card h2{margin:0 0 10px 0; font-size:16px; letter-spacing:.2px}
  .row{display:flex; flex-wrap:wrap; align-items:center; gap:10px}

  .btn{
    --c:var(--peach);
    appearance:none; border:0; background:var(--c); color:#1a1a1a;
    padding:11px 14px; border-radius:12px; font-weight:700; letter-spacing:.2px; cursor:pointer;
    box-shadow:0 2px 0 rgba(0,0,0,.05) inset, 0 8px 18px rgba(0,0,0,.06);
    transition:filter .15s ease;
    user-select:none; -webkit-tap-highlight-color:transparent;
  }
  .btn.pressed{filter:brightness(.96)}
  .btn.disabled{opacity:.5; pointer-events:none}
  .peach{--c:var(--peach)} .mint{--c:var(--mint)} .sky{--c:var(--sky)} .rose{--c:var(--rose)}
  .lemon{--c:var(--lemon)} .lilac{--c:var(--lilac)} .sage{--c:var(--sage)} .sea{--c:var(--sea)}

  .toggle{position:relative; width:64px; height:34px; background:#e9edf3; border:1px solid var(--line); border-radius:999px; cursor:pointer; transition:background .2s ease}
  .toggle::after{
    content:""; position:absolute; top:3px; left:3px; width:28px; height:28px; background:#fff; border-radius:50%;
    box-shadow:0 4px 10px rgba(0,0,0,.12); transition:transform .2s ease;
  }
  .toggle.on{background:#d9e8ff}
  .toggle.on::after{transform:translateX(30px)}

  .slider{appearance:none; width:100%; height:10px; background:#edf1f6; border-radius:999px; border:1px solid var(--line);}
  .slider::-webkit-slider-thumb{
    appearance:none; width:22px; height:22px; border-radius:50%; background:var(--accent); border:0; cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.15);
  }
  .slider::-moz-range-thumb{ width:22px; height:22px; border-radius:50%; background:var(--accent); border:0; cursor:pointer;}

  .wheel{width:120px; height:120px; border-radius:50%; background:conic-gradient(from 0deg, var(--rose), var(--peach), var(--lemon), var(--mint), var(--sky), var(--lilac), var(--rose)); border:6px solid #fff; box-shadow:var(--shadow); margin:6px auto}

  .toast-wrap{position:fixed; right:14px; bottom:14px; display:flex; flex-direction:column; gap:8px; z-index:50}
  .toast{background:#1f2530; color:#fff; padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); transform:translateY(10px); opacity:0; animation:toast-in .18s ease forwards; max-width:70vw}
  .toast.error{background:#e35050}
  @keyframes toast-in{to{transform:none; opacity:1}}
  @keyframes toast-out{to{transform:translateY(10px); opacity:0}}

  .sheet{position:fixed; inset:0; display:none; grid-template-rows:auto 1fr; z-index:40}
  .scrim{grid-row:1/3; background:rgba(10,12,16,.35)}
  .panel{grid-row:2/3; margin-top:auto; background:#fff; border-top-left-radius:18px; border-top-right-radius:18px; border:1px solid var(--line); box-shadow:var(--shadow); padding:14px; touch-action:none}
  .grab{height:6px; width:64px; border-radius:999px; background:#dfe5ee; margin:6px auto 10px}

  .drag-zone{height:160px; border:2px dashed #dce2ec; border-radius:14px; display:grid; place-items:center; position:relative; overflow:hidden; touch-action:none}
  .pebble{position:absolute; left:14px; top:50%; transform:translateY(-50%); background:#fff; border:1px solid var(--line); border-radius:999px; padding:10px 14px; box-shadow:var(--shadow); cursor:grab; user-select:none; touch-action:none}
  .pebble:active{cursor:grabbing}

  .lab{height:220px; border:1px dashed #dfe5ee; border-radius:14px; display:grid; place-items:center; position:relative; overflow:hidden; touch-action:none}
  .blob{position:absolute; left:50%; top:50%; width:120px; height:120px; border-radius:28px; background:radial-gradient(circle at 35% 35%, #fff, #fff0), var(--rose); border:6px solid #fff; box-shadow:var(--shadow); transform:translate(-50%,-50%) translateZ(0); will-change:transform}

  .stack{display:flex; gap:10px; flex-wrap:wrap}
  .chip{background:#fff; border:1px solid var(--line); border-radius:999px; padding:8px 10px; box-shadow:var(--shadow)}

  footer{margin-top:18px; color:var(--muted)}
  code{background:#eef2f8; padding:2px 6px; border-radius:6px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Human Sounds ‚Äî Full-Touch Playground</h1>
      <div class="sub">Tap, press, drag, fling, pull, pinch, rotate. Every gesture has a voice.</div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- Buttons & states -->
      <div class="card">
        <h2>üéöÔ∏è Buttons & States</h2>
        <div class="row">
          <button class="btn peach" id="btnLaunch">Launch Nimbus</button>
          <button class="btn mint"  id="btnFeather">Feather Drift</button>
          <button class="btn sky"   id="btnGhost">Ghost Walk</button>
          <button class="btn rose"  id="btnUndo">Undo Mischief</button>
          <button class="btn lemon" id="btnDisable">Calm Down</button>
        </div>
        <div class="small" style="margin-top:8px;color:var(--muted)">Down uses a deep click; up varies by style. Undo errors on double-tap.</div>
      </div>

      <!-- Sliders / Scrub / Snap -->
      <div class="card">
        <h2>üß≠ Sliders, Scrub & Snap</h2>
        <div style="display:grid; gap:10px">
          <div>
            <div class="label">Spin ‚Äî <span id="spinVal">0</span>¬∞</div>
            <input id="spin" class="slider" type="range" min="0" max="360" value="0"/>
            <div class="wheel" id="wheel"></div>
          </div>
          <div>
            <div class="label">Scrub (friction)</div>
            <input id="scrub" class="slider" type="range" min="0" max="100" value="35"/>
          </div>
          <div>
            <div class="label">Snap Knob</div>
            <input id="snap" class="slider" type="range" min="0" max="100" value="0"/>
          </div>
        </div>
      </div>

      <!-- Toggles -->
      <div class="card">
        <h2>üåó Toggles</h2>
        <div class="row">
          <div>
            <div class="label">Glow</div>
            <div id="tglGlow" class="toggle" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
          <div>
            <div class="label">Anchor</div>
            <div id="tglAnchor" class="toggle" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
          <div>
            <div class="label">Whisper</div>
            <div id="tglWhisper" class="toggle" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
        </div>
      </div>

      <!-- Pull to refresh sheet -->
      <div class="card">
        <h2>ü™Ñ Pull & Sheet</h2>
        <div class="row">
          <button class="btn lilac" id="openSheet">Summon Nova</button>
          <button class="btn sage"  id="spawnToast">Say Hi</button>
          <button class="btn sea"   id="meltChip">Melt Away</button>
        </div>
        <div class="small" style="margin-top:8px">Pull the sheet by the grab handle; overscroll springs. Release above threshold to refresh.</div>
      </div>

      <!-- Sticky Drag -->
      <div class="card">
        <h2>üß≤ Sticky Drag</h2>
        <div class="drag-zone" id="dragZone">
          <div class="pebble" id="pebble">Pebble</div>
        </div>
        <div class="small" style="margin-top:8px">Drag and fling. Subtle friction loop plays while moving.</div>
      </div>

      <!-- Gesture Lab: pinch / rotate / long-press / double-tap -->
      <div class="card">
        <h2>üß™ Gesture Lab</h2>
        <div class="lab" id="lab">
          <div class="blob" id="blob"></div>
        </div>
        <div class="small" style="margin-top:8px">Try: double-tap (ping), press-and-hold (long hey), pinch to scale, two-finger rotate, edge-fling (error).</div>
      </div>

      <!-- Chips stack to show appear/vanish slow -->
      <div class="card">
        <h2>üç¨ Chips</h2>
        <div class="stack" id="stack"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn peach" id="addChip">Sprout Chip</button>
          <button class="btn rose" id="clearChips">Send Away</button>
        </div>
      </div>

    </section>

    <footer>
      <p class="small">Available clips: <code id="avail"></code></p>
    </footer>
  </main>

  <div class="toast-wrap" id="toasts"></div>

  <!-- Bottom Sheet -->
  <div class="sheet" id="sheet" aria-hidden="true">
    <div class="scrim" id="scrim"></div>
    <div class="panel" id="panel">
      <div class="grab"></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Nova</strong>
        <button class="btn mint" id="dismissSheet">Banish</button>
      </div>
      <p class="small" style="margin-top:6px">Pull me. Cross the line to refresh.</p>
      <div class="row" style="margin-top:8px">
        <span class="chip">alpha</span>
        <span class="chip">beta</span>
        <span class="chip">gamma</span>
      </div>
    </div>
  </div>

<script>
const INCLUDED = new Set(["clip_001", "clip_002", "clip_003", "clip_004", "clip_006", "clip_008", "clip_010", "clip_013", "clip_017", "clip_018", "clip_019", "clip_020", "clip_021", "clip_022", "clip_023", "clip_024", "clip_025"]);

// Full mapping
const CLIPS = {
  error: "clip_001",
  clickA: "clip_002",
  vanishSlow: "clip_003",
  goAway: "clip_004",
  arrive: "clip_006",
  heyShort: "clip_008",
  rotate: "clip_010",
  heyLong: "clip_013",
  clickB: "clip_017",
  clickC: "clip_018",
  clickD: "clip_019",
  clickDown: "clip_020",
  sticky1: "clip_021",
  sticky2: "clip_022",
  sticky3: "clip_023",
  clickE: "clip_024",
  tap: "clip_025",
};

function res(id) { return INCLUDED.has(id) ? id : null; }
function pool(id, voices=6) {
  id = res(id);
  const src = id ? `sounds/${id}.wav` : null;
  const v = [];
  for (let i=0;i<voices;i++) { const a = new Audio(src||""); a.preload="auto"; v.push(a); }
  let idx=0;
  return {
    play(opts={}) {
      if (!src) return;
      const a = v[idx++ % v.length];
      try {
        a.pause(); a.currentTime=0;
        a.playbackRate = opts.rate ?? 1;
        a.volume = Math.max(0, Math.min(1, opts.vol ?? 1));
        a.play();
      } catch(e){}
    }
  };
}

// Build pools
const audio = {
  error: pool(CLIPS.error),
  clickA: pool(CLIPS.clickA),
  clickB: pool(CLIPS.clickB),
  clickC: pool(CLIPS.clickC),
  clickD: pool(CLIPS.clickD),
  clickE: pool(CLIPS.clickE),
  clickDown: pool(CLIPS.clickDown),
  vanishSlow: pool(CLIPS.vanishSlow),
  goAway: pool(CLIPS.goAway),
  arrive: pool(CLIPS.arrive),
  heyShort: pool(CLIPS.heyShort),
  heyLong: pool(CLIPS.heyLong),
  rotate: pool(CLIPS.rotate),
  sticky1: pool(CLIPS.sticky1),
  sticky2: pool(CLIPS.sticky2),
  sticky3: pool(CLIPS.sticky3),
};

// Helpers
const toasts = document.getElementById('toasts');
function toast(text, kind="ok", life=1800) {
  const el = document.createElement('div');
  el.className = 'toast' + (kind==="error" ? ' error' : '');
  el.textContent = text;
  toasts.appendChild(el);
  setTimeout(()=>{ el.style.animation = 'toast-out .18s ease forwards'; }, life);
  setTimeout(()=>{ el.remove(); }, life+220);
}

function springValue(start, target, opts={}) {
  // 1D spring (mass-spring-damper). Returns controller with setTarget(new), stop().
  let x = start, v = opts.v0 ?? 0;
  let k = opts.k ?? 100, c = opts.c ?? 18, m = opts.m ?? 1;
  let t = target, active = true;
  let last = performance.now();
  function step() {
    if (!active) return;
    const now = performance.now();
    const dt = Math.min(0.032, (now - last)/1000); last = now;
    const F = -k*(x - t) - c*v;
    const a = F / m;
    v += a*dt; x += v*dt;
    if (Math.abs(v) < 0.001 && Math.abs(x - t) < 0.2) { x = t; active = false; }
    opts.onUpdate?.(x);
    if (active) requestAnimationFrame(step);
    else opts.onComplete?.(x);
  }
  requestAnimationFrame(step);
  return {
    setTarget(nt) { t = nt; if (!active) { active = true; last = performance.now(); requestAnimationFrame(step); } },
    stop() { active = false; },
    get value() { return x; }
  };
}

// Button behaviors: press (down) plays heavy click, release plays style-dependent click.
function bindButton(el, upSound) {
  let pressed = false;
  el.addEventListener('pointerdown', ()=>{ pressed = true; el.classList.add('pressed'); audio.clickDown.play(); });
  el.addEventListener('pointerup', ()=>{ if (!pressed) return; pressed = false; el.classList.remove('pressed'); upSound.play(); });
  el.addEventListener('pointerleave', ()=>{ if (!pressed) return; pressed=false; el.classList.remove('pressed'); audio.clickE.play(); });
  el.addEventListener('dblclick', (e)=>{ e.preventDefault(); audio.error.play(); toast('Nope, that was too eager.', 'error', 1400); });
}

// BUTTONS
const btnLaunch = document.getElementById('btnLaunch');
const btnFeather= document.getElementById('btnFeather');
const btnGhost  = document.getElementById('btnGhost');
const btnUndo   = document.getElementById('btnUndo');
const btnDisable= document.getElementById('btnDisable');

bindButton(btnLaunch, audio.clickA);
bindButton(btnFeather, audio.clickB);
bindButton(btnGhost,   audio.clickC);
bindButton(btnUndo,    audio.clickD);
bindButton(btnDisable, audio.clickE);

btnLaunch.addEventListener('click', ()=>{ audio.arrive.play(); toast('Nimbus launched ‚ú®', 'ok', 1200); });
btnFeather.addEventListener('click', ()=>{ btnFeather.animate([{transform:'translateY(0)'},{transform:'translateY(-4px)'},{transform:'translateY(0)'}], {duration:160}); });
btnGhost.addEventListener('click', ()=>{ btnGhost.animate([{opacity:1},{opacity:.4},{opacity:1}], {duration:200}); });
btnUndo.addEventListener('click', ()=>{ toast('Undo‚Ä¶? hold to confirm', 'ok', 1200); });

let disabled=false;
btnDisable.addEventListener('click', ()=>{ disabled = !disabled; [btnLaunch,btnFeather,btnGhost,btnUndo].forEach(b=>b.classList.toggle('disabled', disabled)); });

// Long-press on Undo to confirm
let lpTimer=null;
btnUndo.addEventListener('pointerdown', ()=>{ lpTimer=setTimeout(()=>{ audio.heyLong.play(); toast('Undone.', 'ok', 1200); }, 520); });
['pointerup','pointerleave','pointercancel'].forEach(t=>btnUndo.addEventListener(t, ()=>{ clearTimeout(lpTimer); }));

// Sliders
const wheel = document.getElementById('wheel');
const spin = document.getElementById('spin'); const spinVal = document.getElementById('spinVal');
spin.addEventListener('input', e=>{ const v=+e.target.value; spinVal.textContent=v; wheel.style.transform = `rotate(${v}deg)`; if ((Date.now()%260)<40) audio.rotate.play({rate:.9 + v/480}); });

const scrub = document.getElementById('scrub');
let scrubTick=0;
scrub.addEventListener('input', ()=>{ const now=performance.now(); if(now-scrubTick>180){ [audio.sticky1,audio.sticky2,audio.sticky3][Math.floor(Math.random()*3)].play({vol:.7, rate:.96 + Math.random()*.12}); scrubTick=now; } });

// Snap slider: springs to nearest of [0, 50, 100]
const snap = document.getElementById('snap');
let snapSpr=null;
snap.addEventListener('change', ()=>{ const v = +snap.value; const t = Math.abs(v-50)<25 ? 50 : (v<50?0:100); if (snapSpr) snapSpr.stop(); snapSpr = springValue(v, t, {k: 80, c: 16, onUpdate:(x)=>{ snap.value = x; }, onComplete:()=>{ audio.clickA.play(); }}); });

// Toggles
function bindToggle(id) {
  const el = document.getElementById(id);
  const set = (on)=>{ el.classList.toggle('on', on); el.setAttribute('aria-checked', on?'true':'false'); };
  el.addEventListener('click', ()=>{ const on=!el.classList.contains('on'); set(on); (on?audio.clickA:audio.clickE).play(); });
  el.addEventListener('keydown', (e)=>{ if (e.key===' '||e.key==='Enter') { e.preventDefault(); const on=!el.classList.contains('on'); set(on); (on?audio.clickB:audio.clickC).play(); } });
}
bindToggle('tglGlow'); bindToggle('tglAnchor'); bindToggle('tglWhisper');

// Bottom sheet with pull
const sheet = document.getElementById('sheet');
const scrim = document.getElementById('scrim');
const panel = document.getElementById('panel');
const openSheet = document.getElementById('openSheet');
const dismissSheet = document.getElementById('dismissSheet');
let sheetY=0, sheetStartY=0, sheetDrag=false, refreshThreshold=140;
function openS(){ sheet.style.display='grid'; panel.style.transform='translateY(100%)'; audio.arrive.play(); springValue(100, 0, {k:120,c:18,onUpdate:(y)=>panel.style.transform=`translateY(${y}%)`}); }
function closeS(sound='goAway'){ springValue(sheetY, 100, {k:120,c:18,onUpdate:(y)=>{ sheetY=y; panel.style.transform=`translateY(${y}%)`; }, onComplete:()=>{ sheet.style.display='none'; audio[sound]?.play(); }}); }

openSheet.addEventListener('click', openS);
dismissSheet.addEventListener('click', ()=>closeS('vanishSlow'));
scrim.addEventListener('click', ()=>closeS('goAway'));

let lastY=0, vY=0, lastT=0;
panel.addEventListener('pointerdown', (e)=>{ sheetDrag=true; panel.setPointerCapture(e.pointerId); sheetStartY=sheetY; lastY=e.clientY; lastT=performance.now(); });
panel.addEventListener('pointermove', (e)=>{
  if(!sheetDrag) return;
  const dy = Math.max(0, e.clientY - lastY);
  const now=performance.now(); const dt=now-lastT; vY = dt>0 ? dy/dt : 0; lastT=now; lastY=e.clientY;
  sheetY = Math.max(0, Math.min(100, sheetStartY + (dy/3))); // resistance
  panel.style.transform=`translateY(${sheetY}%)`;
  if ((now%260)<30) [audio.sticky1,audio.sticky2,audio.sticky3][Math.floor(Math.random()*3)].play({vol:.5});
});
panel.addEventListener('pointerup', ()=>{
  sheetDrag=false;
  if (sheetY>80 || vY>0.9) return closeS('goAway');
  if (sheetY> (refreshThreshold/3)) {
    if (sheetY > (refreshThreshold/1.2)/3) { audio.heyShort.play(); toast('Refreshing‚Ä¶', 'ok', 900); setTimeout(()=>audio.vanishSlow.play(), 900); }
    return springValue(sheetY, 0, {k:160,c:22,onUpdate:(y)=>{ sheetY=y; panel.style.transform=`translateY(${y}%)`; }});
  }
  springValue(sheetY, 0, {k:160,c:22,onUpdate:(y)=>{ sheetY=y; panel.style.transform=`translateY(${y}%)`; }});
});

// Toast buttons
const spawnToast = document.getElementById('spawnToast');
spawnToast.addEventListener('click', ()=>{ audio.heyShort.play(); toast('hey üëã', 'ok', 1200); });
const meltChip = document.getElementById('meltChip');
meltChip.addEventListener('click', ()=>{ audio.goAway.play(); const chip = document.createElement('div'); chip.className='toast'; chip.textContent='Melting‚Ä¶'; toasts.appendChild(chip); setTimeout(()=>{ chip.style.animation='toast-out .18s ease forwards'; audio.vanishSlow.play(); }, 600); setTimeout(()=>{ chip.remove(); }, 860); });

// Sticky Drag pebble
const zone = document.getElementById('dragZone');
const pebble = document.getElementById('pebble');
let dragging=false, dx=0, vy=0, vx=0, last=0, lastPt={x:0,y:0};
pebble.addEventListener('pointerdown', (e)=>{ dragging=true; pebble.setPointerCapture(e.pointerId); const r=pebble.getBoundingClientRect(); dx = (e.clientX - r.left); last=performance.now(); lastPt={x:e.clientX,y:e.clientY}; audio.sticky1.play(); });
window.addEventListener('pointermove', (e)=>{
  if(!dragging) return;
  const now=performance.now(); const dt=(now-last)/1000; last=now;
  const zoneR=zone.getBoundingClientRect();
  let nx = Math.max(8, Math.min(zoneR.width-96, e.clientX - dx - zoneR.left));
  pebble.style.left = nx + 'px';
  vx = (e.clientX - lastPt.x) / Math.max(0.001, (now - last+0.0001));
  vy = (e.clientY - lastPt.y) / Math.max(0.001, (now - last+0.0001));
  lastPt={x:e.clientX,y:e.clientY};
  if ((now%500)<40) [audio.sticky1,audio.sticky2,audio.sticky3][Math.floor(Math.random()*3)].play({vol:.45});
});
window.addEventListener('pointerup', ()=>{ dragging=false; });

// Gesture Lab
const lab = document.getElementById('lab');
const blob = document.getElementById('blob');
let pointers = new Map();
let blobState = {x:0,y:0, scale:1, rot:0}; // relative
function setBlob(){ blob.style.transform = `translate(-50%,-50%) translate(${blobState.x}px, ${blobState.y}px) rotate(${blobState.rot}deg) scale(${blobState.scale})`; }
function randSticky(){ [audio.sticky1,audio.sticky2,audio.sticky3][Math.floor(Math.random()*3)].play({vol:.5}); }

let lastPing=0;
lab.addEventListener('pointerdown', (e)=>{
  lab.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
  const now=performance.now();
  if (now - lastPing < 280) { audio.heyShort.play(); toast('ping', 'ok', 800); }
  lastPing = now;
  // long press
  e.target._lp && clearTimeout(e.target._lp);
  e.target._lp = setTimeout(()=>{ audio.heyLong.play(); toast('long press', 'ok', 900); }, 600);
});

lab.addEventListener('pointermove', (e)=>{
  if (!pointers.has(e.pointerId)) return;
  const prev = pointers.get(e.pointerId);
  pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
  const ps = Array.from(pointers.values());
  if (ps.length===1) {
    // drag
    blobState.x += (e.clientX - prev.x)*0.9;
    blobState.y += (e.clientY - prev.y)*0.9;
    setBlob();
    if ((performance.now()%420)<40) randSticky();
  } else if (ps.length===2) {
    const [p1,p2] = ps;
    const dist = Math.hypot(p1.x-p2.x,p1.y-p2.y);
    const ang = Math.atan2(p2.y-p1.y, p2.x-p1.x) * 180/Math.PI;
    if (!lab._gesture) {
      lab._gesture = {startDist:dist, startAng:ang, startScale:blobState.scale, startRot:blobState.rot};
      audio.arrive.play();
    } else {
      blobState.scale = Math.min(2.2, Math.max(.6, lab._gesture.startScale * (dist / lab._gesture.startDist)));
      const dAng = ang - lab._gesture.startAng;
      blobState.rot = lab._gesture.startRot + dAng;
      setBlob();
      if ((performance.now()%300)<40) audio.rotate.play({rate: 0.95 + Math.random()*0.2});
    }
  }
});

function endPointer(e){ clearTimeout(e.target._lp); pointers.delete(e.pointerId);
  if (pointers.size===0) {
    // spring back toward center
    springValue(blobState.x, 0, {k:80,c:18,onUpdate:(x)=>{ blobState.x=x; setBlob(); }});
    springValue(blobState.y, 0, {k:80,c:18,onUpdate:(y)=>{ blobState.y=y; setBlob(); }});
    springValue(blobState.scale, 1, {k:140,c:20,onUpdate:(s)=>{ blobState.scale=s; setBlob(); }});
    springValue(blobState.rot, 0, {k:90,c:18,onUpdate:(r)=>{ blobState.rot=r; setBlob(); }});
    audio.goAway.play();
  }
}
lab.addEventListener('pointerup', endPointer);
lab.addEventListener('pointercancel', endPointer);
lab.addEventListener('pointerleave', endPointer);

// Edge fling error
lab.addEventListener('pointerup', (e)=>{
  const r = lab.getBoundingClientRect();
  if (e.clientX < r.left+8 || e.clientX > r.right-8 || e.clientY < r.top+8 || e.clientY > r.bottom-8) {
    audio.error.play(); toast('edge crash', 'error', 1000);
  }
});

// Chips stack
const stack = document.getElementById('stack');
const addChip = document.getElementById('addChip');
const clearChips = document.getElementById('clearChips');
let chipId=1;
addChip.addEventListener('click', ()=>{ const c=document.createElement('span'); c.className='chip'; c.textContent='seed '+(chipId++); stack.appendChild(c); audio.arrive.play(); });
clearChips.addEventListener('click', ()=>{ audio.vanishSlow.play(); stack.innerHTML=''; });

// Available list
document.getElementById('avail').textContent = Array.from(INCLUDED).sort().join(', ');

// Unlock on first interaction silently (iOS)
let unlocked=false; function unlock(){ if(unlocked) return; unlocked=true; audio.clickA.play({vol:.0001}); } window.addEventListener('pointerdown', unlock, {once:true});
</script>
</body>
</html>
