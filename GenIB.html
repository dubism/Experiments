<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Italian Brainrot — character groups (3-emoji iso-triangle) — realistic animated</title>
<style>
  :root{
    --t1:#7fd1ff40; --t2:#ff86d640; --t3:#7dffcc40; --t4:#b59bff40;
    --ring2:#00000012; --shadow:0 8px 24px #0000001e,0 2px 8px #00000012;
    --shadow-strong:0 14px 40px #00000026,0 4px 16px #0000001f;
    --ease:cubic-bezier(.2,.8,.2,1);
    --shake-ampl:0; --blur:0px;
    --chip-size:clamp(56px, 12vmin, 88px);   /* fix: force perfect circle, avoid ellipse */
  }
  @property --shake-ampl{syntax:'<number>';initial-value:0;inherits:false}
  @property --blur{syntax:'<length>';initial-value:0px;inherits:false}

  html,body{height:100%;margin:0}
  body{
    background:
      radial-gradient(60vmax 60vmax at 15% 10%, var(--t1), transparent 60%),
      radial-gradient(70vmax 60vmax at 85% 20%, var(--t2), transparent 60%),
      radial-gradient(60vmax 70vmax at 20% 85%, var(--t3), transparent 60%),
      radial-gradient(70vmax 70vmax at 80% 85%, var(--t4), transparent 60%),
      conic-gradient(from 0deg at 50% 50%, #e9f3ff, #ffe9f7, #e9fff6, #f7f3ff, #e9f3ff);
    background-attachment:fixed; animation:hue 24s linear infinite alternate;
    overflow:hidden; -webkit-tap-highlight-color:transparent;
    user-select:none; color:#0a0b0d;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
  }
  @keyframes hue{to{filter:hue-rotate(12deg) saturate(1.05)}}

  .stage{
    position:fixed; inset:0;
    display:grid; grid-template-rows:1fr auto auto;
    gap:10px; padding:10px 12px calc(env(safe-area-inset-bottom,16px) + 6px);
  }

  /* ---------- Bowl ---------- */
  .centerWrap{ display:grid; place-items:center; min-height:0 }
  .cauldron-wrap{
    position:relative; width:min(64vmin,520px); aspect-ratio:1;
    display:grid; place-items:center;
  }
  @media (max-height:740px){ .cauldron-wrap{ width:min(56vmin,460px); } }
  @media (max-height:640px){ .cauldron-wrap{ width:min(50vmin,420px); } }

  .cauldron{
    position:relative; width:100%; height:100%; border-radius:50%;
    background:radial-gradient(120% 120% at 70% 30%, #ffffffc0, #ffffff60 45%, #ffffff30 60%, #ffffff12 75%, #ffffff06 100%);
    box-shadow:var(--shadow-strong), inset 0 1px 0 #ffffffa0, inset 0 -20px 60px #0000000b;
    outline:1px solid var(--ring2);
    overflow:hidden; display:grid; place-items:center;
  }
  .ring{ position:absolute; inset:6%; border-radius:50%; border:1px dashed #00000018; outline:1px solid #ffffff90; outline-offset:-1px; box-shadow:inset 0 0 0 6px #ffffff10; pointer-events:none }
  .cauldron.over{ box-shadow:0 0 0 12px #00c8ff30, var(--shadow-strong) }

  .brew{ position:absolute; inset:0; border-radius:50%; overflow:hidden; filter:blur(var(--blur)) saturate(1.06); }
  .liquid, .beams { position:absolute; inset:10%; border-radius:50%; pointer-events:none; }
  .liquid{
    opacity:.25;
    background:
      radial-gradient(40% 60% at 30% 30%, #ffffffd0, #ffffff10 70%),
      conic-gradient(from 0deg, #bffbe7 0 40%, #dfe8ff 40% 70%, #ffdff2 70% 100%);
    mix-blend-mode:soft-light; filter:saturate(1.05);
  }
  .beams{ opacity:0; }

  /* ===== States ===== */
  @keyframes suspensePulse { 0%{transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }
  .suspense .cauldron{ animation:suspensePulse 500ms ease-in-out infinite; }

  .cauldron.req-blip::after{
    content:""; position:absolute; inset:5%; border-radius:50%;
    box-shadow:0 0 0 0 #00c8ff66, 0 0 30px #00c8ff44 inset;
    animation:reqPulse 320ms cubic-bezier(.2,.8,.2,1) both;
  }
  @keyframes reqPulse {
    0%{ box-shadow:0 0 0 0 #00c8ff66, 0 0 30px #00c8ff44 inset; }
    70%{ box-shadow:0 0 0 12px #00c8ff00, 0 0 40px #00c8ff66 inset; }
    100%{ box-shadow:0 0 0 18px #00c8ff00, 0 0 0 #00c8ff00 inset; }
  }

  @keyframes breatheSpin { 0%{transform:scale(.992) rotate(-.8deg)} 50%{transform:scale(1.008) rotate(.8deg)} 100%{transform:scale(.992) rotate(-.8deg)} }
  .waiting .brew{ animation: breatheSpin 2.4s ease-in-out infinite; }
  @keyframes swirl{to{transform:rotate(360deg)}}
  .waiting .liquid{ opacity:.9; animation:swirl 3.6s linear infinite; }
  @keyframes beams{to{transform:rotate(-360deg)}}
  .waiting .beams{ opacity:.8; animation:beams 2.6s linear infinite; filter:blur(6px); }
  @keyframes rampVars { from{ --shake-ampl:0; --blur:0px; } to{ --shake-ampl:1; --blur:3px; } }
  .waiting{ animation: rampVars 3s ease-in-out forwards; }
  @keyframes shake-linear{
    0%  { transform: translate( calc( 0px * var(--shake-ampl)),  calc( 0px * var(--shake-ampl))); }
    12% { transform: translate( calc( 2px * var(--shake-ampl)),  calc(-2px * var(--shake-ampl))); }
    25% { transform: translate( calc(-2px * var(--shake-ampl)),  calc( 2px * var(--shake-ampl))); }
    37% { transform: translate( calc( 2px * var(--shake-ampl)),  calc( 2px * var(--shake-ampl))); }
    50% { transform: translate( calc(-2px * var(--shake-ampl)),  calc(-2px * var(--shake-ampl))); }
    62% { transform: translate( calc( 1px * var(--shake-ampl)),  calc(-1px * var(--shake-ampl))); }
    75% { transform: translate( calc(-1px * var(--shake-ampl)),  calc( 1px * var(--shake-ampl))); }
    87% { transform: translate( calc( 1px * var(--shake-ampl)),  calc( 1px * var(--shake-ampl))); }
    100%{ transform: translate( calc( 0px * var(--shake-ampl)),  calc( 0px * var(--shake-ampl))); }
  }
  .waiting .cauldron-wrap{ animation:shake-linear 700ms linear infinite; }

  .freeze .cauldron-wrap,
  .freeze .cauldron,
  .freeze .brew,
  .freeze .liquid,
  .freeze .beams{ animation:none !important }
  .freeze .beams{ opacity:0 !important }
  .freeze .cauldron.req-blip::after{ display:none !important }

  /* Image */
  .image-wrap{ position:absolute; inset:0; border-radius:50%; overflow:hidden; z-index:10; }
  .result-img{
    width:100%; height:100%; object-fit:cover; display:block;
    opacity:0; transform:scale(.2);
    transition:opacity .6s var(--ease), transform .9s cubic-bezier(.22,1.2,.22,1);
    pointer-events:auto; -webkit-touch-callout:default; user-select:none;
  }
  .result-img.revealed{ opacity:1; transform:scale(1) }

  /* Layers */
  .overlay{ position:absolute; inset:0; z-index:30; }
  .seeds{ position:fixed; inset:0; z-index:25; pointer-events:none; }

  .seed,.chip,.plus,.cancel{
    width:56px; height:56px; border-radius:50%;
    display:grid; place-items:center; user-select:none;
    background:radial-gradient(120% 120% at 30% 30%, #ffffffcc, #ffffff9a 60%, #ffffff7a 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffffc8, 0 0 0 1px #0001;
    touch-action:none;
  }
  .seed{ position:absolute; transform:translate(-50%,-50%); pointer-events:auto; animation:float var(--dur,9s) ease-in-out infinite var(--delay,0s); }
  @keyframes float{
    0%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px)))} 
    50%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px) - 6px))}
    100%{transform:translate(calc(-50% + var(--fx,0px)), calc(-50% + var(--fy,0px)))}
  }

  .placed{
    position:absolute; width:var(--chip-size); height:var(--chip-size); border-radius:50%;
    display:grid; place-items:center; cursor:grab; pointer-events:auto;
    background:radial-gradient(120% 120% at 30% 30%, #ffffffc0, #ffffff80 60%, #ffffff50 100%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffffb8;
    transform:translate(-50%,-50%) scale(1);
    transition:transform .25s var(--ease), opacity .25s var(--ease), box-shadow .2s var(--ease);
    touch-action:none;
  }
  .placed:active{ transform:translate(-50%,-50%) scale(.95); box-shadow:0 0 0 2px #00c8ff33, var(--shadow) }
  .placed.dropin{ animation:drop .38s var(--ease) }
  @keyframes drop{0%{transform:translate(-50%,-50%) scale(.72)}70%{transform:translate(-50%,-50%) scale(1.14)}100%{transform:translate(-50%,-50%) scale(1)}}

  .waitPulse{ animation:chipPulse 1.8s ease-in-out infinite; }
  @keyframes chipPulse{
    0%  { transform:translate(calc(-50% + 0px),   calc(-50% + 0px)) scale(1);    opacity:1 }
    50% { transform:translate(calc(-50% + var(--ix,0px)), calc(-50% + var(--iy,0px))) scale(.94); opacity:.9 }
    100%{ transform:translate(calc(-50% + 0px),   calc(-50% + 0px)) scale(1);    opacity:1 }
  }

  /* triangle composition (exactly three emoji) */
  .tri{ position:relative; width:100%; height:100%; }
  .tri .e{ position:absolute; line-height:1; }
  .placed .tri .e{ font-size:clamp(18px, 3.6vmin, 26px); }
  .seed   .tri .e{ font-size:20px; }
  .chip   .tri .e{ font-size:22px; }
  /* equilateral-ish points */
  .tri .a{ left:50%; top:22%; transform:translate(-50%,-50%); }
  .tri .b{ left:28%; top:72%; transform:translate(-50%,-50%); }
  .tri .c{ left:72%; top:72%; transform:translate(-50%,-50%); }

  /* ---------- Buttons ---------- */
  .footer{
    display:flex; gap:14px; align-items:center; justify-content:center;
    padding-top:2px;
  }
  .circle-btn{ width:72px; height:72px; min-width:72px; min-height:72px; border-radius:50%; display:grid; place-items:center; cursor:pointer; user-select:none; touch-action:manipulation; }
  @media (max-height:640px){ .circle-btn{ width:64px; height:64px; min-width:64px; min-height:64px; } }
  .plus{ transition:transform .18s var(--ease); }
  .plus:active{ transform:scale(.96) }

  /* ---------- Carousel (story points) ---------- */
  .kindWrap{ display:grid; place-items:center; }
  .kindShell{
    width:min(92vw, 820px);
    background:linear-gradient(180deg,#ffffffee,#f6fbffee);
    border:1px solid #ffffffcc; border-radius:18px;
    box-shadow:
      0 20px 36px rgba(0,0,0,.18),
      0 2px 0 rgba(255,255,255,.7) inset,
      0 -10px 30px rgba(0,0,0,.06) inset;
    backdrop-filter:saturate(1.05) blur(8px);
    transform:perspective(1000px) rotateX(6deg);
  }
  .kindRail{
    display:flex; gap:16px; padding:12px 20px;
    overflow-x:auto; overflow-y:hidden;
    scroll-snap-type:x mandatory; scroll-snap-stop:always;
    -webkit-overflow-scrolling:touch;
    touch-action:pan-x;
    overscroll-behavior-x:contain; overscroll-behavior-y:none;
  }
  .kindRail::-webkit-scrollbar{display:none}
  .spacer{ flex:0 0 50vw; }
  .kchip{
    flex:0 0 auto; width:64px; height:64px; border-radius:50%;
    display:grid; place-items:center; scroll-snap-align:center;
    background:radial-gradient(120% 120% at 30% 30%, #ffffff, #f0f6ff 70%);
    box-shadow:var(--shadow), inset 0 1px 0 #ffffff;
    transform:translateZ(0) scale(.9);
    transition:transform .18s var(--ease), filter .18s var(--ease), box-shadow .18s var(--ease);
    position:relative; touch-action:manipulation;
  }
  .kchip .e{font-size:34px}
  .kchip:active{ transform:scale(.86) }
  .kchip.active{
    transform:scale(1.32) translateZ(20px);
    box-shadow:0 22px 48px rgba(100,150,255,.30), 0 0 0 2px #ffffff inset, 0 0 0 10px #a6d1ff66;
    filter:saturate(1.25);
  }
  .kchip.active::after{
    content:""; position:absolute; inset:-22%; border-radius:50%;
    background:conic-gradient(#b8f0ff66, #e9d0ff66, #b8f0ff66);
    mix-blend-mode:overlay; animation:shine 4s linear infinite; pointer-events:none;
  }
  @keyframes shine{to{transform:rotate(360deg)}}

  /* ---- Character picker ---- */
  character-picker::part(panel){
    position:fixed; inset:auto 0 0 0; margin:auto; width:min(900px,96vw); height:min(76vh,800px);
    background:linear-gradient(180deg, #ffffffcc, #f6fbffcc);
    border:1px solid #ffffffa0; border-radius:18px;
    box-shadow:0 16px 48px rgba(0,0,0,.2), 0 1px 0 rgba(255,255,255,.6) inset; backdrop-filter: blur(12px) saturate(1.05);
    opacity:0; transform:translateY(24px) scale(.98); pointer-events:none;
    transition:opacity 180ms cubic-bezier(.2,.7,.2,1), transform 260ms cubic-bezier(.2,.8,.2,1); z-index:99999;
    display:grid; grid-template-rows:auto 1fr;
  }
  character-picker[open]::part(panel){opacity:1; transform:translateY(0) scale(1); pointer-events:auto}
  character-picker::part(bar){display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px;
    background:linear-gradient(180deg,#ffffffee,#f7fbffee); border-bottom:1px solid #ffffffaa; border-top-left-radius:18px; border-top-right-radius:18px;}
  character-picker::part(close){width:42px; height:42px; border-radius:999px; border:1px solid #ffffffc4;
    background:radial-gradient(120% 120% at 30% 30%, #ffffff, #f0f6ff 70%); box-shadow:0 6px 16px rgba(0,0,0,.08), inset 0 1px 0 #ffffff; cursor:pointer; display:grid; place-items:center;}
  character-picker::part(scroll){position:relative; overflow:auto; padding:12px; border-bottom-left-radius:18px; border-bottom-right-radius:18px;}
  character-picker::part(grid){display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; align-content:start}
  character-picker::part(card){
    display:grid; grid-template-rows:auto auto; gap:6px;
    border-radius:14px; border:1px solid #ffffffc8; background:radial-gradient(120% 120% at 30% 30%, #ffffff, #f3f7ff 70%); box-shadow:0 1px 0 #ffffff inset; padding:10px; cursor:pointer;
  }
  character-picker::part(emojis){display:grid; place-items:center}
  character-picker::part(bubble){width:56px; height:56px; border-radius:50%; background:radial-gradient(120% 120% at 30% 30%, #ffffff, #eef5ff 70%); box-shadow:var(--shadow), inset 0 1px 0 #ffffff}
  character-picker::part(name){font-size:13px; opacity:.8; text-align:center}
</style>
</head>
<body>
  <div class="stage">

    <!-- Bowl -->
    <div class="centerWrap">
      <div class="seeds" id="seeds"></div>
      <div class="cauldron-wrap" id="cauldronWrap">
        <div class="cauldron" id="cauldron" aria-busy="false">
          <div class="ring"></div>
          <div class="brew">
            <div class="liquid" aria-hidden="true"></div>
            <div class="beams" aria-hidden="true"></div>
            <div class="image-wrap">
              <img id="image" class="result-img" alt="" draggable="false"/>
            </div>
          </div>
        </div>
        <div class="overlay" id="overlay"></div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="footer">
      <button class="circle-btn plus" id="openPicker" aria-label="add"><span class="e">➕</span></button>
      <button class="circle-btn cancel" id="cancel" aria-label="reset"><span class="e">❌</span></button>
    </div>

    <!-- Story-point Carousel -->
    <div class="kindWrap">
      <div class="kindShell">
        <div class="kindRail" id="kindRail"><div class="spacer"></div><div class="spacer"></div></div>
      </div>
    </div>
  </div>

  <character-picker id="charPicker"></character-picker>

<script>
/* ---------- Core characters (quality over quantity). Each has EXACTLY three emoji (iso-triangle on chip) ---------- */
const CHARACTERS = [
  {id:"trallallero", name:"Trallallero Trallalà", emojis:["🦈","👟","3️⃣"],
   imagery:"A sleek shark standing tripod-style; fins, gills, and cartilage dominate; bright athletic shoes on the three limbs; no human anatomy."},
  {id:"ballerina_cappuccina", name:"Ballerina Cappuccina", emojis:["☕","🩰","👗"],
   imagery:"A ballet outfit that moves itself: pointe shoes and dress dance while a cappuccino cup is the head; steam as breath; only garments, ceramic, and vapor."},
  {id:"cappuccino_assassino", name:"Cappuccino Assassino", emojis:["☕","🗡️","🕴️"],
   imagery:"A cappuccino cup for a head above a suit that moves without a body; a dagger slides from an empty sleeve; ceramic, cloth, and steel—never skin."},
  {id:"espressona_signora", name:"Espressona Signora", emojis:["☕","🖤","🚬"],
   imagery:"Black espresso cup head under a wide hat; a cigarette’s smoke draws the expression; couture attire animates itself—no person within."},
  {id:"bombardiro", name:"Bombardiro Croccodilo", emojis:["🐊","✈️","💣"],
   imagery:"Crocodile fused with a bomber aircraft: scaly fuselage, jaw as bomb bay, stub wings on armored shoulders; no cockpit, no pilot."},
  {id:"bombombini", name:"Bombombini Gusini", emojis:["🪿","🚢","💣"],
   imagery:"Goose-headed carrier-creature: ship hull torso, prow as beak, depth charges like eggs; metal plates, wake foam."},
  {id:"lirili", name:"Lirilì Larilà", emojis:["🌵","🐘","🩴"],
   imagery:"Cactus-elephant hybrid: succulent hide with spines, elephant head and trunk, flip-flops on sturdy feet; plant and pachyderm only."},
  {id:"brrbrr", name:"Brr Brr Patapim", emojis:["🐒","🌳","🥁"],
   imagery:"Forest monkey with tree-root legs; bark textures and fur; a waist-strapped drum beats the rhythm."},
  {id:"trippi", name:"Trippi Troppi", emojis:["🐟","👑","💪"],
   imagery:"Regal sea fish crowned; powerful fin-arms near the gills; scales glint oil-slick hues; entirely piscine."},
  {id:"frigo_cammello", name:"Frigo Cammello Buffo Fardello", emojis:["🐫","🧊","👞"],
   imagery:"Camel whose torso is a glossy refrigerator; frosty interior breath; sturdy work shoes stamp dust."},
  {id:"giraffa_celeste", name:"Giraffa Celeste", emojis:["🦒","🍉","👢"],
   imagery:"Long-necked giraffe with a watermelon torso; seeds as freckles; boots grip lunar dust beneath a visor sheen."},
  {id:"vacca_saturno", name:"La Vacca Saturno Saturnita", emojis:["🐄","🪐","⚡️"],
   imagery:"Cow set into a ringed planet; hooves leave ionized sparks; storm bands hum—bovine and planetary."},
  {id:"chimp_bananini", name:"Chimpanzini Bananini", emojis:["🦍","🍌","✨"],
   imagery:"Ape head on a banana-shaped torso; peel edges as armor; indestructible, glowing confidence."},
  {id:"pussini_sushini", name:"Pussini Sushini", emojis:["🐱","🍣","🥢"],
   imagery:"Cat assembled from sushi: rice body banded by seaweed, salmon back, curious feline head; chopsticks orbit as tools."},
  {id:"bandito_bobritto", name:"Bandito Bobritto", emojis:["🦫","🕶️","🤠"],
   imagery:"Beaver bandit: reflective sunglasses as eye surfaces and a tilted cowboy hat; damp tail, big incisors."},
  {id:"tung_sahur", name:"Tung Tung Tung Sahur", emojis:["🪵","🪘","🌙"],
   imagery:"Night watch being of joined wooden planks; chest is a hand drum that booms at dawn beneath a crescent moon."}
];

/* ---- Story-point chips: relationship/family, actions, environments, emotions (style never changes) ---- */
const KIND_EMOJIS = ["💞","👪","💔","⚔️","🤝","🍼","🏃‍♂️","🛡️","🏠","🏙️","🌲","🌊","😊","🤬","😱","😔"];

let activeKind=null;

/* ---------- DOM ---------- */
const cauldron=document.getElementById('cauldron');
const overlay=document.getElementById('overlay');
const imageEl=document.getElementById('image');
const seedsEl=document.getElementById('seeds');
const cancelBtn=document.getElementById('cancel');
const kindRail=document.getElementById('kindRail');
const charPicker=document.getElementById('charPicker');

/* ---------- State ---------- */
let seeds=[];       // floating character groups
let placed=[];      // [{id, charId, x, y}]
let dragging=null; let snapTimer=null; let lastActiveKind=null;
let sparkTimer=null;
let requestTimer=null;
let interactingCount=0;
let queuedChange=false;
let genSerial=0, latestSerial=0;
let currentObjectURL=null;

/* ===== Global “freeze while touching” ===== */
function beginInteraction(){ interactingCount++; if(interactingCount===1){ document.body.classList.add('freeze'); cancelSuspense(); } }
function endInteraction(){
  if(interactingCount>0){ interactingCount--; }
  if(interactingCount===0){
    document.body.classList.remove('freeze');
    if(queuedChange){ queuedChange=false; armSuspenseAndRequest(); }
  }
}
addEventListener('pointerdown', beginInteraction, true);
addEventListener('pointerup',   endInteraction, true);
addEventListener('pointercancel', endInteraction, true);
addEventListener('lostpointercapture', endInteraction, true);

/* ===== Suspense / request ===== */
function cancelSuspense(){
  if(requestTimer){ clearTimeout(requestTimer); requestTimer=null; }
  document.body.classList.remove('suspense');
}
function armSuspenseAndRequest(){
  document.body.classList.add('suspense');
  document.body.classList.remove('waiting');
  cauldron.classList.remove('req-blip');
  cauldron.setAttribute('aria-busy','false');
  if(requestTimer) clearTimeout(requestTimer);
  requestTimer=setTimeout(fireRequest, 500);
}
function scheduleRelevantChange(){
  if(interactingCount>0){ queuedChange=true; cancelSuspense(); return; }
  armSuspenseAndRequest();
}
function fireRequest(){
  requestTimer=null;
  cauldron.classList.add('req-blip');
  setTimeout(()=>cauldron.classList.remove('req-blip'), 340);
  startWaiting();
  imageEl.classList.remove('revealed');
  if(currentObjectURL){ try{ URL.revokeObjectURL(currentObjectURL); }catch{} currentObjectURL=null; }
  generateNow();
}

/* ===== Waiting visuals ===== */
function startWaiting(){
  document.body.classList.remove('suspense');
  document.body.classList.add('waiting');
  cauldron.setAttribute('aria-busy','true');

  const bowl=cauldron.getBoundingClientRect(); const cx=50, cy=50;
  for(const p of placed){
    const node=overlay.querySelector(`.placed[data-id="${p.id}"]`); if(!node) continue;
    const dxPct=(cx-p.x)*0.12, dyPct=(cy-p.y)*0.12;
    const ix=dxPct/100*bowl.width, iy=dyPct/100*bowl.height;
    node.style.setProperty('--ix', ix.toFixed(2)+'px'); node.style.setProperty('--iy', iy.toFixed(2)+'px');
    node.classList.add('waitPulse');
  }
  clearInterval(sparkTimer);
  sparkTimer=setInterval(spawnSparks, 260);
}
function stopWaiting(){
  document.body.classList.remove('waiting','suspense');
  cauldron.classList.remove('req-blip');
  cauldron.setAttribute('aria-busy','false');
  clearInterval(sparkTimer);
  document.documentElement.style.setProperty('--shake-ampl','0');
  document.documentElement.style.setProperty('--blur','0px');
}
function spawnSparks(){
  const r=cauldron.getBoundingClientRect();
  const center={x:r.left+r.width/2, y:r.top+r.height/2};
  for(let i=0;i<5;i++){
    const s=document.createElement('div');
    s.style.position='fixed'; s.style.left=center.x+'px'; s.style.top=center.y+'px';
    s.style.width='10px'; s.style.height='10px'; s.style.borderRadius='50%'; s.style.background='#fff';
    s.style.boxShadow='0 0 16px #9ff4db, 0 0 4px #fff inset'; s.style.opacity='0'; s.style.pointerEvents='none';
    s.animate([
      {transform:'translate(0,0) scale(.6)', opacity:0},
      {opacity:.95, offset:.08},
      {transform:`translate(${(Math.cos(Math.random()*Math.PI*2)*r.width*0.22).toFixed(1)}px, ${(Math.sin(Math.random()*Math.PI*2)*r.width*0.22).toFixed(1)}px) scale(0)`, opacity:0}
    ],{duration:900+Math.random()*400, easing:'var(--ease)', fill:'forwards'});
    document.body.appendChild(s); setTimeout(()=>s.remove(),1200);
  }
}

/* ===== Seeds (floating character groups) ===== */
function rect(el){ const r=el.getBoundingClientRect(); return {left:r.left,top:r.top,right:r.right,bottom:r.bottom,width:r.width,height:r.height}; }
function triHTML(arr){
  const [a,b,c] = arr;
  return `<div class="tri" aria-hidden="true">
    <span class="e a">${a}</span>
    <span class="e b">${b}</span>
    <span class="e c">${c}</span>
  </div>`;
}
function initSeeds(){
  const vw=window.innerWidth, vh=window.innerHeight;
  const bowl   = rect(cauldron);
  const rail   = rect(kindRail);
  const footer = rect(document.querySelector('.footer'));
  const avoid = [
    { left:bowl.left-24,   top:bowl.top-24,   right:bowl.right+24,   bottom:bowl.bottom+24 },
    { left:footer.left-12, top:footer.top-12, right:footer.right+12, bottom:footer.bottom+12 },
    { left:rail.left-12,   top:rail.top-12,   right:rail.right+12,   bottom:rail.bottom+12 }
  ];
  const CHIP_R = 28, PAD = 16, MIN_D  = CHIP_R*2 + 18;

  function hitsAvoid(x,y){
    return avoid.some(a => x > a.left-CHIP_R && x < a.right+CHIP_R && y > a.top-CHIP_R && y < a.bottom+CHIP_R);
  }
  function farEnough(x,y){ for(const p of seeds){ if(Math.hypot(x-p.x, y-p.y) < MIN_D) return false; } return true; }

  seeds = []; let i = 0, attempts = 0, maxAttempts = 9000;
  while (i < CHARACTERS.length && attempts++ < maxAttempts){
    const x = PAD + Math.random()*(vw - PAD*2);
    const y = PAD + Math.random()*(vh - PAD*2);
    if (hitsAvoid(x,y)) continue; if (!farEnough(x,y)) continue;
    const ch = CHARACTERS[i++];
    seeds.push({ id:crypto.randomUUID(), charId:ch.id, x, y });
  }
}
let resizeT;
window.addEventListener('resize', () => {
  clearTimeout(resizeT);
  resizeT = setTimeout(()=>{ if (placed.length===0){ initSeeds(); renderSeeds(); } }, 120);
});
function renderSeeds(){
  seedsEl.innerHTML='';
  for(const s of seeds){
    const ch = getCharById(s.charId);
    const n=document.createElement('button'); n.className='seed';
    n.style.left=s.x+'px'; n.style.top=s.y+'px';
    n.style.setProperty('--delay', `${(-Math.random()*6).toFixed(2)}s`);
    n.style.setProperty('--dur', `${(7+Math.random()*4).toFixed(2)}s`);
    n.style.setProperty('--fx', `${(Math.random()*14-7).toFixed(1)}px`);
    n.style.setProperty('--fy', `${(Math.random()*8-4).toFixed(1)}px`);
    n.dataset.id=s.id; n.innerHTML=triHTML(ch.emojis);
    n.title=ch.name;
    n.addEventListener('pointerdown', e=>startDragSeed(e,s.id));
    seedsEl.appendChild(n);
  }
}

/* ===== Character Picker (adds a group directly) ===== */
document.getElementById('openPicker').addEventListener('click',()=>charPicker.open());
charPicker.addEventListener('character-pick', e=>{
  const ch = getCharById(e.detail.charId); if(!ch) return;
  const pos=spotInsideBowl();
  placed.push({id:crypto.randomUUID(), charId:ch.id, x:pos.x, y:pos.y});
  renderPlaced(true);
  scheduleRelevantChange();
});

/* ===== Dragging (seeds → bowl; placed inside bowl) ===== */
function startDragSeed(ev,id){
  ev.preventDefault();
  const idx=seeds.findIndex(s=>s.id===id); if(idx<0) return;
  const node=[...seedsEl.children].find(n=>n.dataset.id===id);
  if(node) node.style.visibility='hidden';
  const ch=getCharById(seeds[idx].charId);
  const ghost=makeGhost(ch.emojis);
  dragging={type:'seed', idx, charId:ch.id, ghostEl:ghost, originalEl:node};
  pointerMove(ev);
  addEventListener('pointermove', pointerMove);
  addEventListener('pointerup', pointerUp, {once:true});
}
function startDragPlaced(ev,id){
  ev.preventDefault();
  const idx=placed.findIndex(p=>p.id===id); if(idx<0) return;
  const node=overlay.querySelector(`.placed[data-id="${id}"]`);
  if(node) node.style.visibility='hidden';
  const ch=getCharById(placed[idx].charId);
  const ghost=makeGhost(ch.emojis);
  dragging={type:'placed', idx, charId:ch.id, ghostEl:ghost, originalEl:node, start:{x:placed[idx].x,y:placed[idx].y}};
  pointerMove(ev);
  addEventListener('pointermove', pointerMove);
  addEventListener('pointerup', pointerUp, {once:true});
}
function makeGhost(emojis){
  const g=document.createElement('div'); g.className='chip'; g.style.position='fixed'; g.style.zIndex=9999; g.style.borderRadius='50%';
  g.style.transform='translate(-50%,-50%) scale(1.0)'; g.style.boxShadow='var(--shadow-strong), 0 0 0 2px #00c8ff30';
  g.innerHTML=triHTML(emojis);
  document.body.appendChild(g); return g;
}
function pointerMove(ev){
  if(!dragging) return;
  dragging.ghostEl.style.left=ev.clientX+'px'; dragging.ghostEl.style.top=ev.clientY+'px';
  const {inside}=coordsInCauldron(ev.clientX,ev.clientY);
  dragging.ghostEl.style.transform=`translate(-50%,-50%) scale(${inside?1.26:1.04})`;
  cauldron.classList.toggle('over',inside);
}
function pointerUp(ev){
  if(!dragging) return cleanupDrag();
  const {inside,px,py}=coordsInCauldron(ev.clientX,ev.clientY); cauldron.classList.remove('over');

  if(dragging.type==='seed'){
    if(inside){
      placed.push({id:crypto.randomUUID(), charId:dragging.charId, x:px, y:py});
      renderPlaced(true);
      if(Number.isInteger(dragging.idx)){ seeds.splice(dragging.idx,1); renderSeeds(); }
      scheduleRelevantChange();
    }else{
      if(dragging.originalEl) dragging.originalEl.style.visibility='';
    }
  }else{
    if(inside){
      placed[dragging.idx].x=px; placed[dragging.idx].y=py; renderPlaced(false);
      scheduleRelevantChange();
    }else{
      const screenX=ev.clientX, screenY=ev.clientY;
      seeds.push({ id:crypto.randomUUID(), charId:dragging.charId, x:screenX, y:screenY });
      placed.splice(dragging.idx,1);
      renderPlaced(false); renderSeeds();
      scheduleRelevantChange();
    }
  }
  cleanupDrag();
}
function cleanupDrag(){
  removeEventListener('pointermove', pointerMove);
  if(dragging?.ghostEl) dragging.ghostEl.remove();
  if(dragging?.originalEl) dragging.originalEl.style.visibility='';
  dragging=null;
}

/* ===== Placed render ===== */
function renderPlaced(playDrop=false){
  overlay.innerHTML='';
  for(const p of placed){
    const ch=getCharById(p.charId);
    const n=document.createElement('div'); n.className='placed'; n.dataset.id=p.id; n.title=ch.name;
    n.style.left=p.x+'%'; n.style.top=p.y+'%'; n.innerHTML=triHTML(ch.emojis);
    if(playDrop) n.classList.add('dropin');
    n.addEventListener('pointerdown', e=>startDragPlaced(e,p.id));
    overlay.appendChild(n);
  }
}

/* ===== Carousel (story points) ===== */
function buildKindRail(){
  KIND_EMOJIS.forEach(k=>{
    const b=document.createElement('button'); b.className='kchip'; b.dataset.kind=k;
    b.innerHTML=`<span class="e">${k}</span>`; b.addEventListener('click',()=>centerChip(b));
    kindRail.insertBefore(b, kindRail.lastElementChild);
  });
  setTimeout(()=>centerChip(kindRail.querySelector('.kchip')),0);
  kindRail.addEventListener('scroll', onRailScroll, {passive:true});
  requestAnimationFrame(updateActiveChipVisual);
}
function centerChip(chip){
  const R=kindRail.getBoundingClientRect(), C=chip.getBoundingClientRect();
  kindRail.scrollBy({left:(C.left+C.width/2)-(R.left+R.width/2), behavior:'smooth'});
}
function onRailScroll(){
  updateActiveChipVisual();
  if(snapTimer) clearTimeout(snapTimer);
  snapTimer=setTimeout(()=>{
    const active=getActiveChip(); if(!active) return;
    const k=active.dataset.kind; activeKind=k;
    if(lastActiveKind!==k){ lastActiveKind=k; scheduleRelevantChange(); }
    centerChip(active);
  },180);
}
function getActiveChip(){ const R=kindRail.getBoundingClientRect(), cx=R.left+R.width/2; let best=null, d=1e9;
  for(const chip of kindRail.querySelectorAll('.kchip')){ const r=chip.getBoundingClientRect(), c=r.left+r.width/2, dd=Math.abs(c-cx); if(dd<d){d=dd; best=chip;} }
  return best;
}
function updateActiveChipVisual(){ const a=getActiveChip(); for(const c of kindRail.querySelectorAll('.kchip')) c.classList.toggle('active', c===a); }

/* ===== Geometry ===== */
function coordsInCauldron(cx,cy){
  const r=cauldron.getBoundingClientRect(); const mx=cx-(r.left+r.width/2); const my=cy-(r.top+r.height/2);
  const inside=Math.hypot(mx,my)<=r.width/2;
  const px=((mx+r.width/2)/r.width)*100; const py=((my+r.height/2)/r.height)*100;
  return {inside, px:Math.max(6,Math.min(94,px)), py:Math.max(6,Math.min(94,py))};
}
function spotInsideBowl(){
  const r=cauldron.getBoundingClientRect(); let tries=0;
  while(tries++<300){ const px=8+Math.random()*84, py=8+Math.random()*84;
    const cx=r.left+px/100*r.width, cy=r.top+py/100*r.height;
    if(Math.hypot(cx-(r.left+r.width/2),cy-(r.top+r.height/2))<r.width/2-40) return {x:px,y:py};
  } return {x:50,y:50};
}

/* ===== Prompt assembly (ALWAYS realistic animated characters; characters ≠ humans) ===== */
const FIXED_STYLE = "Realistic animated characters with a high-end 3D animated-film look, soft global illumination, coherent physically-based materials, cinematic depth of field, and a single consistent visual style across all scenes. No text or watermarks.";

function storyPreset(kind){
  switch(kind){
    case "💞": return {story:"a tender reunion between close companions", action:"a gentle nuzzle using their own anatomies", environment:"a neutral open plaza", emotion:"deep affection"};
    case "👪": return {story:"a protective family moment", action:"one shielding another using bodies and props", environment:"cozy home interior", emotion:"warmth and safety"};
    case "💔": return {story:"a difficult separation", action:"turning away from each other", environment:"quiet empty street", emotion:"heartbreak and regret"};
    case "⚔️": return {story:"a rivalry standoff", action:"tense face-off with poised motion", environment:"abandoned arena", emotion:"determination"};
    case "🤝": return {story:"choosing cooperation", action:"synchronized teamwork pose", environment:"industrial catwalk", emotion:"earned trust"};
    case "🍼": return {story:"caretaker soothing a smaller companion", action:"gentle rocking motion", environment:"dim nursery corner", emotion:"protective tenderness"};
    case "🏃‍♂️": return {story:"a dynamic chase", action:"sprinting and vaulting", environment:"narrow alley", emotion:"urgent adrenaline"};
    case "🛡️": return {story:"holding the line together", action:"defensive formation", environment:"city gate at night", emotion:"bravery under pressure"};
    case "🏠": return {story:"everyday domestic life", action:"preparing breakfast", environment:"sunlit kitchen", emotion:"quiet contentment"};
    case "🏙️": return {story:"meeting in the big city", action:"crosswalk encounter", environment:"neon urban street", emotion:"anticipation"};
    case "🌲": return {story:"life in the woodland", action:"trail walking", environment:"misty forest", emotion:"calm wonder"};
    case "🌊": return {story:"seaside chapter", action:"wading through shallow surf", environment:"windy beach", emotion:"freedom"};
    case "😊": return {story:"celebration after success", action:"jumping and cheering", environment:"confetti-strewn stage", emotion:"joy"};
    case "🤬": return {story:"heated argument", action:"pointing and thumping props", environment:"cramped hideout", emotion:"anger"};
    case "😱": return {story:"sudden revelation", action:"stumbling back in shock", environment:"echoing hall", emotion:"awe and fear"};
    case "😔": return {story:"quiet farewell", action:"slow parting", environment:"train platform", emotion:"melancholy"};
    default: return {story:"neutral encounter", action:"standing together", environment:"simple open space", emotion:"balanced focus"};
  }
}

function computeLayout(){
  return placed.map(p=>{
    const dx=p.x-50, dy=p.y-50, dist=Math.hypot(dx,dy);
    const rPct=Math.min(50, dist);
    const role = rPct<15 ? "center" : (rPct<38 ? "inner" : "rim");
    const hemiLR = p.x<50 ? "left" : "right";
    const hemiTB = p.y<50 ? "top" : "bottom";
    return { id:p.id, char:getCharById(p.charId), xPct:p.x, yPct:p.y, rPct, role, hemiLR, hemiTB };
  });
}
function describeCharacter(ch){
  const base = ch.imagery;
  const guard = "Absolutely no human facial features or human skin; anatomy and motion derive strictly from the specified animals, objects, and materials.";
  return `${base} ${guard}`;
}
function assembleSubjects(layout){
  const roleOrder = {center:0, inner:1, rim:2};
  return [...layout].sort((a,b)=>roleOrder[a.role]-roleOrder[b.role])
    .map(t=>{
      const hemi = `${t.hemiTB}-${t.hemiLR}`;
      const desc = describeCharacter(t.char);
      if(t.role==="center") return `Primary subject at center: ${t.char.name}. ${desc}`;
      if(t.role==="inner")  return `Supporting subject in the inner ring (${hemi}): ${t.char.name}. ${desc}`;
      return `Environmental or chorus subject on the rim (${hemi}): ${t.char.name}. ${desc}`;
    }).join(' ');
}
function assertNoEmoji(text){
  const prop=/[\p{Extended_Pictographic}\uFE0F]/u;
  const range=/[\u2190-\u2BFF\u2600-\u27BF\u{1F300}-\u{1FAFF}]/u;
  if(prop.test(text)||range.test(text)) throw new Error("Prompt contains emoji glyphs.");
}
function buildPrompt(){
  const story = storyPreset(activeKind);
  const layout = computeLayout();
  const subjects = assembleSubjects(layout);
  const text = [
    `${FIXED_STYLE}`,
    `Story point: ${story.story}. Action: ${story.action}. Setting: ${story.environment}. Dominant emotion: ${story.emotion}.`,
    `${subjects}`,
    `Keep bodies and motion non-human; use only the animals/objects/materials in the descriptions. One frame; coherent proportions and physically plausible materials; no text or watermarks.`
  ].join(" ");
  assertNoEmoji(text);
  return text;
}

/* ===== Generator ===== */
async function callPollinations(prompt){
  assertNoEmoji(prompt);
  const url="https://image.pollinations.ai/prompt/"+encodeURIComponent(prompt)+"?width=768&height=768";
  const res=await fetch(url,{mode:"cors"}); if(!res.ok) throw new Error('Pollinations error');
  const blob=await res.blob(); return URL.createObjectURL(blob);
}
async function generateNow(){
  const serial=++genSerial; latestSerial=serial;
  const prompt=buildPrompt();
  try{
    const imgURL=await callPollinations(prompt);
    if(serial!==latestSerial) return;
    if(currentObjectURL){ try{ URL.revokeObjectURL(currentObjectURL); }catch{} }
    currentObjectURL=imgURL;
    imageEl.src=imgURL;
    imageEl.onload=()=>{
      if(serial!==latestSerial) return;
      stopWaiting();
      arrangeOnRim();
      requestAnimationFrame(()=> imageEl.classList.add('revealed'));
    };
  }catch(e){
    console.warn(e);
    stopWaiting();
  }
}

/* ===== Arrange on rim after reveal ===== */
function arrangeOnRim(){
  if(!placed.length) return;
  const cx=50, cy=50, r=44;
  placed.forEach(p=>{
    const node=overlay.querySelector(`.placed[data-id="${p.id}"]`); if(!node) return;
    node.classList.remove('waitPulse');
    let dx=p.x-cx, dy=p.y-cy, len=Math.hypot(dx,dy); if(len<0.0001){ dx=1; dy=0; len=1; }
    const ux=dx/len, uy=dy/len, tx=cx + ux*r, ty=cy + uy*r;
    node.animate([
      {left:p.x+'%', top:p.y+'%', transform:'translate(-50%,-50%) scale(.96)', opacity:1},
      {left:tx+'%', top:ty+'%', transform:'translate(-50%,-50%) scale(.96)', opacity:1}
    ],{duration:560, easing:'cubic-bezier(.2,.8,.2,1)'});
    p.x=tx; p.y=ty; node.style.left=p.x+'%'; node.style.top=p.y+'%';
  });
}

/* ===== Init & Reset ===== */
window.addEventListener('load',()=>{ buildKindRail(); resetApp(true); initCharPicker(); });
function resetApp(){
  if(currentObjectURL){ try{ URL.revokeObjectURL(currentObjectURL); }catch{} currentObjectURL=null; }
  imageEl.classList.remove('revealed'); imageEl.removeAttribute('src');
  placed=[]; overlay.innerHTML='';
  document.body.classList.remove('waiting','suspense','freeze');
  cauldron.classList.remove('req-blip');
  cauldron.setAttribute('aria-busy','false');
  if(requestTimer){ clearTimeout(requestTimer); requestTimer=null; }
  clearInterval(sparkTimer);
  initSeeds(); renderSeeds(); renderPlaced(false);
}
document.getElementById('cancel').addEventListener('click', ()=>resetApp());

/* ===== Helpers ===== */
function getCharById(id){ return CHARACTERS.find(c=>c.id===id); }
function spotInsideBowl(){
  const r=cauldron.getBoundingClientRect(); let tries=0;
  while(tries++<300){ const px=8+Math.random()*84, py=8+Math.random()*84;
    const cx=r.left+px/100*r.width, cy=r.top+py/100*r.height;
    if(Math.hypot(cx-(r.left+r.width/2),cy-(r.top+r.height/2))<r.width/2-40) return {x:px,y:py};
  } return {x:50,y:50};
}

/* ===== Character Picker element setup ===== */
function initCharPicker(){
  charPicker.items = CHARACTERS.map(c=>({id:c.id, name:c.name, emojis: c.emojis.slice()}));
}
</script>

<script>
/* ======= <character-picker> (3-emoji bubbles; emits character-pick) ======= */
class CharacterPicker extends HTMLElement{
  static get observedAttributes(){ return ["open"]; }
  #s = this.attachShadow({mode:"open"});
  #grid; #panel; #close;
  set items(list){ this.#renderList(list); }
  constructor(){
    super();
    this.#s.innerHTML = `
      <div part="panel">
        <div part="bar">
          <div style="font-weight:600;opacity:.8">Add a character</div>
          <button part="close" title="Close">✖️</button>
        </div>
        <div part="scroll"><div part="grid"></div></div>
      </div>`;
  }
  connectedCallback(){
    this.#panel = this.#s.querySelector('[part="panel"]');
    this.#grid  = this.#s.querySelector('[part="grid"]');
    this.#close = this.#s.querySelector('[part="close"]');
    this.#close.addEventListener('click',()=>this.close());
  }
  open(){ this.setAttribute('open',''); }
  close(){ this.removeAttribute('open'); }
  attributeChangedCallback(name){ if(name==="open"){ /* style via ::part */ } }
  #renderList(list){
    if(!this.#grid) return;
    this.#grid.innerHTML='';
    list.forEach(item=>{
      const bubble = document.createElement('div');
      bubble.setAttribute('part','bubble');
      bubble.innerHTML = `<div class="tri">
        <span class="e a">${item.emojis[0]}</span>
        <span class="e b">${item.emojis[1]}</span>
        <span class="e c">${item.emojis[2]}</span>
      </div>`;
      const card = document.createElement('button');
      card.setAttribute('part','card');
      const wrap = document.createElement('div'); wrap.setAttribute('part','emojis'); wrap.appendChild(bubble);
      const name = document.createElement('div'); name.setAttribute('part','name'); name.textContent = item.name;
      card.appendChild(wrap); card.appendChild(name);
      card.addEventListener('click', ()=>{
        this.dispatchEvent(new CustomEvent('character-pick',{detail:{charId:item.id},bubbles:true,composed:true}));
        this.close();
      });
      this.#grid.appendChild(card);
    });
  }
}
customElements.define('character-picker', CharacterPicker);
</script>
</body>
</html>