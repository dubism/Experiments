<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Pollinations — Prompt → Canvas / Interactive UI</title>
<style>
  :root{ --bg:#0b0e13; --fg:#e9eef7; --muted:#93a1b4; --accent:#7bd7ff; --ok:#38d39f; --err:#ff6b6b; --wait:#ffd166; --send:#7bb7ff; --render:#b388ff; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; overflow-x:hidden; }

  header{ padding:12px 16px; border-bottom:1px solid #1b2330; position:sticky; top:0; background:#0b0e13; display:flex; align-items:center; gap:8px; }
  header h1{ font-size:14px; margin:0; color:#cfe7ff; letter-spacing:.2px; flex:1 1 auto; }
  header .rt{ display:flex; gap:8px; }

  main{ display:grid; grid-template-columns:360px 1fr; gap:16px; height:calc(100% - 54px); }
  aside{ padding:12px 16px; border-right:1px solid #1b2330; overflow:auto; }
  #work{ position:relative; overflow:hidden; }

  textarea{ width:100%; min-height:120px; resize:vertical; background:#0f141d; color:var(--fg); border:1px solid #1b2330; border-radius:8px; padding:10px; }
  fieldset{ border:1px solid #1b2330; border-radius:8px; padding:10px; margin:12px 0; }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .chip{ display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #1b2330; border-radius:999px; cursor:pointer; user-select:none; }
  input[type="radio"]{ accent-color:#7bd7ff; }
  input[type="number"],input[type="text"]{ width:96px; background:#0f141d; color:var(--fg); border:1px solid #1b2330; border-radius:6px; padding:6px 8px; }
  button{ background:#152033; color:var(--fg); border:1px solid #223149; border-radius:8px; padding:9px 12px; cursor:pointer; }
  button:hover{ outline:1px solid #29466e; }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
  small{ color:var(--muted); }

  /* Stage */
  #stage{ position:relative; height:100%; min-height:320px; }
  canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; background:#0a0a0a; }
  #imgLayer{ position:absolute; inset:0; object-fit:cover; display:none; } /* cover fill on fallback */
  #codeOut{ position:absolute; inset:16px; border:1px solid #233247; border-radius:10px; background:#0c121b; display:none; z-index:20; }

  /* Immersive full-viewport preview for code */
  body.immersive { overflow: hidden; }
  body.immersive #codeOut{ position:fixed !important; inset: env(safe-area-inset-top,0) env(safe-area-inset-right,0) calc(env(safe-area-inset-bottom,0)) env(safe-area-inset-left,0); border-radius:0; border:0; }
  #immersiveBar{ position:fixed; top:calc(env(safe-area-inset-top,0) + 8px); right:calc(env(safe-area-inset-right,0) + 8px); z-index:30; display:none; }
  body.immersive #immersiveBar{ display:flex; }
  #immersiveBar button{ padding:8px 10px; background:#0f141d; border:1px solid #1b2330; }

  /* Status bar */
  #statusBar{ position:fixed; left:12px; right:12px; bottom:calc(env(safe-area-inset-bottom,0px) + 12px);
    display:flex; gap:10px; align-items:center; background:#0f141d; border:1px solid #1b2330; border-radius:10px; padding:7px 10px; z-index:50; flex-wrap:wrap; }
  #dot{ width:10px; height:10px; border-radius:50%; background:#5b6474; }
  .pulse{ animation:pulse 1s infinite; }
  @keyframes pulse{ 0%{ box-shadow:0 0 0 0 rgba(123,215,255,.6)} 70%{ box-shadow:0 0 0 8px rgba(123,215,255,0)} 100%{ box-shadow:0 0 0 0 rgba(123,215,255,0)} }
  #phase{ min-width:110px; font-weight:600; }
  #elapsed{ min-width:56px; text-align:right; color:#b7c6da; }
  #progress{ width:140px; height:8px; appearance:none; background:#141c28; border:1px solid #223149; border-radius:999px; overflow:hidden; }
  #progress::-webkit-progress-value{ background:var(--accent); }
  #cancel{ margin-left:auto; }

  #feed{ position:fixed; right:12px; bottom:calc(env(safe-area-inset-bottom,0px) + 12px); max-width:42ch; max-height:35vh;
    overflow:auto; list-style:none; margin:0; padding:8px 10px; background:#0f141d; border:1px solid #1b2330; border-radius:10px; color:#b7c6da; z-index:40; }
  #feed li{ margin:2px 0; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }

  #offline{ position:fixed; top:8px; left:50%; transform:translateX(-50%); background:#2a1111; color:#ffdede; border:1px solid #542323; padding:6px 10px; border-radius:8px; display:none; z-index:60; }

  /* Mobile: stack, big stage */
  @media (max-width: 820px){
    main{ grid-template-columns:1fr; height:auto; }
    aside{ border-right:0; border-bottom:1px solid #1b2330; }
    #stage{ min-height:calc(100vh - 320px); }
    #codeOut{ inset:0; border-radius:0; }
  }
</style>
</head>
<body>
<header>
  <h1>Pollinations — Prompt → Canvas / Interactive UI</h1>
  <div class="rt"><button id="expand">Expand</button></div>
</header>

<main>
  <aside>
    <label>Raw idea (creative core)</label>
    <textarea id="raw" placeholder="e.g., Simple traffic-light game with score"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="run">Run</button>
      <small>⌘/Ctrl+Enter runs. Shift+Enter = new line.</small>
    </div>

    <fieldset>
      <legend>Mode</legend>
      <div class="row" id="mode">
        <label class="chip"><input type="radio" name="ptype" value="artdir"> Art-Directed Photo</label>
        <label class="chip"><input type="radio" name="ptype" value="flatillus"> Flat Illustration</label>
        <label class="chip"><input type="radio" name="ptype" value="uicode" checked> UI Code (text)</label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Image options</legend>
      <div class="row">
        <label>Seed <input id="seed" type="number" value="42"></label>
        <label>Model <input id="model" type="text" placeholder="flux or turbo" value="flux"></label>
        <label class="chip"><input id="nologo" type="checkbox" checked> nologo</label>
        <label class="chip"><input id="enhance" type="checkbox"> enhance</label>
      </div>
      <small>Canvas size & DPR are sent as width/height.</small>
    </fieldset>

    <fieldset>
      <legend>Preview prompt</legend>
      <pre id="preview" style="white-space:pre-wrap;background:#0f141d;border:1px solid #1b2330;border-radius:8px;padding:10px;min-height:96px;"></pre>
    </fieldset>
  </aside>

  <section id="work">
    <div id="stage">
      <canvas id="cnv"></canvas>
      <img id="imgLayer" alt="Pollinations output">
      <iframe id="codeOut" sandbox="allow-scripts" title="Generated UI"></iframe>
    </div>
  </section>
</main>

<div id="offline">Offline. Check your connection.</div>
<div id="statusBar" aria-live="polite">
  <div id="dot" aria-hidden="true"></div>
  <div id="phase">Ready</div>
  <progress id="progress" max="1" value="0"></progress>
  <div id="elapsed">0.0s</div>
  <button id="cancel" hidden>Cancel</button>
</div>
<ul id="feed" aria-live="polite"></ul>
<div id="immersiveBar"><button id="exitImmersive">Exit</button></div>

<script type="module">
const $ = s => document.querySelector(s);

/* ---------- Enforce fullscreen + auto-fit on returned HTML ---------- */
function enforceFullscreenHTML(html) {
  const prelude = `
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style id="enforcer">
    :root,html,body{height:100%}
    html,body{margin:0}
    body{min-height:100vh;min-height:100dvh}
    *,*::before,*::after{box-sizing:border-box}
    img,canvas,svg,video{max-width:100%;height:auto}
    #app,main,.app,.container,.viewport,.root{min-height:100% !important; width:100% !important}
  </style>
  <script>
  (function(){
    function fit(){
      var vw = window.innerWidth;
      var docW = Math.max(
        document.documentElement.scrollWidth,
        document.body.scrollWidth,
        document.documentElement.offsetWidth,
        document.body.offsetWidth
      );
      var scale = docW>vw ? (vw/docW) : 1;
      var b = document.body;
      b.style.transformOrigin = 'top left';
      b.style.transform = scale<1 ? 'scale('+scale+')' : '';
      b.style.width = scale<1 ? docW+'px' : '';
    }
    window.addEventListener('resize', fit, {passive:true});
    if (document.fonts && document.fonts.ready) { document.fonts.ready.then(fit); }
    setTimeout(fit,0);
  })();
  <\/script>`;
  html = html.replace(/^[\s\S]*?(?=<!doctype html|<html)/i,'');
  if (/<head[^>]*>/i.test(html)) return html.replace(/<head[^>]*>/i, m => m + prelude);
  if (!/<html/i.test(html)) return `<!doctype html><html><head>${prelude}</head><body>${html}</body></html>`;
  return html.replace(/<html[^>]*>/i, '$&<head>'+prelude+'</head>');
}

/* ---------- Refs & state ---------- */
const raw = $('#raw'), runBtn = $('#run'), preview = $('#preview');
const seedEl = $('#seed'), modelEl = $('#model'), nologoEl = $('#nologo'), enhanceEl = $('#enhance');
const cnv = $('#cnv'), imgLayer = $('#imgLayer'), codeOut = $('#codeOut');
const dot = $('#dot'), phase = $('#phase'), prog = $('#progress'), elapsed = $('#elapsed'), cancelBtn = $('#cancel');
const feed = $('#feed'), offline = $('#offline');
const expandBtn = $('#expand'), exitImmersiveBtn = $('#exitImmersive');

const state = { id:0, ctrl:null, timer:null, start:0, running:false };
const CS = { w:0, h:0, dpr:1 };   // canvas sizing snapshot

function currentType(){ return (document.querySelector('input[name="ptype"]:checked') || { value:'artdir' }).value; }

/* ---------- Canvas sizing & drawing helpers ---------- */
function sizeCanvas(){
  const host = document.getElementById('stage');
  const rect = host.getBoundingClientRect();
  CS.w = Math.max(280, Math.floor(rect.width));
  CS.h = Math.max(280, Math.floor(rect.height));
  CS.dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));

  cnv.style.width = CS.w + 'px';
  cnv.style.height = CS.h + 'px';
  cnv.width  = Math.floor(CS.w * CS.dpr);
  cnv.height = Math.floor(CS.h * CS.dpr);

  const ctx = cnv.getContext('2d');
  ctx.setTransform(CS.dpr,0,0,CS.dpr,0,0);   // CSS-pixel space
  ctx.clearRect(0,0,CS.w,CS.h);
  return { ...CS };
}

function getCtx(){
  const ctx = cnv.getContext('2d');
  ctx.setTransform(CS.dpr,0,0,CS.dpr,0,0);   // re-assert every draw
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  return ctx;
}

/* draw image to fill (cover) the stage, centered */
function drawCover(ctx, img){
  const iw = img.naturalWidth || img.width;
  const ih = img.naturalHeight || img.height;
  if (!iw || !ih) return;

  const scale = Math.max(CS.w/iw, CS.h/ih);
  const dw = Math.ceil(iw*scale);
  const dh = Math.ceil(ih*scale);
  const dx = Math.floor((CS.w - dw)/2);
  const dy = Math.floor((CS.h - dh)/2);

  ctx.clearRect(0,0,CS.w,CS.h);
  ctx.drawImage(img, dx, dy, dw, dh);
}

addEventListener('resize', sizeCanvas, { passive:true }); sizeCanvas();

/* ---------- Prompts ---------- */
function composePrompt(type,W,H){
  const core = (raw.value || 'an evocative scene').trim();

  if (type==='artdir')  return `${core}. cinematic, pro lighting, natural color, depth of field, shot on 50mm, aspect ${W}x${H}.`;
  if (type==='flatillus') return `${core}. minimal flat vector illustration, clean geometry, soft shadows, aspect ${W}x${H}.`;

  const uiSpec = [
    'RESPOND WITH HTML ONLY — a complete single-file HTML document starting with "<!doctype html>".',
    'Do NOT include any prose, explanations, or Markdown fences before or after the HTML.',
    'Inline CSS and vanilla JS only. No external URLs, no iframes, no frameworks.',
    '<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"> is required.',
    'Mobile-first: html, body {height:100%}. The app must fill the viewport (100vh) and respect iOS safe-area insets.',
    'Touch-friendly (min tap target 44×44), keyboard accessible, visible focus.',
    'Interactivity: command palette (Ctrl/Cmd+K), save (Ctrl/Cmd+S to localStorage), Esc closes overlays, "?" shows help.',
    'Theme toggle (light/dark), undo/redo, prefers-reduced-motion respected.',
    `Fit responsively to a viewport of ${W}×${H}.`
  ].join('\n');

  return `Build an interactive UI for: "${core}".\n${uiSpec}`;
}
function updatePreview(){ const {w,h}=sizeCanvas(); preview.textContent = composePrompt(currentType(), w, h); }
raw.addEventListener('input', updatePreview);
document.querySelectorAll('input[name="ptype"]').forEach(r=>r.addEventListener('change', updatePreview));
updatePreview();

/* ---------- Status + logs ---------- */
function feedLine(t){ const li=document.createElement('li'); li.textContent=t; feed.appendChild(li); while(feed.children.length>12) feed.removeChild(feed.firstChild); feed.scrollTop=feed.scrollHeight; }
function setDot(color,pulse=false){ dot.style.background=color; dot.classList.toggle('pulse', pulse); }
function setPhase(text,color,pulse=false){ phase.textContent=text; setDot(color,pulse); }
function setElapsed(t=0){ elapsed.textContent = `${t.toFixed(1)}s`; }
function startTimer(){ state.start=performance.now(); state.timer=setInterval(()=>setElapsed((performance.now()-state.start)/1000),100); }
function stopTimer(){ clearInterval(state.timer); state.timer=null; }
function disableControls(disabled){
  [runBtn, expandBtn, ...document.querySelectorAll('input, textarea')].forEach(el=>{
    if (el===raw) return; if (el!==cancelBtn) el.disabled = disabled;
  });
}
addEventListener('online', ()=>offline.style.display='none');
addEventListener('offline',()=>offline.style.display='block');
offline.style.display = navigator.onLine ? 'none' : 'block';

function begin(kind){
  state.id++; state.ctrl = new AbortController(); state.running = true;
  cancelBtn.hidden = false; disableControls(true); prog.value = 0; setElapsed(0); startTimer();
  setPhase('Composing','#5b6474'); feedLine(`▶ #${state.id} ${kind} — composing`);
}
function sending(){ setPhase('Sending','var(--send)',true); feedLine('↗ sent; awaiting response…'); }
function waiting(){ setPhase('Waiting','var(--wait)',true); }
function receiving(frac){ setPhase('Receiving','var(--wait)',true); prog.value = Math.max(0,Math.min(1,frac)); }
function rendering(){ setPhase('Rendering','var(--render)',true); feedLine('⚙ rendering…'); }
function done(msg='Done'){ setPhase('Done','var(--ok)'); prog.value=1; stopTimer(); cancelBtn.hidden=true; disableControls(false); state.running=false; feedLine(`✔ ${msg}`); }
function failed(msg){ setPhase('Error','var(--err)'); stopTimer(); cancelBtn.hidden=true; disableControls(false); state.running=false; feedLine(`✖ ${msg}`); }

cancelBtn.addEventListener('click', ()=>{ if(state.ctrl) state.ctrl.abort(); failed('Canceled'); });

/* ---------- Immersive controls ---------- */
function enterImmersive(){ document.body.classList.add('immersive'); }
function exitImmersive(){ document.body.classList.remove('immersive'); }
function autoImmersiveIfMobile(){ if (matchMedia('(max-width: 820px)').matches) enterImmersive(); }
$('#expand').addEventListener('click', enterImmersive);
$('#exitImmersive').addEventListener('click', exitImmersive);

/* ---------- Image path (now fills stage) ---------- */
async function generateImage(){
  const {w,h} = sizeCanvas(); begin('image');

  const prompt = composePrompt(currentType(), w, h);
  const qp = new URLSearchParams({
    width:String(Math.max(32,Math.floor(w))),
    height:String(Math.max(32,Math.floor(h))),
    seed:seedEl.value||'42', model:modelEl.value||'flux',
    nologo:String(!!nologoEl.checked), enhance:String(!!enhanceEl.checked), _t:String(Date.now())
  });
  const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?${qp.toString()}`;

  sending();
  const t0 = performance.now();

  let rsp;
  try{ rsp = await fetch(url, { signal:state.ctrl.signal, cache:'no-store' }); }
  catch{ failed('Network error before headers'); return; }

  waiting();
  if (!rsp.ok){ failed(`HTTP ${rsp.status}`); return; }
  feedLine(`↘ headers in ${((performance.now()-t0)/1000).toFixed(1)}s · ${rsp.headers.get('Content-Type')||'unknown'}`);

  try{
    if (rsp.body){
      const reader=rsp.body.getReader(); const chunks=[]; let rec=0; const len=+rsp.headers.get('Content-Length')||0;
      while(true){ const {done,value}=await reader.read(); if(done) break; chunks.push(value); rec+=value.length; if(len) receiving(rec/len); }
      const blob=new Blob(chunks,{type:'image/png'}); const o=URL.createObjectURL(blob);
      rendering();
      await new Promise((res,rej)=>{
        const img=new Image();
        img.onload=()=>{ const ctx=getCtx(); drawCover(ctx,img); URL.revokeObjectURL(o); imgLayer.style.display='none'; codeOut.style.display='none'; res(); };
        img.onerror=rej; img.src=o;
      });
      done('Image drawn');
    }else{ throw new Error('No stream'); }
  }catch{ // Fallback to <img> with cover
    waiting();
    const img=new Image(); img.crossOrigin='anonymous';
    const loaded=new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });
    img.src=url;
    try{
      await loaded; rendering();
      // Try drawing; if CORS taints, just show <img> (cover)
      try{
        const ctx=getCtx(); drawCover(ctx,img);
        imgLayer.style.display='none'; codeOut.style.display='none';
      }catch{ imgLayer.src=url; imgLayer.style.display='block'; codeOut.style.display='none'; }
      done('Image shown');
    }catch{ failed('Image load failed'); }
  }
}

/* ---------- Code path ---------- */
async function generateCode(){
  const {w,h} = sizeCanvas(); begin('ui-code');

  const prompt = composePrompt('uicode', w, h);
  const url = `https://text.pollinations.ai/${encodeURIComponent(prompt)}?model=qwen-coder`;

  sending();
  const t0 = performance.now();

  let rsp;
  try{ rsp = await fetch(url, { signal:state.ctrl.signal, cache:'no-store' }); }
  catch{ failed('Network error before headers'); return; }

  waiting();
  if (!rsp.ok){ failed(`HTTP ${rsp.status}`); return; }
  feedLine(`↘ headers in ${((performance.now()-t0)/1000).toFixed(1)}s · ${rsp.headers.get('Content-Type')||'unknown'}`);

  let text='';
  try{
    if (rsp.body){
      const reader=rsp.body.getReader(); const dec=new TextDecoder(); let buf='';
      while(true){ const {done,value}=await reader.read(); if(done) break; buf+=dec.decode(value,{stream:true}); receiving(Math.min(0.9, buf.length/150000)); }
      text = buf + new TextDecoder().decode();
    } else { text = await rsp.text(); }
  } catch{ failed('Stream/read failed'); return; }

  text = text.replace(/^\s*```(?:html)?/i,'').replace(/```$/,'').trim();
  const start = text.search(/<!doctype html|<html/i);
  if (start > 0) text = text.slice(start);

  rendering();

  const looksHTML = /<html/i.test(text);
  const oneWord   = /^[a-z]+$/i.test(text) && text.length<=12;

  if (!looksHTML){
    if (oneWord){ feedLine(`ℹ Non-HTML reply “${text}”. Falling back to image…`); done('Switching to image'); return generateImage(); }
    const esc=s=>s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    codeOut.srcdoc = `<!doctype html><meta charset="utf-8"><body style="margin:0;background:#0b0e13;color:#eaeef7;font:14px system-ui">
      <div style="padding:16px;border:1px solid #233247;border-radius:10px;margin:16px">
        <b>Provider returned non-HTML.</b>
        <div style="opacity:.9;margin-top:6px">Preview: “${esc(text.slice(0,180)).replace(/\s+/g,' ')}${text.length>180?'…':''}”</div>
      </div></body>`;
    codeOut.style.display='block';
    done('Non-HTML from provider'); return;
  }

  codeOut.srcdoc = enforceFullscreenHTML(text);
  codeOut.style.display='block';
  autoImmersiveIfMobile();
  done('Interactive UI embedded');
}

/* ---------- Run control ---------- */
function runCurrent(){ return currentType()==='uicode' ? generateCode() : generateImage(); }
runBtn.addEventListener('click', runCurrent);
raw.addEventListener('keydown', e => { const meta=e.metaKey||e.ctrlKey; if(meta && e.key==='Enter'){ e.preventDefault(); runCurrent(); } });

/* ---------- Errors ---------- */
addEventListener('error', e => feedLine(`⚠ JS error: ${e.message}`));
addEventListener('unhandledrejection', e => feedLine(`⚠ Promise: ${e.reason}`));
</script>
</body>
</html>