<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lunar Eclipse â€” Clean Mobile + Compass</title>
<style>
  :root{
    --bg:#000; --fg:#e8eef5; --muted:#9aa1ad; --accent:#5ac8fa;
    --moon-hi:#dddddd; --moon-lo:#bfc3c8;
    --pen-fill:rgba(0,0,0,.18); --umb-fill:rgba(0,0,0,.35);
    --ring:rgba(255,255,255,.22);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; overflow:hidden;}
  /* Fullscreen stage */
  #stage{position:relative; width:100vw; height:100svh; display:flex; align-items:center; justify-content:center;}
  /* Square canvas that fits on one screen; moon made smaller (â‰ˆ 2/3 previous) */
  #cv{width:92vmin; height:92vmin; display:block; border-radius:12px;}
  /* Top controls */
  .hud-top{position:absolute; top:calc(env(safe-area-inset-top,0px) + 10px); left:10px; right:10px;
    display:flex; justify-content:space-between; gap:8px; z-index:3;}
  .btn{
    -webkit-tap-highlight-color:transparent; border:1px solid #293242; background:#12161d; color:var(--fg);
    padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}
  /* Bottom timeline: fixed inside the stage so no scrolling */
  .hud-bottom{position:absolute; left:calc(env(safe-area-inset-left,0px) + 10px);
    right:calc(env(safe-area-inset-right,0px) + 10px);
    bottom:calc(env(safe-area-inset-bottom,0px) + 12px);
    display:flex; gap:8px; align-items:center; z-index:3;}
  .timeline{appearance:none; width:100%; height:36px; margin:0; padding:0 2px; background:transparent;}
  .timeline::-webkit-slider-runnable-track{height:4px; background:#263041; border-radius:999px;}
  .timeline::-moz-range-track{height:4px; background:#263041; border-radius:999px;}
  .timeline::-webkit-slider-thumb{-webkit-appearance:none; width:24px; height:24px; margin-top:-10px; border-radius:50%;
    background:#e6eef8; border:0;}
  .timeline::-moz-range-thumb{width:24px; height:24px; border:0; border-radius:50%; background:#e6eef8;}
  /* Info sheet (closed by default) */
  .sheet{position:fixed; inset:auto 0 0 0; background:#0b1017; border-top:1px solid #1e2632;
    transform:translateY(100%); transition:.25s transform ease; padding:14px; z-index:5;}
  .sheet.on{transform:translateY(0)}
  .sheet h3{margin:0 0 8px; font-size:14px}
  .row{display:flex; gap:8px; flex-wrap:wrap;}
  .tag{padding:6px 10px; border-radius:999px; background:#131a23; color:var(--muted); font-size:12px; border:1px solid #1f2a38;}
  .close{float:right}
</style>
</head>
<body>
  <div id="stage">
    <canvas id="cv"></canvas>

    <!-- top-left: info + now; top-right: play + compass -->
    <div class="hud-top">
      <div style="display:flex;gap:8px">
        <button id="infoBtn" class="btn" title="Details">i</button>
        <button id="nowBtn"  class="btn" title="Jump to current time">Now</button>
      </div>
      <div style="display:flex;gap:8px">
        <button id="playBtn"    class="btn" title="Play/Pause">Play</button>
        <button id="compassBtn" class="btn" title="Enable location & orientation">ðŸ§­</button>
      </div>
    </div>

    <!-- full-width slider inside the viewport -->
    <div class="hud-bottom">
      <input id="timeSlider" class="timeline" type="range" min="0" max="100" step="1" />
    </div>
  </div>

  <!-- collapsible info -->
  <div id="sheet" class="sheet" aria-hidden="true">
    <button id="closeSheet" class="btn close">Close</button>
    <h3>Eclipse details</h3>
    <div id="when" style="margin:6px 0 12px; color:var(--muted)"></div>
    <div class="row" id="ticks"></div>
    <p style="color:var(--muted);margin-top:12px">Align the ðŸ§­ pointer to the gold arrow to face the Moon (Â± a few degrees).</p>
  </div>

<script>
(() => {
  // ------- Robust: avoid .at() and other fragile calls ----------
  const contacts = [
    { k:"P1", t:"2025-09-07T15:28:06Z", pa:231.4, axis:1.5358 },
    { k:"U1", t:"2025-09-07T16:26:51Z", pa:225.9, axis:1.0069 },
    { k:"U2", t:"2025-09-07T17:30:36Z", pa:206.0, axis:0.4677 },
    { k:"GE", t:"2025-09-07T18:11:46Z", pa:151.6, axis:0.2721 },
    { k:"U3", t:"2025-09-07T18:53:18Z", pa:96.9,  axis:0.4707 },
    { k:"U4", t:"2025-09-07T19:56:53Z", pa:77.2,  axis:1.0100 },
    { k:"P4", t:"2025-09-07T20:55:27Z", pa:71.7,  axis:1.5395 }
  ];
  for (let i=0;i<contacts.length;i++) contacts[i].ms = Date.parse(contacts[i].t);

  const PEN_R_DEG = 1.2691, UMB_R_DEG = 0.7400;
  const MOON_SD_DEG = (16 + 9.8/60)/60; // 16' 9.8"
  const scaleToMoonR = 1 / MOON_SD_DEG;
  const penR = PEN_R_DEG * scaleToMoonR;
  const umbR = UMB_R_DEG * scaleToMoonR;

  const T0 = contacts[0].ms, T1 = contacts[contacts.length-1].ms;

  // ------- DOM refs ----------
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d'); // no options for max compatibility
  const slider = document.getElementById('timeSlider');
  const playBtn = document.getElementById('playBtn');
  const nowBtn  = document.getElementById('nowBtn');
  const infoBtn = document.getElementById('infoBtn');
  const sheet = document.getElementById('sheet');
  const closeSheet = document.getElementById('closeSheet');
  const ticksBox = document.getElementById('ticks');
  const when = document.getElementById('when');
  const compassBtn = document.getElementById('compassBtn');

  // ------- Info content ----------
  function fmtLocal(ms){ return new Date(ms).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', timeZoneName:'short'}); }
  when.textContent = `Local window: ${fmtLocal(T0)} â€” ${fmtLocal(T1)}`;
  for (let i=0;i<contacts.length;i++){
    const c=contacts[i]; const el=document.createElement('span');
    el.className='tag'; el.textContent = `${c.k} ${fmtLocal(c.ms)}`; ticksBox.appendChild(el);
  }

  // ------- Slider setup (full-width) ----------
  slider.min = T0; slider.max = T1; slider.step = 1000;
  slider.value = clamp(Date.now(), T0, T1);

  // ------- Canvas sizing ----------
  function resize(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = cv.clientWidth, h = cv.clientHeight;
    cv.width = Math.round(w*dpr); cv.height = Math.round(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw(Number(slider.value));
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // ------- Geometry interpolation ----------
  function lerp(a,b,t){ return a + (b-a)*t; }
  function lerpAng(a,b,t){ let d=b-a; while(d>180)d-=360; while(d<-180)d+=360; return a+d*t; }
  function interp(tms){
    if (tms <= T0) return {pa:contacts[0].pa, axis:contacts[0].axis};
    if (tms >= T1) return {pa:contacts[contacts.length-1].pa, axis:contacts[contacts.length-1].axis};
    let i=0; while(i<contacts.length-1 && tms>contacts[i+1].ms) i++;
    const A=contacts[i], B=contacts[i+1], tt=(tms-A.ms)/(B.ms-A.ms);
    return { pa: lerpAng(A.pa,B.pa,tt), axis: lerp(A.axis,B.axis,tt) };
  }

  // ------- Moon position for compass (compact SunCalc-like) ----------
  const rad=Math.PI/180, dayMs=86400000;
  const obs = { lat:50.0755, lon:14.4378, hasGeo:false };
  let deviceHeading=null, moonBearing=null, moonAlt=null, alignedPrev=false;

  function toJulian(d){ return d.valueOf()/dayMs - 0.5 + 2440588; }
  function toDays(d){ return toJulian(d) - 2451545; }
  function rightAsc(l,b){ const e=23.4397*rad; return Math.atan2(Math.sin(l)*Math.cos(e)-Math.tan(b)*Math.sin(e), Math.cos(l)); }
  function decl(l,b){ const e=23.4397*rad; return Math.asin(Math.sin(b)*Math.cos(e)+Math.cos(b)*Math.sin(e)*Math.sin(l)); }
  function sidereal(D,lw){ return rad*(280.16 + 360.9856235*D) - lw; }
  function moonCoords(D){
    const L=rad*(218.316+13.176396*D), M=rad*(134.963+13.064993*D), F=rad*(93.272+13.229350*D);
    const l=L + rad*6.289*Math.sin(M), b=rad*5.128*Math.sin(F); const dist=385001 - 20905*Math.cos(M);
    return { ra:rightAsc(l,b), dec:decl(l,b), dist };
  }
  function getMoonPos(date, lat, lon){
    const D=toDays(date), lw=-lon*rad, Ï†=lat*rad, c=moonCoords(D), H=sidereal(D,lw)-c.ra;
    let h=Math.asin(Math.sin(Ï†)*Math.sin(c.dec)+Math.cos(Ï†)*Math.cos(c.dec)*Math.cos(H));
    const az=Math.atan2(Math.sin(H), Math.cos(H)*Math.sin(Ï†)-Math.tan(c.dec)*Math.cos(Ï†));
    const hp=Math.asin(1/(c.dist/6371)); h=h-hp*Math.cos(h);
    return { alt:h, az };
  }
  function azToBearing(az){ let b=(az+Math.PI)*180/Math.PI; b%=360; if(b<0)b+=360; return b; }
  function angDiff(a,b){ let d=Math.abs(a-b)%360; return d>180?360-d:d; }

  // ------- Drawing ----------
  function draw(tms){
    const W=cv.clientWidth, H=cv.clientHeight;
    const cx=W/2, cy=H/2;

    ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);

    // Make Moon radius smaller (~two-thirds of the previous size)
    const Rpx = Math.min(W,H) * 0.28;

    // Moon
    ctx.save(); ctx.translate(cx,cy);
    const g=ctx.createRadialGradient(-Rpx*0.25,-Rpx*0.25,Rpx*0.2, 0,0,Rpx);
    g.addColorStop(0, getCSS('--moon-hi')); g.addColorStop(1, getCSS('--moon-lo'));
    ctx.beginPath(); ctx.arc(0,0,Rpx,0,Math.PI*2); ctx.fillStyle=g; ctx.fill();

    // Clip to moon to avoid any square artifacts
    ctx.save(); ctx.beginPath(); ctx.arc(0,0,Rpx,0,Math.PI*2); ctx.clip();

    // Interpolated Earth-shadow position in Moon-radii units
    const e = interp(tms);
    const axisR = e.axis * (1/MOON_SD_DEG);
    const A = e.pa * rad;
    const vx = Math.sin(A)*axisR, vy = -Math.cos(A)*axisR;

    // Draw penumbra & umbra as clean circles (thin stroke + black opacity)
    ctx.save(); ctx.scale(Rpx,Rpx);
    ctx.beginPath(); ctx.arc(vx,vy,penR,0,Math.PI*2);
    ctx.fillStyle=getCSS('--pen-fill'); ctx.fill();
    ctx.lineWidth=1/Rpx; ctx.strokeStyle=getCSS('--ring'); ctx.stroke();

    ctx.beginPath(); ctx.arc(vx,vy,umbR,0,Math.PI*2);
    ctx.fillStyle=getCSS('--umb-fill'); ctx.fill();
    ctx.lineWidth=1.25/Rpx; ctx.strokeStyle=getCSS('--ring'); ctx.stroke();
    ctx.restore();

    ctx.restore(); // unclip moon
    ctx.restore();

    // Compass (center)
    drawCompass(cx,cy,Math.min(W,H)*0.12);
  }

  function drawCompass(cx,cy,r){
    const ring=r, inner=r*0.62;
    ctx.save(); ctx.translate(cx,cy);

    ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,.2)';
    ctx.beginPath(); ctx.arc(0,0, ring, 0, Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.arc(0,0, inner, 0, Math.PI*2); ctx.stroke();

    ctx.fillStyle='rgba(255,255,255,.8)'; ctx.font='600 11px system-ui,-apple-system,Segoe UI';
    [['N',0],['E',90],['S',180],['W',270]].forEach(([t,deg])=>{
      const a=(deg-90)*rad, tx=Math.cos(a)*(ring+10), ty=Math.sin(a)*(ring+10);
      ctx.fillText(t, tx-4, ty+4);
    });

    if (deviceHeading!=null){
      const a=(deviceHeading-90)*rad;
      ctx.save(); ctx.rotate(a);
      ctx.beginPath(); ctx.moveTo(inner*0.2,0); ctx.lineTo(ring*0.95,0);
      ctx.strokeStyle='rgba(90,200,250,.95)'; ctx.lineWidth=3; ctx.stroke();
      ctx.beginPath(); ctx.moveTo(ring*0.95,0); ctx.lineTo(ring*0.78,-6); ctx.lineTo(ring*0.78,6); ctx.closePath();
      ctx.fillStyle='rgba(90,200,250,.95)'; ctx.fill();
      ctx.restore();
    }

    if (moonBearing!=null){
      const a=(moonBearing-90)*rad; ctx.save(); ctx.rotate(a);
      ctx.beginPath(); ctx.moveTo(inner*0.1,0); ctx.lineTo(inner*0.1,-5); ctx.lineTo(ring*0.86,0); ctx.lineTo(inner*0.1,5); ctx.closePath();
      ctx.fillStyle = (moonAlt!=null && moonAlt>0) ? 'rgba(255,220,140,.98)' : 'rgba(180,180,180,.85)';
      ctx.fill(); ctx.restore();
    }

    if (deviceHeading!=null && moonBearing!=null){
      const diff=angDiff(deviceHeading,moonBearing);
      if (diff<=10){
        ctx.beginPath(); ctx.arc(0,0, ring+6, 0, Math.PI*2);
        ctx.strokeStyle='rgba(90,200,250,.8)'; ctx.lineWidth=4; ctx.stroke();
        if (!alignedPrev && 'vibrate' in navigator) navigator.vibrate(20);
        alignedPrev=true;
      } else alignedPrev=false;
    }

    ctx.beginPath(); ctx.arc(0,0,4,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fill();
    ctx.restore();
  }

  function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function clamp(v,a,b){ return Math.min(Math.max(v,a),b); }

  // ------- Playback / loop ----------
  let playing=false, last=performance.now(), RATE=120; // sec simulated per sec real
  function loop(now){
    if (playing){
      const dt=(now-last)/1000;
      let v=Number(slider.value)+dt*1000*RATE; if (v>T1) v=T0; slider.value=v;
    }
    last=now;
    updateForTime(Number(slider.value));
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ------- Events (ensure interaction works) ----------
  slider.addEventListener('input', ()=> updateForTime(Number(slider.value)));
  nowBtn.addEventListener('click', ()=>{ slider.value=clamp(Date.now(),T0,T1); updateForTime(Number(slider.value)); });
  playBtn.addEventListener('click', ()=>{ playing=!playing; playBtn.textContent=playing?'Pause':'Play'; });
  infoBtn.addEventListener('click', ()=>{ sheet.classList.add('on'); sheet.setAttribute('aria-hidden','false'); });
  closeSheet.addEventListener('click', ()=>{ sheet.classList.remove('on'); sheet.setAttribute('aria-hidden','true'); });

  // ------- Compass ----------
  compassBtn.addEventListener('click', enableCompass);
  function enableCompass(){
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>{ obs.lat=p.coords.latitude; obs.lon=p.coords.longitude; obs.hasGeo=true; }, ()=>{});
    }
    function onDO(e){
      let h=null;
      if (typeof e.webkitCompassHeading==='number') h=e.webkitCompassHeading;
      else if (typeof e.alpha==='number'){
        h = 360 - e.alpha;
        const ang=(screen.orientation && typeof screen.orientation.angle==='number')?screen.orientation.angle:(window.orientation||0);
        h=(h+ang)%360;
      }
      if (h!=null && isFinite(h)) deviceHeading=(h%360+360)%360;
    }
    if (window.DeviceOrientationEvent){
      if (typeof DeviceOrientationEvent.requestPermission==='function'){
        DeviceOrientationEvent.requestPermission().then(state=>{
          if (state==='granted') window.addEventListener('deviceorientation', onDO, true);
        }).catch(()=>{});
      } else {
        window.addEventListener('deviceorientation', onDO, true);
      }
    }
  }

  // ------- Update moon bearing + redraw ----------
  function updateForTime(tms){
    const d = new Date(tms);
    const pos = getMoonPos(d, obs.lat, obs.lon);
    moonAlt = pos.alt*180/Math.PI;
    moonBearing = azToBearing(pos.az);
    draw(tms);
  }

  // first paint
  updateForTime(Number(slider.value));
})();
</script>
</body>
</html>