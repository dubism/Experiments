<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Minimal Camera + Motion Permission Test</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font:16px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{display:grid;place-items:center;height:100%;padding:16px;gap:16px}
  button{all:unset;background:#1e2a3a;color:#fff;padding:14px 18px;border-radius:12px;border:1px solid #2d3b52;font-weight:600}
  button:active{transform:translateY(1px)}
  .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .banner{width:100%;max-width:720px;padding:12px 14px;border-radius:10px;border:2px solid #333;background:#111}
  .ok{border-color:#1f8b4c;background:#0f2f1f}
  .warn{border-color:#8b6d1f;background:#2f2a0f}
  .err{border-color:#8b1f1f;background:#2f0f0f}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace;white-space:pre-wrap;word-break:break-word}
  video{width:min(60vw,360px);height:auto;background:#111;border:1px solid #333;border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
  <div id="ctx" class="banner mono"></div>

  <div class="row">
    <button id="btnCam">Test Camera</button>
    <button id="btnStopCam">Stop Camera</button>
    <button id="btnMotion">Test Motion</button>
  </div>

  <video id="vid" playsinline muted></video>

  <div id="camBox" class="banner mono">Camera: idle</div>
  <div id="motBox" class="banner mono">Motion: idle</div>
</div>

<script>
(() => {
  const ctxBox = document.getElementById('ctx');
  const camBox = document.getElementById('camBox');
  const motBox = document.getElementById('motBox');
  const vid = document.getElementById('vid');

  // ----- Context info (helps spot HTTPS/iframe issues) -----
  const inIframe = (window.top !== window.self);
  const ctx = {
    isSecureContext: window.isSecureContext || location.protocol === 'https:',
    protocol: location.protocol,
    topLevel: !inIframe,
    noteIframe: inIframe ? 'If embedded, iframe needs allow="camera; accelerometer; gyroscope" and no restrictive sandbox' : '—',
    hasGetUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
    hasPermissionsAPI: 'permissions' in navigator,
    ua: navigator.userAgent
  };
  ctxBox.textContent = JSON.stringify(ctx, null, 2);
  ctxBox.classList.add(ctx.isSecureContext ? 'ok' : 'err');

  // ----- Camera test -----
  let stream = null;
  async function testCamera() {
    camBox.className = 'banner mono';
    try {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        camBox.textContent = 'getUserMedia() not available (need HTTPS or unsupported browser).';
        camBox.classList.add('err');
        return;
        }
      const constraints = { video: { facingMode: { ideal: 'user' }, width: { ideal: 1280 }, height: { ideal: 720 }}, audio: false };
      stream = await navigator.mediaDevices.getUserMedia(constraints); // <-- should trigger Safari prompt
      vid.srcObject = stream;
      await new Promise(res => vid.addEventListener('loadedmetadata', res, { once: true }));
      try { await vid.play(); } catch (e) {}
      const track = stream.getVideoTracks()[0];
      const settings = track ? track.getSettings() : {};
      camBox.textContent = 'Camera: OK\n' + JSON.stringify({
        streamActive: stream.active,
        track: track ? { label: track.label, readyState: track.readyState } : null,
        settings
      }, null, 2);
      camBox.classList.add('ok');
    } catch (err) {
      camBox.textContent = 'Camera error: ' + (err && (err.name + ': ' + err.message) || String(err));
      camBox.classList.add('err');
    }
  }
  function stopCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    vid.srcObject = null;
    camBox.textContent = 'Camera: stopped';
    camBox.classList.remove('ok','err'); camBox.classList.add('warn');
  }

  // ----- Motion test -----
  let doCount = 0, lastTs = 0, listening = false;

  function onDO(e) {
    doCount++; lastTs = Date.now();
    motBox.textContent = 'Motion: receiving\n' + JSON.stringify({
      alpha: e.alpha, beta: e.beta, gamma: e.gamma,
      count: doCount, lastEventAgoMs: 0
    }, null, 2);
    motBox.classList.remove('warn','err'); motBox.classList.add('ok');
  }

  async function testMotion() {
    motBox.className = 'banner mono';
    try {
      // iOS 13+: permission must be requested from a user gesture
      const needIOS =
        (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') ||
        (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function');

      if (needIOS) {
        const p1 = (typeof DeviceMotionEvent !== 'undefined' && DeviceMotionEvent.requestPermission)
          ? await DeviceMotionEvent.requestPermission() : 'granted';
        const p2 = (typeof DeviceOrientationEvent !== 'undefined' && DeviceOrientationEvent.requestPermission)
          ? await DeviceOrientationEvent.requestPermission() : 'granted';
        if (p1 !== 'granted' || p2 !== 'granted') {
          motBox.textContent = 'Motion permission denied (iOS). Check Settings → Safari → Motion & Orientation Access.';
          motBox.classList.add('err');
          return;
        }
      }
      if (!listening) {
        window.addEventListener('deviceorientation', onDO, { passive: true });
        listening = true;
      }
      doCount = 0;
      lastTs = 0;
      motBox.textContent = 'Motion: awaiting events…';
      motBox.classList.add('warn');
      // Simple timeout to detect no events
      setTimeout(() => {
        if (doCount === 0) {
          motBox.textContent = 'No DeviceOrientation events received after 5s.\n'
            + 'iOS: Settings → Safari → Motion & Orientation Access = ON.\n'
            + 'Also ensure not in an iframe without "allow" permissions.';
          motBox.classList.add('err');
        }
      }, 5000);
    } catch (err) {
      motBox.textContent = 'Motion error: ' + (err && (err.name + ': ' + err.message) || String(err));
      motBox.classList.add('err');
    }
  }

  // Buttons
  document.getElementById('btnCam').addEventListener('click', testCamera, { passive: true });
  document.getElementById('btnStopCam').addEventListener('click', stopCamera, { passive: true });
  document.getElementById('btnMotion').addEventListener('click', testMotion, { passive: true });
})();
</script>
</body>
</html>