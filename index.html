<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Experiments â€” Auto Index</title>
<style>
  :root{
    --bg:#0a0b0d; --ink:#f5f6f8; --muted:#a8afbb;
    --card:#0f1117; --card2:#10131a; --line:#1a2130;
    --shadow:0 1px 0 rgba(255,255,255,.02) inset, 0 0 0 1px #1a2130, 0 8px 18px rgba(0,0,0,.45);
    --shadow-hover:0 1px 0 rgba(255,255,255,.03) inset, 0 0 0 1px #24304a, 0 14px 28px rgba(0,0,0,.6);
    --radius:14px;

    /* Green â†’ Bluish â†’ Grey (grey only after 3 days) */
    --t0:#82FFB5; --t1:#66F5C8; --t2:#4FDEDE; --t3:#4BC5F2; --t4:#5AAAF5;
    --t5:#7D96F0; --t6:#9CA6CC; --t7:#A9B6E0; --t8:#B9C2E0; --t9:#B8B8B8;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  header{position:sticky;top:0;z-index:10;background:linear-gradient(#10131a,#0c0f15);border-bottom:1px solid #1c2537}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 14px}
  h1{margin:0;font-size:16px;letter-spacing:.3px}
  main{max-width:1100px;margin:0 auto;padding:14px}

  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type=search]{
    flex:1;min-width:220px;background:#0b0f16;border:1px solid #1e293e;border-radius:10px;
    padding:.55rem .7rem;color:var(--ink);outline:none;
    transition:border-color .2s, background .2s, box-shadow .25s;
    box-shadow:0 0 0 0 rgba(74,163,255,.0);
  }
  input[type=search]::placeholder{color:#8e97a6}
  input[type=search]:focus{border-color:#2b3f65;background:#0d1220;box-shadow:0 0 0 5px rgba(74,163,255,.06)}

  button{
    border:1px solid #25324a;background:#131a26;color:var(--ink);
    padding:.5rem .7rem;border-radius:10px;cursor:pointer;font-weight:650;letter-spacing:.2px;
    transition:transform .15s, box-shadow .2s, border-color .2s, background .2s;
    box-shadow:var(--shadow);
  }
  button:hover{transform:translateY(-1px);box-shadow:var(--shadow-hover);border-color:#31456b;background:#141e2c}
  .status{font-size:12px;color:#9aa3b2}

  .seg{display:inline-flex;border:1px solid #27324a;border-radius:10px;overflow:hidden}
  .seg button{border:0;border-right:1px solid #27324a;background:#101622;padding:.45rem .65rem}
  .seg button:last-child{border-right:0}
  .seg button[aria-pressed="true"]{background:#162133}
  .seg button[aria-pressed="true"] span{opacity:1}
  .seg button span{opacity:.85}

  .grp{margin-top:14px}
  .grp h2{display:flex;align-items:center;gap:8px;font-size:12px;color:#9aa3b2;margin:6px 2px 8px;letter-spacing:.25px}
  .grp h2 .folder-ic{opacity:.85}

  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}

  .card{
    display:grid;text-decoration:none;color:inherit;
    background:linear-gradient(180deg,var(--card),var(--card2));
    border:1px solid var(--line);border-radius:var(--radius);
    padding:12px 14px;
    box-shadow:var(--shadow);
    transition:transform .18s, box-shadow .22s, border-color .2s, background .25s;
    position:relative;overflow:hidden;

    grid-template-columns: 28px 1fr auto;
    grid-template-rows: auto auto;
    grid-template-areas:
      "icon title open"
      "meta meta actions";
    column-gap:10px; row-gap:6px;
    cursor:pointer;
  }
  .card:before{
    content:"";position:absolute;inset:-1px;border-radius:var(--radius);
    background:radial-gradient(90px 60px at 0% 0%, rgba(74,163,255,.08), transparent 60%),
               radial-gradient(120px 80px at 100% 0%, rgba(39,255,136,.05), transparent 60%);
    pointer-events:none;
  }
  .card:hover,.card:focus-visible{transform:translateY(-1px);box-shadow:var(--shadow-hover);border-color:#2a3755;outline:none}

  .ic{grid-area:icon;width:28px;height:28px;display:grid;place-items:center;background:#0c1119;border:1px solid #1f2a42;border-radius:8px}
  .titleWrap{grid-area:title;min-width:0;display:flex;flex-direction:column;gap:2px}
  .name{font-weight:750;letter-spacing:.2px;line-height:1.2;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .path{font-size:11px;color:#97a1b1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .openVis{grid-area:open;align-self:start;justify-self:end;font-size:12px;color:#cfd5df;opacity:.9;display:inline-flex;gap:6px;align-items:center;pointer-events:none}
  .openVis svg{opacity:.9}

  .meta{grid-area:meta;display:flex;align-items:center;gap:10px;min-width:0}
  .actions{grid-area:actions;display:flex;align-items:center;gap:8px;justify-self:end}

  .ago{font-size:11px;font-weight:700;letter-spacing:.3px;display:inline-flex;align-items:center;gap:6px}
  .ago .dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.95}
  .ago.t0{color:var(--t0)} .ago.t1{color:var(--t1)} .ago.t2{color:var(--t2)}
  .ago.t3{color:var(--t3)} .ago.t4{color:var(--t4)} .ago.t5{color:var(--t5)}
  .ago.t6{color:var(--t6)} .ago.t7{color:var(--t7)} .ago.t8{color:var(--t8)} .ago.t9{color:var(--t9)}

  .exact{font-size:11px;color:#cfd5df;opacity:.85;white-space:nowrap}

  .copyBtn{
    border:1px dashed #2a3755;background:#101622;color:#d9e1ee;
    padding:.35rem .55rem;border-radius:9px;font-size:11px;letter-spacing:.2px;
    display:inline-flex;align-items:center;gap:6px;box-shadow:none;
  }
  .copyBtn:hover{background:#12203a;border-color:#35507d}
  .copyBtn svg{opacity:.9}

  footer{color:#9aa3b2;text-align:center;padding:16px;border-top:1px solid #161b25}

  @media (max-width:480px){
    .card{
      grid-template-columns:28px 1fr auto;
      grid-template-rows:auto auto auto;
      grid-template-areas:
        "icon title open"
        "meta  meta  meta"
        "actions actions actions";
    }
    .actions{justify-self:start}
  }
  @media (prefers-reduced-motion: reduce){*{transition:none !important}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ðŸ§ª Experiments â€” Auto Index</h1>
    <div class="row" style="margin-top:8px">
      <input id="q" type="search" placeholder="Filter by name or pathâ€¦" />
      <div class="seg" role="group" aria-label="Sort">
        <button id="sortTime" aria-pressed="true" title="Newest â†’ Oldest"><span>Time</span></button>
        <button id="sortName" aria-pressed="false" title="A â†’ Z by name"><span>Name</span></button>
      </div>
      <button id="refresh" aria-label="Refresh list">
        <span style="display:inline-flex;gap:8px;align-items:center">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 12a 8 8 0 1 1-2.34-5.66" stroke="#9fb3d6" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M20 4v6h-6" stroke="#9fb3d6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Refresh
        </span>
      </button>
      <span id="status" class="status">Loadingâ€¦</span>
    </div>
  </div>
</header>

<main>
  <div id="list"></div>
</main>

<footer>Generated from <code>dubism/Experiments</code> via GitHub API</footer>

<script>
const USER = "dubism";
const REPO = "Experiments";
const BASE = `https://${USER}.github.io/${REPO}/`;

const statusEl = document.getElementById('status');
const listEl = document.getElementById('list');
const qEl = document.getElementById('q');
const sortTimeBtn = document.getElementById('sortTime');
const sortNameBtn = document.getElementById('sortName');
document.getElementById('refresh').onclick = fetchTree;
qEl.oninput = applyFilter;

let allItems = [];
let sortMode = 'time';

sortTimeBtn.onclick = () => setSort('time');
sortNameBtn.onclick = () => setSort('name');

function setSort(mode){
  sortMode = mode;
  sortTimeBtn.setAttribute('aria-pressed', mode==='time' ? 'true' : 'false');
  sortNameBtn.setAttribute('aria-pressed', mode==='name' ? 'true' : 'false');
  applyFilter();
}

function folderOf(path){const i=path.lastIndexOf('/');return i===-1?"":path.slice(0,i);}
function fileIcon(){return `
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M7 3h6l4 4v14H7z" stroke="#9fb3d6" stroke-width="1.3" />
    <path d="M13 3v5h5" stroke="#9fb3d6" stroke-width="1.3"/>
  </svg>`;}
function folderIcon(){return `
  <svg class="folder-ic" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M3 8h7l2 2h9v9H3z" stroke="#8ea2c6" stroke-width="1.3"/>
  </svg>`;}
function arrowIcon(){return `
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M7 17l7-7M10 7h7v7" stroke="#cdd7e6" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;}

function prettyName(name){return name.replace(/\.html?$/i,'').replace(/[-_]+/g,' ').replace(/\b\w/g,m=>m.toUpperCase());}
function isoLocal(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ` +
         `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}

/* Buckets (green â†’ bluish â†’ grey; grey only after 72h) */
function timeAgoClassAndText(d){
  let secs = Math.max(0,(Date.now()-d.getTime())/1000);
  if(secs < 60)  return {cls:'t0', text:`${Math.floor(secs)}s ago`};
  let mins = secs/60;
  if(mins < 5)   return {cls:'t1', text:`${Math.floor(mins)}m ago`};
  if(mins < 15)  return {cls:'t2', text:`${Math.floor(mins)}m ago`};
  if(mins < 30)  return {cls:'t3', text:`${Math.floor(mins)}m ago`};
  if(mins < 60)  return {cls:'t4', text:`${Math.floor(mins)}m ago`};
  let hours = mins/60;
  if(hours < 4)   return {cls:'t5', text:`${Math.floor(hours)}h ago`};
  if(hours < 12)  return {cls:'t6', text:`${Math.floor(hours)}h ago`};
  if(hours < 24)  return {cls:'t7', text:`${Math.floor(hours)}h ago`};
  if(hours < 72)  return {cls:'t8', text:`${Math.floor(hours)}h ago`};
  let days = Math.floor(hours/24);
  return {cls:'t9', text: days < 365 ? `${days}d ago` : `${Math.floor(days/365)}y ago`};
}

function render(items){
  const q = qEl.value.trim().toLowerCase();
  let list = !q ? items : items.filter(it =>
    it.name.toLowerCase().includes(q) || it.path.toLowerCase().includes(q)
  );
  listEl.innerHTML = "";

  if(sortMode === 'time'){
    list.sort((a,b)=>{
      const ad = a.updatedAt ? new Date(a.updatedAt).getTime() : -Infinity;
      const bd = b.updatedAt ? new Date(b.updatedAt).getTime() : -Infinity;
      return bd - ad;
    });

    const section = document.createElement('section');
    section.className = 'grp';
    const h2 = document.createElement('h2');
    h2.textContent = "All files â€” Newest â†’ Oldest";
    section.appendChild(h2);

    const grid = document.createElement('div');
    grid.className = 'cards';

    list.forEach(it=>{
      const card = buildCard(it);
      grid.appendChild(card);
    });

    section.appendChild(grid);
    listEl.appendChild(section);
    return;
  }

  // Name sort (grouped)
  const groups = new Map();
  list.forEach(it=>{
    const key = folderOf(it.path);
    if(!groups.has(key)) groups.set(key,[]);
    groups.get(key).push(it);
  });

  [...groups.entries()].sort().forEach(([folder,arr])=>{
    arr.sort((a,b)=>a.name.localeCompare(b.name));

    const section = document.createElement('section');
    section.className = 'grp';
    const h2 = document.createElement('h2');
    h2.innerHTML = `${folderIcon()} ${folder?`/${folder}`:"/"}`;
    section.appendChild(h2);

    const grid = document.createElement('div');
    grid.className = 'cards';

    arr.forEach(it=>{
      const card = buildCard(it);
      grid.appendChild(card);
    });

    section.appendChild(grid);
    listEl.appendChild(section);
  });
}

function buildCard(it){
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.href = it.href;

  const ic = document.createElement('div');
  ic.className = 'ic';
  ic.innerHTML = fileIcon();

  const titleWrap = document.createElement('div');
  titleWrap.className = 'titleWrap';
  titleWrap.innerHTML = `
    <div class="name">${prettyName(it.name)}</div>
    <div class="path">${it.path}</div>
  `;

  const open = document.createElement('div');
  open.className = 'openVis';
  open.innerHTML = `Open ${arrowIcon()}`;

  const meta = document.createElement('div');
  meta.className = 'meta';

  const when = document.createElement('span');
  when.className = 'ago';
  when.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="t">â€”</span>`;

  const exact = document.createElement('span');
  exact.className = 'exact';
  exact.textContent = 'â€”';

  if(it.updatedAt){
    const d = new Date(it.updatedAt);
    const ag = timeAgoClassAndText(d);
    when.classList.add(ag.cls);
    when.querySelector('.t').textContent = ag.text;
    when.title = `Last updated: ${isoLocal(d)}`;
    exact.textContent = isoLocal(d);
  } else {
    when.classList.add('t9');
  }

  meta.append(when, exact);

  const actions = document.createElement('div');
  actions.className = 'actions';

  const copyBtn = document.createElement('button');
  copyBtn.className = 'copyBtn';
  copyBtn.type = 'button';
  copyBtn.innerHTML = `
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <rect x="9" y="9" width="12" height="12" rx="2" stroke="#cdd7e6" stroke-width="1.5"/>
      <rect x="3" y="3" width="12" height="12" rx="2" stroke="#cdd7e6" stroke-width="1.5" opacity=".85"/>
    </svg>
    Copy HTML`;

  // Keep gesture + focus for iOS
  copyBtn.addEventListener('click', (ev)=>{
    ev.stopPropagation();
    ev.preventDefault();
    copyBtn.focus();
    copyFile(it.path, copyBtn);
  });

  actions.append(copyBtn);

  card.append(ic, titleWrap, open, meta, actions);

  // Navigate only if not clicking an interactive control
  card.addEventListener('click', (e)=>{
    if(e.target.closest('button,.copyBtn,input,textarea,a,select')) return;
    window.location.href = card.dataset.href;
  });

  return card;
}

function applyFilter(){ render(allItems); }

async function fetchTree(){
  statusEl.textContent = "Loadingâ€¦";
  try{
    const r = await fetch(`https://api.github.com/repos/${USER}/${REPO}/git/trees/HEAD?recursive=1`);
    if(!r.ok) throw new Error();
    const data = await r.json();
    allItems = data.tree
      .filter(n => n.type==="blob" && /\.html?$/i.test(n.path) && !/index\.html?$/i.test(n.path))
      .map(n => ({ path:n.path, name:n.path.split('/').pop(), href:BASE+n.path, updatedAt:null }));
    render(allItems);
    statusEl.textContent = `Found ${allItems.length} file(s), fetching datesâ€¦`;
    await fetchDates();
    render(allItems);
    statusEl.textContent = `Found ${allItems.length} file(s)`;
  }catch(e){
    statusEl.textContent = "Error fetching data";
  }
}

async function fetchDates(){
  let i = 0, max = 4;
  async function worker(){
    while(i < allItems.length){
      const idx = i++;
      try{
        const r = await fetch(`https://api.github.com/repos/${USER}/${REPO}/commits?path=${encodeURIComponent(allItems[idx].path)}&per_page=1`);
        if(r.ok){
          const c = await r.json();
          allItems[idx].updatedAt = c[0]?.commit?.committer?.date || null;
        }
      }catch(_){}
    }
  }
  await Promise.all(Array.from({length:max}, worker));
}

/* ===== Copy: Contents API â†’ download_url â†’ Pages ===== */
function encodePath(p){ return p.split('/').map(encodeURIComponent).join('/'); }

function b64ToUint8(b64){
  const bin = atob(b64);
  const len = bin.length;
  const out = new Uint8Array(len);
  for(let i=0;i<len;i++) out[i] = bin.charCodeAt(i);
  return out;
}

async function copyFile(path, btn){
  const original = btn.innerHTML;
  const apiUrl = `https://api.github.com/repos/${USER}/${REPO}/contents/${encodePath(path)}?ref=HEAD`;
  const pagesUrl = `${BASE}${path}`;

  btn.disabled = true;
  btn.innerHTML = 'Copyingâ€¦';
  btn.title = '';

  try{
    // keep gesture alive a tick on iOS
    await new Promise(r=>setTimeout(r, 0));

    // 1) Contents API
    let r = await fetch(apiUrl, { headers:{ 'Accept':'application/vnd.github+json' }, cache:'no-store' });
    if(r.ok){
      const data = await r.json();

      if(data?.encoding === 'base64' && data?.content){
        const text = new TextDecoder('utf-8').decode(b64ToUint8(data.content.replace(/\n/g,'')));
        await writeToClipboard(text, btn);
        btn.innerHTML = 'Copied âœ“';
        return;
      }
      if(data?.download_url){
        const r2 = await fetch(data.download_url, { cache:'no-store', mode:'cors' });
        if(r2.ok){
          const text = await r2.text();
          await writeToClipboard(text, btn);
          btn.innerHTML = 'Copied âœ“';
          return;
        }
      }
    }

    // 2) Pages (same-origin if hosted on GH Pages)
    r = await fetch(pagesUrl, { cache:'no-store', mode:'cors' });
    if(r.ok){
      const text = await r.text();
      await writeToClipboard(text, btn);
      btn.innerHTML = 'Copied âœ“';
      return;
    }

    throw new Error('All fetches failed');
  }catch(err){
    console.error('Copy failed:', err);
    btn.innerHTML = 'Failed âœ•';
    btn.title = String(err?.message||err);
  }finally{
    setTimeout(()=>{ btn.disabled=false; btn.innerHTML = original; btn.title=''; }, 1200);
  }
}

/* Robust clipboard with HTML + plain-text fallbacks */
async function writeToClipboard(text, btn){
  // Prefer modern API
  if (window.isSecureContext && navigator.clipboard?.writeText){
    await navigator.clipboard.writeText(text);
    return;
  }

  // Try ClipboardItem (some Chromium)
  if (window.isSecureContext && navigator.clipboard?.write && window.ClipboardItem){
    const blob = new Blob([text], {type:'text/plain'});
    await navigator.clipboard.write([new ClipboardItem({'text/plain': blob})]);
    return;
  }

  // Try contenteditable selection (better for iOS than textarea-only)
  const div = document.createElement('div');
  div.contentEditable = 'true';
  div.style.position='fixed';
  div.style.opacity='0';
  div.style.pointerEvents='none';
  div.style.whiteSpace='pre';
  div.textContent = text;
  document.body.appendChild(div);

  const range = document.createRange();
  range.selectNodeContents(div);
  const sel = window.getSelection();
  sel.removeAllRanges(); sel.addRange(range);

  try{
    document.execCommand('copy');
  }finally{
    sel.removeAllRanges();
    document.body.removeChild(div);
  }
}

fetchTree();
</script>
</body>
</html>