<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Experiments â€” Auto Index (cached, fast)</title>
<style>
  :root{
    --bg:#0a0b0d; --ink:#f5f6f8; --muted:#a8afbb;
    --card:#0f1117; --card2:#10131a; --line:#1a2130;
    --cardSub:#121823; --card2Sub:#141d2a;
    --shadow:0 1px 0 rgba(255,255,255,.02) inset, 0 0 0 1px #1a2130, 0 8px 18px rgba(0,0,0,.45);
    --shadow-hover:0 1px 0 rgba(255,255,255,.03) inset, 0 0 0 1px #24304a, 0 14px 28px rgba(0,0,0,.6);
    --radius:14px;

    --t0:#82FFB5; --t1:#66F5C8; --t2:#4FDEDE; --t3:#4BC5F2; --t4:#5AAAF5;
    --t5:#7D96F0; --t6:#9CA6CC; --t7:#A9B6E0; --t8:#B9C2E0; --t9:#B8B8B8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(#10131a,#0c0f15);border-bottom:1px solid #1c2537}
  .wrap{max-width:1240px;margin:0 auto;padding:12px 14px}
  h1{margin:0;font-size:16px;letter-spacing:.3px}
  main{max-width:1240px;margin:0 auto;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=search]{
    flex:1;min-width:260px;background:#0b0f16;border:1px solid #1e293e;border-radius:10px;
    padding:.55rem .7rem;color:var(--ink);outline:none;
    transition:border-color .2s, background .2s, box-shadow .25s;
    box-shadow:0 0 0 0 rgba(74,163,255,.0);
  }
  input[type=search]::placeholder{color:#8e97a6}
  input[type=search]:focus{border-color:#2b3f65;background:#0d1220;box-shadow:0 0 0 5px rgba(74,163,255,.06)}
  button{
    border:1px solid #25324a;background:#131a26;color:var(--ink);
    padding:.5rem .75rem;border-radius:10px;cursor:pointer;font-weight:650;letter-spacing:.2px;
    transition:transform .15s, box-shadow .2s, border-color .2s, background .2s;
    box-shadow:var(--shadow);
  }
  button:hover{transform:translateY(-1px);box-shadow:var(--shadow-hover);border-color:#31456b;background:#141e2c}
  .status{font-size:12px;color:#9aa3b2}
  .seg{display:inline-flex;border:1px solid #27324a;border-radius:10px;overflow:hidden}
  .seg button{border:0;border-right:1px solid #27324a;background:#101622;padding:.45rem .7rem}
  .seg button:last-child{border-right:0}
  .seg button[aria-pressed="true"]{background:#162133}
  .seg button[aria-pressed="true"] span{opacity:1}
  .seg button span{opacity:.85}
  .grp{margin-top:16px}
  .grp h2{display:flex;align-items:center;gap:8px;font-size:12px;color:#9aa3b2;margin:6px 2px 10px;letter-spacing:.25px}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:14px}
  .card{
    position:relative; overflow:hidden; text-decoration:none; color:inherit;
    background:linear-gradient(180deg,var(--card),var(--card2));
    border:1px solid var(--line); border-radius:var(--radius);
    padding:14px 16px; box-shadow:var(--shadow);
    transition:transform .18s, box-shadow .22s, border-color .2s, background .25s;
    display:flex; flex-direction:column; gap:10px; min-width:0;
  }
  .card.sub{background:linear-gradient(180deg,var(--cardSub),var(--card2Sub));border-color:#22314a}
  .card:before{
    content:""; position:absolute; inset:-1px; border-radius:var(--radius);
    background:radial-gradient(120px 80px at 0% 0%, rgba(74,163,255,.08), transparent 60%),
               radial-gradient(160px 100px at 100% 0%, rgba(39,255,136,.05), transparent 60%);
    pointer-events:none;
  }
  .card:hover,.card:focus-visible{transform:translateY(-1px);box-shadow:var(--shadow-hover);border-color:#2a3755;outline:none}
  .top{display:flex;align-items:center;gap:12px;min-width:0}
  .ic{flex:0 0 32px; width:32px; height:32px; display:grid; place-items:center; background:#0c1119; border:1px solid #1f2a42; border-radius:10px}
  .titleWrap{min-width:0; display:flex; flex:1 1 auto; flex-direction:column; gap:2px}
  .name{font-weight:750; letter-spacing:.2px; line-height:1.2; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .path{font-size:11px; color:#97a1b1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .openVis{flex:0 0 auto; font-size:12px; color:#cfd5df; opacity:.9; display:inline-flex; gap:6px; align-items:center}
  .bottom{display:flex; align-items:center; justify-content:space-between; gap:12px; min-width:0}
  .meta{display:flex; align-items:center; gap:10px; min-width:0; overflow:hidden}
  .ago{font-size:11px; font-weight:700; letter-spacing:.3px; display:inline-flex; align-items:center; gap:6px; flex:0 0 auto}
  .ago .dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.95}
  .ago.t0{color:var(--t0)} .ago.t1{color:var(--t1)} .ago.t2{color:var(--t2)}
  .ago.t3{color:var(--t3)} .ago.t4{color:var(--t4)} .ago.t5{color:var(--t5)}
  .ago.t6{color:var(--t6)} .ago.t7{color:var(--t7)} .ago.t8{color:var(--t8)} .ago.t9{color:var(--t9)}
  .exact{font-size:11px;color:#cfd5df;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  footer{color:#9aa3b2;text-align:center;padding:18px;border-top:1px solid #161b25}
  dialog::backdrop{background:rgba(0,0,0,.55)}
  dialog{border:1px solid #22314a;border-radius:12px;background:#0f131a;color:var(--ink);padding:12px;max-width:96vw}
  textarea{tab-size:2}
  @media (max-width:900px){.cards{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}}
  @media (max-width:480px){.cards{grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px}.openVis{display:none}}
  @media (prefers-reduced-motion: reduce){*{transition:none !important}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ðŸ§ª Experiments â€” Auto Index</h1>
    <div class="row" style="margin-top:8px">
      <input id="q" type="search" placeholder="Filter by name or pathâ€¦">
      <div class="seg" role="group" aria-label="Sort">
        <button id="sortTime" aria-pressed="true" title="Newest â†’ Oldest"><span>Time</span></button>
        <button id="sortName" aria-pressed="false" title="A â†’ Z by name"><span>Name</span></button>
      </div>
      <button id="refresh" aria-label="Refresh list">Refresh</button>
      <button id="auth" aria-label="Auth">ðŸ”‘</button>
      <span id="status" class="status">â€”</span>
    </div>
  </div>
</header>

<main><div id="list"></div></main>
<footer>Uses branch-SHA cache + ETag; timestamps are hydrated & cached. In-place editor requires a GitHub PAT.</footer>

<!-- Editor dialog -->
<dialog id="editor">
  <form method="dialog" style="display:flex;flex-direction:column;gap:8px;min-width:min(960px,96vw);min-height:60vh">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <strong id="ed-path" style="font-size:13px;letter-spacing:.2px"></strong>
      <div style="display:flex;gap:8px">
        <button id="ed-cancel">Cancel</button>
        <button id="ed-save" value="save" style="font-weight:700">Save</button>
      </div>
    </div>
    <textarea id="ed-text" spellcheck="false" style="flex:1;resize:vertical;background:#0b0f16;color:#f5f6f8;border:1px solid #27324a;border-radius:10px;padding:10px;font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace"></textarea>
    <div id="ed-status" class="status">â€”</div>
  </form>
</dialog>

<script>
/* ===== Config ===== */
const USER = "dubism";
const REPO = "Experiments";
const REF  = "main";

/* ===== DOM ===== */
const statusEl = document.getElementById('status');
const listEl = document.getElementById('list');
const qEl = document.getElementById('q');
const sortTimeBtn = document.getElementById('sortTime');
const sortNameBtn = document.getElementById('sortName');
document.getElementById('refresh').onclick = fetchIndex;

/* ===== State ===== */
let allItems = [];
let sortMode = 'time';
sortTimeBtn.onclick = () => setSort('time');
sortNameBtn.onclick = () => setSort('name');

/* ===== Cache keys ===== */
const SHA_KEY   = `idx:sha:${USER}/${REPO}@${REF}`;
const DATA_KEY  = `idx:data:${USER}/${REPO}@${REF}`;
const ETAG_KEY  = `idx:etag:${USER}/${REPO}@${REF}`;
const TOKEN_KEY = `gh:token:${USER}`;

/* ===== Auth / headers ===== */
let GH_TOKEN = localStorage.getItem(TOKEN_KEY) || '';
function setToken(t){
  GH_TOKEN = t || '';
  if (t) localStorage.setItem(TOKEN_KEY, t);
  else localStorage.removeItem(TOKEN_KEY);
}
function authHeaders(h={}){ return GH_TOKEN ? {...h, Authorization:`Bearer ${GH_TOKEN}`} : h; }
function datesKey(sha){ return `idx:dates:${USER}/${REPO}@${REF}:${sha}`; }

/* ===== UI: auth button ===== */
document.getElementById('auth').onclick = ()=>{
  const hint = GH_TOKEN ? '********' : '';
  const t = prompt('Paste a GitHub fine-grained PAT (with â€œContents: Read and Writeâ€ on this repo). Leave empty to clear:', hint);
  if (t === null) return;
  setToken(t && t!=='********' ? t.trim() : '');
  statusEl.textContent = GH_TOKEN ? 'Auth set.' : 'Auth cleared.';
};

/* ===== Utils ===== */
function setSort(mode){
  sortMode = mode;
  sortTimeBtn.setAttribute('aria-pressed', mode==='time' ? 'true' : 'false');
  sortNameBtn.setAttribute('aria-pressed', mode==='name' ? 'true' : 'false');
  applyFilter();
}
function prettyName(name){return name.replace(/\.html?$/i,'').replace(/[-_]+/g,' ').replace(/\b\w/g,m=>m.toUpperCase());}
function isoLocal(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ` +
         `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
function timeAgoClassAndText(d){
  let secs = Math.max(0,(Date.now()-d.getTime())/1000);
  if(secs < 60)  return {cls:'t0', text:`${Math.floor(secs)}s ago`};
  let mins = secs/60;
  if(mins < 5)   return {cls:'t1', text:`${Math.floor(mins)}m ago`};
  if(mins < 15)  return {cls:'t2', text:`${Math.floor(mins)}m ago`};
  if(mins < 30)  return {cls:'t3', text:`${Math.floor(mins)}m ago`};
  if(mins < 60)  return {cls:'t4', text:`${Math.floor(mins)}m ago`};
  let hours = mins/60;
  if(hours < 4)   return {cls:'t5', text:`${Math.floor(hours)}h ago`};
  if(hours < 12)  return {cls:'t6', text:`${Math.floor(hours)}h ago`};
  if(hours < 24)  return {cls:'t7', text:`${Math.floor(hours)}h ago`};
  if(hours < 72)  return {cls:'t8', text:`${Math.floor(hours)}h ago`};
  let days = Math.floor(hours/24);
  return {cls:'t9', text: days < 365 ? `${days}d ago` : `${Math.floor(days/365)}y ago`};
}
function fileIcon(){return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 3h6l4 4v14H7z" stroke="#9fb3d6" stroke-width="1.3"/><path d="M13 3v5h5" stroke="#9fb3d6" stroke-width="1.3"/></svg>`;}
function folderIcon(){return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 8h7l2 2h9v9H3z" stroke="#8ea2c6" stroke-width="1.3"/></svg>`;}
function arrowIcon(){return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 17l7-7M10 7h7v7" stroke="#cdd7e6" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`;}
const EXCLUDE_TOP = /^(?:assets?|img|images?|icons?|fonts?|audio|sounds?|video|media|dist|build|node_modules|\.github|\.git)\b/i;

/* ===== Rendering ===== */
function buildCard(it){
  // Card root as a div (keyboard-accessible "link")
  const card = document.createElement('div');
  card.className = 'card';
  if(it.depth >= 2) card.classList.add('sub');
  card.setAttribute('role','link');
  card.setAttribute('tabindex','0');
  const href = `https://${USER}.github.io/${REPO}/${it.path}`;
  card.addEventListener('click', (e)=>{
    // ignore clicks on buttons inside
    if (e.target.closest('button')) return;
    window.open(href, '_blank', 'noopener');
  });
  card.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); window.open(href,'_blank','noopener'); }
  });

  const top = document.createElement('div'); top.className = 'top';
  const ic = document.createElement('div'); ic.className = 'ic'; ic.innerHTML = fileIcon();
  const titleWrap = document.createElement('div'); titleWrap.className = 'titleWrap';
  titleWrap.innerHTML = `<div class="name">${prettyName(it.name)}</div><div class="path">${it.path}</div>`;
  const open = document.createElement('div'); open.className = 'openVis'; open.innerHTML = `Open ${arrowIcon()}`;
  top.append(ic, titleWrap, open);

  const bottom = document.createElement('div'); bottom.className = 'bottom';
  const meta = document.createElement('div'); meta.className = 'meta';
  const when = document.createElement('span'); when.className = 'ago t9';
  when.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="t">â€”</span>`;
  const exact = document.createElement('span'); exact.className = 'exact'; exact.textContent = 'â€”';
  if(it.updatedAt){
    const d = new Date(it.updatedAt);
    const ag = timeAgoClassAndText(d);
    when.className = 'ago ' + ag.cls;
    when.querySelector('.t').textContent = ag.text;
    when.title = `Last updated: ${isoLocal(d)}`;
    exact.textContent = isoLocal(d);
  }
  meta.append(when, exact);

  const actions = document.createElement('div');
  actions.style.display = 'flex';
  actions.style.gap = '8px';
  const editBtn = document.createElement('button');
  editBtn.textContent = 'Edit';
  editBtn.title = `Edit ${it.path}`;
  editBtn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); openEditor(it.path); };
  actions.append(editBtn);

  bottom.append(meta, actions);
  card.append(top, bottom);
  return card;
}

function render(items){
  const q = qEl.value?.trim().toLowerCase() ?? '';
  let list = !q ? items : items.filter(it =>
    it.name.toLowerCase().includes(q) || it.path.toLowerCase().includes(q)
  );
  listEl.innerHTML = "";

  if(sortMode === 'time'){
    list.sort((a,b)=>{
      const ad = a.updatedAt ? Date.parse(a.updatedAt) : -Infinity;
      const bd = b.updatedAt ? Date.parse(b.updatedAt) : -Infinity;
      return bd - ad;
    });
    const section = document.createElement('section'); section.className = 'grp';
    const h2 = document.createElement('h2'); h2.textContent = "All files â€” Newest â†’ Oldest";
    section.appendChild(h2);
    const grid = document.createElement('div'); grid.className = 'cards';
    list.forEach(it=> grid.appendChild(buildCard(it)));
    section.appendChild(grid); listEl.appendChild(section);
  } else {
    const groups = new Map();
    list.forEach(it=>{
      const key = it.path.includes('/') ? it.path.split('/')[0] : '';
      if(!groups.has(key)) groups.set(key,[]);
      groups.get(key).push(it);
    });
    [...groups.entries()].sort().forEach(([folder,arr])=>{
      arr.sort((a,b)=>a.name.localeCompare(b.name));
      const section = document.createElement('section'); section.className = 'grp';
      const h2 = document.createElement('h2'); h2.innerHTML = `${folder ? folderIcon() + ' /' + folder : 'Root'}`;
      section.appendChild(h2);
      const grid = document.createElement('div'); grid.className = 'cards';
      arr.forEach(it=> grid.appendChild(buildCard(it)));
      section.appendChild(grid); listEl.appendChild(section);
    });
  }
}

/* Filter hook */
function applyFilter(){ render(allItems); }

/* ===== API helpers ===== */
async function getJSON(url, headers = {}){
  const r = await fetch(url, {headers: {'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28', ...authHeaders(headers)}});
  if(!r.ok) throw new Error(`${url} HTTP ${r.status}`);
  return {json: await r.json(), resp: r};
}
function makeItemsFromTree(tree){
  const files = tree.tree.filter(n => {
    if(n.type !== 'blob') return false;
    if(!/\.html?$/i.test(n.path)) return false;
    if(/^index\.html?$/i.test(n.path)) return false;
    if(EXCLUDE_TOP.test(n.path)) return false;
    return true;
  });
  return files.map(n => ({
    path: n.path,
    name: n.path.split('/').pop(),
    updatedAt: null,
    depth: (n.path.match(/\//g)||[]).length + 1
  }));
}

/* ===== Timestamp hydration (per-file last commit) ===== */
async function getLastCommitISO(path){
  const url = `https://api.github.com/repos/${USER}/${REPO}/commits?sha=${encodeURIComponent(REF)}&path=${encodeURIComponent(path)}&per_page=1`;
  const {json} = await getJSON(url);
  const c = json && json[0] && json[0].commit;
  return c?.committer?.date || c?.author?.date || null;
}

// simple concurrency limiter
async function mapLimit(arr, limit, worker){
  const ret = Array(arr.length);
  let i=0, active=0, done=0;
  return new Promise((resolve,reject)=>{
    const pump = () => {
      while(active<limit && i<arr.length){
        const idx=i++; active++;
        Promise.resolve(worker(arr[idx], idx))
          .then(v=>{ret[idx]=v;})
          .catch(reject)
          .finally(()=>{active--; done++; if(done===arr.length) resolve(ret); else pump();});
      }
    };
    pump();
  });
}

async function hydrateUpdatedAt(items, sha){
  const key = datesKey(sha);
  const memo = JSON.parse(localStorage.getItem(key) || '{}');

  const todoIdx = [];
  items.forEach((it, idx)=>{
    if(memo[it.path]) it.updatedAt = memo[it.path];
    else todoIdx.push(idx);
  });

  if(!todoIdx.length) return;

  statusEl.textContent = `Fetching timestamps (${todoIdx.length})â€¦ ${GH_TOKEN?'(authed)':''}`;

  const limit = GH_TOKEN ? 8 : 4;
  try{
    await mapLimit(todoIdx, limit, async (idx)=>{
      const it = items[idx];
      try{
        const iso = await getLastCommitISO(it.path);
        if(iso){ it.updatedAt = iso; memo[it.path] = iso; }
      }catch(e){
        // swallow non-fatal errors; leave missing
        if(String(e?.message||e).includes('HTTP 403')) throw e;
      }
    });
  }catch(e){
    statusEl.textContent = 'Rate-limited by GitHub. Add a PAT (ðŸ”‘) for faster/higher quota.';
  }
  localStorage.setItem(key, JSON.stringify(memo));
}

/* ===== Fast path with caching by SHA + ETag ===== */
async function fetchIndex(){
  try{
    statusEl.textContent = 'Checking cacheâ€¦';
    // 1) Current branch SHA (tiny)
    const {json: branch} = await getJSON(`https://api.github.com/repos/${USER}/${REPO}/branches/${encodeURIComponent(REF)}`);
    const sha = branch.commit.sha;

    // 2) Cache hit â†’ instant paint + ensure dates
    const cachedSha  = localStorage.getItem(SHA_KEY);
    const cachedData = localStorage.getItem(DATA_KEY);
    if(cachedSha === sha && cachedData){
      allItems = JSON.parse(cachedData);
      await hydrateUpdatedAt(allItems, sha);
      render(allItems);
      statusEl.textContent = `Loaded ${allItems.length} file(s) from cache.`;
      // Background revalidation
      revalidateTree(sha).catch(()=>{});
      return;
    }

    // 3) Fetch tree with ETag (or full if first time)
    await revalidateTree(sha, true);
  }catch(e){
    console.error(e);
    statusEl.textContent = `Error: ${e.message||e}`;
  }
}

async function revalidateTree(sha, paintOnSuccess=false){
  const treeUrl = `https://api.github.com/repos/${USER}/${REPO}/git/trees/${sha}?recursive=1`;
  const etag = localStorage.getItem(ETAG_KEY);
  const headers = etag ? {'If-None-Match': etag} : {};
  statusEl.textContent = etag ? 'Revalidating treeâ€¦' : 'Loading treeâ€¦';

  const r = await fetch(treeUrl, {headers: {'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28', ...authHeaders(headers)}});
  if(r.status === 304){
    statusEl.textContent = 'Up to date (HTTP 304).';
    return;
  }
  if(!r.ok) throw new Error(`${treeUrl} HTTP ${r.status}`);

  const tree = await r.json();
  const newEtag = r.headers.get('etag') || '';
  const items = makeItemsFromTree(tree);

  localStorage.setItem(SHA_KEY, sha);
  localStorage.setItem(ETAG_KEY, newEtag);
  localStorage.setItem(DATA_KEY, JSON.stringify(items));

  // Hydrate timestamps then paint
  allItems = items;
  await hydrateUpdatedAt(allItems, sha);
  if(paintOnSuccess){
    render(allItems);
    statusEl.textContent = `Loaded ${allItems.length} file(s). Cached for next visit.`;
  }
}

/* ===== File I/O (read & write) ===== */
function toBase64(str){
  const bytes = new TextEncoder().encode(str);
  let bin = ''; const step = 0x8000;
  for(let i=0;i<bytes.length;i+=step){
    bin += String.fromCharCode(...bytes.subarray(i,i+step));
  }
  return btoa(bin);
}
function fromBase64(b64){
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
  return new TextDecoder().decode(bytes);
}

async function getFileText(path){
  // Try raw first
  const rawUrl = `https://api.github.com/repos/${USER}/${REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(REF)}`;
  const r = await fetch(rawUrl, {headers: {'Accept':'application/vnd.github.raw','X-GitHub-Api-Version':'2022-11-28', ...authHeaders()}});
  if(r.ok){
    const ct = r.headers.get('content-type') || '';
    if(!ct.includes('json')) return await r.text();
  }
  // Fallback to JSON and decode base64
  const {json} = await getJSON(rawUrl);
  if(json && json.content) return fromBase64(json.content.replace(/\n/g,''));
  throw new Error(`Unable to load ${path}`);
}

async function getFileMeta(path){
  const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(REF)}`;
  const {json} = await getJSON(url);
  return json; // includes .sha
}

async function putFileText(path, newText, message=`Edit ${path} via Auto Index`){
  if(!GH_TOKEN) throw new Error('Missing GitHub token. Click ðŸ”‘ and paste a PAT.');
  const meta = await getFileMeta(path);
  const body = {
    message,
    content: toBase64(newText),
    sha: meta.sha,
    branch: REF
  };
  const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${encodeURIComponent(path)}`;
  const r = await fetch(url, {
    method: 'PUT',
    headers: {'Accept':'application/vnd.github+json','Content-Type':'application/json','X-GitHub-Api-Version':'2022-11-28', ...authHeaders()},
    body: JSON.stringify(body)
  });
  if(!r.ok){
    const t = await r.text().catch(()=> '');
    throw new Error(`Save failed: HTTP ${r.status} ${t}`);
  }
  return await r.json(); // contains .commit.committer.date
}

/* ===== Editor UI ===== */
const ed = {
  dlg: document.getElementById('editor'),
  path: document.getElementById('ed-path'),
  text: document.getElementById('ed-text'),
  status: document.getElementById('ed-status'),
  saveBtn: document.getElementById('ed-save'),
  cancelBtn: document.getElementById('ed-cancel')
};

async function openEditor(path){
  try{
    ed.path.textContent = path;
    ed.status.textContent = 'Loadingâ€¦';
    ed.text.value = await getFileText(path);
    ed.status.textContent = 'Loaded.';
    ed.dlg.showModal();
  }catch(e){
    alert(`Open failed: ${e.message||e}`);
  }
}

ed.dlg.addEventListener('close', ()=>{
  ed.text.value=''; ed.status.textContent='â€”';
});

ed.saveBtn.addEventListener('click', async (ev)=>{
  ev.preventDefault();
  try{
    ed.status.textContent = 'Savingâ€¦';
    const res = await putFileText(ed.path.textContent, ed.text.value);
    ed.status.textContent = 'Saved. Refreshingâ€¦';
    // Invalidate caches and fully reload index (branch SHA changes on commit)
    localStorage.removeItem(SHA_KEY);
    localStorage.removeItem(DATA_KEY);
    localStorage.removeItem(ETAG_KEY);
    ed.dlg.close();
    await fetchIndex();
  }catch(e){
    ed.status.textContent = `Error: ${e.message||e}`;
  }
});

/* ===== init ===== */
fetchIndex();
qEl.addEventListener('input', applyFilter);
</script>
</body></html>