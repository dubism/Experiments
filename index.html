<script>
/* ===== Config ===== */
const USER = "dubism";
const REPO = "Experiments";
const REF  = "main";

/* ===== DOM ===== */
const statusEl = document.getElementById('status');
const listEl = document.getElementById('list');
const qEl = document.getElementById('q');
const sortTimeBtn = document.getElementById('sortTime');
const sortNameBtn = document.getElementById('sortName');
document.getElementById('refresh').onclick = fetchIndex;
qEl.oninput = applyFilter;

/* ===== State ===== */
let allItems = [];
let sortMode = 'time';
sortTimeBtn.onclick = () => setSort('time');
sortNameBtn.onclick = () => setSort('name');

/* ===== Cache keys ===== */
const SHA_KEY  = `idx:sha:${USER}/${REPO}@${REF}`;
const DATA_KEY = `idx:data:${USER}/${REPO}@${REF}`;
const ETAG_KEY = `idx:etag:${USER}/${REPO}@${REF}`;

/* ===== Utils ===== */
function setSort(mode){
  sortMode = mode;
  sortTimeBtn.setAttribute('aria-pressed', mode==='time' ? 'true' : 'false');
  sortNameBtn.setAttribute('aria-pressed', mode==='name' ? 'true' : 'false');
  applyFilter();
}
function prettyName(name){return name.replace(/\.html?$/i,'').replace(/[-_]+/g,' ').replace(/\b\w/g,m=>m.toUpperCase());}
function isoLocal(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ` +
         `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
function timeAgoClassAndText(d){
  let secs = Math.max(0,(Date.now()-d.getTime())/1000);
  if(secs < 60)  return {cls:'t0', text:`${Math.floor(secs)}s ago`};
  let mins = secs/60;
  if(mins < 5)   return {cls:'t1', text:`${Math.floor(mins)}m ago`};
  if(mins < 15)  return {cls:'t2', text:`${Math.floor(mins)}m ago`};
  if(mins < 30)  return {cls:'t3', text:`${Math.floor(mins)}m ago`};
  if(mins < 60)  return {cls:'t4', text:`${Math.floor(mins)}m ago`};
  let hours = mins/60;
  if(hours < 4)   return {cls:'t5', text:`${Math.floor(hours)}h ago`};
  if(hours < 12)  return {cls:'t6', text:`${Math.floor(hours)}h ago`};
  if(hours < 24)  return {cls:'t7', text:`${Math.floor(hours)}h ago`};
  if(hours < 72)  return {cls:'t8', text:`${Math.floor(hours)}h ago`};
  let days = Math.floor(hours/24);
  return {cls:'t9', text: days < 365 ? `${days}d ago` : `${Math.floor(days/365)}y ago`};
}
function fileIcon(){return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 3h6l4 4v14H7z" stroke="#9fb3d6" stroke-width="1.3"/><path d="M13 3v5h5" stroke="#9fb3d6" stroke-width="1.3"/></svg>`;}
function folderIcon(){return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 8h7l2 2h9v9H3z" stroke="#8ea2c6" stroke-width="1.3"/></svg>`;}
function arrowIcon(){return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 17l7-7M10 7h7v7" stroke="#cdd7e6" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`;}
function encode(p){return p.split('/').map(encodeURIComponent).join('/');}

/* ===== Rendering ===== */
function buildCard(it){
  const a = document.createElement('a');
  a.className = 'card';
  if(it.depth >= 2) a.classList.add('sub');
  a.href = `https://${USER}.github.io/${REPO}/${it.path}`;
  const top = document.createElement('div'); top.className = 'top';
  const ic = document.createElement('div'); ic.className = 'ic'; ic.innerHTML = fileIcon();
  const titleWrap = document.createElement('div'); titleWrap.className = 'titleWrap';
  titleWrap.innerHTML = `<div class="name">${prettyName(it.name)}</div><div class="path">${it.path}</div>`;
  const open = document.createElement('div'); open.className = 'openVis'; open.innerHTML = `Open ${arrowIcon()}`;
  top.append(ic, titleWrap, open);

  const bottom = document.createElement('div'); bottom.className = 'bottom';
  const meta = document.createElement('div'); meta.className = 'meta';
  const when = document.createElement('span'); when.className = 'ago t9';
  when.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="t">—</span>`;
  const exact = document.createElement('span'); exact.className = 'exact'; exact.textContent = '—';
  if(it.updatedAt){
    const d = new Date(it.updatedAt);
    const ag = timeAgoClassAndText(d);
    when.className = 'ago ' + ag.cls;
    when.querySelector('.t').textContent = ag.text;
    when.title = `Last updated: ${isoLocal(d)}`;
    exact.textContent = isoLocal(d);
  }
  meta.append(when, exact);
  bottom.append(meta, document.createElement('div'));
  a.append(top, bottom);
  return a;
}

function render(items){
  const q = qEl.value.trim().toLowerCase();
  let list = !q ? items : items.filter(it =>
    it.name.toLowerCase().includes(q) || it.path.toLowerCase().includes(q)
  );
  listEl.innerHTML = "";

  if(sortMode === 'time'){
    list.sort((a,b)=>{
      const ad = a.updatedAt ? Date.parse(a.updatedAt) : -Infinity;
      const bd = b.updatedAt ? Date.parse(b.updatedAt) : -Infinity;
      return bd - ad;
    });
    const section = document.createElement('section'); section.className = 'grp';
    const h2 = document.createElement('h2'); h2.textContent = "All files — Newest → Oldest";
    section.appendChild(h2);
    const grid = document.createElement('div'); grid.className = 'cards';
    list.forEach(it=> grid.appendChild(buildCard(it)));
    section.appendChild(grid); listEl.appendChild(section);
  } else {
    const groups = new Map();
    list.forEach(it=>{
      const key = it.path.includes('/') ? it.path.split('/')[0] : '';
      if(!groups.has(key)) groups.set(key,[]);
      groups.get(key).push(it);
    });
    [...groups.entries()].sort().forEach(([folder,arr])=>{
      arr.sort((a,b)=>a.name.localeCompare(b.name));
      const section = document.createElement('section'); section.className = 'grp';
      const h2 = document.createElement('h2'); h2.innerHTML = `${folder ? folderIcon() + ' /' + folder : 'Root'}`;
      section.appendChild(h2);
      const grid = document.createElement('div'); grid.className = 'cards';
      arr.forEach(it=> grid.appendChild(buildCard(it)));
      section.appendChild(grid); listEl.appendChild(section);
    });
  }
}

/* ===== API helpers ===== */
async function getJSON(url, headers = {}){
  const r = await fetch(url, {headers: {'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28', ...headers}});
  if(!r.ok) throw new Error(`${url} HTTP ${r.status}`);
  return {json: await r.json(), resp: r};
}
const EXCLUDE_TOP = /^(?:assets?|img|images?|icons?|fonts?|audio|sounds?|video|media|dist|build|node_modules|\.github|\.git)\b/i;

function makeItemsFromTree(tree){
  // keep only files we care about; drop obvious non-HTML folders
  const files = tree.tree.filter(n => {
    if(n.type !== 'blob') return false;
    if(!/\.html?$/i.test(n.path)) return false;
    if(/^index\.html?$/i.test(n.path)) return false;
    if(EXCLUDE_TOP.test(n.path)) return false;
    return true;
  });
  return files.map(n => ({
    path: n.path,
    name: n.path.split('/').pop(),
    updatedAt: null, // can be filled later if you want
    depth: (n.path.match(/\//g)||[]).length + 1
  }));
}

/* ===== Fast path with caching by SHA + ETag ===== */
async function fetchIndex(){
  try{
    statusEl.textContent = 'Checking cache…';
    // 1) Get current branch SHA (tiny)
    const {json: branch} = await getJSON(`https://api.github.com/repos/${USER}/${REPO}/branches/${encodeURIComponent(REF)}`);
    const sha = branch.commit.sha;

    // 2) If SHA unchanged, paint instantly from cache
    const cachedSha  = localStorage.getItem(SHA_KEY);
    const cachedData = localStorage.getItem(DATA_KEY);
    if(cachedSha === sha && cachedData){
      allItems = JSON.parse(cachedData);
      render(allItems);
      statusEl.textContent = `Loaded ${allItems.length} file(s) from cache (SHA unchanged).`;
      // Revalidate in background (won't block UI)
      revalidateTree(sha).catch(()=>{});
      return;
    }

    // 3) Otherwise fetch the tree with ETag
    await revalidateTree(sha, true);
  }catch(e){
    console.error(e);
    statusEl.textContent = `Error: ${e.message||e}`;
  }
}

async function revalidateTree(sha, paintOnSuccess=false){
  const treeUrl = `https://api.github.com/repos/${USER}/${REPO}/git/trees/${sha}?recursive=1`;
  const etag = localStorage.getItem(ETAG_KEY);
  const headers = etag ? {'If-None-Match': etag} : {};

  statusEl.textContent = etag ? 'Revalidating tree…' : 'Loading tree…';
  const r = await fetch(treeUrl, {headers: {'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28', ...headers}});
  if(r.status === 304){
    statusEl.textContent = 'Up to date (HTTP 304).';
    return;
  }
  if(!r.ok) throw new Error(`${treeUrl} HTTP ${r.status}`);

  const tree = await r.json();
  const newEtag = r.headers.get('etag') || '';
  const items = makeItemsFromTree(tree);

  // Persist
  localStorage.setItem(SHA_KEY, sha);
  localStorage.setItem(ETAG_KEY, newEtag);
  localStorage.setItem(DATA_KEY, JSON.stringify(items));

  if(paintOnSuccess){
    allItems = items;
    render(allItems);
    statusEl.textContent = `Loaded ${allItems.length} file(s). Cached for next visit.`;
  }
}

/* init */
fetchIndex();
</script>
