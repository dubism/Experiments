<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Experiments â€” Auto Index (No-403)</title>
<style>
  :root{
    --bg:#0a0b0d; --ink:#f5f6f8; --muted:#a8afbb;
    --card:#0f1117; --card2:#10131a; --line:#1a2130;
    --cardSub:#121823; --card2Sub:#141d2a;
    --shadow:0 1px 0 rgba(255,255,255,.02) inset, 0 0 0 1px #1a2130, 0 8px 18px rgba(0,0,0,.45);
    --shadow-hover:0 1px 0 rgba(255,255,255,.03) inset, 0 0 0 1px #24304a, 0 14px 28px rgba(0,0,0,.6);
    --radius:14px;

    --t0:#82FFB5; --t1:#66F5C8; --t2:#4FDEDE; --t3:#4BC5F2; --t4:#5AAAF5;
    --t5:#7D96F0; --t6:#9CA6CC; --t7:#A9B6E0; --t8:#B9C2E0; --t9:#B8B8B8;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}

  header{position:sticky;top:0;z-index:10;background:linear-gradient(#10131a,#0c0f15);border-bottom:1px solid #1c2537}
  .wrap{max-width:1240px;margin:0 auto;padding:12px 14px}
  h1{margin:0;font-size:16px;letter-spacing:.3px}
  main{max-width:1240px;margin:0 auto;padding:14px}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=search]{
    flex:1;min-width:260px;background:#0b0f16;border:1px solid #1e293e;border-radius:10px;
    padding:.55rem .7rem;color:var(--ink);outline:none;
    transition:border-color .2s, background .2s, box-shadow .25s;
    box-shadow:0 0 0 0 rgba(74,163,255,.0);
  }
  input[type=search]::placeholder{color:#8e97a6}
  input[type=search]:focus{border-color:#2b3f65;background:#0d1220;box-shadow:0 0 0 5px rgba(74,163,255,.06)}

  button{
    border:1px solid #25324a;background:#131a26;color:var(--ink);
    padding:.5rem .75rem;border-radius:10px;cursor:pointer;font-weight:650;letter-spacing:.2px;
    transition:transform .15s, box-shadow .2s, border-color .2s, background .2s;
    box-shadow:var(--shadow);
  }
  button:hover{transform:translateY(-1px);box-shadow:var(--shadow-hover);border-color:#31456b;background:#141e2c}
  .status{font-size:12px;color:#9aa3b2}

  .seg{display:inline-flex;border:1px solid #27324a;border-radius:10px;overflow:hidden}
  .seg button{border:0;border-right:1px solid #27324a;background:#101622;padding:.45rem .7rem}
  .seg button:last-child{border-right:0}
  .seg button[aria-pressed="true"]{background:#162133}
  .seg button[aria-pressed="true"] span{opacity:1}
  .seg button span{opacity:.85}

  .grp{margin-top:16px}
  .grp h2{display:flex;align-items:center;gap:8px;font-size:12px;color:#9aa3b2;margin:6px 2px 10px;letter-spacing:.25px}

  .cards{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(360px,1fr));
    gap:14px;
  }

  .card{
    position:relative; overflow:hidden; text-decoration:none; color:inherit;
    background:linear-gradient(180deg,var(--card),var(--card2));
    border:1px solid var(--line); border-radius:var(--radius);
    padding:14px 16px; box-shadow:var(--shadow);
    transition:transform .18s, box-shadow .22s, border-color .2s, background .25s;
    display:flex; flex-direction:column; gap:10px; min-width:0;
  }
  .card.sub{background:linear-gradient(180deg,var(--cardSub),var(--card2Sub));border-color:#22314a}
  .card:before{
    content:""; position:absolute; inset:-1px; border-radius:var(--radius);
    background:radial-gradient(120px 80px at 0% 0%, rgba(74,163,255,.08), transparent 60%),
               radial-gradient(160px 100px at 100% 0%, rgba(39,255,136,.05), transparent 60%);
    pointer-events:none;
  }
  .card:hover,.card:focus-visible{transform:translateY(-1px);box-shadow:var(--shadow-hover);border-color:#2a3755;outline:none}

  .top{display:flex;align-items:center;gap:12px;min-width:0}
  .ic{flex:0 0 32px; width:32px; height:32px; display:grid; place-items:center; background:#0c1119; border:1px solid #1f2a42; border-radius:10px}
  .titleWrap{min-width:0; display:flex; flex:1 1 auto; flex-direction:column; gap:2px}
  .name{font-weight:750; letter-spacing:.2px; line-height:1.2; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .path{font-size:11px; color:#97a1b1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .openVis{flex:0 0 auto; font-size:12px; color:#cfd5df; opacity:.9; display:inline-flex; gap:6px; align-items:center; pointer-events:none}

  .bottom{display:flex; align-items:center; justify-content:space-between; gap:12px; min-width:0}
  .meta{display:flex; align-items:center; gap:10px; min-width:0; overflow:hidden}
  .ago{font-size:11px; font-weight:700; letter-spacing:.3px; display:inline-flex; align-items:center; gap:6px; flex:0 0 auto}
  .ago .dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.95}
  .ago.t0{color:var(--t0)} .ago.t1{color:var(--t1)} .ago.t2{color:var(--t2)}
  .ago.t3{color:var(--t3)} .ago.t4{color:var(--t4)} .ago.t5{color:var(--t5)}
  .ago.t6{color:var(--t6)} .ago.t7{color:var(--t7)} .ago.t8{color:var(--t8)} .ago.t9{color:var(--t9)}
  .exact{font-size:11px;color:#cfd5df;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .copyBtn{
    border:1px dashed #2a3755;background:#101622;color:#d9e1ee;
    padding:.38rem .6rem;border-radius:9px;font-size:11px;letter-spacing:.2px;
    display:inline-flex;align-items:center;gap:6px;box-shadow:none;flex:0 0 auto;
  }
  .copyBtn:hover{background:#12203a;border-color:#35507d}
  .copyBtn svg{opacity:.9}

  footer{color:#9aa3b2;text-align:center;padding:18px;border-top:1px solid #161b25}

  @media (max-width:900px){
    .cards{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
  }
  @media (max-width:480px){
    .cards{grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px}
    .openVis{display:none}
  }
  @media (prefers-reduced-motion: reduce){*{transition:none !important}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ðŸ§ª Experiments â€” Auto Index</h1>
    <div class="row" style="margin-top:8px">
      <input id="q" type="search" placeholder="Filter by name or pathâ€¦">
      <div class="seg" role="group" aria-label="Sort">
        <button id="sortTime" aria-pressed="true" title="Newest â†’ Oldest"><span>Time</span></button>
        <button id="sortName" aria-pressed="false" title="A â†’ Z by name"><span>Name</span></button>
      </div>
      <button id="refresh" aria-label="Refresh list">
        <span style="display:inline-flex;gap:8px;align-items:center">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 12a 8 8 0 1 1-2.34-5.66" stroke="#9fb3d6" stroke-width="1.5" stroke-linecap="round"></path>
            <path d="M20 4v6h-6" stroke="#9fb3d6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          Refresh
        </span>
      </button>
      <button id="copySelf" aria-label="Copy this pageâ€™s HTML">Copy this page</button>
      <span id="status" class="status">â€”</span>
    </div>
  </div>
</header>

<main>
  <div id="list"></div>
</main>

<footer>Generated from <code>dubism/Experiments</code> via Git Trees API</footer>

<script>
/* ===== Config ===== */
const USER = "dubism";
const REPO = "Experiments";
const REF  = "main";  // fixed to avoid hitting /repos default-branch endpoints
const BASE = `https://${USER}.github.io/${REPO}/`;

/* ===== DOM ===== */
const statusEl = document.getElementById('status');
const listEl = document.getElementById('list');
const qEl = document.getElementById('q');
const sortTimeBtn = document.getElementById('sortTime');
const sortNameBtn = document.getElementById('sortName');
const copySelfBtn = document.getElementById('copySelf');
document.getElementById('refresh').onclick = fetchIndex;
qEl.oninput = applyFilter;
copySelfBtn.onclick = copySelf;

/* ===== State ===== */
let allItems = [];
let sortMode = 'time';
sortTimeBtn.onclick = () => setSort('time');
sortNameBtn.onclick = () => setSort('name');

/* ===== Utils ===== */
function setSort(mode){
  sortMode = mode;
  sortTimeBtn.setAttribute('aria-pressed', mode==='time' ? 'true' : 'false');
  sortNameBtn.setAttribute('aria-pressed', mode==='name' ? 'true' : 'false');
  applyFilter();
}
function withTimeout(promise, ms, label){
  return Promise.race([
    promise,
    new Promise((_,rej)=>setTimeout(()=>rej(new Error(`${label} timeout after ${ms}ms`)), ms))
  ]);
}
async function gh(url){
  const r = await withTimeout(fetch(url, {
    headers:{
      'Accept':'application/vnd.github+json',
      'X-GitHub-Api-Version':'2022-11-28'
    }
  }), 15000, url);

  // Explicit, readable rate-limit handling
  if (r.status === 403) {
    const reset = r.headers.get('x-ratelimit-reset');
    const retry = r.headers.get('retry-after');
    const etaMs = retry ? (+retry*1000)
      : reset ? Math.max(0, (+reset*1000 - Date.now()))
      : 0;
    const eta = etaMs ? `${Math.ceil(etaMs/1000)}s` : 'soon';
    throw new Error(`${url} HTTP 403 (rate limited, try again in ~${eta})`);
  }
  if (!r.ok) throw new Error(`${url} HTTP ${r.status}`);
  return r.json();
}
function fileIcon(){return `
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M7 3h6l4 4v14H7z" stroke="#9fb3d6" stroke-width="1.3" />
    <path d="M13 3v5h5" stroke="#9fb3d6" stroke-width="1.3"/>
  </svg>`;}
function folderIcon(){return `
  <svg class="folder-ic" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M3 8h7l2 2h9v9H3z" stroke="#8ea2c6" stroke-width="1.3"/>
  </svg>`;}
function arrowIcon(){return `
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M7 17l7-7M10 7h7v7" stroke="#cdd7e6" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;}
function prettyName(name){return name.replace(/\.html?$/i,'').replace(/[-_]+/g,' ').replace(/\b\w/g,m=>m.toUpperCase());}
function isoLocal(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ` +
         `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
function timeAgoClassAndText(d){
  let secs = Math.max(0,(Date.now()-d.getTime())/1000);
  if(secs < 60)  return {cls:'t0', text:`${Math.floor(secs)}s ago`};
  let mins = secs/60;
  if(mins < 5)   return {cls:'t1', text:`${Math.floor(mins)}m ago`};
  if(mins < 15)  return {cls:'t2', text:`${Math.floor(mins)}m ago`};
  if(mins < 30)  return {cls:'t3', text:`${Math.floor(mins)}m ago`};
  if(mins < 60)  return {cls:'t4', text:`${Math.floor(mins)}m ago`};
  let hours = mins/60;
  if(hours < 4)   return {cls:'t5', text:`${Math.floor(hours)}h ago`};
  if(hours < 12)  return {cls:'t6', text:`${Math.floor(hours)}h ago`};
  if(hours < 24)  return {cls:'t7', text:`${Math.floor(hours)}h ago`};
  if(hours < 72)  return {cls:'t8', text:`${Math.floor(hours)}h ago`};
  let days = Math.floor(hours/24);
  return {cls:'t9', text: days < 365 ? `${days}d ago` : `${Math.floor(days/365)}y ago`};
}

/* ===== Rendering ===== */
function buildCard(it){
  const a = document.createElement('a');
  a.className = 'card';
  if(it.depth >= 2) a.classList.add('sub');
  a.href = it.href;
  a.dataset.path = it.path;

  const top = document.createElement('div'); top.className = 'top';
  const ic = document.createElement('div'); ic.className = 'ic'; ic.innerHTML = fileIcon();
  const titleWrap = document.createElement('div'); titleWrap.className = 'titleWrap';
  titleWrap.innerHTML = `
    <div class="name">${prettyName(it.name)}</div>
    <div class="path">${it.path}</div>
  `;
  const open = document.createElement('div'); open.className = 'openVis'; open.innerHTML = `Open ${arrowIcon()}`;
  top.append(ic, titleWrap, open);

  const bottom = document.createElement('div'); bottom.className = 'bottom';
  const meta = document.createElement('div'); meta.className = 'meta';
  const when = document.createElement('span'); when.className = 'ago t9';
  when.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="t">â€”</span>`;
  const exact = document.createElement('span'); exact.className = 'exact'; exact.textContent = 'â€”';
  if(it.updatedAt){
    const d = new Date(it.updatedAt);
    const ag = timeAgoClassAndText(d);
    when.classList.add(ag.cls); when.querySelector('.t').textContent = ag.text; when.title = `Last updated: ${isoLocal(d)}`;
    exact.textContent = isoLocal(d);
  }
  meta.append(when, exact);

  const actions = document.createElement('div'); actions.className = 'actions';
  const copyBtn = document.createElement('button');
  copyBtn.className = 'copyBtn'; copyBtn.type = 'button';
  copyBtn.innerHTML = `
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <rect x="9" y="9" width="12" height="12" rx="2" stroke="#cdd7e6" stroke-width="1.5"/>
      <rect x="3" y="3" width="12" height="12" rx="2" stroke="#cdd7e6" stroke-width="1.5" opacity=".85"/>
    </svg>
    Copy HTML`;
  copyBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); ev.stopPropagation(); copyFile(it.path, copyBtn); });
  actions.append(copyBtn);
  bottom.append(meta, actions);

  a.append(top, bottom);
  return a;
}

function render(items){
  const q = qEl.value.trim().toLowerCase();
  let list = !q ? items : items.filter(it =>
    it.name.toLowerCase().includes(q) || it.path.toLowerCase().includes(q)
  );
  listEl.innerHTML = "";

  if(sortMode === 'time'){
    list.sort((a,b)=>{
      const ad = a.updatedAt ? new Date(a.updatedAt).getTime() : -Infinity;
      const bd = b.updatedAt ? new Date(b.updatedAt).getTime() : -Infinity;
      return bd - ad;
    });

    const section = document.createElement('section');
    section.className = 'grp';
    const h2 = document.createElement('h2'); h2.textContent = "All files â€” Newest â†’ Oldest (dates load on demand)";
    section.appendChild(h2);

    const grid = document.createElement('div'); grid.className = 'cards';
    list.forEach(it=> grid.appendChild(buildCard(it)));
    section.appendChild(grid);
    listEl.appendChild(section);
  } else {
    const groups = new Map();
    list.forEach(it=>{
      const key = it.path.includes('/') ? it.path.split('/')[0] : '';
      if(!groups.has(key)) groups.set(key,[]);
      groups.get(key).push(it);
    });
    [...groups.entries()].sort().forEach(([folder,arr])=>{
      arr.sort((a,b)=>a.name.localeCompare(b.name));
      const section = document.createElement('section'); section.className = 'grp';
      const h2 = document.createElement('h2'); h2.innerHTML = `${folder ? folderIcon() + ' /' + folder : 'Root'}`;
      section.appendChild(h2);
      const grid = document.createElement('div'); grid.className = 'cards';
      arr.forEach(it=> grid.appendChild(buildCard(it)));
      section.appendChild(grid); listEl.appendChild(section);
    });
  }

  initDateObserver(); // attach lazy date loader to current cards
}

function applyFilter(){ render(allItems); }

/* ===== Data via Git Trees (two calls, no folder fan-out) ===== */
async function fetchIndex(){
  statusEl.textContent = "Loadingâ€¦";
  try{
    // 1) Resolve branch SHA
    const branch = await gh(`https://api.github.com/repos/${USER}/${REPO}/branches/${encodeURIComponent(REF)}`);
    const sha = branch.commit.sha;

    // 2) Get recursive tree
    const tree = await gh(`https://api.github.com/repos/${USER}/${REPO}/git/trees/${sha}?recursive=1`);

    const files = tree.tree.filter(n =>
      n.type === 'blob' && /\.html?$/i.test(n.path) && !/^index\.html?$/i.test(n.path)
    );

    allItems = files.map(n => {
      const name = n.path.split('/').pop();
      return {
        path: n.path,
        name,
        href: BASE + n.path,
        updatedAt: null,
        depth: n.path.includes('/') ? n.path.split('/').length : 1
      };
    });

    render(allItems);
    statusEl.textContent = `Found ${allItems.length} file(s). Dates load on demand.`;
  }catch(e){
    console.error(e);
    statusEl.textContent = `Error: ${e.message || e}`;
  }
}

/* ===== Lazy commit dates (viewport-triggered, concurrency=1) ===== */
const DATE_LIMIT_TOTAL = 40;    // safety: at most N dates per page view
let dateRequested = new Set();
let dateFetched = 0;
let queue = [];
let processing = false;
let cooldownUntil = 0;

function initDateObserver(){
  const cards = document.querySelectorAll('.card');
  const io = new IntersectionObserver((entries)=>{
    for(const entry of entries){
      if(!entry.isIntersecting) continue;
      const path = entry.target.dataset.path;
      if(!path || dateRequested.has(path)) continue;
      if(dateFetched + queue.length >= DATE_LIMIT_TOTAL) continue; // cap
      dateRequested.add(path);
      queue.push(path);
      processQueue();
    }
  }, {rootMargin:'200px 0px 200px 0px'});

  cards.forEach(c=> io.observe(c));
}

async function processQueue(){
  if(processing) return;
  processing = true;
  try{
    while(queue.length){
      const now = Date.now();
      if(now < cooldownUntil){
        const waitMs = cooldownUntil - now;
        statusEl.textContent = `Cooling down for rate limitâ€¦ resuming in ~${Math.ceil(waitMs/1000)}s`;
        await new Promise(r=>setTimeout(r, Math.min(waitMs, 5000)));
        continue;
      }

      const path = queue.shift();
      try{
        const d = await fetchCommitDate(path);
        const it = allItems.find(x=>x.path===path);
        if(it && d){ it.updatedAt = d.toISOString(); updateCardDates(path, d); dateFetched++; }
        if(sortMode==='time'){ applyFilter(); } // keep order fresh
      }catch(err){
        // 403 handling sets cooldown; others we ignore
        console.warn('Date fetch failed for', path, err);
      }
    }
  } finally {
    processing = false;
  }
}

async function fetchCommitDate(path){
  const url = `https://api.github.com/repos/${USER}/${REPO}/commits?path=${encodeURIComponent(path)}&per_page=1&sha=${encodeURIComponent(REF)}`;
  const r = await withTimeout(fetch(url, {
    headers:{
      'Accept':'application/vnd.github+json',
      'X-GitHub-Api-Version':'2022-11-28'
    }
  }), 15000, 'commits');

  if (r.status === 403){
    const reset = r.headers.get('x-ratelimit-reset');
    const retry = r.headers.get('retry-after');
    const etaMs = retry ? (+retry*1000)
      : reset ? Math.max(0, (+reset*1000 - Date.now()))
      : 30*1000;
    cooldownUntil = Date.now() + Math.max(etaMs, 10*1000);
    throw new Error(`Rate limited, cooling ~${Math.ceil(etaMs/1000)}s`);
  }
  if(!r.ok) throw new Error(`Commits HTTP ${r.status}`);

  const c = await r.json();
  const iso = c?.[0]?.commit?.committer?.date;
  return iso ? new Date(iso) : null;
}

function updateCardDates(path, d){
  const card = document.querySelector(`.card[data-path="${cssEscape(path)}"]`);
  if(!card) return;
  const when = card.querySelector('.ago');
  const exact = card.querySelector('.exact');
  if(!when || !exact) return;
  when.className = 'ago'; // reset classes
  const ag = timeAgoClassAndText(d);
  when.classList.add(ag.cls);
  when.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="t">${ag.text}</span>`;
  when.title = `Last updated: ${isoLocal(d)}`;
  exact.textContent = isoLocal(d);
}

// Minimal CSS.escape fallback
function cssEscape(sel){
  return sel.replace(/["\\#.;,!?+*~^$[\] ()=>|]/g, '\\$&');
}

/* ===== Copy helpers (no API: fetch from Pages) ===== */
async function copyFile(path, btn){
  const original = btn.innerHTML;
  try{
    btn.disabled = true; btn.innerHTML = 'Copyingâ€¦';
    const r = await withTimeout(fetch(`${BASE}${path}`, {cache:'no-store'}), 15000, 'pages');
    if(!r.ok) throw new Error(`Pages HTTP ${r.status}`);
    const text = await r.text();
    await writeToClipboard(text);
    btn.innerHTML = 'Copied âœ“';
  }catch(err){
    console.error('Copy failed:', err);
    btn.innerHTML = 'Failed âœ•';
  }finally{
    setTimeout(()=>{ btn.disabled=false; btn.innerHTML = original; }, 1200);
  }
}

async function writeToClipboard(text){
  if(navigator.clipboard?.writeText){ return navigator.clipboard.writeText(text); }
  const ta = document.createElement('textarea');
  ta.value = text; ta.style.position='fixed'; ta.style.left='-9999px';
  document.body.appendChild(ta); ta.focus(); ta.select();
  try{ document.execCommand('copy'); } finally{ document.body.removeChild(ta); }
}

/* Copy this page (DOM fallback) */
async function copySelf(){
  const btn = copySelfBtn; const original = btn.innerHTML;
  try{
    btn.disabled = true; btn.innerHTML = 'Copyingâ€¦';
    // Try to fetch raw from Pages; fallback to DOM
    let text = '';
    try{
      const r = await withTimeout(fetch(`${BASE}index.html`, {cache:'no-store'}), 12000, 'self');
      if(r.ok) text = await r.text();
    }catch(_){}
    if(!text){ text = '<!DOCTYPE html>\n' + document.documentElement.outerHTML; }
    await writeToClipboard(text);
    btn.innerHTML = 'Copied âœ“';
  }catch(e){
    console.error(e); btn.innerHTML = 'Failed âœ•';
  }finally{
    setTimeout(()=>{ btn.disabled=false; btn.innerHTML=original; }, 1200);
  }
}

/* init */
fetchIndex();
</script>
</body></html>
