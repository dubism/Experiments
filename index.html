<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Experiments ‚Äî Auto Index</title>
<style>
  :root{
    /* Base */
    --bg:#0a0b0d; --ink:#f5f6f8; --muted:#a8afbb;
    --card:#0f1117; --card2:#10131a; --line:#1a2130;
    --shadow: 0 1px 0 rgba(255,255,255,.02) inset, 0 0 0 1px #1a2130, 0 8px 24px rgba(0,0,0,.45);
    --shadow-hover: 0 1px 0 rgba(255,255,255,.03) inset, 0 0 0 1px #24304a, 0 18px 36px rgba(0,0,0,.6);
    --radius:14px;

    /* Green ‚Üí Bluish ‚Üí Grey (grey only after 3 days) */
    --t0:#82FFB5;  /* <1m fresh green */
    --t1:#66F5C8;  /* 1‚Äì5m greenish aqua */
    --t2:#4FDEDE;  /* 5‚Äì15m teal-blue */
    --t3:#4BC5F2;  /* 15‚Äì30m light blue */
    --t4:#5AAAF5;  /* 30‚Äì60m medium blue */
    --t5:#7D96F0;  /* 1‚Äì4h soft blue-grey */
    --t6:#9CA6CC;  /* 4‚Äì12h cool grey-blue */
    --t7:#A9B6E0;  /* 12‚Äì24h cooler blue-grey */
    --t8:#B9C2E0;  /* 24‚Äì72h desaturated blue-grey */
    --t9:#B8B8B8;  /* >72h neutral grey */
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  header{position:sticky;top:0;z-index:10;background:linear-gradient(#10131a,#0c0f15);border-bottom:1px solid #1c2537}
  .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
  h1{margin:0;font-size:16px;letter-spacing:.3px}
  main{max-width:1100px;margin:0 auto;padding:18px 16px}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=search]{
    flex:1;min-width:240px;background:#0b0f16;border:1px solid #1e293e;border-radius:12px;
    padding:.65rem .85rem;color:var(--ink);outline:none;
    transition:border-color .2s, background .2s, box-shadow .25s;
    box-shadow:0 0 0 0 rgba(74,163,255,.0);
  }
  input[type=search]::placeholder{color:#8e97a6}
  input[type=search]:focus{border-color:#2b3f65;background:#0d1220;box-shadow:0 0 0 6px rgba(74,163,255,.06)}

  button{
    border:1px solid #25324a;background:#131a26;color:var(--ink);
    padding:.6rem .85rem;border-radius:12px;cursor:pointer;font-weight:650;letter-spacing:.2px;
    transition:transform .15s, box-shadow .2s, border-color .2s, background .2s;
    box-shadow:var(--shadow);
  }
  button:hover{transform:translateY(-1px);box-shadow:var(--shadow-hover);border-color:#31456b;background:#141e2c}
  .status{font-size:12px;color:var(--muted)}

  /* sort toggle (segmented) */
  .seg{display:inline-flex;border:1px solid #27324a;border-radius:12px;overflow:hidden}
  .seg button{border:0;border-right:1px solid #27324a;background:#101622;padding:.5rem .7rem}
  .seg button:last-child{border-right:0}
  .seg button[aria-pressed="true"]{background:#162133}
  .seg button[aria-pressed="true"] span{opacity:1}
  .seg button span{opacity:.85}

  .grp{margin-top:18px}
  .grp h2{
    display:flex;align-items:center;gap:8px;
    font-size:12px;color:#9aa3b2;margin:8px 2px 10px;letter-spacing:.25px
  }
  .grp h2 .folder-ic{opacity:.85}

  .cards{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:12px;
  }

  /* Card */
  .card{
    display:block;text-decoration:none;color:inherit;
    background:linear-gradient(180deg,var(--card),var(--card2));
    border:1px solid var(--line);border-radius:var(--radius);
    padding:12px 12px 10px;
    box-shadow:var(--shadow);
    transition:transform .18s, box-shadow .22s, border-color .2s, background .25s;
    position:relative;overflow:hidden;
  }
  .card:before{
    content:"";position:absolute;inset:-1px;border-radius:var(--radius);
    background:radial-gradient(120px 80px at 0% 0%, rgba(74,163,255,.08), transparent 60%),
               radial-gradient(160px 100px at 100% 0%, rgba(39,255,136,.05), transparent 60%);
    pointer-events:none;
  }
  .card:hover,.card:focus-visible{transform:translateY(-2px);box-shadow:var(--shadow-hover);border-color:#2a3755;outline:none}

  .top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .ic{
    width:22px;height:22px;flex:0 0 22px;display:grid;place-items:center;
    background:#0c1119;border:1px solid #1f2a42;border-radius:9px;
  }
  .name{font-weight:700;letter-spacing:.2px;line-height:1.25;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .path{font-size:11px;color:#97a1b1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .meta{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:10px;flex-wrap:wrap}
  .timeBlock{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  /* ‚ÄúTime since‚Äù ‚Äî text only (no backplate) */
  .ago{
    font-size:11px;font-weight:700;letter-spacing:.3px;
    display:inline-flex;align-items:center;gap:6px;
  }
  .ago .dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.95}

  /* Colored text variants (no background/border) */
  .ago.t0{color:var(--t0)} .ago.t1{color:var(--t1)} .ago.t2{color:var(--t2)}
  .ago.t3{color:var(--t3)} .ago.t4{color:var(--t4)} .ago.t5{color:var(--t5)}
  .ago.t6{color:var(--t6)} .ago.t7{color:var(--t7)} .ago.t8{color:var(--t8)}
  .ago.t9{color:var(--t9)}

  /* Exact timestamp ‚Äî subtle, text only */
  .exact{font-size:11px;color:#cfd5df;opacity:.85;white-space:nowrap}

  /* Copy button (small, non-primary) */
  .copyBtn{
    border:1px dashed #2a3755;background:#101622;color:#d9e1ee;
    padding:.35rem .55rem;border-radius:10px;font-size:11px;letter-spacing:.2px;
    display:inline-flex;align-items:center;gap:6px;box-shadow:none;
  }
  .copyBtn:hover{background:#12203a;border-color:#35507d}
  .copyBtn svg{opacity:.9}

  .go{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:#cfd5df;opacity:.85}
  .go svg{opacity:.9;transition:transform .18s}
  .card:hover .go svg{transform:translateX(2px)}

  footer{color:#9aa3b2;text-align:center;padding:18px 16px;border-top:1px solid #161b25}

  @media (prefers-reduced-motion: reduce){*{transition:none !important}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üß™ Experiments ‚Äî Auto Index</h1>
    <div class="row" style="margin-top:10px">
      <input id="q" type="search" placeholder="Filter by name or path‚Ä¶" />
      <div class="seg" role="group" aria-label="Sort">
        <button id="sortTime" aria-pressed="true" title="Newest ‚Üí Oldest"><span>Time</span></button>
        <button id="sortName" aria-pressed="false" title="A ‚Üí Z by name"><span>Name</span></button>
      </div>
      <button id="refresh" aria-label="Refresh list">
        <span style="display:inline-flex;gap:8px;align-items:center">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="#9fb3d6" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M20 4v6h-6" stroke="#9fb3d6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Refresh
        </span>
      </button>
      <span id="status" class="status">Loading‚Ä¶</span>
    </div>
  </div>
</header>

<main>
  <div id="list"></div>
</main>

<footer>Generated from <code>dubism/Experiments</code> via GitHub API</footer>

<script>
const USER = "dubism";
const REPO = "Experiments";
const BASE = `https://${USER}.github.io/${REPO}/`;

const statusEl = document.getElementById('status');
const listEl = document.getElementById('list');
const qEl = document.getElementById('q');
const sortTimeBtn = document.getElementById('sortTime');
const sortNameBtn = document.getElementById('sortName');
document.getElementById('refresh').onclick = fetchTree;
qEl.oninput = applyFilter;

let allItems = [];
let sortMode = 'time'; // 'time' | 'name'

sortTimeBtn.onclick = () => setSort('time');
sortNameBtn.onclick = () => setSort('name');

function setSort(mode){
  sortMode = mode;
  sortTimeBtn.setAttribute('aria-pressed', mode==='time' ? 'true' : 'false');
  sortNameBtn.setAttribute('aria-pressed', mode==='name' ? 'true' : 'false');
  applyFilter();
}

function folderOf(path){const i=path.lastIndexOf('/');return i===-1?"":path.slice(0,i);}
function fileIcon(){return `
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M7 3h6l4 4v14H7z" stroke="#9fb3d6" stroke-width="1.3" />
    <path d="M13 3v5h5" stroke="#9fb3d6" stroke-width="1.3"/>
  </svg>`;}
function folderIcon(){return `
  <svg class="folder-ic" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M3 8h7l2 2h9v9H3z" stroke="#8ea2c6" stroke-width="1.3"/>
  </svg>`;}
function arrowIcon(){return `
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M7 17l7-7M10 7h7v7" stroke="#cdd7e6" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;}

function prettyName(name){return name.replace(/\.html?$/i,'').replace(/[-_]+/g,' ').replace(/\b\w/g,m=>m.toUpperCase());}
function isoLocal(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ` +
         `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}

/* Buckets (green ‚Üí bluish ‚Üí grey; grey only after 72h):
   t0:<1m, t1:1‚Äì5m, t2:5‚Äì15m, t3:15‚Äì30m, t4:30‚Äì60m,
   t5:1‚Äì4h, t6:4‚Äì12h, t7:12‚Äì24h, t8:24‚Äì72h, t9:>72h */
function timeAgoClassAndText(d){
  let secs = Math.max(0,(Date.now()-d.getTime())/1000);
  if(secs < 60)  return {cls:'t0', text:`${Math.floor(secs)}s ago`};

  let mins = secs/60;
  if(mins < 5)   return {cls:'t1', text:`${Math.floor(mins)}m ago`};
  if(mins < 15)  return {cls:'t2', text:`${Math.floor(mins)}m ago`};
  if(mins < 30)  return {cls:'t3', text:`${Math.floor(mins)}m ago`};
  if(mins < 60)  return {cls:'t4', text:`${Math.floor(mins)}m ago`};

  let hours = mins/60;
  if(hours < 4)   return {cls:'t5', text:`${Math.floor(hours)}h ago`};
  if(hours < 12)  return {cls:'t6', text:`${Math.floor(hours)}h ago`};
  if(hours < 24)  return {cls:'t7', text:`${Math.floor(hours)}h ago`};
  if(hours < 72)  return {cls:'t8', text:`${Math.floor(hours)}h ago`};

  let days = Math.floor(hours/24);
  return {cls:'t9', text: days < 365 ? `${days}d ago` : `${Math.floor(days/365)}y ago`};
}

function render(items){
  // filter
  const q = qEl.value.trim().toLowerCase();
  let list = !q ? items : items.filter(it =>
    it.name.toLowerCase().includes(q) || it.path.toLowerCase().includes(q)
  );

  listEl.innerHTML = "";

  if(sortMode === 'time'){
    // newest ‚Üí oldest (items without updatedAt go last)
    list.sort((a,b)=>{
      const ad = a.updatedAt ? new Date(a.updatedAt).getTime() : -Infinity;
      const bd = b.updatedAt ? new Date(b.updatedAt).getTime() : -Infinity;
      return bd - ad;
    });

    const section = document.createElement('section');
    section.className = 'grp';

    const h2 = document.createElement('h2');
    h2.textContent = "All files ‚Äî Newest ‚Üí Oldest";
    section.appendChild(h2);

    const grid = document.createElement('div');
    grid.className = 'cards';

    list.forEach(it=>{
      const a = document.createElement('a');
      a.className = 'card';
      a.href = it.href;

      const top = document.createElement('div');
      top.className = 'top';

      const ic = document.createElement('div');
      ic.className = 'ic';
      ic.innerHTML = fileIcon();

      const textWrap = document.createElement('div');
      const nm = document.createElement('div');
      nm.className = 'name';
      nm.textContent = prettyName(it.name);

      const pt = document.createElement('div');
      pt.className = 'path';
      pt.textContent = it.path;

      textWrap.append(nm, pt);
      top.append(ic, textWrap);

      const meta = document.createElement('div');
      meta.className = 'meta';

      const timeBlock = document.createElement('div');
      timeBlock.className = 'timeBlock';

      const when = document.createElement('span');
      when.className = 'ago';
      when.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="t">‚Äî</span>`;

      const exact = document.createElement('span');
      exact.className = 'exact';
      exact.textContent = '‚Äî';

      if(it.updatedAt){
        const d = new Date(it.updatedAt);
        const ag = timeAgoClassAndText(d);
        when.classList.add(ag.cls);
        when.querySelector('.t').textContent = ag.text;
        when.title = `Last updated: ${isoLocal(d)}`;
        exact.textContent = isoLocal(d); // visible exact time
      } else {
        when.classList.add('t9');
      }

      timeBlock.append(when, exact);

      const actions = document.createElement('div');
      actions.style.display='inline-flex';
      actions.style.gap='8px';
      actions.style.alignItems='center';

      const copyBtn = document.createElement('button');
      copyBtn.className = 'copyBtn';
      copyBtn.type = 'button';
      copyBtn.innerHTML = `
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="9" y="9" width="12" height="12" rx="2" stroke="#cdd7e6" stroke-width="1.5"/>
          <rect x="3" y="3" width="12" height="12" rx="2" stroke="#cdd7e6" stroke-width="1.5" opacity=".85"/>
        </svg>
        Copy HTML`;
      // Prevent navigation when pressing copy
      copyBtn.addEventListener('click', (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        copyFile(it.path, copyBtn);
      });

      const go = document.createElement('span');
      go.className = 'go';
      go.innerHTML = `Open ${arrowIcon()}`;

      actions.append(copyBtn, go);

      meta.append(timeBlock, actions);
      a.append(top, meta);
      grid.appendChild(a);
    });

    section.appendChild(grid);
    listEl.appendChild(section);
    return;
  }

  // Name sort (grouped by folder)
  const groups = new Map();
  list.forEach(it=>{
    const key = folderOf(it.path);
    if(!groups.has(key)) groups.set(key,[]);
    groups.get(key).push(it);
  });

  [...groups.entries()].sort().forEach(([folder,arr])=>{
    arr.sort((a,b)=>a.name.localeCompare(b.name));

    const section = document.createElement('section');
    section.className = 'grp';

    const h2 = document.createElement('h2');
    h2.innerHTML = `${folderIcon()} ${folder?`/${folder}`:"/"}`;
    section.appendChild(h2);

    const grid = document.createElement('div');
    grid.className = 'cards';

    arr.forEach(it=>{
      const a = document.createElement('a');
      a.className = 'card';
      a.href = it.href;

      const top = document.createElement('div');
      top.className = 'top';

      const ic = document.createElement('div');
      ic.className = 'ic';
      ic.innerHTML = fileIcon();

      const textWrap = document.createElement('div');
      const nm = document.createElement('div');
      nm.className = 'name';
      nm.textContent = prettyName(it.name);

      const pt = document.createElement('div');
      pt.className = 'path';
      pt.textContent = it.path;

      textWrap.append(nm, pt);
      top.append(ic, textWrap);

      const meta = document.createElement('div');
      meta.className = 'meta';

      const timeBlock = document.createElement('div');
      timeBlock.className = 'timeBlock';

      const when = document.createElement('span');
      when.className = 'ago';
      when.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="t">‚Äî</span>`;

      if(it.updatedAt){
        const d = new Date(it.updatedAt);
        const ag = timeAgoClassAndText(d);
        when.classList.add(ag.cls);
        when.querySelector('.t').textContent = ag.text;
        when.title = `Last updated: ${isoLocal(d)}`;
      } else {
        when.classList.add('t9');
      }

      timeBlock.append(when);

      const actions = document.createElement('div');
      actions.style.display='inline-flex';
      actions.style.gap='8px';
      actions.style.alignItems='center';

      const copyBtn = document.createElement('button');
      copyBtn.className = 'copyBtn';
      copyBtn.type = 'button';
      copyBtn.innerHTML = `
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="9" y="9" width="12" height="12" rx="2" stroke="#cdd7e6" stroke-width="1.5"/>
          <rect x="3" y="3" width="12" height="12" rx="2" stroke="#cdd7e6" stroke-width="1.5" opacity=".85"/>
        </svg>
        Copy HTML`;
      copyBtn.addEventListener('click', (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        copyFile(it.path, copyBtn);
      });

      const go = document.createElement('span');
      go.className = 'go';
      go.innerHTML = `Open ${arrowIcon()}`;

      actions.append(copyBtn, go);

      meta.append(timeBlock, actions);
      a.append(top, meta);
      grid.appendChild(a);
    });

    section.appendChild(grid);
    listEl.appendChild(section);
  });
}

function applyFilter(){
  render(allItems);
}

async function fetchTree(){
  statusEl.textContent = "Loading‚Ä¶";
  try{
    const r = await fetch(`https://api.github.com/repos/${USER}/${REPO}/git/trees/HEAD?recursive=1`);
    if(!r.ok) throw new Error();
    const data = await r.json();
    allItems = data.tree
      .filter(n => n.type==="blob" && /\.html?$/i.test(n.path) && !/index\.html?$/i.test(n.path))
      .map(n => ({ path:n.path, name:n.path.split('/').pop(), href:BASE+n.path, updatedAt:null }));
    render(allItems);
    statusEl.textContent = `Found ${allItems.length} file(s), fetching dates‚Ä¶`;
    await fetchDates();
    render(allItems);
    statusEl.textContent = `Found ${allItems.length} file(s)`;
  }catch(e){
    statusEl.textContent = "Error fetching data";
  }
}

async function fetchDates(){
  let i = 0, max = 4;
  async function worker(){
    while(i < allItems.length){
      const idx = i++;
      try{
        const r = await fetch(`https://api.github.com/repos/${USER}/${REPO}/commits?path=${encodeURIComponent(allItems[idx].path)}&per_page=1`);
        if(r.ok){
          const c = await r.json();
          allItems[idx].updatedAt = c[0]?.commit?.committer?.date || null;
        }
      }catch(_){}
    }
  }
  await Promise.all(Array.from({length:max}, worker));
}

/* Copy the file's HTML contents to clipboard using GitHub Contents API (base64) */
async function copyFile(path, btn){
  const original = btn.innerHTML;
  try{
    btn.disabled = true;
    btn.innerHTML = 'Copying‚Ä¶';
    const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${encodeURIComponent(path)}?ref=HEAD`;
    const resp = await fetch(url);
    if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    let content = '';
    if(data && data.content){
      // decode base64; handle large strings safely by chunking
      const b64 = data.content.replace(/\n/g,'');
      content = atob(b64);
    }else{
      // fallback: fetch from pages
      const r2 = await fetch(`${BASE}${path}`);
      content = await r2.text();
    }

    await writeToClipboard(content);
    btn.innerHTML = 'Copied ‚úì';
  }catch(err){
    console.error(err);
    btn.innerHTML = 'Failed ‚úï';
  }finally{
    setTimeout(()=>{ btn.disabled=false; btn.innerHTML = original; }, 1500);
  }
}

async function writeToClipboard(text){
  if(navigator.clipboard && navigator.clipboard.writeText){
    return navigator.clipboard.writeText(text);
  }
  // Fallback
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position='fixed'; ta.style.left='-9999px';
  document.body.appendChild(ta);
  ta.focus(); ta.select();
  try{ document.execCommand('copy'); }
  finally{ document.body.removeChild(ta); }
}

fetchTree();
</script>
</body>
</html>