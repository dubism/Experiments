<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Experiments ‚Äî Auto Index (cached, fast)</title>
<style>
  :root{
    --bg:#0a0b0d; --ink:#f5f6f8; --muted:#a8afbb;
    --card:#0f1117; --card2:#10131a; --line:#1a2130;
    --cardSub:#121823; --card2Sub:#141d2a;
    --shadow:0 1px 0 rgba(255,255,255,.02) inset, 0 0 0 1px #1a2130, 0 8px 18px rgba(0,0,0,.45);
    --shadow-hover:0 1px 0 rgba(255,255,255,.03) inset, 0 0 0 1px #24304a, 0 14px 28px rgba(0,0,0,.6);
    --radius:14px;

    --t0:#82FFB5; --t1:#66F5C8; --t2:#4FDEDE; --t3:#4BC5F2; --t4:#5AAAF5;
    --t5:#7D96F0; --t6:#9CA6CC; --t7:#A9B6E0; --t8:#B9C2E0; --t9:#B8B8B8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(#10131a,#0c0f15);border-bottom:1px solid #1c2537}
  .wrap{max-width:1240px;margin:0 auto;padding:12px 14px}
  h1{margin:0;font-size:16px;letter-spacing:.3px}
  main{max-width:1240px;margin:0 auto;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=search]{
    flex:1;min-width:260px;background:#0b0f16;border:1px solid #1e293e;border-radius:10px;
    padding:.55rem .7rem;color:var(--ink);outline:none;
    transition:border-color .2s, background .2s, box-shadow .25s;
    box-shadow:0 0 0 0 rgba(74,163,255,.0);
  }
  input[type=search]::placeholder{color:#8e97a6}
  input[type=search]:focus{border-color:#2b3f65;background:#0d1220;box-shadow:0 0 0 5px rgba(74,163,255,.06)}
  button{
    border:1px solid #25324a;background:#131a26;color:var(--ink);
    padding:.45rem .65rem;border-radius:10px;cursor:pointer;font-weight:650;letter-spacing:.2px;
    transition:transform .15s, box-shadow .2s, border-color .2s, background .2s, filter .2s;
    box-shadow:var(--shadow);
  }
  button:hover{transform:translateY(-1px);box-shadow:var(--shadow-hover);border-color:#31456b;background:#141e2c}
  .status{font-size:12px;color:#9aa3b2}
  .seg{display:inline-flex;border:1px solid #27324a;border-radius:10px;overflow:hidden}
  .seg button{border:0;border-right:1px solid #27324a;background:#101622;padding:.45rem .7rem}
  .seg button:last-child{border-right:0}
  .seg button[aria-pressed="true"]{background:#162133}
  .seg button[aria-pressed="true"] span{opacity:1}
  .seg button span{opacity:.85}
  .grp{margin-top:16px}
  .grp h2{display:flex;align-items:center;gap:8px;font-size:12px;color:#9aa3b2;margin:6px 2px 10px;letter-spacing:.25px}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:14px}
  .card{
    position:relative; overflow:hidden; color:inherit; cursor:pointer;
    background:linear-gradient(180deg,var(--card),var(--card2));
    border:1px solid var(--line); border-radius:var(--radius);
    padding:14px 16px; box-shadow:var(--shadow);
    transition:transform .18s, box-shadow .22s, border-color .2s, background .25s;
    display:flex; flex-direction:column; gap:10px; min-width:0;
  }
  .card.sub{background:linear-gradient(180deg,var(--cardSub),var(--card2Sub));border-color:#22314a}
  .card:before{
    content:""; position:absolute; inset:-1px; border-radius:var(--radius);
    background:radial-gradient(120px 80px at 0% 0%, rgba(74,163,255,.08), transparent 60%),
               radial-gradient(160px 100px at 100% 0%, rgba(39,255,136,.05), transparent 60%);
    pointer-events:none;
  }
  .card:hover,.card:focus-within{transform:translateY(-1px);box-shadow:var(--shadow-hover);border-color:#2a3755;outline:none}
  .top{display:flex;align-items:center;gap:12px;min-width:0}
  .ic{flex:0 0 32px; width:32px; height:32px; display:grid; place-items:center; background:#0c1119; border:1px solid #1f2a42; border-radius:10px}
  .titleWrap{min-width:0; display:flex; flex:1 1 auto; flex-direction:column; gap:2px}
  .name{font-weight:750; letter-spacing:.2px; line-height:1.2; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .path{font-size:11px; color:#97a1b1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .openVis{flex:0 0 auto; font-size:12px; color:#cfd5df; opacity:.9; display:inline-flex; gap:6px; align-items:center}
  .bottom{display:flex; align-items:center; justify-content:space-between; gap:12px; min-width:0}
  .meta{display:flex; align-items:center; gap:10px; min-width:0; overflow:hidden}
  .ago{font-size:11px; font-weight:700; letter-spacing:.3px; display:inline-flex; align-items:center; gap:6px; flex:0 0 auto}
  .ago .dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.95}
  .ago.t0{color:var(--t0)} .ago.t1{color:var(--t1)} .ago.t2{color:var(--t2)}
  .ago.t3{color:var(--t3)} .ago.t4{color:var(--t4)} .ago.t5{color:var(--t5)}
  .ago.t6{color:var(--t6)} .ago.t7{color:var(--t7)} .ago.t8{color:var(--t8)} .ago.t9{color:var(--t9)}
  .exact{font-size:11px;color:#cfd5df;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  footer{color:#9aa3b2;text-align:center;padding:18px;border-top:1px solid #161b25}
  .copy-ok{filter:drop-shadow(0 0 10px rgba(130,255,181,.35));}
  @media (max-width:900px){.cards{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}}
  @media (max-width:480px){.cards{grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px}.openVis{display:none}}
  @media (prefers-reduced-motion: reduce){*{transition:none !important}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üß™ Experiments ‚Äî Auto Index</h1>
    <div class="row" style="margin-top:8px">
      <input id="q" type="search" placeholder="Filter by name or path‚Ä¶">
      <div class="seg" role="group" aria-label="Sort">
        <button id="sortTime" aria-pressed="true" title="Newest ‚Üí Oldest"><span>Time</span></button>
        <button id="sortName" aria-pressed="false" title="A ‚Üí Z by name"><span>Name</span></button>
      </div>
      <button id="refresh" aria-label="Refresh list">Refresh</button>
      <span id="status" class="status" aria-live="polite">‚Äî</span>
    </div>
  </div>
</header>

<main><div id="list"></div></main>
<footer>Whole card opens the page; ‚ÄúCopy code‚Äù stops navigation and confirms.</footer>

<script>
/* ===== Config ===== */
const USER = "dubism";
const REPO = "Experiments";
const REF  = "main";

/* ===== DOM ===== */
const statusEl = document.getElementById('status');
const listEl = document.getElementById('list');
const qEl = document.getElementById('q');
const sortTimeBtn = document.getElementById('sortTime');
const sortNameBtn = document.getElementById('sortName');
document.getElementById('refresh').onclick = fetchIndex;

/* ===== State ===== */
let allItems = [];
let sortMode = 'time';
sortTimeBtn.onclick = () => setSort('time');
sortNameBtn.onclick = () => setSort('name');

/* ===== Cache keys ===== */
const SHA_KEY   = `idx:sha:${USER}/${REPO}@${REF}`;
const DATA_KEY  = `idx:data:${USER}/${REPO}@${REF}`;
const ETAG_KEY  = `idx:etag:${USER}/${REPO}@${REF}`;
function datesKey(sha){ return `idx:dates:${USER}/${REPO}@${REF}:${sha}`; }

/* ===== Utils ===== */
function setSort(mode){
  sortMode = mode;
  sortTimeBtn.setAttribute('aria-pressed', mode==='time' ? 'true' : 'false');
  sortNameBtn.setAttribute('aria-pressed', mode==='name' ? 'true' : 'false');
  applyFilter();
}
function prettyName(name){return name.replace(/\.html?$/i,'').replace(/[-_]+/g,' ').replace(/\b\w/g,m=>m.toUpperCase());}
function isoLocal(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ` +
         `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
function timeAgoClassAndText(d){
  let secs = Math.max(0,(Date.now()-d.getTime())/1000);
  if(secs < 60)  return {cls:'t0', text:`${Math.floor(secs)}s ago`};
  let mins = secs/60;
  if(mins < 5)   return {cls:'t1', text:`${Math.floor(mins)}m ago`};
  if(mins < 15)  return {cls:'t2', text:`${Math.floor(mins)}m ago`};
  if(mins < 30)  return {cls:'t3', text:`${Math.floor(mins)}m ago`};
  if(mins < 60)  return {cls:'t4', text:`${Math.floor(mins)}m ago`};
  let hours = mins/60;
  if(hours < 4)   return {cls:'t5', text:`${Math.floor(hours)}h ago`};
  if(hours < 12)  return {cls:'t6', text:`${Math.floor(hours)}h ago`};
  if(hours < 24)  return {cls:'t7', text:`${Math.floor(hours)}h ago`};
  if(hours < 72)  return {cls:'t8', text:`${Math.floor(hours)}h ago`};
  let days = Math.floor(hours/24);
  return {cls:'t9', text: days < 365 ? `${days}d ago` : `${Math.floor(days/365)}y ago`};
}
function fileIcon(){return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 3h6l4 4v14H7z" stroke="#9fb3d6" stroke-width="1.3"/><path d="M13 3v5h5" stroke="#9fb3d6" stroke-width="1.3"/></svg>`;}
function folderIcon(){return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 8h7l2 2h9v9H3z" stroke="#8ea2c6" stroke-width="1.3"/></svg>`;}
function arrowIcon(){return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 17l7-7M10 7h7v7" stroke="#cdd7e6" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`;}
const EXCLUDE_TOP = /^(?:assets?|img|images?|icons?|fonts?|audio|sounds?|video|media|dist|build|node_modules|\.github|\.git)\b/i;

/* ===== Rendering ===== */
function buildCard(it){
  const card = document.createElement('div');
  card.className = 'card';
  if(it.depth >= 2) card.classList.add('sub');
  card.setAttribute('role','link');
  card.setAttribute('tabindex','0');

  const href = `https://${USER}.github.io/${REPO}/${it.path}`;

  // Whole-card navigation (mouse + keyboard)
  card.addEventListener('click', (e)=>{
    if (e.target.closest('button')) return;       // do not navigate when clicking buttons
    window.open(href, '_blank', 'noopener');      // open as before
  });
  card.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); window.open(href,'_blank','noopener'); }
  });

  const top = document.createElement('div'); top.className = 'top';
  const ic = document.createElement('div'); ic.className = 'ic'; ic.innerHTML = fileIcon();
  const titleWrap = document.createElement('div'); titleWrap.className = 'titleWrap';
  titleWrap.innerHTML = `<div class="name">${prettyName(it.name)}</div><div class="path">${it.path}</div>`;
  const open = document.createElement('div'); open.className = 'openVis'; open.innerHTML = `Open ${arrowIcon()}`;
  top.append(ic, titleWrap, open);

  const bottom = document.createElement('div'); bottom.className = 'bottom';
  const meta = document.createElement('div'); meta.className = 'meta';
  const when = document.createElement('span'); when.className = 'ago t9';
  when.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="t">‚Äî</span>`;
  const exact = document.createElement('span'); exact.className = 'exact'; exact.textContent = '‚Äî';
  if(it.updatedAt){
    const d = new Date(it.updatedAt);
    const ag = timeAgoClassAndText(d);
    when.className = 'ago ' + ag.cls;
    when.querySelector('.t').textContent = ag.text;
    when.title = `Last updated: ${isoLocal(d)}`;
    exact.textContent = isoLocal(d);
  }
  meta.append(when, exact);

  const actions = document.createElement('div');
  actions.style.display = 'flex';
  actions.style.gap = '8px';

  const copyBtn = document.createElement('button');
  copyBtn.textContent = 'Copy code';
  copyBtn.title = `Copy HTML of ${it.path}`;
  copyBtn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); handleCopy(it.path, copyBtn, card); };

  actions.append(copyBtn);
  bottom.append(meta, actions);

  card.append(top, bottom);
  return card;
}

function render(items){
  const q = qEl.value?.trim().toLowerCase() ?? '';
  let list = !q ? items : items.filter(it =>
    it.name.toLowerCase().includes(q) || it.path.toLowerCase().includes(q)
  );
  listEl.innerHTML = "";

  if(sortMode === 'time'){
    list.sort((a,b)=>{
      const ad = a.updatedAt ? Date.parse(a.updatedAt) : -Infinity;
      const bd = b.updatedAt ? Date.parse(b.updatedAt) : -Infinity;
      return bd - ad;
    });
    const section = document.createElement('section'); section.className = 'grp';
    const h2 = document.createElement('h2'); h2.textContent = "All files ‚Äî Newest ‚Üí Oldest";
    section.appendChild(h2);
    const grid = document.createElement('div'); grid.className = 'cards';
    list.forEach(it=> grid.appendChild(buildCard(it)));
    section.appendChild(grid); listEl.appendChild(section);
  } else {
    const groups = new Map();
    list.forEach(it=>{
      const key = it.path.includes('/') ? it.path.split('/')[0] : '';
      if(!groups.has(key)) groups.set(key,[]);
      groups.get(key).push(it);
    });
    [...groups.entries()].sort().forEach(([folder,arr])=>{
      arr.sort((a,b)=>a.name.localeCompare(b.name));
      const section = document.createElement('section'); section.className = 'grp';
      const h2 = document.createElement('h2'); h2.innerHTML = `${folder ? folderIcon() + ' /' + folder : 'Root'}`;
      section.appendChild(h2);
      const grid = document.createElement('div'); grid.className = 'cards';
      arr.forEach(it=> grid.appendChild(buildCard(it)));
      section.appendChild(grid); listEl.appendChild(section);
    });
  }
}

/* Filter hook */
function applyFilter(){ render(allItems); }

/* ===== API helpers ===== */
async function getJSON(url, headers = {}){
  const r = await fetch(url, {headers: {'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28', ...headers}});
  if(!r.ok) throw new Error(`${url} HTTP ${r.status}`);
  return {json: await r.json(), resp: r};
}
function makeItemsFromTree(tree){
  const files = tree.tree.filter(n => {
    if(n.type !== 'blob') return false;
    if(!/\.html?$/i.test(n.path)) return false;
    if(/^index\.html?$/i.test(n.path)) return false;
    if(EXCLUDE_TOP.test(n.path)) return false;
    return true;
  });
  return files.map(n => ({
    path: n.path,
    name: n.path.split('/').pop(),
    updatedAt: null,
    depth: (n.path.match(/\//g)||[]).length + 1
  }));
}

/* ===== Timestamp hydration (per-file last commit) ===== */
async function getLastCommitISO(path){
  const url = `https://api.github.com/repos/${USER}/${REPO}/commits?sha=${encodeURIComponent(REF)}&path=${encodeURIComponent(path)}&per_page=1`;
  const {json} = await getJSON(url);
  const c = json && json[0] && json[0].commit;
  return c?.committer?.date || c?.author?.date || null;
}
async function mapLimit(arr, limit, worker){
  const ret = Array(arr.length);
  let i=0, active=0, done=0;
  return new Promise((resolve,reject)=>{
    const pump = () => {
      while(active<limit && i<arr.length){
        const idx=i++; active++;
        Promise.resolve(worker(arr[idx], idx))
          .then(v=>{ret[idx]=v;})
          .catch(reject)
          .finally(()=>{active--; done++; if(done===arr.length) resolve(ret); else pump();});
      }
    };
    pump();
  });
}
async function hydrateUpdatedAt(items, sha){
  const key = datesKey(sha);
  const memo = JSON.parse(localStorage.getItem(key) || '{}');

  const todoIdx = [];
  items.forEach((it, idx)=>{
    if(memo[it.path]) it.updatedAt = memo[it.path];
    else todoIdx.push(idx);
  });

  if(!todoIdx.length) return;

  statusEl.textContent = `Fetching timestamps (${todoIdx.length})‚Ä¶`;

  const limit = 6;
  try{
    await mapLimit(todoIdx, limit, async (idx)=>{
      const it = items[idx];
      try{
        const iso = await getLastCommitISO(it.path);
        if(iso){ it.updatedAt = iso; memo[it.path] = iso; }
      }catch(e){
        if(String(e?.message||e).includes('HTTP 403')) throw e;
      }
    });
  }catch(e){
    statusEl.textContent = 'Rate-limited by GitHub while fetching timestamps.';
  }
  localStorage.setItem(key, JSON.stringify(memo));
}

/* ===== Fast path with caching by SHA + ETag ===== */
async function fetchIndex(){
  try{
    statusEl.textContent = 'Checking cache‚Ä¶';
    const {json: branch} = await getJSON(`https://api.github.com/repos/${USER}/${REPO}/branches/${encodeURIComponent(REF)}`);
    const sha = branch.commit.sha;

    const cachedSha  = localStorage.getItem(SHA_KEY);
    const cachedData = localStorage.getItem(DATA_KEY);
    if(cachedSha === sha && cachedData){
      allItems = JSON.parse(cachedData);
      await hydrateUpdatedAt(allItems, sha);
      render(allItems);
      statusEl.textContent = `Loaded ${allItems.length} file(s) from cache.`;
      revalidateTree(sha).catch(()=>{});
      return;
    }

    await revalidateTree(sha, true);
  }catch(e){
    console.error(e);
    statusEl.textContent = `Error: ${e.message||e}`;
  }
}

async function revalidateTree(sha, paintOnSuccess=false){
  const treeUrl = `https://api.github.com/repos/${USER}/${REPO}/git/trees/${sha}?recursive=1`;
  const etag = localStorage.getItem(ETAG_KEY);
  const headers = etag ? {'If-None-Match': etag} : {};
  statusEl.textContent = etag ? 'Revalidating tree‚Ä¶' : 'Loading tree‚Ä¶';

  const r = await fetch(treeUrl, {headers: {'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28', ...headers}});
  if(r.status === 304){
    statusEl.textContent = 'Up to date (HTTP 304).';
    return;
  }
  if(!r.ok) throw new Error(`${treeUrl} HTTP ${r.status}`);

  const tree = await r.json();
  const newEtag = r.headers.get('etag') || '';
  const items = makeItemsFromTree(tree);

  localStorage.setItem(SHA_KEY, sha);
  localStorage.setItem(ETAG_KEY, newEtag);
  localStorage.setItem(DATA_KEY, JSON.stringify(items));

  allItems = items;
  await hydrateUpdatedAt(allItems, sha);
  if(paintOnSuccess){
    render(allItems);
    statusEl.textContent = `Loaded ${allItems.length} file(s). Cached for next visit.`;
  }
}

/* ===== Copy-to-clipboard ===== */
async function getFileText(path){
  const rawUrl = `https://api.github.com/repos/${USER}/${REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(REF)}`;
  const r = await fetch(rawUrl, {headers: {'Accept':'application/vnd.github.raw','X-GitHub-Api-Version':'2022-11-28'}});
  if(r.ok){
    const ct = r.headers.get('content-type') || '';
    if(!ct.includes('json')) return await r.text();
  }
  const {json} = await getJSON(rawUrl);
  if(json && json.content){
    const bin = atob(json.content.replace(/\n/g,''));
    const bytes = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder().decode(bytes);
  }
  throw new Error(`Unable to load ${path}`);
}

async function copyToClipboard(text){
  if (navigator.clipboard?.writeText) {
    await navigator.clipboard.writeText(text);
    return true;
  }
  const ta = document.createElement('textarea');
  ta.value = text; ta.style.position='fixed'; ta.style.opacity='0';
  document.body.appendChild(ta); ta.select();
  try{ const ok = document.execCommand('copy'); document.body.removeChild(ta); return ok; }
  catch(e){ document.body.removeChild(ta); throw e; }
}

async function handleCopy(path, btn, card){
  const orig = btn.textContent;
  btn.disabled = true; btn.textContent = 'Copying‚Ä¶';
  try{
    const txt = await getFileText(path);
    await copyToClipboard(txt);
    btn.textContent = 'Copied ‚úì';
    card.classList.add('copy-ok');
    statusEl.textContent = `Copied: ${path}`;
    await new Promise(r=>setTimeout(r,1200));
  }catch(e){
    console.error(e);
    btn.textContent = 'Copy failed';
    statusEl.textContent = `Copy failed for ${path}: ${e.message||e}`;
    await new Promise(r=>setTimeout(r,1500));
  }finally{
    btn.disabled = false; btn.textContent = orig;
    card.classList.remove('copy-ok');
  }
}

/* ===== init ===== */
fetchIndex();
qEl.addEventListener('input', applyFilter);
</script>
</body></html>