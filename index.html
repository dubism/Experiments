<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Experiments — HTML Index (Copy & Replace Fix)</title>
<style>
  :root{
    --bg:#0a0b0d; --ink:#f5f6f8; --muted:#a8afbb;
    --card:#0f1117; --card2:#10131a; --line:#1a2130;
    --accent:#6ea8fe; --ok:#37d67a; --warn:#ffb020; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100dvh}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 28px}
  header{
    display:grid;gap:10px;align-items:center;
    grid-template-columns:repeat(12,1fr);
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);
    padding:10px;border-radius:12px;border:1px solid var(--line);
    position:sticky;top:0;backdrop-filter:saturate(120%) blur(6px); z-index:5;
  }
  header .field{grid-column: span 3; display:flex; gap:8px; align-items:center}
  header .field.wide{grid-column: span 4}
  header label{font-size:12px;color:var(--muted)}
  header input{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line);
    background:var(--card2); color:var(--ink); outline:none;
  }
  header .actions{grid-column: span 12; display:flex; gap:8px; flex-wrap:wrap}
  button,a.btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 12px; border-radius:10px; border:1px solid var(--line);
    background:var(--card2); color:var(--ink); text-decoration:none; cursor:pointer;
    transition:transform .06s ease, background .2s ease, border-color .2s ease;
    user-select:none;
  }
  button:hover, a.btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.02)}
  .primary{background:rgba(110,168,254,.15); border-color:#2a3b63}
  .ok{background:rgba(55,214,122,.12); border-color:#1d3a2b}
  .warn{background:rgba(255,176,32,.12); border-color:#3d2e14}
  .bad{background:rgba(255,107,107,.12); border-color:#3d1919}

  .grid{display:grid; gap:12px; margin-top:16px}
  @media (min-width:720px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (min-width:1024px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr))} }

  .card{
    display:flex; flex-direction:column; gap:10px; padding:14px;
    background:var(--card); border:1px solid var(--line); border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .card.folder{ background:#121621 }            /* slightly lighter for files found in a folder */
  .card .path{ font:600 14px/1.4 ui-sans-serif,system-ui; word-break:break-all }
  .card .sub{ color:var(--muted); font-size:12px }
  .row{ display:flex; gap:8px; flex-wrap:wrap }
  .row .spacer{ flex:1 }

  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:var(--card2); color:var(--ink); border:1px solid var(--line);
    padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none;
    transition:opacity .2s ease, transform .15s ease;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(-2px) }
  textarea#__clip_fallback{position:fixed;left:-9999px;top:-9999px}
  .help{color:var(--muted); font-size:12px; margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="field"><label>Owner</label><input id="owner" placeholder="e.g. dubism"></div>
      <div class="field"><label>Repo</label><input id="repo"  placeholder="e.g. Experiments"></div>
      <div class="field"><label>Branch (for files)</label><input id="branch" placeholder="e.g. main"></div>
      <div class="field wide"><label>Token (only needed for commit replace)</label><input id="token" type="password" placeholder="GitHub token with repo/public_repo scope"></div>
      <div class="actions">
        <button id="load" class="primary">Load HTML Files</button>
        <button id="clearLocal" class="">Clear Local Overrides</button>
        <a id="pagesLink" class="btn" target="_blank" rel="noopener">Open GitHub Pages</a>
      </div>
    </header>

    <div id="grid" class="grid"></div>
    <div class="help">Tip: “Copy HTML” uses a reliable clipboard path for iOS. “Replace (commit)” uses the GitHub API if a token is provided. “Replace (local)” only updates your local preview and lets you download the file.</div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <textarea id="__clip_fallback"></textarea>

<script>
const D = document;
const byId = id => D.getElementById(id);
const grid = byId('grid');
const toastEl = byId('toast');

let FILES = new Map(); // path -> {content, sha, depth, urlPages}
let LOCAL_OVERRIDES = new Map(); // path -> string

function status(msg){
  console.log(msg);
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(status._t);
  status._t = setTimeout(()=>toastEl.classList.remove('show'), 1800);
}

async function copyTextReliable(text){
  if (navigator.clipboard && navigator.clipboard.writeText){
    try { await navigator.clipboard.writeText(text); return true; }
    catch(e){ /* fall back */ }
  }
  const ta = byId('__clip_fallback');
  ta.value = text; ta.focus(); ta.select();
  const ok = document.execCommand('copy');
  ta.value = '';
  return ok;
}

function b64utf8(str){ return btoa(unescape(encodeURIComponent(str))); }

function pagesBase(owner, repo){
  // project pages
  return `https://${owner}.github.io/${repo}`;
}

function rawApiUrl(owner, repo, path, ref){
  return `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}${ref?`?ref=${encodeURIComponent(ref)}`:''}`;
}

async function ghGetFileMeta(owner, repo, path, ref, token){
  const r = await fetch(rawApiUrl(owner,repo,path,ref), {
    headers:{
      'Accept':'application/vnd.github+json',
      ...(token? {'Authorization':`Bearer ${token}`} : {})
    }
  });
  if(!r.ok) throw new Error(`GET ${path} ${r.status}`);
  return r.json();
}

async function ghPutFile(owner, repo, path, token, contentBase64, sha, message){
  const r = await fetch(rawApiUrl(owner,repo,path,''), {
    method:'PUT',
    headers:{
      'Accept':'application/vnd.github+json',
      'Authorization':`Bearer ${token}`,
      'Content-Type':'application/json'
    },
    body: JSON.stringify({ message, content: contentBase64, sha })
  });
  if(!r.ok) throw new Error(`PUT ${path} ${r.status}`);
  return r.json();
}

async function listDir(owner, repo, path='', token){
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const r = await fetch(url, {
    headers:{
      'Accept':'application/vnd.github+json',
      ...(token? {'Authorization':`Bearer ${token}`} : {})
    }
  });
  if(!r.ok) throw new Error(`List ${path||'/'} ${r.status}`);
  return r.json();
}

function isHtml(name){ return /\.html?$/i.test(name); }

async function preloadFile(owner, repo, branch, path, depth, token){
  try{
    const j = await ghGetFileMeta(owner, repo, path, branch, token);
    let content = j.content ? atob(j.content.replace(/\n/g,'')) : '';
    const urlPages = `${pagesBase(owner,repo)}/${path}`;
    FILES.set(path, { content, sha:j.sha, depth, urlPages });
  }catch(e){
    console.warn('Preload failed', path, e);
  }
}

function renderCards(owner, repo){
  grid.innerHTML = '';
  const paths = [...FILES.keys()].sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));
  for(const p of paths){
    const meta = FILES.get(p) || {};
    const card = D.createElement('div');
    card.className = 'card' + (meta.depth>0 ? ' folder' : '');
    const head = D.createElement('div');
    head.className = 'path';
    head.textContent = p;
    const sub = D.createElement('div');
    sub.className = 'sub';
    sub.textContent = meta.urlPages || '';

    const row1 = D.createElement('div'); row1.className='row';
    const open = D.createElement('a'); open.className='btn'; open.textContent='Open'; open.target='_blank'; open.rel='noopener';
    open.href = meta.urlPages || '#';
    const download = D.createElement('button'); download.textContent='Download';
    const copy = D.createElement('button'); copy.textContent='Copy HTML';
    const replCommit = D.createElement('button'); replCommit.textContent='Replace (commit)'; replCommit.classList.add('warn');
    const replLocal  = D.createElement('button'); replLocal.textContent='Replace (local)';
    row1.append(open, copy, replCommit, replLocal, download);

    card.append(head, sub, row1);
    grid.append(card);

    copy.addEventListener('click', async ()=>{
      const cached = FILES.get(p);
      const text = cached?.content ?? '';
      const ok = await copyTextReliable(text);
      status(ok ? 'Copied' : 'Copy failed');
    });

    download.addEventListener('click', ()=>{
      const override = LOCAL_OVERRIDES.get(p);
      const text = override ?? (FILES.get(p)?.content ?? '');
      if(!text){ status('No content'); return; }
      const blob = new Blob([text], {type:'text/html'});
      const a = D.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = p.split('/').pop() || 'index.html';
      D.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    });

    replLocal.addEventListener('click', async ()=>{
      let txt = '';
      try{ txt = await navigator.clipboard.readText(); }
      catch(e){ txt=''; }
      if(!txt){ status('No HTML on clipboard'); return; }
      LOCAL_OVERRIDES.set(p, txt);
      try{ localStorage.setItem('localOverride:'+p, txt); }catch(_){}
      status('Replaced locally. Use “Download” to save.');
    });

    replCommit.addEventListener('click', async ()=>{
      const token = byId('token').value.trim();
      const owner = byId('owner').value.trim();
      const repo  = byId('repo').value.trim();
      const branch= byId('branch').value.trim();
      if(!token || !owner || !repo){ status('Missing token/owner/repo'); return; }

      let newHtml='';
      try{ newHtml = await navigator.clipboard.readText(); }
      catch(e){ newHtml=''; }
      if(!newHtml){ status('No HTML on clipboard'); return; }

      try{
        const fresh = await ghGetFileMeta(owner,repo,p,branch,token);
        const sha = fresh.sha;
        await ghPutFile(owner,repo,p,token,b64utf8(newHtml),sha,`Replace ${p} via web index`);
        FILES.set(p, { ...FILES.get(p), content:newHtml, sha, urlPages: FILES.get(p)?.urlPages, depth: FILES.get(p)?.depth });
        status('Replaced. Pages will rebuild.');
      }catch(e){
        status('Replace failed: '+ e.message);
      }
    });
  }
}

async function loadAll(){
  const owner = byId('owner').value.trim();
  const repo  = byId('repo').value.trim();
  const branchInput = byId('branch').value.trim();
  const token = byId('token').value.trim() || null;

  if(!owner || !repo){ status('Fill owner and repo'); return; }

  byId('pagesLink').href = pagesBase(owner,repo);
  byId('pagesLink').textContent = 'Open GitHub Pages';

  FILES.clear();
  grid.innerHTML = '';

  let root = [];
  try{
    root = await listDir(owner,repo,'',token);
  }catch(e){
    status('Could not list repo: '+e.message);
    return;
  }

  // Detect default branch if not provided
  let branch = branchInput;
  if(!branch){
    try{
      const r = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
        headers:{ 'Accept':'application/vnd.github+json', ...(token? {'Authorization':`Bearer ${token}`} : {}) }
      });
      if(r.ok){ const j = await r.json(); branch = j.default_branch || 'main'; }
      else branch = 'main';
    }catch{ branch = 'main'; }
    byId('branch').value = branch;
  }

  const topFiles = root.filter(it => it.type==='file' && isHtml(it.name)).map(it => it.path);
  const topDirs  = root.filter(it => it.type==='dir').map(it => it.path);

  for(const p of topFiles){ await preloadFile(owner,repo,branch,p,0,token); }

  for(const dir of topDirs){
    try{
      const items = await listDir(owner,repo,dir,token);
      const htmls = items.filter(it => it.type==='file' && isHtml(it.name)).map(it=>it.path);
      for(const p of htmls){ await preloadFile(owner,repo,branch,p,1,token); }
    }catch(e){
      console.warn('Skip dir', dir, e);
    }
  }

  // Restore local overrides
  LOCAL_OVERRIDES.clear();
  try{
    for(const key in localStorage){
      if(key && key.startsWith && key.startsWith('localOverride:')){
        const path = key.slice('localOverride:'.length);
        const val = localStorage.getItem(key);
        if(val) LOCAL_OVERRIDES.set(path, val);
      }
    }
  }catch(_){}

  renderCards(owner,repo);
  status('Loaded');
}

function inferFromLocation(){
  try{
    const host = location.host;
    const path = location.pathname.replace(/^\/+/,'');
    if(/\.github\.io$/i.test(host)){
      const owner = host.split('.')[0];
      const parts = path.split('/').filter(Boolean);
      const repo  = parts[0] || '';
      if(owner && repo){
        byId('owner').value = byId('owner').value || owner;
        byId('repo').value  = byId('repo').value  || repo;
      }
    }
  }catch(_){}
}

byId('load').addEventListener('click', loadAll);
byId('clearLocal').addEventListener('click', ()=>{
  for(const k of Object.keys(localStorage)){
    if(k.startsWith('localOverride:')) localStorage.removeItem(k);
  }
  LOCAL_OVERRIDES.clear();
  status('Local overrides cleared');
});

inferFromLocation();
</script>
</body>
</html>