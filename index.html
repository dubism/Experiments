<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Experiments â€” Auto Index</title>
<style>
  body{margin:0;background:#0f1117;color:#e7e9ee;font:14px system-ui,sans-serif}
  header{padding:.9rem 1rem;background:#141a25;border-bottom:1px solid #22304a;position:sticky;top:0}
  h1{margin:0;font-size:16px}
  main{max-width:960px;margin:auto;padding:16px}
  input[type=search]{flex:1;min-width:220px;background:#0c111a;border:1px solid #22304a;
    border-radius:8px;padding:.5rem .7rem;color:#e7e9ee}
  button{border:1px solid #22304a;background:#182234;color:#e7e9ee;
    padding:.5rem .75rem;border-radius:8px;cursor:pointer;font-weight:600}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .list{margin-top:12px;border:1px solid #22304a;border-radius:10px;overflow:hidden}
  section.grp{border-top:1px solid #22304a;padding:8px 12px}
  section.grp:first-child{border-top:0}
  h2{font-size:12px;color:#9aa3b2;margin:.2rem 0 .4rem}
  ul{list-style:none;margin:0;padding:0}
  li{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:12px;
    padding:8px 6px;border-top:1px dashed #1f2a44}
  li:first-child{border-top:0}
  a{color:#a8c7ff;text-decoration:none}
  a:hover{text-decoration:underline}
  .pill{font-size:11px;color:#9aa3b2}
  .ago{font-size:11px;padding:.1rem .4rem;border-radius:999px;border:1px solid #22304a}
  .green{color:#22da6e;border-color:rgba(34,218,110,.35)}
  .yellow{color:#ffd166;border-color:rgba(255,209,102,.35)}
  .orange{color:#ff9f6e;border-color:rgba(255,159,110,.35)}
  .red{color:#ff6b6b;border-color:rgba(255,107,107,.35)}
  footer{color:#9aa3b2;text-align:center;padding:16px}
  .status{font-size:11px;color:#9aa3b2}
</style>
</head>
<body>
<header><h1>ðŸ§ª Experiments â€” Auto Index</h1></header>
<main>
<div class="row">
  <input id="q" type="search" placeholder="Filter by nameâ€¦">
  <button id="refresh">Refresh</button>
  <span id="status" class="status">Loadingâ€¦</span>
</div>
<div id="list" class="list"></div>
</main>
<footer>Generated from <code>dubism/Experiments</code> via GitHub API</footer>

<script>
const USER = "dubism";
const REPO = "Experiments";
const BASE = `https://${USER}.github.io/${REPO}/`;
const statusEl = document.getElementById('status');
const listEl = document.getElementById('list');
const qEl = document.getElementById('q');
document.getElementById('refresh').onclick = fetchTree;
qEl.oninput = applyFilter;

let allItems = [];

function folderOf(path){let i=path.lastIndexOf('/');return i===-1?"":path.slice(0,i);}
function prettyName(name){return name.replace(/\.html?$/i,'').replace(/[-_]+/g,' ')
  .replace(/\b\w/g,m=>m.toUpperCase());}
function isoLocal(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}
function timeAgo(d){
  let diff = (Date.now()-d.getTime())/1000;
  if(diff<60) return {t:`${Math.floor(diff)}s ago`,c:'green'};
  diff/=60; if(diff<60) return {t:`${Math.floor(diff)}m ago`,c: diff<10?'green':'yellow'};
  diff/=60; if(diff<24) return {t:`${Math.floor(diff)}h ago`,c: diff<6?'yellow':'orange'};
  diff/=24; if(diff<30) return {t:`${Math.floor(diff)}d ago`,c: diff<7?'orange':'red'};
  diff/=30; if(diff<12) return {t:`${Math.floor(diff)}mo ago`,c:'red'};
  return {t:`${Math.floor(diff/12)}y ago`,c:'red'};
}

function render(items){
  listEl.innerHTML="";
  const groups=new Map();
  items.forEach(it=>{
    let key=folderOf(it.path);
    if(!groups.has(key)) groups.set(key,[]);
    groups.get(key).push(it);
  });
  [...groups.entries()].sort().forEach(([folder,arr])=>{
    arr.sort((a,b)=>a.name.localeCompare(b.name));
    const sec=document.createElement('section');
    sec.className='grp';
    const h2=document.createElement('h2');
    h2.textContent=folder?`/${folder}`:"/";
    sec.appendChild(h2);
    const ul=document.createElement('ul');
    arr.forEach(it=>{
      const li=document.createElement('li');
      const a=document.createElement('a');
      a.href=it.href; a.textContent=prettyName(it.name);
      const meta=document.createElement('span');
      meta.className='pill'; meta.textContent=it.path;
      const when=document.createElement('span');
      when.className='ago';
      if(it.updatedAt){
        const d=new Date(it.updatedAt);
        const ag=timeAgo(d);
        when.textContent=ag.t; when.classList.add(ag.c);
        when.title=`Last updated: ${isoLocal(d)}`;
      } else {
        when.textContent="â€”";
      }
      li.append(a,meta,when);
      ul.appendChild(li);
    });
    sec.appendChild(ul);
    listEl.appendChild(sec);
  });
}

function applyFilter(){
  const q=qEl.value.trim().toLowerCase();
  render(!q?allItems:allItems.filter(it=>it.name.toLowerCase().includes(q)||it.path.toLowerCase().includes(q)));
}

async function fetchTree(){
  statusEl.textContent="Loadingâ€¦";
  try{
    const r=await fetch(`https://api.github.com/repos/${USER}/${REPO}/git/trees/HEAD?recursive=1`);
    if(!r.ok) throw new Error();
    const data=await r.json();
    allItems=data.tree.filter(n=>n.type==="blob" && /\.html?$/i.test(n.path) && !/index\.html?$/i.test(n.path))
      .map(n=>({path:n.path,name:n.path.split('/').pop(),href:BASE+n.path,updatedAt:null}));
    render(allItems);
    statusEl.textContent=`Found ${allItems.length} file(s), fetching datesâ€¦`;
    await fetchDates();
    render(allItems);
    statusEl.textContent=`Found ${allItems.length} file(s)`;
  }catch(e){
    statusEl.textContent="Error fetching data";
  }
}

async function fetchDates(){
  let i=0, max=4; // concurrency
  async function worker(){
    while(i<allItems.length){
      const idx=i++;
      try{
        const r=await fetch(`https://api.github.com/repos/${USER}/${REPO}/commits?path=${encodeURIComponent(allItems[idx].path)}&per_page=1`);
        if(r.ok){
          const c=await r.json();
          allItems[idx].updatedAt=c[0]?.commit?.committer?.date||null;
        }
      }catch(e){}
    }
  }
  await Promise.all(Array.from({length:max},worker));
}

fetchTree();
</script>
</body>
</html>